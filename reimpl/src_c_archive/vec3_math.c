/* vec3_math.c -- 3D vector operations (fixed-point 16.16)
 *
 * Hand-translated from annotated ASM (asm/math_helpers.s)
 * and verified instruction-by-instruction against build/aprog.s binary.
 *
 * Functions:
 *   FUN_060274DA (0x060274DA) -- vec3_dot: dot product of two 3-element vectors
 *   FUN_06027498 (0x06027498) -- vec3_normalize: normalize vector to unit length
 *
 * Both operate on 3-element int arrays (X, Y, Z) in 16.16 fixed-point.
 * The dot product uses the SH-2 MAC unit for 64-bit accumulation.
 * Normalize uses dot(self), isqrt, fpdiv(1.0/mag), then scales each component.
 *
 * Original addresses: 0x060274DA, 0x06027498
 */

/* External math primitives */
extern unsigned int FUN_06027552(int a, int b);  /* fpmul: (a*b)>>16 */
extern int FUN_0602755C(int dividend, int divisor); /* fpdiv: (a<<16)/b */
extern int FUN_06027476(int value);              /* isqrt: floor(sqrt(x))<<8 */


/* ================================================================
 * FUN_060274DA -- Vec3 Dot Product (0x060274DA)
 *
 * CONFIDENCE: DEFINITE (math_helpers.s lines 402-429, binary verified)
 * Verified byte-for-byte at 0x060274DA. 7 instructions total.
 *
 * Uses SH-2 MAC (Multiply-Accumulate) unit:
 *   clrmac
 *   mac.l @r4+,@r5+ (x3)
 *   sts mach,r1 / sts macl,r0 / xtrct r1,r0
 *
 * The xtrct extracts middle 32 bits of the 64-bit accumulator,
 * giving (accumulator >> 16) -- the 16.16 fixed-point dot product.
 *
 * LEAF function. Not in aprog_syms.txt (unlabeled helper).
 * ================================================================ */
int FUN_060274DA(int *a, int *b)
{
    long long acc = 0;
    acc += (long long)a[0] * (long long)b[0];
    acc += (long long)a[1] * (long long)b[1];
    acc += (long long)a[2] * (long long)b[2];
    return (int)(acc >> 16);
}


/* ================================================================
 * FUN_06027498 -- Vec3 Normalize (0x06027498)
 *
 * CONFIDENCE: DEFINITE (math_helpers.s lines 342-399, binary verified)
 * Pool verified:
 *   0x060274F8 = 0x00010000 (1.0 in 16.16 fixed-point)
 *
 * Algorithm:
 *   1. mag_sq = vec3_dot(vec, vec)     (bsr 060274DA)
 *   2. mag = isqrt(mag_sq)            (bsr 06027476)
 *   3. if mag <= 0: return             (zero vector, skip)
 *   4. inv_mag = fpdiv(1.0, mag)       (bsr 0602755C)
 *   5. vec[0] = fpmul(vec[0], inv_mag) (dmuls.l + xtrct, x3)
 *   6. vec[1] = fpmul(vec[1], inv_mag)
 *   7. vec[2] = fpmul(vec[2], inv_mag)
 *
 * Normalizes vector in-place to unit length.
 * Uses callee-saved r14 to preserve vector pointer across calls.
 * ================================================================ */
#if 0 /* FUN_06027498 -- replaced by ASM import */
void FUN_06027498(int *vec)
{
    int mag_sq, mag, inv_mag;

    mag_sq = FUN_060274DA(vec, vec);
    mag = FUN_06027476(mag_sq);

    if (mag <= 0)
        return;

    inv_mag = FUN_0602755C(0x00010000, mag);

    vec[0] = (int)FUN_06027552(vec[0], inv_mag);
    vec[1] = (int)FUN_06027552(vec[1], inv_mag);
    vec[2] = (int)FUN_06027552(vec[2], inv_mag);
}
#endif

/* FUN_06027498 -- original binary (564 bytes) */
__asm__(
    ".section .text.FUN_06027498, \"ax\"\n"
    ".balign 2\n"
    ".global _FUN_06027498\n"
    ".type _FUN_06027498, @function\n"
    "_FUN_06027498:\n"
    ".byte 0x2F, 0xE6, 0x4F, 0x22, 0x6E, 0x43, 0xB0, 0x1C, 0x65, 0x43, 0xBF, 0xE8, 0x64, 0x03, 0x40, 0x15\n"  /* 0x06027498 */
    ".byte 0x8B, 0x14, 0xD4, 0x13, 0xB0, 0x56, 0x65, 0x03, 0x51, 0xE0, 0x52, 0xE1, 0x31, 0x0D, 0x53, 0xE2\n"  /* 0x060274A8 */
    ".byte 0x04, 0x0A, 0x01, 0x1A, 0x21, 0x4D, 0x32, 0x0D, 0x1E, 0x10, 0x04, 0x0A, 0x02, 0x1A, 0x22, 0x4D\n"  /* 0x060274B8 */
    ".byte 0x33, 0x0D, 0x1E, 0x21, 0x04, 0x0A, 0x03, 0x1A, 0x23, 0x4D, 0x1E, 0x32, 0x4F, 0x26, 0x00, 0x0B\n"  /* 0x060274C8 */
    ".byte 0x6E, 0xF6, 0x00, 0x28, 0x05, 0x4F, 0x05, 0x4F, 0x05, 0x4F, 0x01, 0x0A, 0x00, 0x1A, 0x00, 0x0B\n"  /* 0x060274D8 */
    ".byte 0x20, 0x1D, 0x00, 0x09, 0x00, 0x2F, 0x2F, 0x20, 0x00, 0x2F, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00\n"  /* 0x060274E8 */
    ".byte 0x00, 0x01, 0x00, 0x00, 0x40, 0x00, 0x3F, 0xFC, 0x0F, 0xFC, 0x40, 0x00, 0x3F, 0xEB, 0x3F, 0xD6\n"  /* 0x060274F8 */
    ".byte 0x3F, 0xBA, 0x3F, 0x97, 0x3F, 0x6A, 0x3F, 0x2F, 0x3E, 0xFB, 0x3E, 0xA4, 0x3D, 0x74, 0x03, 0xE8\n"  /* 0x06027508 */
    ".byte 0x00, 0x1E, 0x00, 0x28, 0x00, 0x32, 0x00, 0x46, 0x00, 0x64, 0x00, 0x96, 0x00, 0xFA, 0x01, 0xF4\n"  /* 0x06027518 */
    ".byte 0x00, 0x00, 0x0A, 0xC0, 0x00, 0x00, 0x15, 0x81, 0x00, 0x00, 0x47, 0xAE, 0x00, 0x00, 0xB3, 0x33\n"  /* 0x06027528 */
    ".byte 0x00, 0x01, 0x80, 0x00, 0x00, 0x02, 0xF3, 0x33, 0x00, 0x05, 0x33, 0x33, 0x00, 0x08, 0xB3, 0x33\n"  /* 0x06027538 */
    ".byte 0x00, 0x15, 0xB6, 0xDB, 0x60, 0x49, 0x00, 0x0B, 0x60, 0x0F, 0x35, 0x4D, 0x04, 0x0A, 0x00, 0x1A\n"  /* 0x06027548 */
    ".byte 0x00, 0x0B, 0x20, 0x4D, 0x92, 0x08, 0x63, 0x43, 0x12, 0x50, 0x43, 0x29, 0x63, 0x3F, 0x12, 0x34\n"  /* 0x06027558 */
    ".byte 0x44, 0x28, 0x12, 0x45, 0x00, 0x0B, 0x50, 0x27, 0xFF, 0x00, 0x00, 0x00, 0x35, 0x40, 0x89, 0x0C\n"  /* 0x06027568 */
    ".byte 0xE7, 0x00, 0x36, 0x70, 0x89, 0x09, 0x35, 0x46, 0x89, 0x09, 0x35, 0x6C, 0x34, 0x6C, 0x75, 0xFF\n"  /* 0x06027578 */
    ".byte 0x67, 0x50, 0x46, 0x10, 0x24, 0x74, 0x8F, 0xFB, 0x75, 0xFF, 0x00, 0x0B, 0x00, 0x09, 0x67, 0x54\n"  /* 0x06027588 */
    ".byte 0x46, 0x10, 0x24, 0x70, 0x8F, 0xFB, 0x74, 0x01, 0x00, 0x0B, 0x00, 0x09, 0x35, 0x40, 0x89, 0x0E\n"  /* 0x06027598 */
    ".byte 0xE7, 0x00, 0x36, 0x70, 0x89, 0x0B, 0x67, 0x63, 0x35, 0x46, 0x8D, 0x0A, 0x46, 0x01, 0x35, 0x7C\n"  /* 0x060275A8 */
    ".byte 0x34, 0x7C, 0x75, 0xFC, 0x67, 0x51, 0x46, 0x10, 0x24, 0x75, 0x8F, 0xFB, 0x75, 0xFE, 0x00, 0x0B\n"  /* 0x060275B8 */
    ".byte 0x00, 0x09, 0x67, 0x55, 0x46, 0x10, 0x24, 0x71, 0x8F, 0xFB, 0x74, 0x02, 0x00, 0x0B, 0x00, 0x09\n"  /* 0x060275C8 */
    ".byte 0x35, 0x40, 0x89, 0x0E, 0xE7, 0x00, 0x36, 0x70, 0x89, 0x0B, 0x67, 0x63, 0x35, 0x46, 0x8D, 0x0A\n"  /* 0x060275D8 */
    ".byte 0x46, 0x09, 0x35, 0x7C, 0x34, 0x7C, 0x75, 0xFC, 0x67, 0x52, 0x46, 0x10, 0x24, 0x76, 0x8F, 0xFB\n"  /* 0x060275E8 */
    ".byte 0x75, 0xFC, 0x00, 0x0B, 0x00, 0x09, 0x67, 0x56, 0x46, 0x10, 0x24, 0x72, 0x8F, 0xFB, 0x74, 0x04\n"  /* 0x060275F8 */
    ".byte 0x00, 0x0B, 0x00, 0x09, 0xE0, 0x00, 0x76, 0xFF, 0x01, 0x5C, 0x36, 0x07, 0x04, 0x14, 0x8D, 0xFB\n"  /* 0x06027608 */
    ".byte 0x70, 0x01, 0x00, 0x0B, 0x76, 0x01, 0xE0, 0x00, 0x76, 0xFE, 0x01, 0x5D, 0x36, 0x07, 0x04, 0x15\n"  /* 0x06027618 */
    ".byte 0x8D, 0xFB, 0x70, 0x02, 0x00, 0x0B, 0x76, 0x02, 0xE0, 0x00, 0x76, 0xFC, 0x01, 0x5E, 0x36, 0x07\n"  /* 0x06027628 */
    ".byte 0x04, 0x16, 0x8D, 0xFB, 0x70, 0x04, 0x00, 0x0B, 0x76, 0x04, 0x60, 0x56, 0x61, 0x56, 0x62, 0x56\n"  /* 0x06027638 */
    ".byte 0x63, 0x56, 0x14, 0x00, 0x14, 0x11, 0x14, 0x22, 0x14, 0x33, 0x60, 0x56, 0x61, 0x56, 0x62, 0x56\n"  /* 0x06027648 */
    ".byte 0x63, 0x56, 0x14, 0x04, 0x14, 0x15, 0x14, 0x26, 0x14, 0x37, 0x46, 0x10, 0x8F, 0xED, 0x74, 0x20\n"  /* 0x06027658 */
    ".byte 0x00, 0x0B, 0x00, 0x09, 0xD0, 0x07, 0x60, 0x02, 0xD1, 0x07, 0x20, 0x18, 0x8B, 0xFA, 0xD1, 0x07\n"  /* 0x06027668 */
    ".byte 0x92, 0x07, 0x11, 0x41, 0x11, 0x50, 0x11, 0x62, 0x11, 0x23, 0xE0, 0x07, 0x11, 0x05, 0x00, 0x0B\n"  /* 0x06027678 */
    ".byte 0x11, 0x24, 0x01, 0x01, 0x25, 0xFE, 0x00, 0x7C, 0x00, 0x00, 0x27, 0x2E, 0x25, 0xFE, 0x00, 0x00\n"  /* 0x06027688 */
    ".byte 0x00, 0x09, 0x00, 0x00, 0x91, 0x10, 0x90, 0x14, 0x52, 0x42, 0x11, 0x04, 0x11, 0x20, 0xE0, 0x00\n"  /* 0x06027698 */
    ".byte 0x11, 0x05, 0x50, 0x41, 0x62, 0x42, 0x60, 0x0B, 0x54, 0x17, 0x34, 0x2D, 0x02, 0x0A, 0x34, 0x0D\n"  /* 0x060276A8 */
    ".byte 0x25, 0x21, 0x00, 0x0A, 0x00, 0x0B, 0x81, 0x51, 0xFF, 0x00, 0x00, 0x09, 0x00, 0x01, 0x00, 0x00\n"  /* 0x060276B8 */
    ".byte 0xFF, 0x00, 0x00, 0xA0\n"  /* 0x060276C8 */
);

