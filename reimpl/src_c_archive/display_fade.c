/* display_fade.c -- Display brightness fade-in/fade-out control
 *
 * Functions:
 *   FUN_0601D478 (0x0601D478) -- Brightness fade init: set params, start fade
 *   FUN_0601D4A8 (0x0601D4A8) -- Brightness fade step: per-frame fade update
 *
 * These functions control the screen brightness fade effect used
 * during state transitions (attract mode, post-race, etc.).
 *
 * Shared registers:
 *   0x0605AAA2: Fade mode flag (short, set to 2 during init)
 *   0x0607885C: Current brightness level (int, decremented by 0x100000)
 *   0x0607886E: Fade timer (short, decremented by 2 per frame)
 *   0x0607887F: Fade phase counter (byte, incremented when timer expires)
 *
 * Original addresses: 0x0601D478, 0x0601D4A8
 */

/* Render parameter setter (type, value, flags) */
extern void FUN_06014884(int type, int value, int flags);

/* Sound/display fade table lookup (lowercase: defined in batch_subsystem_1c.c) */
extern void FUN_0601d57c(int timer_value);


/* ================================================================
 * FUN_0601D478 -- Brightness Fade Init (0x0601D478)
 *
 * CONFIDENCE: DEFINITE (binary verified at 0x0601D478-0x0601D4A6)
 * Pool verified:
 *   0x0601D4F0 = 0x0605AAA2 (fade mode flag)
 *   0x0601D4F4 = 0x01500000 (initial brightness)
 *   0x0601D4F8 = 0x0607885C (brightness register)
 *   0x0601D4FC = 0x06014884 (render parameter setter)
 *   0x0601D500 = 0x0607886E (fade timer)
 *   0x0601D504 = 0x0607887F (fade phase counter)
 *
 * Sets fade mode=2, initial brightness=0x01500000, calls render param
 * setter with mesh attribute (32), sets timer to 42, calls fade table
 * lookup, increments phase counter.
 *
 * 24 instructions (incl. delay slots). Saves PR.
 * ================================================================ */
/* FUN_0601D478 -- original binary (48 bytes) */
__asm__(
    ".section .text.FUN_0601D478, \"ax\"\n"
    ".balign 2\n"
    ".global _FUN_0601D478\n"
    ".global _FUN_0601d478\n"
    ".type _FUN_0601D478, @function\n"
    "_FUN_0601D478:\n"
    "_FUN_0601d478:\n"
    ".byte 0x4F, 0x22, 0xE2, 0x02, 0xE6, 0x00, 0xD3, 0x1C, 0x23, 0x21, 0xD3, 0x1C, 0xD2, 0x1C, 0x22, 0x32\n"  /* 0x0601D478 */
    ".byte 0x65, 0x23, 0xD3, 0x1C, 0x65, 0x52, 0x43, 0x0B, 0xE4, 0x20, 0xE2, 0x2A, 0xD3, 0x1A, 0x23, 0x21\n"  /* 0x0601D488 */
    ".byte 0xB0, 0x70, 0x64, 0x23, 0xD4, 0x19, 0x4F, 0x26, 0x62, 0x40, 0x72, 0x01, 0x00, 0x0B, 0x24, 0x20\n"  /* 0x0601D498 */
);



/* ================================================================
 * FUN_0601D4A8 -- Brightness Fade Step (0x0601D4A8)
 *
 * CONFIDENCE: DEFINITE (binary verified at 0x0601D4A8-0x0601D4EE)
 * Pool verified:
 *   0x0601D508 = 0x00100000 (fade step amount)
 *   0x0601D500 = 0x0607886E (fade timer)
 *   0x0601D4F8 = 0x0607885C (brightness register)
 *   0x0601D4FC = 0x06014884 (render parameter setter)
 *   0x0601D504 = 0x0607887F (fade phase counter)
 *
 * Per-frame fade update. If timer != 0: decreases brightness by
 * 0x100000, applies via render param setter, decreases timer by 2,
 * calls fade table lookup. If timer == 0: increments phase counter,
 * decreases brightness by 0x100000.
 *
 * 36 instructions (incl. delay slots + pool). Saves PR + r13 + r14.
 * ================================================================ */
#if 0 /* FUN_0601D4A8 -- replaced by ASM import */
void FUN_0601D4A8(void)
{
    unsigned short timer = *(volatile unsigned short *)0x0607886E;

    if (timer != 0) {
        /* Fade in progress: decrease brightness and update */
        *(volatile int *)0x0607885C -= 0x00100000;
        FUN_06014884(32, *(volatile int *)0x0607885C, 0);

        /* Decrease timer by 2 and update fade table */
        *(volatile short *)0x0607886E = (short)(timer - 2);
        FUN_0601d57c((int)(timer - 2));
    } else {
        /* Fade complete: increment phase counter, final brightness step */
        (*(volatile unsigned char *)0x0607887F)++;
        *(volatile int *)0x0607885C -= 0x00100000;
    }
}
#endif

/* FUN_0601D4A8 -- original binary (212 bytes) */
__asm__(
    ".section .text.FUN_0601D4A8, \"ax\"\n"
    ".balign 2\n"
    ".global _FUN_0601D4A8\n"
    ".global _FUN_0601d4a8\n"
    ".type _FUN_0601D4A8, @function\n"
    "_FUN_0601D4A8:\n"
    "_FUN_0601d4a8:\n"
    ".byte 0x2F, 0xE6, 0x2F, 0xD6, 0x4F, 0x22, 0xD4, 0x16, 0xDD, 0x13, 0xDE, 0x11, 0x60, 0xD1, 0x60, 0x0D\n"  /* 0x0601D4A8 */
    ".byte 0x20, 0x08, 0x89, 0x0E, 0xE6, 0x00, 0x63, 0xE2, 0x33, 0x48, 0x2E, 0x32, 0x65, 0x33, 0xD3, 0x0D\n"  /* 0x0601D4B8 */
    ".byte 0x43, 0x0B, 0xE4, 0x20, 0x64, 0xD1, 0x74, 0xFE, 0x2D, 0x41, 0x4F, 0x26, 0x6D, 0xF6, 0xA0, 0x51\n"  /* 0x0601D4C8 */
    ".byte 0x6E, 0xF6, 0xD5, 0x0A, 0x62, 0x50, 0x72, 0x01, 0x25, 0x20, 0x63, 0xE2, 0x33, 0x48, 0x2E, 0x32\n"  /* 0x0601D4D8 */
    ".byte 0x4F, 0x26, 0x6D, 0xF6, 0x00, 0x0B, 0x6E, 0xF6, 0x06, 0x05, 0xAA, 0xA2, 0x01, 0x50, 0x00, 0x00\n"  /* 0x0601D4E8 */
    ".byte 0x06, 0x07, 0x88, 0x5C, 0x06, 0x01, 0x48, 0x84, 0x06, 0x07, 0x88, 0x6E, 0x06, 0x07, 0x88, 0x7F\n"  /* 0x0601D4F8 */
    ".byte 0x00, 0x10, 0x00, 0x00, 0xD0, 0x10, 0x60, 0x02, 0x20, 0x08, 0x89, 0x13, 0xD0, 0x0F, 0x60, 0x02\n"  /* 0x0601D508 */
    ".byte 0xC8, 0x01, 0x8D, 0x09, 0xE6, 0x00, 0xD5, 0x0C, 0xE3, 0x00, 0x65, 0x52, 0x33, 0x57, 0x35, 0x3E\n"  /* 0x0601D518 */
    ".byte 0x45, 0x21, 0xD3, 0x09, 0xA0, 0x03, 0x23, 0x52, 0xD5, 0x07, 0x65, 0x52, 0x65, 0x5B, 0xD3, 0x08\n"  /* 0x0601D528 */
    ".byte 0x43, 0x2B, 0xE4, 0x20, 0xD4, 0x07, 0x62, 0x40, 0x72, 0x01, 0x00, 0x0B, 0x24, 0x20, 0xE5, 0x17\n"  /* 0x0601D538 */
    ".byte 0xD4, 0x05, 0xD3, 0x06, 0x43, 0x2B, 0x64, 0x42, 0x06, 0x07, 0x88, 0x5C, 0x06, 0x07, 0xEB, 0xC8\n"  /* 0x0601D548 */
    ".byte 0x06, 0x01, 0x48, 0x84, 0x06, 0x07, 0x88, 0x7F, 0x06, 0x07, 0xEB, 0xCC, 0x06, 0x00, 0x33, 0x8C\n"  /* 0x0601D558 */
    ".byte 0xD3, 0x1C, 0xE2, 0x01, 0x63, 0x32, 0x33, 0x23, 0x89, 0x02, 0xE2, 0x06, 0xD3, 0x1A, 0x23, 0x22\n"  /* 0x0601D568 */
    ".byte 0x00, 0x0B, 0x00, 0x09\n"  /* 0x0601D578 */
);

