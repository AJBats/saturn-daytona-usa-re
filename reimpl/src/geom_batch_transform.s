/* geom_batch_transform -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601EFC4 - 0x0601F40C
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Batch vertex transform — LARGEST LEAF function in binary (930 bytes).
 * Copies geometry data byte-by-byte from multiple source arrays (vertex
 * matrix rows, scale tables, model descriptors, coordinate extents,
 * course params, display flags, and transform scratchpad) into a
 * contiguous output buffer. All fixed-point, no function calls.
 * Unrolled loops for SH-2 throughput.
 *
 * r4 = dest pointer (walks through output buffer)
 * r5 = 0x00F0 (batch stride / vertex count per block)
 */

    .section .text.FUN_0601EFC4


    .global geom_batch_transform
    .type geom_batch_transform, @function
geom_batch_transform:
    mov.l r14, @-r15             ! save callee-saved regs
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov.w   .L_const_batch_stride, r5 ! r5 = 0x00F0 (batch stride)
    mov.l   .L_ptr_geom_busy_flag, r0 ! r0 -> busy flag byte
    mov.b @r0, r0                ! read flag
    extu.b r0, r0
    tst r0, r0                   ! flag == 0?
    bt      .L_begin_copy        ! yes: proceed with copy
    bra     .L_epilogue          ! no: skip (geometry busy)
    nop
.L_const_batch_stride:
    .2byte  0x00F0               ! 240 = batch stride per row block
    .4byte  sym_06060D68         ! (out-of-TU pool refs)
    .4byte  sym_06060D6A
    .4byte  sym_06060D70
    .4byte  sym_06060D74
    .4byte  sym_06060D6C
.L_ptr_geom_busy_flag:
    .4byte  sym_06087080         ! -> geom busy flag byte
    ! ---- Phase 1: Copy vertex matrix row data (9 pairs x stride) ----
.L_begin_copy:
    mov.l   .L_ptr_output_buf, r4 ! r4 -> output buffer base ptr
    mov.l @r4, r4               ! dereference: r4 = actual buffer addr
    add #0x10, r4               ! skip 16-byte header
    mov.l   .L_ptr_vtx_row_table, r6 ! r6 -> row ptr table (9 entries)
    mov r6, r7                  ! r7 = current table entry ptr
    mov r6, r11
    add #0x48, r11              ! r11 = table end (9 entries * 8 bytes)
.L_row_table_outer:              ! for each row pair in table
    mov.l @r7, r14              ! r14 = source data base for this row
    mov r14, r6                 ! r6 = current source pos
    mov r14, r12
    add r5, r12                 ! r12 = end of this row block (base + stride)
.L_row_table_inner:              ! copy 12 bytes (3x4) per vertex entry
    mov r6, r0                  ! r0 = entry base
    mov r6, r14
    mov.b @r14+, r1             ! copy bytes [0..3] -> dest
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov.b r2, @r4
    add #0x1, r4
    mov r0, r14
    add #0x4, r14               ! advance to bytes [4..7]
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov.b r2, @r4
    add #0x1, r4
    mov r0, r14
    add #0x8, r14               ! advance to bytes [8..11]
    mov.b @r14+, r1
    add #0xC, r6               ! advance src by 12
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov.b r2, @r4
    cmp/hs r12, r6             ! reached end of row block?
    bf/s    .L_row_table_inner  ! no: next entry
    add #0x1, r4
    add #0x8, r7               ! advance to next table pair
    cmp/hs r11, r7             ! done all 9 pairs?
    bf      .L_row_table_outer  ! no: next row
    ! ---- Phase 2: Copy model descriptors (6 entries, 8 bytes each) ----
    mov.l   .L_ptr_model_desc_table, r6 ! r6 -> descriptor ptr table
    mov r6, r7
    add #0x18, r7              ! r7 = table end (6 ptrs * 4 bytes)
.L_copy_model_desc:             ! deref each ptr, copy 8 bytes
    mov.l @r6, r0              ! r0 = deref'd ptr -> descriptor data
    add #0x4, r6               ! advance table ptr
    mov r0, r14
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov r0, r14
    mov.b r2, @r4
    add #0x4, r14
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov.b r2, @r4
    cmp/hs r7, r6             ! done all 6 descriptors?
    bf/s    .L_copy_model_desc  ! no: next descriptor
    add #0x1, r4
    ! ---- Phase 3: Copy vertex scale table A (8 entries, 8 bytes each) ----
    mov.l   .L_ptr_vtx_scale_a, r6 ! r6 -> scale table A base
    mov r6, r7
    add #0x20, r7              ! r7 = end (8 entries * 4 bytes)
.L_copy_scale_a:                ! copy 8 bytes per entry (2x4 byte halves)
    mov r6, r14
    add #0x4, r6
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov r6, r14
    mov.b r2, @r4
    add #0x4, r6
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov.b r2, @r4
    cmp/hs r7, r6             ! done all 8 entries?
    bf/s    .L_copy_scale_a    ! no: next scale entry
    add #0x1, r4
    ! ---- Phase 4: Copy vertex scale table B (8 entries, 8 bytes each) ----
    mov.l   .L_ptr_vtx_scale_b, r6 ! r6 -> scale table B base
    mov r6, r7
    add #0x20, r7              ! r7 = end
.L_copy_scale_b:                ! copy 8 bytes per entry
    mov r6, r14
    mov.b @r14+, r1
    add #0x4, r6
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov r6, r14
    mov.b r2, @r4
    add #0x4, r6
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r14, r2
    mov.b r2, @r4
    cmp/hs r7, r6             ! done all 8?
    bf/s    .L_copy_scale_b    ! no: next
    add #0x1, r4
    ! ---- Phase 5: Copy coordinate extents (3 entries, 12 bytes each) ----
    mov.l   .L_ptr_coord_extents, r6 ! r6 -> extents base
    mov r6, r7                  ! r7 = current pos
    mov r6, r14
    add #0x24, r14              ! r14 = end (3 * 12 = 36 = 0x24)
.L_copy_extents:                ! copy 12 bytes per extent entry
    mov r7, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    add #0xC, r7
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    cmp/hs r14, r7             ! done all 3 extents?
    bf/s    .L_copy_extents    ! no: next extent
    add #0x1, r4
    ! ---- Phase 6: Copy course data (3 x 4-byte entries) ----
    mov.l   .L_ptr_course_data_a, r6 ! copy course param A (4 bytes)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_course_data_b, r6 ! copy course param B (4 bytes)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_course_data_c, r6 ! copy course param C (4 bytes)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    ! ---- Phase 7: Copy single-byte flags (4 bytes total) ----
    mov.l   .L_ptr_anim_flag_a, r2 ! animation state flag A
    mov.b @r2, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_anim_flag_b, r2 ! animation state flag B
    mov.b @r2, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_disp_flag_a, r2 ! display mode flag A
    mov.b @r2, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_disp_flag_b, r2 ! display mode flag B
    mov.b @r2, r2
    mov.b r2, @r4
    add #0x1, r4
    ! ---- Phase 8: Copy transform scratchpad params (2-byte pairs) ----
    mov.l   .L_ptr_xform_param_00, r6 ! xform param pair [0x00] (2 bytes)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_02, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_04, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_06, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_08, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_0A, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_0C, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_0E, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_10, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_14, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_18, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov r4, r3
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r3
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_1C, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_1E, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_20, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    bra     .L_copy_tail_params  ! jump past pool to continue
    nop
    ! ==== constant pool 1 ====
.L_ptr_output_buf:
    .4byte  sym_0605E098         ! -> geom output buf ptr (deref'd)
.L_ptr_vtx_row_table:
    .4byte  sym_0605DD6C         ! -> vertex matrix row ptr table (9 pairs)
.L_ptr_model_desc_table:
    .4byte  sym_0605DE24         ! -> model descriptor ptr table (6 entries)
.L_ptr_vtx_scale_a:
    .4byte  sym_0605DDB4         ! -> vertex scale table A (8 x 4 bytes)
.L_ptr_vtx_scale_b:
    .4byte  sym_0605DDD4         ! -> vertex scale table B (8 x 4 bytes)
.L_ptr_coord_extents:
    .4byte  sym_0605DE40         ! -> coordinate extent table (3 x 12 bytes)
.L_ptr_course_data_a:
    .4byte  sym_0605AD00         ! -> course data param A (4 bytes)
.L_ptr_course_data_b:
    .4byte  sym_0605AD04         ! -> course data param B (4 bytes)
.L_ptr_course_data_c:
    .4byte  sym_0605AD0C         ! -> course data param C (4 bytes)
.L_ptr_anim_flag_a:
    .4byte  sym_0605AB16         ! -> animation state flag A (1 byte)
.L_ptr_anim_flag_b:
    .4byte  sym_0605AB17         ! -> animation state flag B (1 byte)
.L_ptr_disp_flag_a:
    .4byte  sym_0605D240         ! -> display mode flag A (1 byte)
.L_ptr_disp_flag_b:
    .4byte  sym_0605D241         ! -> display mode flag B (1 byte)
.L_ptr_xform_param_00:          ! transform scratchpad — 2-byte runtime values
    .4byte  sym_06060D44         ! param pair [0x00]
.L_ptr_xform_param_02:
    .4byte  sym_06060D46         ! param pair [0x02]
.L_ptr_xform_param_04:
    .4byte  sym_06060D40         ! param pair [0x04]
.L_ptr_xform_param_06:
    .4byte  sym_06060D42         ! param pair [0x06]
.L_ptr_xform_param_08:
    .4byte  sym_06060D48         ! param pair [0x08]
.L_ptr_xform_param_0A:
    .4byte  sym_06060D4A         ! param pair [0x0A]
.L_ptr_xform_param_0C:
    .4byte  sym_06060D4C         ! param pair [0x0C]
.L_ptr_xform_param_0E:
    .4byte  sym_06060D4E         ! param pair [0x0E]
.L_ptr_xform_param_10:
    .4byte  sym_06060D54         ! param pair [0x10] (4 bytes)
.L_ptr_xform_param_14:
    .4byte  sym_06060D58         ! param pair [0x14] (4 bytes)
.L_ptr_xform_param_18:
    .4byte  sym_06060D50         ! param pair [0x18] (4 bytes)
.L_ptr_xform_param_1C:
    .4byte  sym_06060D60         ! param pair [0x1C]
.L_ptr_xform_param_1E:
    .4byte  sym_06060D62         ! param pair [0x1E]
.L_ptr_xform_param_20:
    .4byte  sym_06060D5C         ! param pair [0x20]
    ! ---- Phase 9: Copy remaining transform params (past pool gap) ----
.L_copy_tail_params:
    add #0x1, r4               ! resume dest advancement
    mov.l   .L_ptr_xform_param_22, r6 ! xform param pair [0x22]
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_24, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_26, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_28, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_2A, r6
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_2C, r6 ! xform param [0x2C] (4 bytes)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_30, r6 ! xform param [0x30] (4 bytes)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r2
    mov.b r2, @r4
    add #0x1, r4
    mov.l   .L_ptr_xform_param_34, r6 ! xform param [0x34] (4 bytes, last)
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6+, r1
    mov.b r1, @r4
    add #0x1, r4
    mov.b @r6, r3
    mov.b r3, @r4               ! final byte written
.L_epilogue:                     ! restore callee-saved regs and return
    mov.l @r15+, r11
    mov.l @r15+, r12
    rts
    mov.l @r15+, r14             ! (delay slot)
    ! ==== constant pool 2 ====
.L_ptr_xform_param_22:
    .4byte  sym_06060D5E         ! param pair [0x22]
.L_ptr_xform_param_24:
    .4byte  sym_06060D64         ! param pair [0x24]
.L_ptr_xform_param_26:
    .4byte  sym_06060D66         ! param pair [0x26]
.L_ptr_xform_param_28:
    .4byte  sym_06060D68         ! param pair [0x28]
.L_ptr_xform_param_2A:
    .4byte  sym_06060D6A         ! param pair [0x2A]
.L_ptr_xform_param_2C:
    .4byte  sym_06060D70         ! param pair [0x2C] (4 bytes)
.L_ptr_xform_param_30:
    .4byte  sym_06060D74         ! param pair [0x30] (4 bytes)
.L_ptr_xform_param_34:
    .4byte  sym_06060D6C         ! param pair [0x34] (4 bytes)
