/* obj_init_defaults -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06020430 - 0x060204B4
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Object Display List Default Initializer
 * ----------------------------------------
 * Iterates over a type table and initializes each object's display list
 * entry in the object table (sym_0605F44E). For each object:
 *   - Reads a type byte from the caller-provided type table
 *   - If type == 0x20 (default marker): writes the caller-supplied default
 *     value (r14) into both the display list index fields (+4, +6)
 *   - Otherwise: computes display list indices from (type - 0x40) and
 *     writes index*2 to field +4 and index*2+1 to field +6
 *   - Calls display_list_loader to load the corresponding display list
 *
 * Register inputs (caller-saved r8..r14 set by caller before entry):
 *   r4  = object_count (byte) — number of objects to initialize
 *   r6  = base_index — starting offset into the display list source data
 *   r7  = type_table_ptr — pointer to word table of object type bytes
 *   r8  = slot_index — starting slot in the display list source
 *   r13 = type_index — starting index into the type table
 *   r14 = default_value — default display list index for type 0x20 objects
 *
 * Calls:
 *   sym_06028400 = display_list_loader(r4=mode, r5=dlist_base, r6=src_offset, r7=tex_data)
 *
 * Data references:
 *   sym_0605F44E = object display list base table
 *   0x3C79       = texture data constant passed to display_list_loader
 */

    .section .text.FUN_06020430


    .global obj_init_defaults
    .type obj_init_defaults, @function
obj_init_defaults:
    sts.l pr, @-r15                             ! save return address to stack
    add #-0xC, r15                              ! allocate 12 bytes of local stack space
    mov.w   .L_wpool_060204A8, r10              ! r10 = 0x3C79 (texture data constant)
    mov.l   .L_pool_obj_table, r12              ! r12 = sym_0605F44E (object display list base)
    mov.b r4, @r15                              ! stack[0] = object_count (byte)
    mov r12, r11                                ! r11 = obj_table base
    mov r12, r9                                 ! r9 = obj_table base
    mov.l r7, @(4, r15)                         ! stack[4] = type_table_ptr
    add #0x4, r11                               ! r11 = &obj_table[+4] (dlist index field A)
    mov.l r6, @(8, r15)                         ! stack[8] = base_index
    mov.b @r15, r3                              ! r3 = object_count
    cmp/pl r3                                   ! test if object_count > 0
    bf/s    .L_epilogue                         ! if count <= 0, skip loop and return
    add #0x6, r9                                ! r9 = &obj_table[+6] (dlist index field B) [delay slot]
.L_loop_top:
    extu.b r13, r0                              ! r0 = type_index (zero-extended byte)
    mov.l @(4, r15), r3                         ! r3 = type_table_ptr
    shll r0                                     ! r0 = type_index * 2 (word offset into table)
    mov.w @(r0, r3), r4                         ! r4 = type_table[type_index] (word entry)
    extu.b r4, r4                               ! r4 = low byte of table entry (type code)
    extu.b r4, r0                               ! r0 = type code (for comparison)
    cmp/eq #0x20, r0                            ! is type code == 0x20 (default marker)?
    bf      .L_compute_index                    ! if not default, compute index from type code
    extu.w r14, r3                              ! r3 = default_value (zero-extended word)
    mov.w r3, @r11                              ! obj_table[+4] = default_value (dlist index A)
    extu.w r14, r2                              ! r2 = default_value (zero-extended word)
    bra     .L_call_loader                      ! jump to display_list_loader call
    mov.w r2, @r9                               ! obj_table[+6] = default_value (dlist index B) [delay slot]
.L_compute_index:
    extu.b r4, r5                               ! r5 = type code (byte)
    add #-0x40, r5                              ! r5 = type - 0x40 (base offset for non-default types)
    shll r5                                     ! r5 = (type - 0x40) * 2 (dlist index A)
    extu.w r5, r3                               ! r3 = dlist index A (zero-extended word)
    mov.w r3, @r11                              ! obj_table[+4] = dlist index A
    add #0x1, r5                                ! r5 = (type - 0x40) * 2 + 1 (dlist index B)
    extu.w r5, r5                               ! r5 = dlist index B (zero-extended word)
    mov.w r5, @r9                               ! obj_table[+6] = dlist index B
.L_call_loader:
    mov r10, r7                                 ! r7 = 0x3C79 (tex_data for display_list_loader)
    extu.w r8, r6                               ! r6 = slot_index (zero-extended word)
    mov r12, r5                                 ! r5 = sym_0605F44E (dlist_base for loader)
    mov.l   .L_pool_dlist_loader, r2            ! r2 = &display_list_loader (sym_06028400)
    mov.l @(8, r15), r3                         ! r3 = base_index
    add r3, r6                                  ! r6 = slot_index + base_index
    shll r6                                     ! r6 = (slot_index + base_index) * 2 (byte offset)
    jsr @r2                                     ! call display_list_loader(mode, dlist_base, src_offset, tex_data)
    mov #0x8, r4                                ! r4 = 0x8 (mode = load) [delay slot]
    add #0x1, r13                               ! type_index++
    mov.b @r15, r2                              ! r2 = object_count
    extu.b r13, r3                              ! r3 = type_index (zero-extended)
    cmp/ge r2, r3                               ! has type_index reached object_count?
    bf/s    .L_loop_top                         ! if not, continue loop
    add #0x1, r8                                ! slot_index++ [delay slot]
.L_epilogue:
    add #0xC, r15                               ! deallocate local stack space (12 bytes)
    lds.l @r15+, pr                             ! restore return address
    mov.l @r15+, r8                             ! restore r8
    mov.l @r15+, r9                             ! restore r9
    mov.l @r15+, r10                            ! restore r10
    mov.l @r15+, r11                            ! restore r11
    mov.l @r15+, r12                            ! restore r12
    mov.l @r15+, r13                            ! restore r13
    rts                                         ! return to caller
    mov.l @r15+, r14                            ! restore r14 [delay slot]
.L_wpool_060204A8:
    .2byte  0x3C79
    .2byte  0xFFFF
.L_pool_obj_table:
    .4byte  sym_0605F44E
.L_pool_dlist_loader:
    .4byte  sym_06028400
