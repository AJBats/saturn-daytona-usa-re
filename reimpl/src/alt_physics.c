#include "game.h"

/* Per-file car struct access macros */
#define CAR_INT(car, off)    (*(volatile int *)((char *)(car) + (off)))

/*
 * alt_physics.c -- Alternate physics pipeline (AI/VS mode)
 *
 * Hand-translated from binary at 0x0600E7C8 (104 instructions).
 *
 * Functions:
 *   FUN_0600E7C8 (0x0600E7C8) -- Alternate car physics update
 *
 * This is the alternate physics pipeline, called for AI-controlled cars
 * or VS mode. It runs a subset of physics subsystems, then performs
 * heading convergence based on a mode byte, and finishes with
 * checkpoint tracking and optional camera projection.
 *
 * Called from physics_entry.c.
 */

/* External dependencies */
extern void FUN_06008318(void);             /* physics subsystem A */
extern void FUN_06008640(void);             /* physics subsystem B */
extern void FUN_0600D266(void);             /* heading/position update */
extern void FUN_0600C4F8(void);             /* speed processing */
extern void FUN_0602D88E(void);             /* misc physics step */
extern void FUN_0600CEBA(void);             /* checkpoint advance */
extern unsigned int FUN_06027552(int a, int b);  /* fpmul: (a*b)>>16 */

/* Mode byte: selects heading convergence algorithm */
#define CONVERGENCE_MODE     (*(volatile unsigned char *)0x06083261)

/* Global multiplier for velocity projection */
#define VEL_PROJ_MULTIPLIER  (*(volatile int *)0x0607EA9C)

/* Car field at offset 0x25C: target heading for convergence */
#define CAR_CONVERGENCE_HDG  0x25C


/* ================================================================
 * FUN_0600E7C8 -- Alternate Physics Pipeline (0x0600E7C8)
 *
 * CONFIDENCE: DEFINITE (binary verified at 0x0600E7C8-0x0600E904)
 * Pool verified:
 *   0x0600E878 = 0x0607E940 (CAR_PTR_CURRENT)
 *   0x0600E87C = 0x06008318 (physics subsystem A)
 *   0x0600E880 = 0x06008640 (physics subsystem B)
 *   0x0600E884 = 0x0600D266 (heading update)
 *   0x0600E888 = 0x0600C4F8 (speed processing)
 *   0x0600E88C = 0x0602D88E (misc physics)
 *   0x0600E890 = 0x06083261 (convergence mode byte)
 *   0x0600E894 = 0x00008000 (180-degree bias)
 *   0x0600E928 = 0x0600CEBA (checkpoint advance)
 *   0x0600E92C = 0x0607EA9C (vel proj multiplier)
 *   0x0600E930 = 0x0607EBC4 (GAME_STATE_BIT)
 *   0x0600E934 = 0x00200000 (state mask for projection)
 *   0x0600E938 = 0x066505B3 (projection constant)
 *   0x0600E93C = 0x06027552 (fpmul)
 * Word pool:
 *   0x0600E86C = 0x025C (convergence heading target)
 *   0x0600E86E = 0x0208 (CAR_GENERAL_TIMER)
 *   0x0600E870 = 0x01E4 (CAR_CHECKPOINT_IDX)
 *   0x0600E872 = 0x01F8 (CAR_TARGET_HDG)
 *   0x0600E874 = 0x0400 (1024, correction count)
 *   0x0600E91E = 0x0228 (CAR_RANKING)
 *   0x0600E920 = 0x01F8 (CAR_TARGET_HDG, reused)
 *   0x0600E922 = 0x00E4 (CAR_PROJECTED_B)
 *   0x0600E924 = 0x00E0 (CAR_PROJECTED_A)
 *
 * Algorithm:
 *   1. Call 5 physics subsystems in sequence
 *   2. Switch on convergence mode byte:
 *      - Mode 1: interpolate heading toward target (25%/frame)
 *      - Mode 2: interpolate with 180Â° bias (50%/frame), timer logic
 *      - Default: skip to common path
 *   3. Common path: call checkpoint advance, compute vel_proj,
 *      look up segment, optionally project camera
 *
 * 104 instructions. Saves r14, PR, MACL.
 * ================================================================ */
/* FUN_0600E7C8 -- original binary (318 bytes) */
__asm__(
    ".section .text.FUN_0600E7C8, \"ax\"\n"
    ".balign 2\n"
    ".global _FUN_0600E7C8\n"
    ".global _FUN_0600e7c8\n"
    ".type _FUN_0600E7C8, @function\n"
    "_FUN_0600E7C8:\n"
    "_FUN_0600e7c8:\n"
    ".byte 0x2F, 0xE6, 0x4F, 0x22, 0x4F, 0x12, 0xDE, 0x2A, 0xD3, 0x2A, 0x43, 0x0B, 0x6E, 0xE2, 0xD3, 0x2A\n"  /* 0x0600E7C8 */
    ".byte 0x43, 0x0B, 0x00, 0x09, 0xD3, 0x29, 0x43, 0x0B, 0x00, 0x09, 0xD3, 0x29, 0x43, 0x0B, 0x00, 0x09\n"  /* 0x0600E7D8 */
    ".byte 0xD3, 0x28, 0x43, 0x0B, 0x00, 0x09, 0xD0, 0x28, 0xA0, 0x52, 0x60, 0x00, 0x54, 0xEA, 0x90, 0x39\n"  /* 0x0600E7E8 */
    ".byte 0x02, 0xEE, 0x32, 0x48, 0x42, 0x28, 0x42, 0x21, 0x42, 0x21, 0x42, 0x29, 0x62, 0x2F, 0x32, 0x4C\n"  /* 0x0600E7F8 */
    ".byte 0x64, 0x2F, 0x65, 0x4F, 0x1E, 0x5C, 0xA0, 0x47, 0x1E, 0x5A, 0x54, 0xEA, 0x90, 0x2A, 0xD3, 0x1F\n"  /* 0x0600E808 */
    ".byte 0x02, 0xEE, 0x70, 0xAC, 0x32, 0x48, 0x32, 0x3C, 0x42, 0x28, 0x42, 0x21, 0x42, 0x29, 0x62, 0x2F\n"  /* 0x0600E818 */
    ".byte 0x32, 0x4C, 0x64, 0x2F, 0x65, 0x4F, 0x1E, 0x5C, 0x1E, 0x5A, 0x00, 0xEE, 0x20, 0x08, 0x89, 0x33\n"  /* 0x0600E828 */
    ".byte 0x90, 0x19, 0x03, 0xEE, 0x73, 0xFF, 0x0E, 0x36, 0x23, 0x38, 0x8B, 0x11, 0x90, 0x14, 0x04, 0xEE\n"  /* 0x0600E838 */
    ".byte 0x63, 0x43, 0x44, 0x08, 0x44, 0x00, 0x43, 0x08, 0x43, 0x08, 0x34, 0x3C, 0x70, 0xFC, 0x03, 0xEE\n"  /* 0x0600E848 */
    ".byte 0x34, 0x3C, 0x85, 0x4A, 0x63, 0x03, 0x90, 0x08, 0x0E, 0x36, 0x93, 0x07, 0x70, 0x0C, 0x0E, 0x36\n"  /* 0x0600E858 */
    ".byte 0xA0, 0x1A, 0x00, 0x09, 0x02, 0x5C, 0x02, 0x08, 0x01, 0xE4, 0x01, 0xF8, 0x04, 0x00, 0xFF, 0xFF\n"  /* 0x0600E868 */
    ".byte 0x06, 0x07, 0xE9, 0x40, 0x06, 0x00, 0x83, 0x18, 0x06, 0x00, 0x86, 0x40, 0x06, 0x00, 0xD2, 0x66\n"  /* 0x0600E878 */
    ".byte 0x06, 0x00, 0xC4, 0xF8, 0x06, 0x02, 0xD8, 0x8E, 0x06, 0x08, 0x32, 0x61, 0x00, 0x00, 0x80, 0x00\n"  /* 0x0600E888 */
    ".byte 0x88, 0x01, 0x89, 0xAB, 0x88, 0x02, 0x89, 0xB8, 0xD3, 0x21, 0x43, 0x0B, 0x00, 0x09, 0x90, 0x3A\n"  /* 0x0600E898 */
    ".byte 0xD3, 0x20, 0x02, 0xEE, 0x63, 0x32, 0x70, 0xC4, 0x02, 0x37, 0x03, 0xEE, 0x02, 0x1A, 0x70, 0x08\n"  /* 0x0600E8A8 */
    ".byte 0x32, 0x3C, 0x0E, 0x26, 0x70, 0xF0, 0x04, 0xEE, 0x70, 0xFC, 0x63, 0x43, 0x44, 0x08, 0x43, 0x08\n"  /* 0x0600E8B8 */
    ".byte 0x44, 0x00, 0x43, 0x08, 0x34, 0x3C, 0x03, 0xEE, 0x34, 0x3C, 0x85, 0x4A, 0x63, 0x03, 0x90, 0x23\n"  /* 0x0600E8C8 */
    ".byte 0x0E, 0x36, 0xD3, 0x15, 0xD2, 0x15, 0x63, 0x32, 0x23, 0x29, 0x23, 0x38, 0x89, 0x0B, 0xD5, 0x14\n"  /* 0x0600E8D8 */
    ".byte 0xD3, 0x14, 0x43, 0x0B, 0x54, 0xE3, 0x40, 0x29, 0x60, 0x0F, 0x91, 0x16, 0x31, 0xEC, 0x21, 0x02\n"  /* 0x0600E8E8 */
    ".byte 0x91, 0x14, 0x31, 0xEC, 0x21, 0x02, 0x4F, 0x16, 0x4F, 0x26, 0x00, 0x0B, 0x6E, 0xF6\n"  /* 0x0600E8F8 */
);

