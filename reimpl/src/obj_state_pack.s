/* obj_state_pack -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06020BCE - 0x06020C3C
 * Auto-generated by tools/generate_l3_tu.py
 */

    .section .text.FUN_06020BCE


    .global obj_state_pack
    .type obj_state_pack, @function

/* =========================================================================
 * obj_state_pack
 *
 * Finalizes object state for the current frame:
 *   1. Calls command_slot_write(8) to allocate a display command slot
 *   2. Calls scene_color_intensity(1.0) to set full-brightness color
 *   3. Calls command_queue_commit to flush the command queue
 *   4. Sets bit 26 (0x04000000) in the render mode flags
 *   5. Sets display_timer = 2 (activates display for 2 frames)
 *   6. Clears the input skip flag (re-enables input processing)
 *   7. Tail-calls display_update to push changes to hardware
 * ========================================================================= */
obj_state_pack:
    sts.l pr, @-r15                          ! save return address to stack
    .byte   0xD3, 0x16    /* mov.l .L_ptr_cmd_slot_write, r3 */
    jsr @r3                                  ! call command_slot_write
    mov #0x8, r4                             ! arg: slot index = 8 (delay slot)
    .byte   0xD5, 0x16    /* mov.l .L_fp_one, r5 */
    .byte   0xD3, 0x16    /* mov.l .L_ptr_scene_color_intensity, r3 */
    jsr @r3                                  ! call scene_color_intensity
    mov r5, r4                               ! arg: intensity = 1.0 fixed-point (delay slot)
    .byte   0xD3, 0x16    /* mov.l .L_ptr_cmd_queue_commit, r3 */
    jsr @r3                                  ! call command_queue_commit
    nop                                      ! delay slot (no arg needed)
    .byte   0xD4, 0x08    /* mov.l .L_ptr_render_mode_flags, r4 */
    .byte   0xD2, 0x09    /* mov.l .L_render_flag_bit26, r2 */
    mov.l @r4, r3                            ! r3 = current render mode flags
    or r2, r3                                ! r3 |= 0x04000000 (set bit 26)
    mov.l r3, @r4                            ! store updated render mode flags
    mov #0x2, r2                             ! r2 = 2 (display active for 2 frames)
    .byte   0xD3, 0x07    /* mov.l .L_ptr_display_timer, r3 */
    mov.w r2, @r3                            ! display_timer = 2
    mov #0x0, r2                             ! r2 = 0 (clear value)
    .byte   0xD3, 0x07    /* mov.l .L_ptr_input_skip_flag, r3 */
    mov.l r2, @r3                            ! input_skip_flag = 0 (re-enable input)
    .byte   0xD3, 0x07    /* mov.l .L_ptr_display_update, r3 */
    jmp @r3                                  ! tail-call display_update
    lds.l @r15+, pr                          ! restore return address (delay slot)

/* -- constant pool -------------------------------------------------------- */
    .4byte  sym_0607EBF4                     /* display/mode flags (32-bit) */
    .4byte  sym_0602853E                     /* display channel configure */
.L_ptr_render_mode_flags:
    .4byte  sym_0605B6D8                     /* render mode flags (32-bit bitmask) */
.L_render_flag_bit26:
    .4byte  0x04000000                       /* bit 26 flag constant */
.L_ptr_display_timer:
    .4byte  sym_0608780C                     /* display_timer (16-bit word; 2 = active) */
.L_ptr_input_skip_flag:
    .4byte  sym_0605A00C                     /* input skip flag (nonzero = skip input) */
.L_ptr_display_update:
    .4byte  sym_06026CE0                     /* display_update (tail-call target) */
    .4byte  sym_06059F6F                     /* (shared pool data) */
    .4byte  sym_06085F8A                     /* object compaction needed flag (byte) */
    .4byte  sym_0607EBCC                     /* countdown timer (attract mode) */
    .4byte  sym_06063F5C                     /* car struct array base pointer */
.L_ptr_cmd_slot_write:
    .4byte  sym_0603850C                     /* command_slot_write */
.L_fp_one:
    .4byte  0x00010000                       /* 1.0 (16.16 fixed-point) */
.L_ptr_scene_color_intensity:
    .4byte  scene_color_intensity            /* scene color intensity function */
.L_ptr_cmd_queue_commit:
    .4byte  sym_06038520                     /* command_queue_commit */
