#include "game.h"

/* Per-file car struct access macros */
#define CAR_INT(car, off)    (*(volatile int *)((char *)(car) + (off)))

/*
 * car_position_update.c -- Car-to-object position transfer
 *
 * Hand-translated from binary at 0x060061C8 (53 instructions).
 *
 * Functions:
 *   FUN_060061C8 (0x060061C8) -- Apply car position to display objects
 *
 * Takes the current car's X/Y/Z world position and applies it to 4
 * display object structs. Each struct is a 12-byte position record
 * (X at +0, Y at +4, Z at +8). X and Z are accumulated (+=), Y is
 * replaced directly.
 *
 * Also calls rendering setup functions (position projection, heading
 * rotation) and decrements OBJ_STATE_PRIMARY by 48 (one render slot).
 *
 * Called from per_car_loop.c.
 */

/* External dependencies */
extern void FUN_06026DBC(void);             /* position projection setup */
extern void FUN_06026E0C(void);             /* render state processing */
extern void FUN_06026EDE(int heading);      /* heading rotation setup */
extern void FUN_06026FFC(int table, int output);  /* position table lookup */

/* 4 display object position structs (12 bytes each: X, Y, Z) */
#define OBJ_POS_A  ((volatile int *)0x06063E9C)
#define OBJ_POS_B  ((volatile int *)0x06063EB0)
#define OBJ_POS_C  ((volatile int *)0x06063ED8)
#define OBJ_POS_D  ((volatile int *)0x06063EC4)

/* 4 position lookup tables */
#define TABLE_A    0x0604464C
#define TABLE_B    0x06044640
#define TABLE_C    0x06044658
#define TABLE_D    0x06044664


/* ================================================================
 * FUN_060061C8 -- Car-to-Object Position Transfer (0x060061C8)
 *
 * CONFIDENCE: DEFINITE (binary verified at 0x060061C8-0x06006260)
 * Pool verified:
 *   0x06006264 = 0x0607E940 (CAR_PTR_CURRENT)
 *   0x06006268 = 0x06026DBC (position projection setup)
 *   0x0600626C = 0x06026E0C (render state processing)
 *   0x06006270 = 0x06026EDE (heading rotation)
 *   0x06006274 = 0x06026FFC (position table lookup)
 *   0x06006278 = 0x06063E9C (output A)
 *   0x0600627C = 0x0604464C (table A)
 *   0x06006280 = 0x06063EB0 (output B)
 *   0x06006284 = 0x06044640 (table B)
 *   0x06006288 = 0x06063ED8 (output C)
 *   0x0600628C = 0x06044658 (table C)
 *   0x06006290 = 0x06063EC4 (output D)
 *   0x06006294 = 0x06044664 (table D)
 *   0x06006298 = 0x06089EDC (OBJ_STATE_PRIMARY)
 *
 * Algorithm:
 *   1. Load car X/Y/Z position from current car struct
 *   2. Call position/heading setup functions
 *   3. 4x: call FUN_06026FFC(table, output) for each object
 *   4. 4x: accumulate X/Z, set Y in each output struct
 *   5. Decrement OBJ_STATE_PRIMARY by 48 (release render slot)
 *
 * 53 instructions. Saves r14, r13, r12, r11, PR.
 * ================================================================ */
/* FUN_060061C8 -- original binary (212 bytes) */
__asm__(
    ".section .text.FUN_060061C8, \"ax\"\n"
    ".balign 2\n"
    ".global _FUN_060061C8\n"
    ".global _FUN_060061c8\n"
    ".type _FUN_060061C8, @function\n"
    "_FUN_060061C8:\n"
    "_FUN_060061c8:\n"
    ".byte 0x2F, 0xE6, 0x2F, 0xD6, 0x2F, 0xC6, 0x2F, 0xB6, 0x4F, 0x22, 0xDB, 0x24, 0xD3, 0x24, 0x6B, 0xB2\n"  /* 0x060061C8 */
    ".byte 0x5E, 0xB4, 0x5D, 0xB5, 0x43, 0x0B, 0x5C, 0xB6, 0xD3, 0x22, 0x43, 0x0B, 0x00, 0x09, 0xD3, 0x22\n"  /* 0x060061D8 */
    ".byte 0x43, 0x0B, 0x54, 0xBC, 0xDB, 0x21, 0xD5, 0x22, 0xD4, 0x22, 0x4B, 0x0B, 0x00, 0x09, 0xD5, 0x22\n"  /* 0x060061E8 */
    ".byte 0xD4, 0x22, 0x4B, 0x0B, 0x00, 0x09, 0xD5, 0x22, 0xD4, 0x22, 0x4B, 0x0B, 0x00, 0x09, 0xD5, 0x22\n"  /* 0x060061F8 */
    ".byte 0xD4, 0x22, 0x4B, 0x0B, 0x00, 0x09, 0xD4, 0x1A, 0x62, 0x42, 0x32, 0xEC, 0x24, 0x22, 0x14, 0xD1\n"  /* 0x06006208 */
    ".byte 0x53, 0x42, 0x33, 0xCC, 0x14, 0x32, 0xD4, 0x18, 0x62, 0x42, 0x32, 0xEC, 0x24, 0x22, 0x14, 0xD1\n"  /* 0x06006218 */
    ".byte 0x53, 0x42, 0x33, 0xCC, 0x14, 0x32, 0xD4, 0x16, 0x62, 0x42, 0x32, 0xEC, 0x24, 0x22, 0x14, 0xD1\n"  /* 0x06006228 */
    ".byte 0x53, 0x42, 0x33, 0xCC, 0x14, 0x32, 0xD4, 0x14, 0x62, 0x42, 0x32, 0xEC, 0x24, 0x22, 0x14, 0xD1\n"  /* 0x06006238 */
    ".byte 0x53, 0x42, 0x33, 0xCC, 0x14, 0x32, 0xD4, 0x12, 0x62, 0x42, 0x72, 0xD0, 0x24, 0x22, 0x4F, 0x26\n"  /* 0x06006248 */
    ".byte 0x6B, 0xF6, 0x6C, 0xF6, 0x6D, 0xF6, 0x00, 0x0B, 0x6E, 0xF6, 0xFF, 0xFF, 0x06, 0x07, 0xE9, 0x40\n"  /* 0x06006258 */
    ".byte 0x06, 0x02, 0x6D, 0xBC, 0x06, 0x02, 0x6E, 0x0C, 0x06, 0x02, 0x6E, 0xDE, 0x06, 0x02, 0x6F, 0xFC\n"  /* 0x06006268 */
    ".byte 0x06, 0x06, 0x3E, 0x9C, 0x06, 0x04, 0x46, 0x4C, 0x06, 0x06, 0x3E, 0xB0, 0x06, 0x04, 0x46, 0x40\n"  /* 0x06006278 */
    ".byte 0x06, 0x06, 0x3E, 0xD8, 0x06, 0x04, 0x46, 0x58, 0x06, 0x06, 0x3E, 0xC4, 0x06, 0x04, 0x46, 0x64\n"  /* 0x06006288 */
    ".byte 0x06, 0x08, 0x9E, 0xDC\n"  /* 0x06006298 */
);

