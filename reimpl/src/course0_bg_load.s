/* course0_bg_load -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06018738 - 0x06018834
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Course 0 (Three Seven Speedway) background data loader — copies palette,
 * tile, and map data to Work RAM Low and VDP2 VRAM, then patches offset
 * tables for the rendering pipeline.
 *
 * Data copies (via memcpy_long_idx):
 *   1. Palette data → WRAM Low (0x07DC bytes)
 *   2. Tile set A → WRAM Low + 0x07DC (0x3100 bytes)
 *   3. Base BG data → WRAM Low + 0x38DC (0x4F80 bytes)
 *   4. Map data → 0x240000 (0x18000 bytes = 96KB)
 *   5. Tile set B → 0x240000 + 0xA660 (0x3000 bytes)
 *   6. Tile set C → 0x240000 + 0x6660 (0x4000 bytes)
 *   7. Data block D → 0x240000 + 0xB108 (0x3000 bytes)
 *
 * After copying: patches offset tables (4 entries), calls
 * sound_init_sequence(race_end_state), tail-calls render_batch_proc.
 *
 * Persistent registers:
 *   r9  = WRAM Low base (0x200000) / then VDP VRAM base (0x240000)
 *   r10 = loop limit (8 entries)
 *   r11 = offset table A (sym_0605D1DC)
 *   r12 = offset table B (sym_06085FD0)
 *   r13 = memcpy_long_idx function
 *   r14 = BG data base address (sym_060D6900)
 */

    .section .text.FUN_06018738


    .global course0_bg_load
    .type course0_bg_load, @function
course0_bg_load:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov.l r10, @-r15
    mov #0x8, r10                        /* loop limit = 8 */
    mov.l r9, @-r15
    sts.l pr, @-r15
    mov.l   .L_offset_table_a, r11     /* r11 = offset source table */
    mov.l   .L_offset_table_b, r12     /* r12 = offset dest table */
    mov.l   .L_bg_data_base, r14       /* r14 = BG data base */
    mov.l   .L_fn_memcpy_long, r13     /* r13 = memcpy function */
    mov.w   .L_palette_size, r6         /* 0x07DC = palette size */
    mov.l   .L_wram_low, r9            /* r9 = 0x200000 (WRAM Low) */
    mov.l   .L_palette_src, r4
    jsr @r13                             /* memcpy(palette_src, WRAM_Low, 0x7DC) */
    mov r9, r5
    mov.w   .L_tile_a_size, r6          /* 0x3100 = tile set A size */
    mov.w   .L_palette_size, r5         /* 0x07DC = dest offset */
    mov.l   .L_tile_a_src, r4
    jsr @r13                             /* memcpy(tile_a, WRAM+0x7DC, 0x3100) */
    add r9, r5
    mov.w   .L_bg_base_size, r6         /* 0x4F80 = base BG size */
    mov.w   .L_bg_base_offset, r5       /* 0x38DC = dest offset */
    add r9, r5
    jsr @r13                             /* memcpy(bg_data, WRAM+0x38DC, 0x4F80) */
    mov r14, r4
    mov.l   .L_map_size, r6            /* 0x18000 = map data size */
    mov.l   .L_vram_dest_base, r9      /* r9 = 0x240000 (VRAM dest) */
    mov.l   .L_map_src, r4
    jsr @r13                             /* memcpy(map_src, 0x240000, 0x18000) */
    mov r9, r5
    mov.w   .L_tile_b_size, r6          /* 0x3000 = tile set B size */
    mov.l   .L_tile_b_offset, r5       /* 0xA660 */
    mov.l   .L_tile_b_src, r4
    jsr @r13                             /* memcpy(tile_b, 0x240000+0xA660, 0x3000) */
    add r9, r5
    mov.w   .L_tile_c_size, r6          /* 0x4000 = tile set C size */
    mov.w   .L_tile_c_offset, r5        /* 0x6660 */
    mov.l   .L_tile_c_src, r4
    jsr @r13                             /* memcpy(tile_c, 0x240000+0x6660, 0x4000) */
    add r9, r5
    mov.w   .L_tile_b_size, r6          /* 0x3000 = data D size (same as tile B) */
    mov.l   .L_data_d_offset, r5       /* 0xB108 */
    mov.l   .L_data_d_src, r4
    jsr @r13                             /* memcpy(data_d, 0x240000+0xB108, 0x3000) */
    add r9, r5
    mov #0x0, r6                         /* === Patch offset tables === */
    mov r6, r5                           /* i = 0, pair_idx = 0 */
    mov r6, r4                           /* table_offset = 0 */
.L_0601879C:                              /* --- loop: 4 pairs --- */
    mov r4, r2
    mov r4, r3
    add #0x2, r5                         /* pair_idx += 2 */
    add r11, r2                          /* &offset_table_a[table_offset] */
    add r12, r3                          /* &offset_table_b[table_offset] */
    add #0x4, r4
    mov.l @r2, r1                        /* raw offset from table A */
    mov r4, r6
    add r14, r1                          /* add BG data base */
    mov r4, r2
    mov.l r1, @r3                        /* offset_table_b[i] = base + offset */
    add r11, r2
    mov r4, r3
    mov.l @r2, r1                        /* next raw offset */
    add r12, r3
    add r14, r1
    mov.l r1, @r3                        /* offset_table_b[i+1] = base + offset */
    cmp/ge r10, r5
    bf/s    .L_0601879C
    add #0x4, r4                         /* table_offset += 4 */
    mov.l   .L_race_end_state, r4      /* === Sound + render === */
    mov.l   .L_fn_sound_init, r3
    jsr @r3                              /* sound_init_sequence(race_end_state) */
    mov.l @r4, r4
    lds.l @r15+, pr
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    mov.l   .L_fn_render_batch, r3
    jmp @r3                              /* → render_batch_proc() (tail call) */
    mov.l @r15+, r14
.L_palette_size:
    .2byte  0x07DC                        /* palette data: 2012 bytes */
.L_tile_a_size:
    .2byte  0x3100                        /* tile set A: 12544 bytes */
.L_bg_base_size:
    .2byte  0x4F80                        /* base BG data: 20352 bytes */
.L_bg_base_offset:
    .2byte  0x38DC                        /* WRAM offset for base BG */
.L_tile_b_size:
    .2byte  0x3000                        /* tile set B/D: 12288 bytes */
.L_tile_c_size:
    .2byte  0x4000                        /* tile set C: 16384 bytes */
.L_tile_c_offset:
    .2byte  0x6660                        /* VRAM offset for tile set C */
.L_offset_table_a:
    .4byte  sym_0605D1DC               /* BG offset source table */
.L_offset_table_b:
    .4byte  sym_06085FD0               /* BG offset dest table */
.L_bg_data_base:
    .4byte  sym_060D6900               /* BG data base address (course 0) */
.L_fn_memcpy_long:
    .4byte  memcpy_long_idx            /* long-indexed memory copy */
.L_wram_low:
    .4byte  0x00200000                  /* Work RAM Low base */
.L_palette_src:
    .4byte  sym_060D5840               /* palette source data */
.L_tile_a_src:
    .4byte  sym_060C6000               /* tile set A source */
.L_map_size:
    .4byte  0x00018000                  /* map data: 96KB */
.L_vram_dest_base:
    .4byte  0x00240000                  /* VRAM destination base */
.L_map_src:
    .4byte  sym_060A6000               /* map data source */
.L_tile_b_offset:
    .4byte  0x0000A660                  /* VRAM offset for tile set B */
.L_tile_b_src:
    .4byte  sym_060BF000               /* tile set B source */
.L_tile_c_src:
    .4byte  sym_060C2000               /* tile set C source */
.L_data_d_offset:
    .4byte  0x0000B108                  /* VRAM offset for data block D */
.L_data_d_src:
    .4byte  0x002F8000                  /* data block D source address */
.L_race_end_state:
    .4byte  sym_0607EAD8               /* race end state (0/1/2) */
.L_fn_sound_init:
    .4byte  sound_init_sequence        /* sound initialization for course */
.L_fn_render_batch:
    .4byte  render_batch_proc          /* render batch processing */
