/* disc_sector_read — Attract phase color setup + course state init
 * Translation unit: 0x0601B024 - 0x0601B074
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Called during attract mode phase transitions.  Sets up color transform
 * parameters for the current scene, initializes course rendering state,
 * then advances the attract phase index and resets the phase timer.
 *
 * Entered via fall-through from disc_ready_stub (which saves r14 and
 * sets r7 = 0, the channel_type for scene A).
 *
 * Sequence:
 *   1. Store 0x30 into sym_06086014 (attract color state word)
 *   2. Call color_transform_calc with channel_type from r7, masks 0x30/0x30,
 *      and stack args: mode=0x01, intensity=0x0030, component=0x0160, offset=0x00A7
 *   3. Call course_state_setup to init course rendering tables
 *   4. Reset phase countdown timer (sym_0608600F) to 0x14 (20 frames)
 *   5. Increment current attract phase index (sym_06086011)
 *
 * Args (inherited from disc_ready_stub fall-through or direct call):
 *   r7  = channel_type (0 = scene A, 1 = scene B)
 *   r14 = already saved by disc_ready_stub
 *
 * Returns: void
 */

    .section .text.FUN_0601B024


    .global disc_sector_read
    .type disc_sector_read, @function
disc_sector_read:
    sts.l pr, @-r15                              ! save return address
    mov #0x30, r14                               ! r14 = 0x30 (color intensity / mask value)
    mov.l   .L_attract_color_state, r3           ! r3 = &attract_color_state (sym_06086014)
    mov r14, r6                                  ! r6 = 0x30 (channel_mask_b for color_transform_calc)
    mov r14, r5                                  ! r5 = 0x30 (channel_mask_a for color_transform_calc)
    mov.l r14, @r3                               ! attract_color_state = 0x30
    mov.w   .L_const_color_offset, r2                ! r2 = 0x00A7 (color offset value — stack arg 4)
    mov.l r2, @-r15                              ! push color_offset onto stack
    mov.w   .L_const_color_component, r3                ! r3 = 0x0160 (color component value — stack arg 3)
    extu.w r14, r2                               ! r2 = 0x0030 (intensity, zero-extended — stack arg 2)
    mov.l r3, @-r15                              ! push color_component onto stack
    mov #0x1, r3                                 ! r3 = 1 (mode flag — stack arg 1)
    mov.l r2, @-r15                              ! push intensity onto stack
    mov.l r3, @-r15                              ! push mode flag onto stack
    mov.l   .L_fn_color_transform, r3            ! r3 = &color_transform_calc
    jsr @r3                                      ! call color_transform_calc(channel_type, 0x30, 0x30, r7_orig)
    mov r7, r4                                   ! (delay) r4 = channel_type (from r7)
    .byte   0xB0, 0x47    /* bsr 0x0601B0D8 (external) */  ! call course_state_setup
    add #0x10, r15                               ! (delay) pop 4 stack args (16 bytes)
    mov #0x14, r2                                ! r2 = 0x14 (20 — new phase timer value)
    mov.l   .L_phase_timer, r3                   ! r3 = &phase_countdown_timer (sym_0608600F)
    mov.b r2, @r3                                ! phase_countdown_timer = 20 frames
    mov.l   .L_phase_index, r4                   ! r4 = &phase_index (sym_06086011)
    mov.b @r4, r2                                ! r2 = current phase index
    add #0x1, r2                                 ! r2 = next phase index
    mov.b r2, @r4                                ! advance phase index
    lds.l @r15+, pr                              ! restore return address
    rts                                          ! return to caller
    mov.l @r15+, r14                             ! (delay) restore r14
.L_const_color_offset:
    .2byte  0x00A7                               /* color offset value (167) */
.L_const_color_component:
    .2byte  0x0160                               /* color component value (352) */
    .2byte  0xFFFF                               /* alignment padding */
.L_attract_color_state:
    .4byte  sym_06086014                         /* attract color state word (byte/long) */
.L_fn_color_transform:
    .4byte  color_transform_calc                 /* VDP2 color transform calculator */
.L_phase_index:
    .4byte  sym_06086011                         /* current attract phase index (byte) */
.L_phase_timer:
    .4byte  sym_0608600F                         /* phase countdown timer (byte) */
