/* hud_utility -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601E6A4 - 0x0601E6E0
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Polls a display callback validator (dispatch table slot 2, offset +8)
 * up to 10 times with the given display_id. If the callback returns 0
 * (valid), returns 0 immediately. If all 10 attempts return non-zero,
 * returns the last non-zero result code.
 *
 * Args:
 *   r4 = display_id (passed through to callback each iteration)
 *
 * Returns:
 *   r0 = 0 if callback returned 0 (valid), else last non-zero result
 *
 * Uses:
 *   sym_06000354 = function dispatch table pointer (deref'd to get vtable)
 */

    .section .text.FUN_0601E6A4


    .global hud_utility
    .type hud_utility, @function
hud_utility:
    mov.l r14, @-r15               ! save r14 (loop counter)
    mov.l r13, @-r15               ! save r13 (dispatch table ptr addr)
    mov.l r12, @-r15               ! save r12 (max iterations)
    sts.l pr, @-r15                ! save return address
    add #-0x4, r15                 ! allocate 4 bytes on stack for display_id
    mov #0xA, r12                  ! r12 = 10 (max poll attempts)
    mov.l   .L_pool_dispatch_ptr, r13 ! r13 = &dispatch_table_ptr
    mov.l r4, @r15                 ! store display_id on stack
    mov #0x0, r14                  ! r14 = 0 (loop counter)
.L_poll_loop:
    mov.l @r13, r3                 ! r3 = *dispatch_table_ptr (vtable base)
    mov.l @(8, r3), r2             ! r2 = vtable[2] (callback fn at offset +8)
    jsr @r2                        ! call callback(display_id)
    mov.l @r15, r4                 ! (delay) r4 = display_id from stack
    mov r0, r4                     ! r4 = callback result
    tst r4, r4                     ! test if result == 0
    bf      .L_retry               ! result != 0: try again
    bra     .L_epilogue            ! result == 0: callback valid, exit
    mov #0x0, r0                   ! (delay) r0 = 0 (return success)
.L_retry:
    add #0x1, r14                  ! counter++
    cmp/ge r12, r14                ! counter >= 10?
    bf      .L_poll_loop           ! not yet: poll again
    mov r4, r0                     ! all attempts failed: r0 = last non-zero result
.L_epilogue:
    add #0x4, r15                  ! free stack local
    lds.l @r15+, pr                ! restore return address
    mov.l @r15+, r12               ! restore r12
    mov.l @r15+, r13               ! restore r13
    rts                            ! return to caller
    mov.l @r15+, r14               ! (delay) restore r14
.L_pool_dispatch_ptr:
    .4byte  sym_06000354
