/* track_utility_misc -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060185D8 - 0x06018738
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Track camera/scroll utilities — two functions:
 *
 * track_utility_misc (0x060185D8):
 *   Track-specific camera setup. Only runs when game mode == 3.
 *   1. camera_init() — reset camera state
 *   2. camera_pos(position XYZ from param table)
 *   3. mat_rot_y(0x38E3) — fixed rotation angle
 *   4. vec_copy(src → WRAM Low + 0xBABE0, 0x178 bytes)
 *   5. vec_scale(src + 0xBBD80, scale, 0x145 bytes)
 *   6. Tail-call camera_finalize()
 *
 * sym_06018634 (scroll position reset):
 *   Dispatch on race_end_state (0/1/2):
 *     State 0: Clear 8 scroll position registers + 2 scroll offsets
 *     State 1: Clear 2 scroll position registers + all 8 + 2 offsets
 *     State 2: Clear 2 scroll position + 2 offsets only
 *   Then there are 2 additional small embedded sub-functions that clear
 *   subsets of scroll registers (encoded as raw bytes after the pool).
 */

    .section .text.FUN_060185D8


    .global track_utility_misc
    .type track_utility_misc, @function
track_utility_misc:
    mov.l r14, @-r15
    sts.l pr, @-r15
    add #-0x4, r15
    mov.l   .L_game_mode, r0
    mov.b @r0, r0
    extu.b r0, r0
    cmp/eq #0x3, r0                   /* game mode == 3? */
    bf      .L_0601862C              /* no → exit */
    mov.l   .L_fn_camera_init, r3
    jsr @r3                            /* camera_init() */
    nop
    mov.l   .L_camera_param_table, r14
    mov.l   .L_fn_camera_pos, r3
    mov.l @(8, r14), r6             /* param[+8] = Z */
    mov.l @(4, r14), r5             /* param[+4] = Y */
    jsr @r3                            /* camera_pos(X, Y, Z) */
    mov.l @r14, r4                   /* param[+0] = X */
    mov.w   DAT_06018660, r4        /* 0x38E3 = fixed rotation angle */
    mov.l   .L_fn_rot_y, r3
    jsr @r3                            /* mat_rot_y(0x38E3) */
    nop
    mov.w   .L_vec_copy_size, r5    /* 0x178 = copy size */
    mov.l   .L_wram_low, r2         /* 0x200000 = Work RAM Low base */
    mov.l   .L_wram_offset_a, r3    /* 0xBABE0 */
    mov r2, r4
    add r3, r4                        /* dest = WRAM_Low + 0xBABE0 */
    mov.l   .L_fn_vec_copy, r3
    jsr @r3                            /* vec_copy(src, WRAM+0xBABE0, 0x178) */
    mov.l r2, @r15                   /* save WRAM base on stack */
    mov.w   .L_vec_scale_size, r6   /* 0x145 = scale size */
    mov.l   .L_scale_factor, r5
    mov.l @r15, r4                   /* WRAM base from stack */
    mov.l   .L_wram_offset_b, r2    /* 0xBBD80 */
    mov.l   .L_fn_vec_scale, r3
    mov.w @r5, r5                    /* scale value (16-bit) */
    jsr @r3                            /* vec_scale(src + 0xBBD80, scale, 0x145) */
    add r2, r4                        /* dest = WRAM_Low + 0xBBD80 */
    add #0x4, r15
    lds.l @r15+, pr
    mov.l   .L_fn_camera_finalize, r3
    jmp @r3                            /* → camera_finalize() (tail call) */
    mov.l @r15+, r14
.L_0601862C:
    add #0x4, r15
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global sym_06018634
sym_06018634:                             /* === Scroll position reset === */
    mov.l   .L_scroll_pos_a, r6
    mov.l   .L_scroll_pos_b, r5
    mov #0x0, r4
    mov.l   .L_race_end_state, r0
    bra     .L_060186AC              /* → dispatch on end state */
    mov.l @r0, r0
.L_06018640:                              /* --- state 0: clear all scroll regs --- */
    bra     .L_060186BC
    nop
.L_06018644:                              /* --- state 1: clear offsets + all regs --- */
    extu.w r4, r2
    mov.l   .L_scroll_offset_a, r3
    mov.w r2, @r3                     /* scroll_offset_a = 0 */
    extu.w r4, r1
    mov.l   .L_scroll_offset_b, r3
    mov.w r1, @r3                     /* scroll_offset_b = 0 */
    extu.w r4, r0
    bra     .L_0601865A
    mov.w r0, @r5                     /* scroll_pos_b = 0 */
.L_06018656:                              /* --- state 2: clear pos + offsets only --- */
    extu.w r4, r2
    mov.w r2, @r5                     /* scroll_pos_b = 0 */
.L_0601865A:
    extu.w r4, r4
    bra     .L_060186B8
    mov.w r4, @r6                     /* scroll_pos_a = 0 */

    .global DAT_06018660
DAT_06018660:
    .2byte  0x38E3                        /* fixed rotation angle for track camera */
.L_vec_copy_size:
    .2byte  0x0178                        /* vector copy byte count (376 bytes) */
.L_vec_scale_size:
    .2byte  0x0145                        /* vector scale byte count (325 bytes) */
    .2byte  0xFFFF
.L_game_mode:
    .4byte  sym_06083254               /* game rendering mode (byte) */
.L_fn_camera_init:
    .4byte  sym_06026DBC               /* camera state initialization */
.L_camera_param_table:
    .4byte  sym_06048140               /* camera position parameters (X/Y/Z) */
.L_fn_camera_pos:
    .4byte  sym_06026E2E               /* set camera base position */
.L_fn_rot_y:
    .4byte  mat_rot_y                  /* Y-axis rotation */
.L_wram_low:
    .4byte  0x00200000                  /* Work RAM Low base */
.L_wram_offset_a:
    .4byte  0x000BABE0                  /* WRAM offset A (vec copy dest) */
.L_fn_vec_copy:
    .4byte  sym_06031D8C               /* vector copy function */
.L_scale_factor:
    .4byte  sym_06089E98               /* per-mode scale factor (16-bit) */
.L_wram_offset_b:
    .4byte  0x000BBD80                  /* WRAM offset B (vec scale dest) */
.L_fn_vec_scale:
    .4byte  sym_06031A28               /* scaled vector copy function */
.L_fn_camera_finalize:
    .4byte  sym_06026DF8               /* camera state finalization */
.L_scroll_pos_a:
    .4byte  sym_0605BE38               /* scroll position register A (16-bit) */
.L_scroll_pos_b:
    .4byte  sym_0605BE36               /* scroll position register B (16-bit) */
.L_race_end_state:
    .4byte  sym_0607EAD8               /* race end state (0/1/2 dispatch) */
.L_scroll_offset_a:
    .4byte  sym_0605BE1C               /* scroll offset A (16-bit) */
.L_scroll_offset_b:
    .4byte  sym_0605BE1E               /* scroll offset B (16-bit) */
.L_060186AC:                              /* --- end state dispatch --- */
    cmp/eq #0x0, r0
    bt      .L_06018640              /* state 0 */
    cmp/eq #0x1, r0
    bt      .L_06018644              /* state 1 */
    cmp/eq #0x2, r0
    bt      .L_06018656              /* state 2 */
.L_060186B8:
    rts
    nop
.L_060186BC:                              /* --- state 0: clear all 8+2 scroll regs --- */
    mov #0x0, r4
    mov.l   .L_scroll_reg_0, r2
    exts.w r4, r0
    mov.w r4, @r2                     /* scroll_reg_0 = 0 */
    mov.l   .L_scroll_reg_1, r2
    mov.w r4, @r2                     /* scroll_reg_1 = 0 */
    mov.l   .L_scroll_reg_2, r2
    mov.w r0, @r2                     /* scroll_reg_2 = 0 */
    mov.l   .L_scroll_reg_3, r2
    exts.w r4, r0
    mov.w r4, @r2                     /* scroll_reg_3 = 0 */
    mov.l   .L_scroll_reg_4, r2
    mov.w r4, @r2                     /* scroll_reg_4 = 0 */
    mov.l   .L_scroll_reg_5, r2
    mov.w r0, @r2                     /* scroll_reg_5 = 0 */
    mov.l   .L_scroll_reg_6, r2
    mov.w r4, @r2                     /* scroll_reg_6 = 0 */
    mov.l   .L_scroll_reg_7, r2
    rts
    mov.w r4, @r2                     /* scroll_reg_7 = 0 */
    .4byte  0xE400D20D                  /* (embedded sub-fn: raw bytes) */
    .4byte  0x634D604D                  /* clears 4 scroll regs + offsets */
    .4byte  0x2231D20C
    .4byte  0x2241D208
    .4byte  0x2201D308
    .4byte  0x000B2341
.L_scroll_reg_0:
    .4byte  sym_0605BE24               /* scroll register 0 (16-bit) */
.L_scroll_reg_1:
    .4byte  sym_0605BE22               /* scroll register 1 (16-bit) */
.L_scroll_reg_2:
    .4byte  sym_0605BE20               /* scroll register 2 (16-bit) */
.L_scroll_reg_3:
    .4byte  sym_0605BE2A               /* scroll register 3 (16-bit) */
.L_scroll_reg_4:
    .4byte  sym_0605BE26               /* scroll register 4 (16-bit) */
.L_scroll_reg_5:
    .4byte  sym_0605BE28               /* scroll register 5 (16-bit) */
.L_scroll_reg_6:
    .4byte  sym_0605BE36               /* scroll register 6 (16-bit) */
.L_scroll_reg_7:
    .4byte  sym_0605BE38               /* scroll register 7 (16-bit) */
    .4byte  sym_0605BE1C               /* (embedded pool: scroll offset A) */
    .4byte  sym_0605BE1E               /* (embedded pool: scroll offset B) */
    .4byte  0xE400D202                  /* (embedded sub-fn: raw bytes) */
    .4byte  0x2241D202                  /* clears 2 regs + offsets */
    .4byte  0x000B2241
    .4byte  sym_0605BE36               /* (embedded pool: scroll pos B) */
    .4byte  sym_0605BE38               /* (embedded pool: scroll pos A) */
