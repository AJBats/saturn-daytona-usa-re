/* state_pre_race -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008E48 - 0x06008EBC
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Pre-race state handler — manages the transition from mode select into
 * active race setup.
 *
 * On first entry (countdown timer < 0):
 *   1. Sets game_state = 0xE (pre-race initialization phase)
 *   2. Calls init_finalize() to complete scene/resource initialization
 *   3. Clears camera_follow_flag (camera free for cutscene positioning)
 *
 * On subsequent frames (countdown timer >= 0):
 *   Delegates to game_state_dispatch() for per-frame state machine updates
 *
 * After both paths: checks game_state. If state == 0xD (pre-race complete),
 * returns to caller. Otherwise, tail-calls handler_init_reset to continue
 * initialization pipeline.
 */

    .section .text.FUN_06008E48


    .global state_pre_race
    .type state_pre_race, @function
state_pre_race:
    sts.l pr, @-r15                     ! save return address
    mov.l   .L_countdown_timer, r3      ! r3 = &countdown_timer
    mov.l @r3, r3                       ! r3 = countdown_timer value
    cmp/pz r3                           ! T = (countdown >= 0)?
    bt      .L_dispatch_state           ! countdown >= 0 → already initialized, dispatch
    mov #0xE, r3                        ! r3 = 0xE (pre-race init state)
    mov.l   .L_game_state, r2           ! r2 = &game_state
    mov.l r3, @r2                       ! game_state = 0xE
    mov.l   .L_fn_init_finalize, r3     ! r3 = &init_finalize
    jsr @r3                             ! init_finalize() — complete scene setup
    nop                                 ! delay slot
    mov #0x0, r2                        ! r2 = 0 (clear value)
    mov.l   .L_camera_follow_flag, r3   ! r3 = &camera_follow_flag
    mov.l r2, @r3                       ! camera_follow_flag = 0 (free camera)
    bra     .L_check_state_done         ! skip dispatch, go check completion
    nop                                 ! delay slot
.L_dispatch_state:
    mov.l   .L_fn_game_state_dispatch, r3 ! r3 = &game_state_dispatch
    jsr @r3                             ! game_state_dispatch() — run state machine
    nop                                 ! delay slot
.L_check_state_done:
    mov.l   .L_game_state, r0           ! r0 = &game_state
    mov.l @r0, r0                       ! r0 = current game_state value
    cmp/eq #0xD, r0                     ! game_state == 0xD (pre-race complete)?
    bt      .L_return                   ! yes → pre-race finished, return normally
    mov.l   .L_fn_handler_init_reset, r3 ! r3 = &handler_init_reset
    jmp @r3                             ! tail-call handler_init_reset (continue init)
    lds.l @r15+, pr                     ! restore PR in delay slot
.L_return:
    lds.l @r15+, pr                     ! restore return address
    rts                                 ! return to caller
    nop                                 ! delay slot
    .2byte  0xFFFF                      ! alignment padding
    .4byte  race_resource_init          ! (unreferenced pool entry)
    .4byte  race_prep_init              ! (unreferenced pool entry)
.L_game_state:
    .4byte  g_game_state               /* game phase state */
    .4byte  car_physics_init           /* (unreferenced pool entry) */
    .4byte  obj_render_update          /* (unreferenced pool entry) */
    .4byte  sym_0605B6D8               /* (unreferenced — render flags) */
    .4byte  0x40000000                 /* (unreferenced — render flag bit 30) */
.L_fn_init_finalize:
    .4byte  sym_06026CE0               /* initialization finalization function */
.L_camera_follow_flag:
    .4byte  sym_06059F44               /* camera follow mode flag */
    .4byte  sym_0605A016               /* (unreferenced — game state word) */
    .4byte  handler_dispatch           /* (unreferenced pool entry) */
.L_countdown_timer:
    .4byte  sym_0607EBCC               /* race countdown timer */
.L_fn_game_state_dispatch:
    .4byte  game_state_dispatch        /* main game state machine dispatcher */
.L_fn_handler_init_reset:
    .4byte  handler_init_reset         /* initialization pipeline continuation */
