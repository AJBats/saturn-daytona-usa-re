/* state_time_extend_active -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06009788 - 0x06009A60
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Time extend state handler — runs each frame during the "time extend"
 * bonus period after completing a checkpoint. Manages the countdown
 * timer display, accepts input to adjust the time value, plays the
 * extend sound, and handles state transitions.
 *
 * Input handling:
 *   - Button 0x8000 (Up): increment time_value (capped at 99)
 *   - Button 0x4000 (Down): decrement time_value (min 1)
 *   - Button 0x0800 (Start): trigger transition → sound + state change
 *   - Buttons 0x0070 (all 3 set): end extend mode
 *
 * Per-frame render pipeline:
 *   1. Optional menu_overlay_render
 *   2. Display time value + extend graphics
 *   3. Update extend_timer (flash counter, bit 4 toggle)
 *   4. Optional special render + geometry dispatch
 *   5. camera_finalize + clear anim_state
 *
 * State transitions:
 *   Start pressed → game_state = countdown_timer value, camera_finalize
 *   Buttons 0x0070 all set + special_render active:
 *     → race_event_flags = 1, game_state = 0x18, camera_finalize
 *   Buttons 0x0070 all set + no special_render:
 *     → game_sub_state = 1, game_state = 0x0E
 *
 * Persistent registers:
 *   r8  = 0xF000 mask
 *   r9  = sprite coord A (0x0694)
 *   r10 = render_flags pointer
 *   r11 = special_render_flag pointer
 *   r12 = time_value byte pointer
 *   r13 = sprite coord B (0x0090)
 *   r14 = geom_render function
 */

    .section .text.FUN_06009788


    .global state_time_extend_active
    .type state_time_extend_active, @function
state_time_extend_active:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov.l r10, @-r15
    mov.l r9, @-r15
    mov.l r8, @-r15
    sts.l pr, @-r15
    add #-0x8, r15
    mov.l   .L_mask_nibble3, r8          /* 0xF000 mask for geom dispatch */
    mov.l   .L_render_flags, r10
    mov.l   .L_special_render_flag, r11
    mov.l   .L_time_value_byte, r12
    mov.l   .L_input_data, r4           /* --- Read input buttons --- */
    mov.w @(2, r4), r0                  /* buttons_held (16-bit) */
    mov r0, r3
    mov.w r3, @r15                       /* [sp+0] = buttons_held */
    mov.w @r4, r3                        /* buttons_pressed (16-bit) */
    mov r3, r0
    mov.w r0, @(4, r15)                 /* [sp+4] = buttons_pressed */
    mov.l   .L_overlay_active, r0       /* --- Optional overlay --- */
    mov.b @r0, r0
    tst r0, r0
    bt      .L_060097BE
    mov.l   .L_fn_menu_overlay, r3
    jsr @r3                              /* menu_overlay_render(0) */
    mov #0x0, r4
.L_060097BE:                              /* === Extend mode input === */
    mov.l   .L_extend_mode_flag, r0
    mov.b @r0, r0
    tst r0, r0
    bt      .L_0600983E                  /* not in extend mode → skip input */
    mov.w @r15, r3                       /* buttons_held */
    mov.l   .L_btn_up_mask, r2          /* 0x8000 = Up button */
    extu.w r3, r3
    and r2, r3
    tst r3, r3
    bt      .L_06009808                  /* Up not held → check Down */
    mov #0x63, r2                        /* --- Up pressed: increment --- */
    mov.b @r12, r3                       /* time_value */
    extu.b r3, r3
    cmp/ge r2, r3                        /* >= 99? */
    bt      .L_06009824                  /* at max → skip */
    mov.b @r12, r2
    add #0x1, r2                         /* time_value++ */
    bra     .L_06009824
    mov.b r2, @r12
.L_mask_nibble3:
    .4byte  0x0000F000                  /* nibble 3 mask */
.L_render_flags:
    .4byte  sym_0605B6D8               /* render mode flags (32-bit) */
.L_special_render_flag:
    .4byte  sym_0607ED8C               /* special render enable (16-bit) */
.L_time_value_byte:
    .4byte  sym_06078649               /* time extend value (byte, 0-99) */
.L_input_data:
    .4byte  sym_06063D98               /* input data (pressed + held) */
.L_overlay_active:
    .4byte  sym_0605AB18               /* overlay active flag (byte) */
.L_fn_menu_overlay:
    .4byte  menu_overlay_render        /* menu overlay render function */
.L_extend_mode_flag:
    .4byte  sym_0607864A               /* time extend mode flag (byte) */
.L_btn_up_mask:
    .4byte  0x00008000                  /* Up button mask */
.L_06009808:                              /* --- Check Down button --- */
    mov.w @r15, r2
    mov.w   .L_btn_down_mask, r3        /* 0x4000 = Down button */
    extu.w r2, r2
    and r3, r2
    tst r2, r2
    bt      .L_06009824                  /* Down not held → skip */
    mov #0x1, r2                         /* --- Down pressed: decrement --- */
    mov.b @r12, r3                       /* time_value */
    extu.b r3, r3
    cmp/gt r2, r3                        /* > 1? */
    bf      .L_06009824                  /* at min → skip */
    mov.b @r12, r2
    add #-0x1, r2                        /* time_value-- */
    mov.b r2, @r12
.L_06009824:                              /* === Display time value === */
    mov.b @r12, r7
    mov r8, r6                           /* 0xF000 mask */
    mov.w   .L_hud_sprite_a, r5         /* 0x0CCC = sprite params */
    mov.l   .L_fn_hud_number, r3
    extu.b r7, r7
    jsr @r3                              /* hud_number_display(8, 0x0CCC, 0xF000, value) */
    mov #0x8, r4
    mov r8, r6                           /* --- Extend graphics --- */
    mov.w   .L_hud_sprite_b, r5         /* 0x0CB8 */
    mov.l   .L_extend_gfx_data_a, r7
    mov.l   .L_fn_geom_dispatch, r3
    jsr @r3                              /* geom_dispatch(8, 0x0CB8, 0xF000, gfx_data_a) */
    mov #0x8, r4
.L_0600983E:                              /* === Start button check === */
    mov.w   .L_hud_coord_a, r9          /* 0x0694 persistent */
    mov.w   .L_hud_coord_b, r13         /* 0x0090 persistent */
    mov.l   .L_fn_geom_render, r14      /* persistent render fn */
    mov.w @r15, r2                       /* buttons_held */
    mov.w   .L_btn_start_mask, r3       /* 0x0800 = Start button */
    extu.w r2, r2
    and r3, r2
    tst r2, r2
    bt      .L_06009920                  /* Start not pressed → skip */
    mov #0x14, r2                        /* --- Start pressed --- */
    mov.l   .L_extend_timer, r3
    mov.w @r3, r3                        /* extend_timer */
    extu.w r3, r3
    cmp/ge r2, r3                        /* timer >= 20? */
    bf      .L_06009920                  /* too early → ignore */
    mov.l   .L_extend_trigger, r0
    mov.b @r0, r0
    cmp/eq #0x1, r0                      /* already triggered? */
    bt      .L_06009920
    mov.l   .L_snd_cmd_extend, r5       /* --- Play extend sound --- */
    mov.l   .L_fn_sound_dispatch, r3
    jsr @r3                              /* sound_cmd_dispatch(0, 0xAE0004FF) */
    mov #0x0, r4
    mov r13, r6                          /* --- Render extend text --- */
    mov.l   .L_extend_text_data, r2
    mov.l r2, @r15
    mov r2, r7
    mov.w   .L_text_sprite_a, r5        /* 0x0526 */
    add #0x3B, r7                        /* text_data + 0x3B */
    jsr @r14                             /* geom_render(8, 0x0526, 0x0090, text+0x3B) */
    mov #0x8, r4
    mov r13, r6
    mov r9, r5                           /* 0x0694 */
    mov.l @r15, r7
    add #0x28, r7                        /* text_data + 0x28 */
    jsr @r14                             /* geom_render(8, 0x0694, 0x0090, text+0x28) */
    mov #0x8, r4
    mov r13, r6
    mov.w   .L_text_sprite_b, r5        /* 0x079C */
    mov.l @r15, r7
    add #0x2E, r7                        /* text_data + 0x2E */
    jsr @r14                             /* geom_render(8, 0x079C, 0x0090, text+0x2E) */
    mov #0x8, r4
    mov.l   .L_countdown_timer, r3      /* --- State transition --- */
    mov.l   .L_game_state, r2
    mov.l @r3, r3
    mov.l r3, @r2                        /* game_state = countdown_timer value */
    mov.l   .L_extend_lap_byte, r3
    mov.l   .L_lap_count, r2
    mov.b @r3, r3
    mov.b r3, @r2                        /* lap_count = extend_lap_byte */
    mov.l   .L_extend_trigger, r0
    mov.b @r0, r0
    tst r0, r0
    bf      .L_060098B0                  /* triggered → clear and finalize */
    bra     .L_060099F4                  /* → end frame */
    nop
.L_060098B0:                              /* --- Clear trigger + re-display --- */
    mov #0x0, r3
    mov #0xF, r6
    mov.l   .L_extend_trigger, r2
    mov.b r3, @r2                        /* extend_trigger = 0 */
    mov.b @r12, r5                       /* time_value */
    extu.b r5, r5
    mov.l r5, @r15                       /* save to stack */
    mov.l   .L_fn_handler_dispatch, r3
    jsr @r3                              /* handler_dispatch(value, 0xF) */
    mov r5, r4
    mov.l   .L_extend_gfx_data_b, r7    /* --- Update gfx display --- */
    mov r8, r6
    mov.w   .L_hud_sprite_b, r5         /* 0x0CB8 */
    mov.l   .L_fn_geom_dispatch, r3
    jsr @r3                              /* geom_dispatch(8, 0x0CB8, 0xF000, gfx_data_b) */
    mov #0x8, r4
    bra     .L_060099F4
    nop
.L_btn_down_mask:
    .2byte  0x4000                        /* Down button mask */
.L_hud_sprite_a:
    .2byte  0x0CCC                        /* HUD sprite parameter A */
.L_hud_sprite_b:
    .2byte  0x0CB8                        /* HUD sprite parameter B */
.L_hud_coord_a:
    .2byte  0x0694                        /* HUD coordinate A */
.L_hud_coord_b:
    .2byte  0x0090                        /* HUD coordinate B */
.L_btn_start_mask:
    .2byte  0x0800                        /* Start button mask */
.L_text_sprite_a:
    .2byte  0x0526                        /* text sprite parameter A */
.L_text_sprite_b:
    .2byte  0x079C                        /* text sprite parameter B */
.L_fn_hud_number:
    .4byte  hud_number_display         /* HUD number display function */
.L_extend_gfx_data_a:
    .4byte  sym_060446E0               /* time extend graphics data A */
.L_fn_geom_dispatch:
    .4byte  sym_060283E0               /* geometry render dispatch */
.L_fn_geom_render:
    .4byte  sym_060284AE               /* geometry element render */
.L_extend_timer:
    .4byte  sym_06078650               /* time extend timer (16-bit) */
.L_extend_trigger:
    .4byte  sym_0607864A               /* time extend trigger flag (byte) */
.L_snd_cmd_extend:
    .4byte  0xAE0004FF                  /* sound command: time extend */
.L_fn_sound_dispatch:
    .4byte  sound_cmd_dispatch         /* sound command dispatcher */
.L_extend_text_data:
    .4byte  sym_0605AC9C               /* time extend text/sprite data */
.L_countdown_timer:
    .4byte  sym_0607EACC               /* countdown timer (32-bit) */
.L_game_state:
    .4byte  sym_0605AD10               /* game state dispatch value */
.L_extend_lap_byte:
    .4byte  sym_06078652               /* extend mode lap byte */
.L_lap_count:
    .4byte  sym_06078654               /* current lap count */
.L_fn_handler_dispatch:
    .4byte  handler_dispatch           /* handler dispatch function */
.L_extend_gfx_data_b:
    .4byte  sym_060446EC               /* time extend graphics data B */
.L_06009920:                              /* === Check end-extend buttons === */
    mov #0x70, r4                        /* buttons 0x0070 mask */
    mov.w @(4, r15), r0                 /* buttons_pressed */
    mov r0, r2
    extu.w r2, r2
    and r4, r2
    cmp/eq r4, r2                        /* all 3 bits set? */
    bf      .L_06009972                  /* no → normal frame render */
    .byte   0xB4, 0x43    /* bsr 0x0600A1B8 (external helper) */
    nop
    mov.l   .L_fp_min, r2               /* --- End extend: state transition --- */
    mov.l @r10, r3                       /* render_flags */
    or r2, r3
    mov.l r3, @r10                       /* render_flags |= 0x80000000 */
    mov.w @r11, r0                       /* special_render_flag */
    extu.w r0, r0
    tst r0, r0
    bt      .L_06009962                  /* no special render → simple exit */
    mov #0x1, r3                         /* --- With special render --- */
    mov.l   .L_race_event_flags, r2
    mov.l r3, @r2                        /* race_event_flags = 1 */
    mov #0x2, r3
    mov #0x18, r2
    mov.w r3, @r11                       /* special_render = 2 */
    mov.l   .L_game_state_b, r3
    mov.l r2, @r3                        /* game_state = 0x18 */
    mov.l   .L_fn_camera_finalize, r3
    jsr @r3                              /* camera_finalize() */
    nop
    mov #0x0, r2
    mov.l   .L_anim_state, r3
    mov.l r2, @r3                        /* anim_state = 0 */
    bra     .L_060099F4
    nop
.L_06009962:                              /* --- Without special render --- */
    mov #0x1, r2
    mov.l   .L_game_sub_state, r3
    mov.l r2, @r3                        /* game_sub_state = 1 */
    mov #0xE, r2
    mov.l   .L_game_state_b, r3
    mov.l r2, @r3                        /* game_state = 0x0E */
    bra     .L_060099F4
    nop
.L_06009972:                              /* === Normal frame render === */
    mov.l   .L_extend_timer_b, r4
    mov.w @r4, r0
    add #0x1, r0
    mov.w r0, @r4                        /* extend_timer++ */
    extu.w r0, r0
    tst #0x10, r0                        /* bit 4 toggle (flash every 16 frames) */
    bt      .L_0600999C                  /* off-phase → skip text render */
    mov r13, r6                          /* --- Flash on: render text --- */
    mov r9, r5
    mov.l   .L_extend_text_data_b, r3
    mov.l r3, @r15
    mov r3, r7
    jsr @r14                             /* geom_render(8, coord_a, coord_b, text_data) */
    mov #0x8, r4
    mov.l @r15, r7                       /* --- Render second text line --- */
    mov r13, r6
    mov.w   .L_text_sprite_c, r5        /* 0x0794 */
    jsr @r14                             /* geom_render(8, 0x0794, 0x0090, text_data) */
    mov #0x8, r4
    bra     .L_060099F4
    nop
.L_0600999C:                              /* --- Check special render for alt gfx --- */
    mov.w @r11, r0                       /* special_render_flag */
    extu.w r0, r0
    tst r0, r0
    bt      .L_060099E0                  /* no special → simple gfx */
    mov r13, r6                          /* --- Special render path --- */
    mov r9, r5
    mov.l   .L_extend_gfx_special, r7
    jsr @r14                             /* geom_render with special gfx */
    mov #0x8, r4
    mov.l   .L_extend_gfx_alt_a, r7
    bra     .L_060099EC
    nop
.L_text_sprite_c:
    .2byte  0x0794                        /* text sprite parameter C */
    .2byte  0xFFFF
.L_fp_min:
    .4byte  0x80000000                  /* min negative / sign bit */
.L_race_event_flags:
    .4byte  sym_0607EBF4               /* race event bitfield (32-bit) */
.L_game_state_b:
    .4byte  sym_0605AD10               /* game state dispatch value */
.L_fn_camera_finalize:
    .4byte  sym_06026CE0               /* camera state finalization */
.L_anim_state:
    .4byte  sym_06059F44               /* animation state (32-bit) */
.L_game_sub_state:
    .4byte  sym_0605AD08               /* game sub-state (32-bit) */
.L_extend_timer_b:
    .4byte  sym_06078650               /* time extend timer (16-bit) */
.L_extend_text_data_b:
    .4byte  sym_0605ACC4               /* extend text/sprite data */
.L_extend_gfx_special:
    .4byte  sym_060446FC               /* extend special graphics */
.L_extend_gfx_alt_a:
    .4byte  sym_06044718               /* extend alt graphics A */
.L_060099E0:                              /* --- No special render path --- */
    mov.l   .L_extend_gfx_normal, r7
    mov r13, r6
    mov r9, r5
    jsr @r14                             /* geom_render with normal gfx */
    mov #0x8, r4
    mov.l   .L_extend_gfx_alt_b, r7
.L_060099EC:                              /* --- Common: render second gfx --- */
    mov r13, r6
    mov.w   .L_sprite_param_d, r5       /* 0x079C */
    jsr @r14                             /* geom_render */
    mov #0x8, r4
.L_060099F4:                              /* === End-of-frame === */
    mov.w @r11, r0                       /* special_render_flag */
    extu.w r0, r0
    tst r0, r0
    bt      .L_06009A02
    mov.l   .L_fn_special_render, r3
    jsr @r3                              /* special_render() */
    nop
.L_06009A02:                              /* --- Geometry dispatch --- */
    mov.l   .L_geom_render_flag, r0
    mov.b @r0, r0
    extu.b r0, r0
    tst r0, r0
    bt      .L_06009A18                  /* no geometry → skip */
    mov r8, r6                           /* 0xF000 */
    mov.w   .L_geom_tile_size, r5       /* 0x0082 */
    mov.l   .L_geom_data_ptr, r7
    mov.l   .L_fn_geom_dispatch_b, r3
    jsr @r3                              /* geom_dispatch(8, 0x82, 0xF000, geom_data) */
    mov #0x8, r4
.L_06009A18:                              /* --- Camera finalize + cleanup --- */
    mov.l @r10, r0                       /* render_flags */
    mov.l   .L_fn_camera_finalize_b, r3
    or #0x4, r0                          /* set bit 2 */
    jsr @r3                              /* camera_finalize() */
    mov.l r0, @r10                       /* render_flags |= 4 */
    mov #0x0, r2
    mov.l   .L_anim_state_b, r3
    mov.l r2, @r3                        /* anim_state = 0 */
    add #0x8, r15
    lds.l @r15+, pr
    mov.l @r15+, r8
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14
.L_sprite_param_d:
    .2byte  0x079C                        /* sprite parameter D */
.L_geom_tile_size:
    .2byte  0x0082                        /* geometry tile size parameter */
.L_extend_gfx_normal:
    .4byte  sym_060446FC               /* extend normal graphics */
.L_extend_gfx_alt_b:
    .4byte  sym_0604472C               /* extend alt graphics B */
.L_fn_special_render:
    .4byte  sym_060033E6               /* special render function */
.L_geom_render_flag:
    .4byte  sym_06086030               /* geometry render enable (byte) */
.L_geom_data_ptr:
    .4byte  sym_0605A1C8               /* geometry data pointer */
.L_fn_geom_dispatch_b:
    .4byte  sym_060283E0               /* geometry render dispatch */
.L_fn_camera_finalize_b:
    .4byte  sym_06026CE0               /* camera state finalization */
.L_anim_state_b:
    .4byte  sym_06059F44               /* animation state (32-bit) */
