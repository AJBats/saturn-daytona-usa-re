/* state_demo_setup -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06009F10 - 0x06009FFC
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Demo mode state handler — runs each frame during the attract demo race.
 * Manages the countdown timer and dispatches either the full render pipeline
 * or a simplified exit path when the demo ends.
 *
 * Per-frame logic:
 *   1. BSR to external update sub (0x0600A294)
 *   2. Decrement attract countdown
 *   3. If countdown < 0 (demo expired):
 *      - Write demo car parameters to car state struct (+0x224, +0x240)
 *      - Copy course selection to replay state
 *      - Set game_state = 0x18 (demo exit)
 *      - Set display_timer = 3
 *      - Return
 *   4. If countdown >= 0 (demo running):
 *      - If race_end_state == 2: disp_score_renderer()
 *      - geom_display_ctrl_b()
 *      - If display_timer != 3: run full render pipeline
 *        (set car visibility bit 7, countdown_update, proximity_check,
 *         perspective_project, scene_master, frame_end_commit)
 *      - If display_timer == 3: clear anim state, camera_finalize
 *
 * Car state struct offsets used:
 *   +0x0224 = demo parameter A (from sym_06078637)
 *   +0x0240 = demo parameter B (from sym_06078638)
 */

    .section .text.FUN_06009F10


    .global state_demo_setup
    .type state_demo_setup, @function
state_demo_setup:
    sts.l pr, @-r15
    .byte   0xB1, 0xBF    /* bsr 0x0600A294 (external update sub) */
    nop
    mov.l   .L_attract_countdown, r4   /* --- decrement countdown --- */
    mov.l @r4, r2
    add #-0x1, r2
    mov.l r2, @r4                        /* countdown-- */
    mov r2, r3
    cmp/pz r3
    bt      .L_06009F52                  /* countdown >= 0 → still running */
    mov.l   .L_car_state_ptr, r4       /* === Demo expired: setup exit === */
    mov.l   .L_demo_param_a, r2
    mov.w   .L_off_demo_param_a, r0     /* 0x0224 */
    mov.l @r4, r3
    mov.b @r2, r2                        /* read demo param A */
    mov.l r2, @(r0, r3)                 /* car[+0x224] = demo_param_a */
    add #0x1C, r0                        /* 0x0240 */
    mov.l @r4, r3
    mov.l   .L_demo_param_b, r2
    mov.l @r2, r2                        /* read demo param B */
    mov.l r2, @(r0, r3)                 /* car[+0x240] = demo_param_b */
    mov.l   .L_course_select_src, r3   /* --- copy course → replay --- */
    mov.l   .L_replay_course, r2
    mov.l @r3, r3
    mov.l r3, @r2                        /* replay_course = course_select */
    mov #0x18, r3
    mov.l   .L_game_state, r2
    mov.l r3, @r2                        /* game_state = 0x18 (demo exit) */
    mov #0x3, r3
    mov.l   .L_display_timer, r2
    lds.l @r15+, pr
    rts
    mov.w r3, @r2                        /* display_timer = 3 */
.L_06009F52:                              /* === Demo running === */
    mov.l   .L_race_end_state, r0
    mov.l @r0, r0
    cmp/eq #0x2, r0
    bf      .L_06009F60
    mov.l   .L_fn_score_render, r3
    jsr @r3                              /* disp_score_renderer() */
    nop
.L_06009F60:
    mov.l   .L_fn_geom_ctrl, r3
    jsr @r3                              /* geom_display_ctrl_b() */
    nop
    mov.l   .L_display_timer, r0
    mov.w @r0, r0
    extu.w r0, r0
    cmp/eq #0x3, r0
    bt      .L_06009F9A                  /* timer == 3 → simplified exit */
    mov.l   .L_car_array_base, r3      /* --- full render pipeline --- */
    add #0x1, r3
    mov.b @r3, r0                        /* car[+1] = visibility flags */
    and #0x7F, r0
    or #0x80, r0                         /* set bit 7 (visible in demo) */
    mov.b r0, @r3
    mov.l   .L_fn_countdown, r3
    jsr @r3                              /* race_countdown_update() */
    nop
    mov.l   .L_fn_proximity, r3
    jsr @r3                              /* car_proximity_check() */
    nop
    mov.l   .L_fn_perspective, r3
    jsr @r3                              /* perspective_project() */
    nop
    mov.l   .L_fn_scene_master, r3
    jsr @r3                              /* scene_master() */
    nop
    mov.l   .L_fn_frame_commit, r3
    jmp @r3                              /* → frame_end_commit() (tail call) */
    lds.l @r15+, pr
.L_06009F9A:                              /* --- simplified exit path --- */
    mov #0x0, r2
    mov.l   .L_anim_state, r3
    mov.l r2, @r3                        /* anim_state = 0 */
    mov.l   .L_fn_camera_finalize, r3
    jmp @r3                              /* → camera_finalize() (tail call) */
    lds.l @r15+, pr
    .2byte  0x4F26                        /* (dead code / alignment) */
    .4byte  0x000B0009
.L_off_demo_param_a:
    .2byte  0x0224                        /* car struct offset: demo param A */
    .2byte  0xFFFF
.L_attract_countdown:
    .4byte  sym_0607EBCC               /* attract mode countdown (32-bit) */
.L_car_state_ptr:
    .4byte  sym_0607E944               /* car state base pointer */
.L_demo_param_a:
    .4byte  sym_06078637               /* demo parameter A (byte) */
.L_demo_param_b:
    .4byte  sym_06078638               /* demo parameter B (32-bit ptr) */
.L_course_select_src:
    .4byte  sym_0607863C               /* course selection source */
.L_replay_course:
    .4byte  sym_060786A4               /* replay course store */
.L_game_state:
    .4byte  sym_0605AD10               /* game state dispatch value */
.L_display_timer:
    .4byte  sym_06087804               /* display timer (16-bit) */
.L_race_end_state:
    .4byte  sym_0607EAD8               /* race end state (0/1/2) */
.L_fn_score_render:
    .4byte  disp_score_renderer        /* score display renderer */
.L_fn_geom_ctrl:
    .4byte  geom_display_ctrl_b        /* geometry display control */
.L_car_array_base:
    .4byte  sym_06078900               /* car data array base */
.L_fn_countdown:
    .4byte  race_countdown_update      /* race countdown timer update */
.L_fn_proximity:
    .4byte  car_proximity_check        /* car proximity/collision check */
.L_fn_perspective:
    .4byte  perspective_project        /* 3D perspective projection */
.L_fn_scene_master:
    .4byte  scene_master               /* scene rendering master */
.L_fn_frame_commit:
    .4byte  frame_end_commit           /* frame end commit */
.L_anim_state:
    .4byte  sym_0605A00C               /* animation state (32-bit) */
.L_fn_camera_finalize:
    .4byte  sym_06026CE0               /* camera state finalization */
