/* lap_progress_indicator -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060111E2 - 0x06011310
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Lap progress HUD indicator — renders 3 VDP1 display elements showing
 * the current lap number/position on the racing HUD.
 *
 * Mode selection:
 *   - If game_mode == 0xB AND mode_flags bit 0 is set → r13 = 3
 *   - If game_mode == 0xB AND mode_flags bit 0 is clear → r13 = 4
 *   - Otherwise → r13 = 3 (default)
 *   This selects between 3-lap and 4-lap display layouts.
 *
 * Two rendering paths based on race_active_flag:
 *   Path A (race active, flag != 0):
 *     - Element 1: VDP1 offset 0x02A0, position sprite, computed from
 *       display table + (r13+2)*0x400 (selects lap-specific tile row)
 *     - Element 2: VDP1 offset 0x0530, selects sprite based on lap_state:
 *       active sprite if state != 0, inactive sprite if state == 0
 *     - Element 3: VDP1 offset 0x0534, same active/inactive selection
 *
 *   Path B (race inactive, flag == 0):
 *     - Same 3 elements with alternate position sprite
 *     - No (r13+2)*0x400 offset on position element
 *
 * The r14 register is reused as the draw function pointer throughout.
 */

    .section .text.FUN_060111E2


    .global lap_progress_indicator
    .type lap_progress_indicator, @function
lap_progress_indicator:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov.l r10, @-r15
    sts.l pr, @-r15
    .byte   0xD0, 0x09    /* mov.l .L_game_mode, r0 */
    mov.b @r0, r0                     /* read game mode byte */
    extu.b r0, r0
    cmp/eq #0xB, r0                   /* mode 0xB = specific race variant */
    bf/s    .L_0601121E               /* not mode 0xB → default r13 = 3 */
    mov #0x3, r13                      /* r13 = 3 (default lap count) */
    .byte   0xD0, 0x07    /* mov.l .L_mode_flags, r0 */
    mov.l @r0, r0                     /* check mode flag bit 0 */
    tst #0x1, r0
    bt      .L_0601121C              /* bit 0 clear → r13 = 4 */
    bra     .L_0601121E              /* bit 0 set → keep r13 = 3 */
    nop

    .global DAT_06011206
DAT_06011206:
    mov.l @(r0, r9), r2
    .word 0x04A8 /* UNKNOWN */
    .word 0x02BA /* UNKNOWN */
    mov.b r12, @(r0, r4)
    .word 0xFFFF /* UNKNOWN */
    .4byte  sym_06078644               /* (adjacent data) */
.L_game_mode:
    .4byte  sym_0607887F               /* game mode byte (0xB = variant) */
.L_mode_flags:
    .4byte  sym_0607EBC8               /* mode configuration flags (bit 0 = lap count) */
.L_0601121C:
    mov #0x4, r13                      /* r13 = 4 (alternate lap count) */
.L_0601121E:
    .byte   0xDC, 0x32    /* mov.l .L_lap_state, r12 */
    .byte   0xDE, 0x32    /* mov.l .L_fn_draw_elem, r14 */
    .byte   0xD0, 0x33    /* mov.l .L_race_active_flag, r0 */
    mov.l @r0, r0                     /* check if race is active */
    tst r0, r0
    bt      .L_06011280              /* race not active → path B */
    .byte   0xDA, 0x32    /* mov.l .L_disp_struct, r10 */
    mov r13, r11                       /* --- PATH A: race active --- */
    mov.w   .L_vdp1_off_position, r6  /* element 1: VDP1 offset 0x02A0 */
    .byte   0xD5, 0x31    /* mov.l .L_sprite_position_a, r5 */
    mov.l @(4, r10), r7               /* r7 = display base */
    add #0x2, r11                      /* r11 = (r13 + 2) */
    shll8 r11                          /* × 256 */
    shll2 r11                          /* × 1024 total = × 0x400 */
    shll2 r11
    add r11, r7                        /* r7 += (r13+2) * 0x400 (lap row) */
    jsr @r14                           /* draw position element */
    mov #0x4, r4
    mov.l @(4, r10), r7               /* element 2: VDP1 offset 0x0530 */
    mov.w   .L_vdp1_off_count, r6
    mov.l @r12, r0                     /* check lap_state */
    tst r0, r0
    bt/s    .L_06011252               /* state == 0 → inactive sprite */
    add r11, r7
    bra     .L_06011254
    mov #0x1, r0                       /* state != 0 → active sprite (index 1) */
.L_06011252:
    mov #0x0, r0                       /* inactive sprite (index 0) */
.L_06011254:
    shll2 r0                           /* index * 4 */
    .byte   0xD5, 0x29    /* mov.l .L_car_index, r5 */
    .byte   0xD3, 0x29    /* mov.l .L_sprite_table, r3 */
    mov.l @r5, r5
    shll2 r5                           /* car_index * 4 */
    shll r5                            /* car_index * 8 (table entry stride) */
    add r3, r5                         /* r5 → sprite_table[car_index] */
    mov.l @(r0, r5), r5               /* select active/inactive entry */
    jsr @r14                           /* draw count element */
    mov #0x4, r4
    mov.l @(4, r10), r7               /* element 3: VDP1 offset 0x0534 */
    mov.w   DAT_060112e6, r6
    mov.l @r12, r0                     /* check lap_state again */
    tst r0, r0
    bt/s    .L_0601127A               /* state == 0 → inactive sprite */
    add r11, r7
    .byte   0xD5, 0x23    /* mov.l .L_sprite_active, r5 */
    bra     .L_060112D0               /* → draw and exit */
    nop
.L_0601127A:
    .byte   0xD5, 0x23    /* mov.l .L_sprite_inactive, r5 */
    bra     .L_060112D0               /* → draw and exit */
    nop
.L_06011280:                              /* --- PATH B: race not active --- */
    .byte   0xDA, 0x1C    /* mov.l .L_disp_struct, r10 */
    mov r13, r11
    mov.w   .L_vdp1_off_position, r6  /* element 1: VDP1 offset 0x02A0 */
    .byte   0xD5, 0x21    /* mov.l .L_sprite_position_b, r5 */
    mov.l @(4, r10), r7               /* r7 = display base (no lap row offset) */
    shll8 r11                          /* r11 = r13 * 0x400 */
    shll2 r11
    shll2 r11
    add r11, r7
    jsr @r14                           /* draw position element */
    mov #0x4, r4
    mov.l @(4, r10), r7               /* element 2: VDP1 offset 0x0530 */
    mov.w   .L_vdp1_off_count, r6
    mov.l @r12, r0                     /* check lap_state */
    tst r0, r0
    bt/s    .L_060112A6               /* state == 0 → inactive */
    add r11, r7
    bra     .L_060112A8
    mov #0x1, r0
.L_060112A6:
    mov #0x0, r0
.L_060112A8:
    shll2 r0
    .byte   0xD5, 0x14    /* mov.l .L_car_index, r5 */
    .byte   0xD3, 0x14    /* mov.l .L_sprite_table, r3 */
    mov.l @r5, r5
    shll2 r5
    shll r5
    add r3, r5
    mov.l @(r0, r5), r5
    jsr @r14                           /* draw count element */
    mov #0x4, r4
    mov.l @(4, r10), r7               /* element 3: VDP1 offset 0x0534 */
    mov.w   DAT_060112e6, r6
    mov.l @r12, r0                     /* check lap_state */
    tst r0, r0
    bt/s    .L_060112CE               /* state == 0 → inactive */
    add r11, r7
    .byte   0xD5, 0x0E    /* mov.l .L_sprite_active, r5 */
    bra     .L_060112D0
    nop
.L_060112CE:
    .byte   0xD5, 0x0E    /* mov.l .L_sprite_inactive, r5 */
.L_060112D0:                              /* --- shared draw + exit --- */
    jsr @r14                           /* draw final element */
    mov #0x4, r4
    lds.l @r15+, pr
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14
.L_vdp1_off_position:
    .2byte  0x02A0                        /* VDP1 cmd offset: position/lap icon */
.L_vdp1_off_count:
    .2byte  0x0530                        /* VDP1 cmd offset: lap count digit */

    .global DAT_060112e6
DAT_060112e6:
    .2byte  0x0534                        /* VDP1 cmd offset: lap indicator border */
.L_lap_state:
    .4byte  sym_06078644               /* lap state flag (nonzero = lap in progress) */
.L_fn_draw_elem:
    .4byte  sym_06028400               /* HUD element draw function */
.L_race_active_flag:
    .4byte  sym_0607EAB8               /* race active flag (nonzero = racing) */
.L_disp_struct:
    .4byte  sym_06063828               /* display structure (VDP1 base at +4) */
.L_sprite_position_a:
    .4byte  sym_0605A8B6               /* position sprite data (race active) */
.L_car_index:
    .4byte  sym_06078868               /* car/player index for sprite lookup */
.L_sprite_table:
    .4byte  sym_0605ABBC               /* sprite lookup table (8 bytes per car) */
.L_sprite_active:
    .4byte  sym_0605A9B0               /* active state sprite (lap in progress) */
.L_sprite_inactive:
    .4byte  sym_0605A9B8               /* inactive state sprite (no lap) */
.L_sprite_position_b:
    .4byte  sym_0605A7FC               /* position sprite data (race inactive) */
