/* bonus_multiplier -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06013C20 - 0x06013C58
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Bonus multiplier increment — called after ranking_pts_calc phase reset
 * (loc_06013C10 sets phase=7 and resets frame timer, then falls through here).
 *
 * Increments the 16-bit frame timer (sym_06084AF6) by 1, clamping at max 20.
 * Then calls bg_obj_render_loop and tail-jumps to race_variant_setup_a to
 * render the current results screen frame.
 *
 * Constant pool entries before .L_pool_frame_timer belong to ranking_pts_calc
 * (they overflow from the preceding TU's pool region).
 */

    .section .text.FUN_06013C20


    .global bonus_multiplier
    .type bonus_multiplier, @function
bonus_multiplier:
    sts.l pr, @-r15                      ! save return address
    mov #0x14, r6                        ! r6 = 20 (max multiplier cap)
    mov.l   .L_pool_frame_timer, r5      ! r5 = &frame_timer (sym_06084AF6)
    mov.w @r5, r4                        ! r4 = current frame timer (16-bit)
    extu.w r4, r4                        ! zero-extend to 32-bit
    add #0x1, r4                         ! r4 = timer + 1
    cmp/gt r6, r4                        ! timer + 1 > 20?
    bf      .L_under_max                 ! no — use incremented value
    bra     .L_clamp_done                ! yes — use max
    mov r6, r3                           ! delay: r3 = 20 (capped value)
.L_under_max:
    mov r4, r3                           ! r3 = timer + 1 (uncapped)
.L_clamp_done:
    extu.w r3, r3                        ! zero-extend clamped value to 16-bit
    mov.w r3, @r5                        ! write clamped timer back to memory
    .byte   0xB1, 0xC3    /* bsr bg_obj_render_loop (external) */
    nop                                  ! delay slot
    .byte   0xA2, 0x95    /* bra race_variant_setup_a (external — tail call) */
    lds.l @r15+, pr                      ! delay: restore return address (for tail call)
    .2byte  0xFFFF                       ! alignment padding
    .4byte  sym_06084B14                 ! variant char table (used by ranking_pts_calc pool)
    .4byte  sym_0605B0FC                 ! score table (used by ranking_pts_calc pool)
    .4byte  0xAB1102FF                   ! default sound ID (used by ranking_pts_calc pool)
    .4byte  sym_06084AF2                 ! phase byte (used by ranking_pts_calc pool)
.L_pool_frame_timer:
    .4byte  sym_06084AF6                 ! &frame_timer (16-bit multiplier counter)
