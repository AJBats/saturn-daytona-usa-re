/* restore_state_snapshot -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06018FFC - 0x06019058
 * Auto-generated by tools/generate_l3_tu.py
 */

    .section .text.FUN_06018FFC


/* ==========================================================================
 * restore_state_snapshot
 * --------------------------------------------------------------------------
 * Sound state transition for the "restore" phase of a state snapshot cycle.
 * Reloads the in-game sound bank (GAMED.BIN) after a menu or overlay has
 * swapped in a different sound bank, then restarts background music.
 *
 * Sequence:
 *   1. Send sound-stop command (0xAE0001FF) via sound_cmd_dispatch
 *   2. Send system-variant command (0xAE0005FF) via sound_cmd_dispatch
 *   3. Wait for sound driver ready (poll Sound RAM 0x25A02DBE for 0xFFFF)
 *   4. If no timeout: load GAMED.BIN sound data to Sound RAM, then clear
 *      the driver-ready flag so next wait will block until driver reboots
 *   5. Start background music (0xAE0600FF)
 *   6. Send sound-stop (0xAE0001FF) to silence startup transient
 *
 * Sibling functions: save_state_snapshot (loads SLCTD.BIN, no BGM restart),
 *                    state_snapshot_compare (loads OVERD.BIN, sends BGM)
 * ======================================================================== */

    .global restore_state_snapshot
    .type restore_state_snapshot, @function
restore_state_snapshot:
    sts.l pr, @-r15                             ! save return address to stack
    mov.l   .L_pool_snd_cmd_dispatch, r14       ! r14 = sound_cmd_dispatch (reused for all jsr calls)
    mov.l   .L_pool_snd_timeout_flag, r2        ! r2 = &timeout_flag (sym_06086050)
    mov.l r3, @r2                               ! store caller-provided value into timeout flag
    mov.l   .L_pool_cmd_stop, r5                ! r5 = 0xAE0001FF (sound stop command)
    jsr @r14                                    ! sound_cmd_dispatch(0xF, 0xAE0001FF) -- send stop
    mov #0xF, r4                                ! r4 = 0xF (direct command channel) [delay slot]
    mov.l   .L_pool_cmd_sys_variant, r5         ! r5 = 0xAE0005FF (system variant command)
    jsr @r14                                    ! sound_cmd_dispatch(0xF, 0xAE0005FF) -- send sys variant
    mov #0xF, r4                                ! r4 = 0xF (direct command channel) [delay slot]
    .byte   0xB1, 0x6A    /* bsr 0x060192E8 (external) */  ! call wait_sound_driver_ready (polls Sound RAM)
    nop                                         ! delay slot
    mov.l   .L_pool_snd_timeout_flag, r0        ! r0 = &timeout_flag
    mov.l @r0, r0                               ! r0 = timeout_flag value
    tst r0, r0                                  ! test if timeout occurred (0 = success)
    bf      .L_skip_sound_load                  ! if timeout nonzero, skip sound data load
    mov.l   .L_pool_load_gamed_sndram, r3       ! r3 = load_gamed_sndram (sym_06012EBC)
    jsr @r3                                     ! load GAMED.BIN to Sound RAM +0x3000
    nop                                         ! delay slot
    mov #0x0, r2                                ! r2 = 0 (clear value)
    mov.l   .L_pool_snd_driver_ready, r3        ! r3 = 0x25A02DBE (Sound RAM driver-ready flag)
    mov.w r2, @r3                               ! clear driver-ready flag (driver will re-set on boot)
.L_skip_sound_load:
    mov.l   .L_pool_cmd_start_bgm, r5           ! r5 = 0xAE0600FF (start background music)
    jsr @r14                                    ! sound_cmd_dispatch(0xF, 0xAE0600FF) -- start BGM
    mov #0xF, r4                                ! r4 = 0xF (direct command channel) [delay slot]
    mov.l   .L_pool_cmd_stop, r5                ! r5 = 0xAE0001FF (sound stop command)
    jsr @r14                                    ! sound_cmd_dispatch(0xF, 0xAE0001FF) -- silence startup transient
    mov #0xF, r4                                ! r4 = 0xF (direct command channel) [delay slot]
    lds.l @r15+, pr                             ! restore return address from stack
    rts                                         ! return to caller
    mov.l @r15+, r14                            ! restore r14 from stack [delay slot]
    .2byte  0xFFFF                              ! alignment padding
.L_pool_snd_cmd_dispatch:
    .4byte  sound_cmd_dispatch
.L_pool_snd_timeout_flag:
    .4byte  sym_06086050
.L_pool_cmd_stop:
    .4byte  0xAE0001FF
.L_pool_cmd_sys_variant:
    .4byte  0xAE0005FF
.L_pool_load_gamed_sndram:
    .4byte  sym_06012EBC
.L_pool_snd_driver_ready:
    .4byte  0x25A02DBE                  /* Sound RAM +0x02DBE */
.L_pool_cmd_start_bgm:
    .4byte  0xAE0600FF
