/* transition_sound_trigger -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601918C - 0x060191E0
 * Auto-generated by tools/generate_l3_tu.py
 */

    .section .text.FUN_0601918C


/*
 * transition_sound_trigger
 *
 * Resets the sound subsystem for a scene transition:
 *   1. Sends sound-stop command (0xAE0001FF) to silence current audio
 *   2. Sends system-variant command (0xAE0005FF) to configure sound mode
 *   3. Waits for the sound driver to become ready (polls Sound RAM)
 *   4. If sound driver did NOT time out (busy flag == 0):
 *      a. Loads MUSIC3D.BIN into Sound RAM
 *      b. Clears the Sound RAM driver-ready flag (0x25A02DBE)
 *   5. Sends sound-stop again to silence any startup transient
 *
 * Arguments: none
 * Returns:   none
 * Clobbers:  r0, r2, r3, r4, r5, r14, pr
 */
    .global transition_sound_trigger
    .type transition_sound_trigger, @function
transition_sound_trigger:
    sts.l pr, @-r15                         ! save return address
    mov.l   .L_pool_sound_dispatch, r14     ! r14 = &sound_cmd_dispatch (cached for reuse)
    mov.l   .L_pool_snd_busy_flag, r2       ! r2 = &snd_busy_flag (sym_06086050)
    mov.l r3, @r2                           ! store r3 into busy flag (mark sound driver busy)
    mov.l   .L_pool_cmd_stop, r5            ! r5 = 0xAE0001FF (sound stop command)
    jsr @r14                                ! sound_cmd_dispatch(0xF, 0xAE0001FF) — stop all sound
    mov #0xF, r4                            ! r4 = 0xF (channel mask: all channels)
    mov.l   .L_pool_cmd_sys_variant, r5     ! r5 = 0xAE0005FF (system variant command)
    jsr @r14                                ! sound_cmd_dispatch(0xF, 0xAE0005FF) — configure mode
    mov #0xF, r4                            ! r4 = 0xF (channel mask: all channels)
    .byte   0xB0, 0xA2    /* bsr 0x060192E8 (external) */  ! call wait_sound_driver_ready
    nop                                     ! (branch delay slot)
    mov.l   .L_pool_snd_busy_flag, r0       ! r0 = &snd_busy_flag
    mov.l @r0, r0                           ! r0 = snd_busy_flag value
    tst r0, r0                              ! test if flag == 0 (driver ready, no timeout)
    bf      .L_skip_music_load              ! if nonzero (timed out), skip music load
    mov.l   .L_pool_load_music3d, r3        ! r3 = &load_music3d_sndram
    jsr @r3                                 ! load MUSIC3D.BIN into Sound RAM +0x3000
    nop                                     ! (branch delay slot)
    mov #0x0, r2                            ! r2 = 0 (clear value)
    mov.l   .L_pool_snd_driver_ready, r3    ! r3 = 0x25A02DBE (Sound RAM driver-ready flag)
    mov.w r2, @r3                           ! clear driver-ready flag in Sound RAM
.L_skip_music_load:
    mov.l   .L_pool_cmd_stop, r5            ! r5 = 0xAE0001FF (sound stop command)
    jsr @r14                                ! sound_cmd_dispatch(0xF, 0xAE0001FF) — silence transient
    mov #0xF, r4                            ! r4 = 0xF (channel mask: all channels)
    lds.l @r15+, pr                         ! restore return address
    rts                                     ! return
    mov.l @r15+, r14                        ! (delay slot) restore r14
.L_pool_sound_dispatch:
    .4byte  sound_cmd_dispatch
.L_pool_snd_busy_flag:
    .4byte  sym_06086050
.L_pool_cmd_stop:
    .4byte  0xAE0001FF
.L_pool_cmd_sys_variant:
    .4byte  0xAE0005FF
    .4byte  sym_06012F58
.L_pool_snd_driver_ready:
    .4byte  0x25A02DBE                  /* Sound RAM +0x02DBE */
.L_pool_load_music3d:
    .4byte  sym_06012F60
