/* state_mode_select_active -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008D74 - 0x06008E00
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Mode select screen per-frame handler (game state 5).
 * Called every frame while the mode select menu is displayed
 * (Saturn / Arcade / Time Trial). Entered after state_mode_select_setup
 * (state 4) completes initialization.
 *
 * Per-frame logic:
 *   1. Read display status flags — if == 0x70 (all three display layers
 *      ready), set course_type = 2 (Saturn Mode selection)
 *   2. Decrement attract_countdown timer by 1 each frame
 *      - If timer goes negative: reset game_state = 0, disable_display()
 *        (transition back to attract mode — idle timeout)
 *   3. Read button status word, mask with 0x0100 (A / confirm button)
 *      - If pressed: reset game_state = 0, disable_display()
 *        (player pressed Start during mode select — restart attract)
 *   4. Call render_setup_dispatch() for mode select rendering
 *   5. Set render_mode_flags |= 0x04 (mode select render enable bit)
 *   6. Call camera_finalize() to commit camera state
 *   7. Clear animation_state = 0
 *
 * Parameters:
 *   r14 = 0 throughout (used as zero constant, saved/restored)
 *
 * Global references:
 *   sym_06063DA0 = display status flags (16-bit)
 *   sym_06078644 = course_type (32-bit)
 *   sym_0607EBCC = attract_countdown (32-bit, frames)
 *   sym_0605AD10 = game_state_dispatch (32-bit)
 *   sym_060149E0 = disable_display() — clears bit 15 of display reg
 *   sym_06063D9A = button status word (16-bit)
 *   sym_0605B6D8 = render_mode_flags (32-bit bitmask)
 *   sym_06026CE0 = camera_finalize()
 *   sym_06059F44 = animation_state (32-bit)
 */

    .section .text.FUN_06008D74


    .global state_mode_select_active
    .type state_mode_select_active, @function
state_mode_select_active:
    mov.l r14, @-r15                            ! save r14
    sts.l pr, @-r15                             ! save return address
    mov.l   _pool_display_status_ptr, r0        ! r0 = &display_status_flags
    mov.w @r0, r0                               ! r0 = display_status_flags (16-bit)
    extu.w r0, r0                               ! zero-extend to 32-bit
    cmp/eq #0x70, r0                            ! display_status == 0x70? (all 3 layers ready)
    bf/s    .L_skip_saturn_mode                 ! if not ready, skip course type assignment
    mov #0x0, r14                               ! r14 = 0 (zero constant for function lifetime)
    mov #0x2, r2                                ! r2 = 2 (Saturn Mode course type)
    mov.l   _pool_course_type_ptr, r3           ! r3 = &course_type
    mov.l r2, @r3                               ! course_type = 2 (Saturn Mode)
.L_skip_saturn_mode:
    mov.l   _pool_countdown_ptr, r4             ! r4 = &attract_countdown
    mov.l @r4, r2                               ! r2 = attract_countdown
    add #-0x1, r2                               ! r2 = countdown - 1
    mov.l r2, @r4                               ! attract_countdown -= 1 (write back)
    mov r2, r3                                  ! r3 = updated countdown value
    cmp/pz r3                                   ! countdown >= 0?
    bt      .L_countdown_ok                     ! if still positive, skip timeout
    mov.l   _pool_game_state_ptr, r3            ! r3 = &game_state_dispatch
    mov.l r14, @r3                              ! game_state_dispatch = 0 (return to attract)
    mov.l   _pool_fn_disable_display, r3        ! r3 = &disable_display
    jsr @r3                                     ! disable_display() — turn off screen
    nop                                         ! (delay slot)
.L_countdown_ok:
    mov.l   _pool_button_status_ptr, r2         ! r2 = &button_status_word
    mov.w @r2, r3                               ! r3 = button_status (16-bit)
    extu.w r3, r3                               ! zero-extend to 32-bit
    mov.w   _wpool_confirm_mask, r2             ! r2 = 0x0100 (A/confirm button mask)
    and r2, r3                                  ! isolate confirm button bit
    tst r3, r3                                  ! confirm button pressed?
    bt      .L_no_confirm                       ! if not pressed, skip
    mov.l   _pool_game_state_ptr, r3            ! r3 = &game_state_dispatch
    mov.l r14, @r3                              ! game_state_dispatch = 0 (return to attract)
    mov.l   _pool_fn_disable_display, r3        ! r3 = &disable_display
    jsr @r3                                     ! disable_display() — turn off screen
    nop                                         ! (delay slot)
.L_no_confirm:
    mov.l   _pool_fn_render_dispatch, r3        ! r3 = &render_setup_dispatch
    jsr @r3                                     ! render_setup_dispatch() — mode select render
    nop                                         ! (delay slot)
    mov.l   _pool_render_flags_ptr, r4          ! r4 = &render_mode_flags
    mov.l   _pool_fn_camera_finalize, r3        ! r3 = &camera_finalize
    mov.l @r4, r0                               ! r0 = render_mode_flags
    or #0x4, r0                                 ! r0 |= 0x04 (mode select render enable)
    jsr @r3                                     ! camera_finalize() — commit camera state
    mov.l r0, @r4                               ! render_mode_flags |= 0x04 (delay slot write)
    mov.l   _pool_anim_state_ptr, r3            ! r3 = &animation_state
    mov.l r14, @r3                              ! animation_state = 0 (clear each frame)
    lds.l @r15+, pr                             ! restore return address
    rts                                         ! return to caller
    mov.l @r15+, r14                            ! (delay slot) restore r14
_wpool_confirm_mask:
    .2byte  0x0100
_pool_display_status_ptr:
    .4byte  sym_06063DA0
_pool_course_type_ptr:
    .4byte  sym_06078644
_pool_countdown_ptr:
    .4byte  sym_0607EBCC
_pool_game_state_ptr:
    .4byte  sym_0605AD10
_pool_fn_disable_display:
    .4byte  sym_060149E0
_pool_button_status_ptr:
    .4byte  sym_06063D9A
_pool_fn_render_dispatch:
    .4byte  render_setup_dispatch
_pool_render_flags_ptr:
    .4byte  sym_0605B6D8
_pool_fn_camera_finalize:
    .4byte  sym_06026CE0
_pool_anim_state_ptr:
    .4byte  sym_06059F44
