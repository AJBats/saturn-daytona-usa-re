/* input_event_handler -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06005A22 - 0x06005AE8
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Per-frame display element submission driven by a countdown timer.
 * Called from the per-frame update chain. Decrements a lap display timer
 * (sym_0607EABC) each frame and submits display elements while it is
 * positive.
 *
 * Two alternating paths based on bit 0 of the decremented timer value:
 *
 *   Bit 0 SET (odd frames):
 *     Selects a display element index based on 2-player mode:
 *       - 2P mode (sym_06085FF4 nonzero): index = 0xB0 (176)
 *       - 1P mode: index = 0x21 (33)
 *     Multiplies index * 8 to index into the car object table
 *     (sym_06063750). Reads descriptor fields to build render params.
 *     Checks anim countdown (sym_0607EAC0) for element size selection:
 *       - Nonzero: r6 = 0x049C
 *       - Zero: r6 = 0x059C
 *     Tail-calls display_list_loader (sym_06028400) with mode 0x8.
 *
 *   Bit 0 CLEAR (even frames):
 *     Calls geom_dispatch_final (sym_060284AE) with static rendering
 *     data (sym_0605ACDD), then tail-calls it again with different
 *     size params. Submits two display elements per even frame.
 *
 * Key data:
 *   sym_0607EABC = lap display timer (32-bit countdown, frames)
 *   sym_06085FF4 = 2-player mode flag (byte, 0=1P, nonzero=2P)
 *   sym_0607EAC0 = anim countdown timer (32-bit)
 *   sym_06063750 = car object table base (8 bytes per entry)
 *   sym_06028400 = display_list_loader (r4=mode, r5=src, r6=size, r7=dest)
 *   sym_060284AE = geom_dispatch_final (r4=mode, r5=size, r6=index, r7=data)
 *   sym_0605ACDD = static rendering data pointer
 */

    .section .text.FUN_06005A22


    .global input_event_handler
    .type input_event_handler, @function
input_event_handler:
    mov.l r14, @-r15                          ! save r14
    sts.l pr, @-r15                           ! save return address
    add #-0x4, r15                            ! allocate 4 bytes on stack
    .byte   0xD4, 0x26    /* mov.l _pool_lap_disp_timer, r4 */  ! r4 = &lap_disp_timer (sym_0607EABC)
    mov.l @r4, r3                             ! r3 = lap_disp_timer value
    cmp/pl r3                                 ! test timer > 0
    bf      .L_epilogue                       ! if timer <= 0: nothing to display, exit
    mov.l @r4, r3                             ! r3 = lap_disp_timer (re-read)
    add #-0x1, r3                             ! r3-- (decrement timer)
    mov r3, r0                                ! r0 = decremented value (for bit test)
    tst #0x1, r0                              ! test bit 0 of timer
    bt/s    .L_even_frame                     ! if bit 0 clear (even): static path
    mov.l r3, @r4                             ! store decremented timer (delay slot)
    .byte   0xD0, 0x22    /* mov.l _pool_2p_mode_flag, r0 */  ! r0 = &2p_mode_flag (sym_06085FF4)
    mov.b @r0, r0                             ! r0 = 2p_mode_flag value (byte)
    tst r0, r0                                ! test 2p_mode == 0
    bt      .L_1p_index                       ! if 1P mode: use index 0x21
    mov.w   _wpool_2p_elem_index, r14         ! r14 = 0x00B0 (2P display element index)
    bra     .L_index_selected                 ! skip 1P assignment
    nop                                       ! delay slot
.L_1p_index:
    mov #0x21, r14                            ! r14 = 0x21 (1P display element index)
.L_index_selected:
    .byte   0xD0, 0x1F    /* mov.l _pool_anim_countdown, r0 */  ! r0 = &anim_countdown (sym_0607EAC0)
    mov.l @r0, r0                             ! r0 = anim_countdown value
    tst r0, r0                                ! test anim_countdown == 0
    bt      .L_anim_zero                      ! if zero: use larger element size
    /* --- Anim countdown nonzero: use element size 0x049C --- */
    mov r14, r7                               ! r7 = element index
    shll2 r7                                  ! r7 = index * 4
    shll r7                                   ! r7 = index * 8 (table stride)
    .byte   0xD3, 0x1D    /* mov.l _pool_car_obj_table, r3 */  ! r3 = car_obj_table base (sym_06063750)
    add r3, r7                                ! r7 = &car_obj_table[index] (entry ptr)
    mov.l r7, @r15                            ! stack[0] = entry ptr (save for later)
    mov.l @(4, r7), r7                        ! r7 = entry.field4 (src base addr)
    mov.w   DAT_06005abc, r3                  ! r3 = 0x5000 (VRAM offset)
    add r3, r7                                ! r7 = src_base + 0x5000 (VRAM dest)
    mov.w   DAT_06005abe, r6                  ! r6 = 0x049C (element size — anim active)
    mov.l @r15, r5                            ! r5 = entry ptr (from stack)
    mov.l @r5, r5                             ! r5 = entry.field0 (src data ptr)
    mov #0x8, r4                              ! r4 = 0x8 (copy mode)
    add #0x4, r15                             ! deallocate stack frame
    lds.l @r15+, pr                           ! restore return address
    .byte   0xD3, 0x18    /* mov.l _pool_dlist_loader, r3 */  ! r3 = &display_list_loader (sym_06028400)
    jmp @r3                                   ! tail-call display_list_loader(0x8, src, 0x049C, dest)
    mov.l @r15+, r14                          ! restore r14 (delay slot)
.L_anim_zero:
    /* --- Anim countdown zero: use element size 0x059C --- */
    mov r14, r7                               ! r7 = element index
    shll2 r7                                  ! r7 = index * 4
    shll r7                                   ! r7 = index * 8 (table stride)
    .byte   0xD3, 0x14    /* mov.l _pool_car_obj_table, r3 */  ! r3 = car_obj_table base (sym_06063750)
    add r3, r7                                ! r7 = &car_obj_table[index] (entry ptr)
    mov.l r7, @r15                            ! stack[0] = entry ptr (save for later)
    mov.l @(4, r7), r7                        ! r7 = entry.field4 (src base addr)
    mov.w   DAT_06005abc, r3                  ! r3 = 0x5000 (VRAM offset)
    add r3, r7                                ! r7 = src_base + 0x5000 (VRAM dest)
    mov.w   DAT_06005ac0, r6                  ! r6 = 0x059C (element size — anim idle)
    mov.l @r15, r5                            ! r5 = entry ptr (from stack)
    mov.l @r5, r5                             ! r5 = entry.field0 (src data ptr)
    mov #0x8, r4                              ! r4 = 0x8 (copy mode)
    add #0x4, r15                             ! deallocate stack frame
    lds.l @r15+, pr                           ! restore return address
    .byte   0xD3, 0x0F    /* mov.l _pool_dlist_loader, r3 */  ! r3 = &display_list_loader (sym_06028400)
    jmp @r3                                   ! tail-call display_list_loader(0x8, src, 0x059C, dest)
    mov.l @r15+, r14                          ! restore r14 (delay slot)
.L_even_frame:
    /* --- Even frame: submit two display elements via geom_dispatch_final --- */
    .byte   0xD7, 0x0E    /* mov.l _pool_static_data, r7 */  ! r7 = &static_data (sym_0605ACDD)
    mov.w   _wpool_static_size, r6            ! r6 = 0x0090 (static element size)
    mov.w   DAT_06005abe, r5                  ! r5 = 0x049C (first element size)
    .byte   0xD3, 0x0E    /* mov.l _pool_geom_dispatch, r3 */  ! r3 = &geom_dispatch_final (sym_060284AE)
    jsr @r3                                   ! call geom_dispatch_final(0x8, 0x049C, 0x0090, static_data)
    mov #0x8, r4                              ! r4 = 0x8 (delay slot: render mode)
    /* Second element submission */
    .byte   0xD7, 0x0B    /* mov.l _pool_static_data, r7 */  ! r7 = &static_data (sym_0605ACDD)
    mov.w   _wpool_static_size, r6            ! r6 = 0x0090 (static element size)
    mov.w   DAT_06005ac0, r5                  ! r5 = 0x059C (second element size)
    mov #0x8, r4                              ! r4 = 0x8 (render mode)
    add #0x4, r15                             ! deallocate stack frame
    lds.l @r15+, pr                           ! restore return address
    .byte   0xD3, 0x09    /* mov.l _pool_geom_dispatch, r3 */  ! r3 = &geom_dispatch_final (sym_060284AE)
    jmp @r3                                   ! tail-call geom_dispatch_final(0x8, 0x059C, 0x0090, static_data)
    mov.l @r15+, r14                          ! restore r14 (delay slot)

    /* --- Word constant pool (PC-relative mov.w targets) --- */

_wpool_2p_elem_index:
    .2byte  0x00B0                            /* 2P mode display element index (176) */

    .global DAT_06005abc
DAT_06005abc:
    .2byte  0x5000                            /* VRAM offset for car object table entry */

    .global DAT_06005abe
DAT_06005abe:
    .2byte  0x049C                            /* element size A (anim active / first elem) */

    .global DAT_06005ac0
DAT_06005ac0:
    .2byte  0x059C                            /* element size B (anim idle / second elem) */

_wpool_static_size:
    .2byte  0x0090                            /* static element size */

    /* --- Longword constant pool (PC-relative mov.l targets) --- */

_pool_lap_disp_timer:
    .4byte  sym_0607EABC                      /* -> lap display timer (32-bit countdown) */
_pool_2p_mode_flag:
    .4byte  sym_06085FF4                      /* -> 2-player mode flag (byte) */
_pool_anim_countdown:
    .4byte  sym_0607EAC0                      /* -> anim countdown timer (32-bit) */
_pool_car_obj_table:
    .4byte  sym_06063750                      /* -> car object table base (8 bytes/entry) */
_pool_dlist_loader:
    .4byte  sym_06028400                      /* -> display_list_loader function */
_pool_static_data:
    .4byte  sym_0605ACDD                      /* -> static rendering data pointer */
_pool_geom_dispatch:
    .4byte  sym_060284AE                      /* -> geom_dispatch_final function */

    /* --- Early exit: timer expired --- */

.L_epilogue:
    add #0x4, r15                             ! deallocate stack frame
    lds.l @r15+, pr                           ! restore return address
    rts                                       ! return to caller
    mov.l @r15+, r14                          ! restore r14 (delay slot)
