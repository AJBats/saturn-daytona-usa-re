/* transition_multi_step -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060191E4 - 0x06019248
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Multi-step sound transition handler. Performs:
 *   1. Stores caller's r3 into the sound-busy flag (sym_06086050)
 *   2. Sends sound init command (0xAE0001FF) via sound_cmd_dispatch(0xF, ...)
 *   3. Sends sound stop command (0xAE0005FF) via sound_cmd_dispatch(0xF, ...)
 *   4. BSR to wait_sound_ready (polls 0x25A02DBE for driver-ready 0xFFFF)
 *   5. If driver came up OK (busy flag == 0):
 *      - Copies 0x6D000 bytes from Work RAM Low base (0x00200000) to Sound RAM
 *        (0x25A03000) via memcpy_byte_idx -- restores sound driver data
 *      - Clears the sound-ready mailbox word at 0x25A02DBE to 0
 *   6. Sends sound resume command (0xAE0001FF) via sound_cmd_dispatch(0xF, ...)
 *
 * Nearly identical to transition_full_exec, except the source address for the
 * memcpy is Work RAM Low base (0x00200000) instead of the offset buffer
 * (0x0026D000). This variant restores sound data from the start of WRAM Low
 * rather than from a secondary save region.
 */

    .section .text.FUN_060191E4


    .global transition_multi_step
    .type transition_multi_step, @function
transition_multi_step:
    sts.l pr, @-r15                         ! save return address
    mov.l   .L_fn_sound_cmd_dispatch, r14   ! r14 = &sound_cmd_dispatch (reused for 3 calls)
    mov.l   .L_snd_busy_flag, r2            ! r2 = &sym_06086050 (sound busy/error flag)
    mov.l r3, @r2                           ! store caller's r3 into busy flag
    mov.l   .L_snd_cmd_init, r5             ! r5 = 0xAE0001FF (sound init command)
    jsr @r14                                ! sound_cmd_dispatch(0xF, 0xAE0001FF)
    mov #0xF, r4                            ! (delay) r4 = 0xF (direct command channel)
    mov.l   .L_snd_cmd_stop, r5             ! r5 = 0xAE0005FF (sound stop command)
    jsr @r14                                ! sound_cmd_dispatch(0xF, 0xAE0005FF)
    mov #0xF, r4                            ! (delay) r4 = 0xF (direct command channel)
    .byte   0xB0, 0x76    /* bsr 0x060192E8 (external) */  ! call wait_sound_ready
    nop                                     ! (delay slot)
    mov.l   .L_snd_busy_flag, r0            ! r0 = &busy_flag
    mov.l @r0, r0                           ! r0 = busy_flag value
    tst r0, r0                              ! test if zero (no error)
    bf      .L_skip_sound_restore           ! if nonzero (timeout): skip sound data restore
    mov.l   .L_copy_size, r6                ! r6 = 0x0006D000 (byte count to copy)
    mov.l   .L_wram_low_base, r5            ! r5 = 0x00200000 (source: Work RAM Low base)
    mov.l   .L_snd_ram_dst, r4              ! r4 = 0x25A03000 (dest: Sound RAM driver data)
    mov.l   .L_fn_memcpy_byte_idx, r3       ! r3 = &memcpy_byte_idx
    jsr @r3                                 ! memcpy_byte_idx(snd_ram, wram_low, size)
    nop                                     ! (delay slot)
    mov #0x0, r2                            ! r2 = 0
    mov.l   .L_snd_ready_mailbox, r3        ! r3 = 0x25A02DBE (sound ready mailbox)
    mov.w r2, @r3                           ! clear ready mailbox = 0
.L_skip_sound_restore:
    mov.l   .L_snd_cmd_init, r5             ! r5 = 0xAE0001FF (sound resume command)
    jsr @r14                                ! sound_cmd_dispatch(0xF, 0xAE0001FF)
    mov #0xF, r4                            ! (delay) r4 = 0xF (direct command channel)
    lds.l @r15+, pr                         ! restore return address
    rts                                     ! return
    mov.l @r15+, r14                        ! (delay) restore r14
    .2byte  0xFFFF
.L_fn_sound_cmd_dispatch:
    .4byte  sound_cmd_dispatch
.L_snd_busy_flag:
    .4byte  sym_06086050
.L_snd_cmd_init:
    .4byte  0xAE0001FF
.L_snd_cmd_stop:
    .4byte  0xAE0005FF
.L_copy_size:
    .4byte  0x0006D000
.L_wram_low_base:
    .4byte  0x00200000                  /* Work RAM Low base */
.L_snd_ram_dst:
    .4byte  0x25A03000                  /* Sound RAM +0x03000 */
.L_fn_memcpy_byte_idx:
    .4byte  memcpy_byte_idx
.L_snd_ready_mailbox:
    .4byte  0x25A02DBE                  /* Sound RAM +0x02DBE */
