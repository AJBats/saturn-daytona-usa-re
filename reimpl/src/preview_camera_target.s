/* preview_camera_target -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601A7AC - 0x0601A80C
 *
 * Preview mode player-count selector and race-start trigger.
 *
 * Reads the button flags word from the input state struct (g_pad_state + 2):
 *   - If Down button (bit 14 / 0x4000) is pressed: set two_player_flag = 0 (1P mode)
 *   - If Up button (bit 15 / 0x8000) is pressed: set two_player_flag = 1 (2P mode)
 *   - Otherwise: leave two_player_flag unchanged
 *
 * After updating the flag, calls car_init_handler to load car display lists,
 * then tail-jumps to race_start_sound_trigger to play the start sound.
 *
 * Key symbols:
 *   sym_0605D241 = two-player mode flag (byte, 0=1P, 1=2P)
 *   g_pad_state = input button state struct (+2 = button flags word)
 *
 * Auto-generated by tools/generate_l3_tu.py
 */

    .section .text.FUN_0601A7AC


    .global preview_camera_target
    .type preview_camera_target, @function
preview_camera_target:
    sts.l pr, @-r15                             ! save PR (return address)
    mov.l   .L_pool_two_player_flag, r5         ! r5 -> &two_player_flag (sym_0605D241)
    mov.l   .L_pool_input_state, r4             ! r4 -> &input_state struct (g_pad_state)
    mov.w   .L_w_down_btn_mask, r2               ! r2 = 0x4000 (Down button mask, bit 14)
    mov.w @(2, r4), r0                          ! r0 = button_flags word (input_state+2)
    mov r0, r3                                  ! r3 = button_flags (copy)
    extu.w r3, r3                               ! r3 = zero-extend to 32-bit
    and r2, r3                                  ! r3 = button_flags & 0x4000 (Down pressed?)
    tst r3, r3                                  ! is Down button pressed?
    bt      .L_check_up_button                  ! no -> check Up button
    mov #0x0, r3                                ! r3 = 0 (1P mode)
    mov.b r3, @r5                               ! two_player_flag = 0 (select 1P)
    bra     .L_init_and_trigger                 ! -> proceed to car init + sound trigger
    nop                                         ! (delay)
.L_check_up_button:
    mov.w @(2, r4), r0                          ! r0 = button_flags word (re-read)
    mov.l   .L_pool_up_button_mask, r3          ! r3 = 0x8000 (Up button mask, bit 15)
    mov r0, r2                                  ! r2 = button_flags (copy)
    extu.w r2, r2                               ! r2 = zero-extend to 32-bit
    and r3, r2                                  ! r2 = button_flags & 0x8000 (Up pressed?)
    tst r2, r2                                  ! is Up button pressed?
    bt      .L_init_and_trigger                 ! no -> skip, leave flag unchanged
    mov #0x1, r3                                ! r3 = 1 (2P mode)
    mov.b r3, @r5                               ! two_player_flag = 1 (select 2P)
.L_init_and_trigger:
    .byte   0xBF, 0x40    /* bsr 0x0601A65E (external) */  ! call car_init_handler
    nop                                         ! (delay)
    .byte   0xAF, 0xAE    /* bra 0x0601A73E (external) */  ! tail-jump to race_start_sound_trigger
    lds.l @r15+, pr                             ! (delay) restore PR
.L_w_down_btn_mask:
    .2byte  0x4000                             /* [HIGH] Down button mask (bit 14) */
    .4byte  sym_06085FF6                       /* (unused pool entry) */
    .4byte  sym_06012EC4                       /* (unused pool entry) */
    .4byte  sym_06012F00                       /* (unused pool entry) */
    .4byte  sym_06085FF7                       /* (unused pool entry) */
    .4byte  race_variant_e                     /* (unused pool entry) */
    .4byte  0xAE0001FF                         /* (unused pool entry) */
    .4byte  sound_cmd_dispatch                 /* (unused pool entry) */
.L_pool_two_player_flag:
    .4byte  sym_0605D241                       /* [HIGH] two-player mode flag (byte, 0=1P, 1=2P) */
.L_pool_input_state:
    .4byte  g_pad_state                       /* [HIGH] held button state struct */
.L_pool_up_button_mask:
    .4byte  0x00008000                         /* [HIGH] Up button mask (bit 15, 32-bit for AND) */
