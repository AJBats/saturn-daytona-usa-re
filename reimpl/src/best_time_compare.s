/* best_time_compare -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06013A74 - 0x06013B04
 * Auto-generated by tools/generate_l3_tu.py
 */

/*
 * best_time_compare â€” End-of-race best-time check and countdown handler
 *
 * Calls the five per-frame rendering/physics passes in sequence (bg render,
 * per-car variant render, camera interpolation, dynamic-object physics,
 * and race variant setup), then branches on the current game mode word
 * (sym_06063D9E == 0x10 selects one sub-path vs. the other) to invoke
 * either race_variant_setup_c or camera_track_update.  After that it
 * calls adv_collision_resp, checks a button-state mask (0x0800), and
 * manages a 16-bit countdown field (sym_06084AF0) for a post-race wait
 * loop.  When the counter reaches zero or the car count threshold (4) is
 * already met, it tail-calls track_wall_collision to exit the sequence.
 *
 * loc_06013ADA is a separate entry point (externally referenced) that
 * writes a mode byte (0x05) into sym_06084AF2, resets sym_06084AF6 to
 * zero, and tail-calls into the next function (0x06013B04).
 *
 * Registers on entry: none required (callee-saved PR on stack).
 * Returns: via RTS (normal exit) or tail-call to track_wall_collision.
 */

    .section .text.FUN_06013A74


    .global best_time_compare
    .type best_time_compare, @function
best_time_compare:
    sts.l pr, @-r15                       ! save return address (PR) on stack
    .byte   0xB4, 0x73    /* bsr 0x06014360 (external) */  ! call multi_obj_physics
    nop                                   ! (delay slot)
    .byte   0xB3, 0x77    /* bsr 0x0601416C (external) */  ! call race_variant_setup_a
    nop                                   ! (delay slot)
    .byte   0xB3, 0xE5    /* bsr 0x0601424C (external) */  ! call camera_angle_interp
    nop                                   ! (delay slot)
    .byte   0xB3, 0x1F    /* bsr 0x060140C4 (external) */  ! call dyn_obj_physics
    nop                                   ! (delay slot)
    .byte   0xB4, 0xE1    /* bsr 0x0601444C (external) */  ! call race_variant_setup_b
    nop                                   ! (delay slot)
    mov.l   .L_pool_mode_word, r0         ! r0 = &game_mode_word (sym_06063D9E)
    mov.w @r0, r0                         ! r0 = game_mode_word (16-bit load)
    extu.w r0, r0                         ! zero-extend to 32 bits
    cmp/eq #0x10, r0                      ! mode == 0x10 (attract/demo mode)?
    bf      .L_mode_not_attract           ! if not 0x10, branch to other path
    .byte   0xB4, 0xE7    /* bsr 0x06014466 (external) */  ! call race_variant_setup_c (attract path)
    nop                                   ! (delay slot)
    bra     .L_after_mode_branch          ! skip alternate path
    nop                                   ! (delay slot)
.L_mode_not_attract:
    .byte   0xB5, 0x36    /* bsr 0x0601450C (external) */  ! call camera_track_update (non-attract path)
    nop                                   ! (delay slot)
.L_after_mode_branch:
    .byte   0xB5, 0x8C    /* bsr 0x060145BC (external) */  ! call adv_collision_resp
    nop                                   ! (delay slot)
    mov.l   .L_pool_btn_state, r2         ! r2 = &new_button_presses (sym_06063D9A)
    mov.w @r2, r3                         ! r3 = new_button_presses (16-bit)
    mov.w   .L_wpool_btn_mask, r2         ! r2 = 0x0800 (button mask)
    extu.w r3, r3                         ! zero-extend button state
    and r2, r3                            ! r3 = btn_state & 0x0800
    tst r3, r3                            ! any masked button pressed?
    bt      .L_skip_wall_call             ! if zero (no press), skip wall collision call
    .byte   0xB6, 0x0E    /* bsr 0x060146D2 (external) */  ! call track_wall_collision (button pressed)
    nop                                   ! (delay slot)
.L_skip_wall_call:
    mov #0x4, r3                          ! r3 = 4 (car count threshold)
    mov.l   .L_pool_active_car_count, r2  ! r2 = &active_car_count (sym_06084B18)
    mov.l @r2, r2                         ! r2 = active_car_count (32-bit load)
    cmp/hs r3, r2                         ! active_car_count >= 4?
    bt      .L_tail_wall_call             ! if so, tail-call exit immediately
    mov.l   .L_pool_countdown, r3         ! r3 = &countdown_timer (sym_06084AF0)
    mov.l   .L_pool_countdown, r2         ! r2 = &countdown_timer (sym_06084AF0, second copy for write)
    mov.w @r3, r3                         ! r3 = countdown_timer (16-bit load)
    add #-0x1, r3                         ! r3 = countdown_timer - 1
    mov.w r3, @r2                         ! countdown_timer -= 1 (write back)
    exts.w r3, r3                         ! sign-extend to 32 bits
    cmp/pl r3                             ! countdown_timer > 0?
    bt      .L_return_normal              ! if still positive, return normally
.L_tail_wall_call:
    .byte   0xA5, 0xFF    /* bra 0x060146D2 (external) */  ! tail-call track_wall_collision (counter expired)
    lds.l @r15+, pr                       ! (delay) restore PR before tail-call
.L_return_normal:
    lds.l @r15+, pr                       ! restore PR
    rts                                   ! return to caller
    nop                                   ! (delay slot)

    .global loc_06013ADA
loc_06013ADA:
    ! Entry point: initialise post-race mode fields and jump to ranking pipeline
    mov #0x5, r3                          ! r3 = 0x05 (post-race mode byte)
    mov.l   .L_pool_mode_byte_ptr, r2     ! r2 = &post_race_mode_byte (sym_06084AF2)
    mov.b r3, @r2                         ! post_race_mode_byte = 0x05
    mov #0x0, r3                          ! r3 = 0
    mov.l   .L_pool_wait_counter_ptr, r2  ! r2 = &wait_counter (sym_06084AF6)
    mov.w r3, @r2                         ! wait_counter = 0
    .byte   0xA0, 0x0D    /* bra 0x06013B04 (external) */  ! tail-call ranking_pts_calc
    nop                                   ! (delay slot)
.L_wpool_btn_mask:
    .2byte  0x0800                        /* button mask: bit 11 (Start / action button) */
.L_pool_mode_word:
    .4byte  sym_06063D9E                  /* game mode word (0x10 = attract/demo mode) */
.L_pool_btn_state:
    .4byte  sym_06063D9A                  /* new button presses (edge-triggered, per-frame) */
.L_pool_active_car_count:
    .4byte  sym_06084B18                  /* active car count in race (32-bit) */
.L_pool_countdown:
    .4byte  sym_06084AF0                  /* post-race countdown timer (16-bit, counts down to 0) */
.L_pool_mode_byte_ptr:
    .4byte  sym_06084AF2                  /* post-race mode byte (set to 0x05 at loc_06013ADA) */
.L_pool_wait_counter_ptr:
    .4byte  sym_06084AF6                  /* post-race wait counter (reset to 0 at loc_06013ADA) */
