/* race_resource_init -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0600A0C0 - 0x0600A140
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Race Resource Initialization (128 bytes)
 *
 * Sets up display channels, scroll planes, screen coordinate bounds,
 * and DMA configuration for a race scene transition. This is a lighter
 * version of disc_load_mgr — it configures the display pipeline without
 * loading disc resources.
 *
 * Sequence:
 *   1. channel_nibble_config(0x0100, 0) — clear channel priority nibble
 *   2. camera_finalize() — finalize camera state
 *   3. Clear animation state (sym_06059F44 = 0)
 *   4. vdp2_scroll_update(car_struct_base) — set up VDP2 scroll planes
 *   5. vdp1_erase_window_set(0, 0, 0, 351) with 223 on stack — screen bounds
 *   6. Clear DMA config state (sym_0605A008 = 0)
 *   7. Write 0.5 fixed-point (0x8000) to car struct array base
 *   8. camera_finalize() — re-finalize after scroll update
 *   9. Clear animation state again (sym_06059F44 = 0)
 *
 * Register usage:
 *   r14 = 0 (persistent zero, used for clearing state variables)
 *   r3  = scratch (function pointers, memory addresses)
 *   r4  = first argument to called functions
 *   r5  = second argument / zero
 *   r6  = zero (screen coord Y origin)
 *   r7  = screen width - 1 (351)
 */

    .section .text.FUN_0600A0C0


    .global race_resource_init
    .type race_resource_init, @function
race_resource_init:
    mov.l r14, @-r15                           ! save r14 (callee-saved)
    sts.l pr, @-r15                            ! save return address

    ! --- Step 1: Clear channel priority nibble for bit 0x0100 ---
    mov.w   .L_w_channel_bitmask, r4              ! r4 = 0x0100 (channel bitmask: Array A word[0] low nibble)
    mov.l   .L_fn_channel_nibble_config, r3    ! r3 = &channel_nibble_config
    jsr @r3                                    ! channel_nibble_config(0x0100, 0)
    mov #0x0, r5                               ! r5 = 0 (nibble value — delay slot)

    ! --- Step 2: Finalize camera state ---
    mov.l   .L_fn_camera_finalize, r3          ! r3 = &camera_finalize (sym_06026CE0)
    jsr @r3                                    ! camera_finalize()
    nop                                        ! delay slot (no useful work)

    ! --- Step 3: Clear animation state ---
    mov #0x0, r14                              ! r14 = 0 (persistent zero for clearing state)
    mov.l   .L_ptr_anim_state, r3              ! r3 = &animation_state (sym_06059F44)
    mov.l r14, @r3                             ! animation_state = 0

    ! --- Step 4: Update VDP2 scroll planes ---
    mov.l   .L_ptr_car_struct_base, r4         ! r4 = &car_struct_base (sym_06063F5C, arg)
    mov.l   .L_fn_vdp2_scroll_update, r3      ! r3 = &vdp2_scroll_update
    jsr @r3                                    ! vdp2_scroll_update(car_struct_base)
    nop                                        ! delay slot

    ! --- Step 5: Set VDP1 erase window screen bounds ---
    mov.w   DAT_0600a110, r2                   ! r2 = 0x00DF (screen height - 1 = 223)
    mov r14, r6                                ! r6 = 0 (Y origin)
    mov r14, r5                                ! r5 = 0 (X origin)
    mov.l r2, @-r15                            ! push screen height onto stack (5th arg)
    mov.w   DAT_0600a112, r7                   ! r7 = 0x015F (screen width - 1 = 351)
    mov.l   .L_fn_erase_window_set, r3        ! r3 = &vdp1_erase_window_set (sym_060393FC)
    jsr @r3                                    ! vdp1_erase_window_set(0, 0, 0, 351) [+stack: 223]
    mov r14, r4                                ! r4 = 0 (delay slot)

    ! --- Step 6: Clear DMA config state ---
    mov.l   .L_ptr_dma_config, r3             ! r3 = &dma_config_state (sym_0605A008)
    mov.l r14, @r3                             ! dma_config_state = 0

    ! --- Step 7: Write 0.5 FP to car struct array base ---
    mov.l   .L_ptr_car_struct_base, r2         ! r2 = &car_struct_base ptr (sym_06063F5C)
    mov.l   .L_fp_half, r3                     ! r3 = 0x00008000 (0.5 in 16.16 fixed-point)
    mov.l @r2, r2                              ! r2 = car_struct_base (dereference pointer)
    mov.w r3, @r2                              ! *(u16*)car_struct_base = 0x8000

    ! --- Step 8: Re-finalize camera state ---
    mov.l   .L_fn_camera_finalize, r3          ! r3 = &camera_finalize (sym_06026CE0)
    jsr @r3                                    ! camera_finalize()
    add #0x4, r15                              ! pop stack arg from step 5 (delay slot)

    ! --- Step 9: Clear animation state again ---
    mov.l   .L_ptr_anim_state, r3              ! r3 = &animation_state (sym_06059F44)
    mov.l r14, @r3                             ! animation_state = 0

    ! --- Epilogue ---
    lds.l @r15+, pr                            ! restore return address
    rts                                        ! return to caller
    mov.l @r15+, r14                           ! restore r14 (delay slot)

    .global DAT_0600a10c
DAT_0600a10c:
    mov.b @(r0, r11), r0
.L_w_channel_bitmask:
    .2byte  0x0100                     /* [HIGH] channel priority bitmask */

    .global DAT_0600a110
DAT_0600a110:
    .2byte  0x00DF                     /* screen height - 1 (223) */

    .global DAT_0600a112
DAT_0600a112:
    .2byte  0x015F                     /* screen width - 1 (351) */
    .4byte  sym_0607E944               /* (adjacent TU pool entry) */
    .4byte  display_channel_b          /* (adjacent TU pool entry) */
    .4byte  sym_0607EBC8               /* (adjacent TU pool entry) */
.L_fn_channel_nibble_config:
    .4byte  channel_nibble_config      /* [HIGH] channel priority nibble config fn */
.L_fn_camera_finalize:
    .4byte  sym_06026CE0               /* [HIGH] display update / palette commit fn */
.L_ptr_anim_state:
    .4byte  sym_06059F44               /* [HIGH] VBlank-OUT counter / animation state */
.L_ptr_car_struct_base:
    .4byte  sym_06063F5C               /* [HIGH] VDP1 command buffer base pointer */
.L_fn_vdp2_scroll_update:
    .4byte  vdp2_scroll_update         /* [HIGH] VDP2 scroll plane update fn */
.L_fn_erase_window_set:
    .4byte  sym_060393FC               /* [HIGH] vdp1_erase_window_set fn */
.L_ptr_dma_config:
    .4byte  sym_0605A008               /* [HIGH] frame counter / DMA config state */
.L_fp_half:
    .4byte  0x00008000                 /* [HIGH] 0.5 (16.16 fixed-point) */
