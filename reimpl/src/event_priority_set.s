/* event_priority_set -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06040AF8 - 0x06040B34
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Sets the priority field on an event descriptor by dispatching
 * through evt_state_dispatch.  The priority offset (0x10) is
 * obtained from the local helper .L_get_priority_offset.
 *
 * Entry: event_priority_set(r4 = event_desc)
 *   r4 -- event descriptor struct pointer
 *
 * Flow:
 *   1. Call .L_get_priority_offset to get the priority field offset (0x10).
 *   2. If offset is zero, return 0 (failure â€” should not happen).
 *   3. Call evt_state_dispatch(r4 = priority_offset, r5 = event_desc)
 *      to apply the priority to the event.
 *   4. If dispatch returns zero, return 0 (failure).
 *   5. Otherwise return the priority offset (success).
 *
 * Returns: r0 = priority offset (0x10) on success, 0 on failure
 */

    .section .text.FUN_06040AF8


    .global event_priority_set
    .type event_priority_set, @function
event_priority_set:
    mov.l r14, @-r15                             ! save r14
    sts.l pr, @-r15                              ! save return address
    add #-0x4, r15                               ! allocate 4-byte stack frame
    bsr     .L_get_priority_offset               ! call helper -> r0 = 0x10 (priority offset)
    mov.l r4, @r15                               ! stack[+0x00] = event_desc (r4) [delay slot]
    mov r0, r14                                  ! r14 = priority_offset (0x10)
    tst r14, r14                                 ! priority_offset == 0?
    bf      .L_offset_valid                      ! if non-zero -> offset is valid
    mov #0x0, r0                                 ! r0 = 0 (failure)
    add #0x4, r15                                ! deallocate stack frame
    lds.l @r15+, pr                              ! restore return address
    rts                                          ! return failure
    mov.l @r15+, r14                             ! restore r14 [delay slot]
.L_offset_valid:
    mov.l @r15, r5                               ! r5 = event_desc (reload from stack)
    .byte   0xB0, 0x7C    /* bsr 0x06040C10 (external: evt_state_dispatch) */
    mov r14, r4                                  ! r4 = priority_offset [delay slot]
    mov r0, r4                                   ! r4 = dispatch result
    tst r4, r4                                   ! dispatch result == 0?
    bf      .L_dispatch_ok                       ! if non-zero -> dispatch succeeded
    mov #0x0, r0                                 ! r0 = 0 (failure)
    add #0x4, r15                                ! deallocate stack frame
    lds.l @r15+, pr                              ! restore return address
    rts                                          ! return failure
    mov.l @r15+, r14                             ! restore r14 [delay slot]
.L_dispatch_ok:
    mov r14, r0                                  ! r0 = priority_offset (success value)
    add #0x4, r15                                ! deallocate stack frame
    lds.l @r15+, pr                              ! restore return address
    rts                                          ! return success
    mov.l @r15+, r14                             ! restore r14 [delay slot]
.L_get_priority_offset:
    mov #0x10, r0                                ! r0 = 0x10 (priority field offset in event struct)
