/* obj_visibility_test -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0602052C - 0x0602070C
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Object visibility setup for scene transitions. Configures display layers,
 * loads palettes into VDP2 CRAM, copies display list segments from the
 * obj/replay struct, sets up display channels, and computes viewport
 * draw coordinates (x/y) from fixed-point scale values via fpmul/fpdiv.
 *
 * Phase 1: Display layer init — render_state_commit, gameover_channel_setup,
 *          display_layer_cfg(0xC), display_layer_cfg(0x4)
 * Phase 2: Palette DMA — 4x memcpy_word_idx into VDP2 CRAM banks
 * Phase 3: Display list copy — 3x display_list_copy from obj struct fields
 * Phase 4: Channel enable — display_channel_b(0x20/0x8/0x4), channel_nibble x5
 * Phase 5: Viewport calc — scale → fpmul(176/112) → fpdiv → draw coords
 * Phase 6: Scene finalize — scene_color_intensity, scene_data_write_add, commit
 */

    .section .text.FUN_0602052C


    .global obj_visibility_test
    .type obj_visibility_test, @function
obj_visibility_test:
    mov.l r14, @-r15
    mov r4, r0                              ! r0 = obj index arg
    mov #0x3, r3
    mov.l r13, @-r15
    sts.l pr, @-r15
    add #-0x8, r15                          ! allocate 0x8 bytes on stack
    mov.b r0, @(4, r15)                     ! save obj index on stack
    mov.l   .L_display_timer, r2
    mov.w r3, @r2                           ! display_timer = 0x3
    mov.l   .L_fn_render_state_commit, r3   ! --- Phase 1: display layer init ---
    jsr @r3                                 ! render_state_commit()
    nop
    mov.l   .L_fn_gameover_channel, r3
    jsr @r3                                 ! gameover_channel_setup()
    nop
    mov.l   .L_fn_display_layer_cfg, r3
    jsr @r3                                 ! display_layer_cfg(0xC)
    mov #0xC, r4
    mov.l   .L_fn_display_layer_cfg, r3
    jsr @r3                                 ! display_layer_cfg(0x4)
    mov #0x4, r4
    mov.l   .L_fn_memcpy_word, r14          ! --- Phase 2: palette DMA to VDP2 CRAM ---
    mov.l   .L_pal_src_cram6E0, r5          ! r14 = memcpy_word_idx (reused)
    mov.l   .L_vdp2_cram_0x6E0, r4
    jsr @r14                                ! memcpy_word_idx(CRAM+0x6E0, pal_src, 0x20)
    mov #0x20, r6
    mov.l   .L_pal_src_cram300, r5
    mov.l   .L_vdp2_cram_0x300, r4
    jsr @r14                                ! memcpy_word_idx(CRAM+0x300, pal_src, 0x20)
    mov #0x20, r6
    mov #0x20, r6
    mov.l   .L_pal_src_cram400, r2
    mov.l r2, @r15                          ! save pal_src on stack (reused for 0x060)
    mov.l   .L_vdp2_cram_0x400, r4
    jsr @r14                                ! memcpy_word_idx(CRAM+0x400, pal_src, 0x20)
    mov r2, r5
    mov #0x20, r6
    mov.l   .L_vdp2_cram_0x060, r4
    jsr @r14                                ! memcpy_word_idx(CRAM+0x060, pal_src, 0x20)
    mov.l @r15, r5
    mov.l   .L_obj_struct_base, r13      ! --- Phase 3: display list copy from struct ---
    mov #0x0, r6                            ! r13 = obj struct base ptr
    mov.l   .L_fn_display_list_copy, r14    ! r14 = display_list_copy (reused)
    mov.w   .L_off_struct_0x558, r7
    add r13, r7                             ! r7 = &struct[0x558]
    mov.l r7, @r15                          ! save struct field ptr on stack
    mov.l @(4, r7), r7                      ! r7 = struct[0x55C] (size/len)
    mov.l   .L_fp_half, r3
    mov.l @r15, r5
    add r3, r7                              ! r7 += 0.5 (round up)
    mov.l @r5, r5                           ! r5 = struct[0x558] (src ptr)
    jsr @r14                                ! display_list_copy(0, src, size, 0)
    mov r6, r4
    mov.w   .L_off_struct_0x560, r7
    add r13, r7                             ! r7 = &struct[0x560]
    mov.l r7, @r15
    mov.l @(4, r7), r7                      ! r7 = struct[0x564] (size/len)
    mov.w   .L_copy_len_0x294, r6
    mov.l @r15, r5
    mov.l @r5, r5                           ! r5 = struct[0x560] (src ptr)
    jsr @r14                                ! display_list_copy(4, src, size, 0x294)
    mov #0x4, r4
    mov.w   .L_off_struct_0x550, r7
    add r13, r7                             ! r7 = &struct[0x550]
    mov.l r7, @r15
    mov.l @(4, r7), r7                      ! r7 = struct[0x554] (size/len)
    mov.w   .L_fp_adj_0x6000, r3
    mov.w   .L_copy_len_0x82, r6
    mov.l @r15, r5
    add r3, r7                              ! r7 += 0x6000 adjustment
    mov.l @r5, r5                           ! r5 = struct[0x550] (src ptr)
    jsr @r14                                ! display_list_copy(0xC, src, size, 0x82)
    mov #0xC, r4
    mov #0x0, r6                            ! --- Phase 4: enable display channels ---
    mov.l   .L_fn_display_channel_b, r14    ! r14 = display_channel_b (reused)
    mov r6, r5
    jsr @r14                                ! display_channel_b(0x20, 0, 0)
    mov #0x20, r4
    mov #0x0, r6
    mov r6, r5
    jsr @r14                                ! display_channel_b(0x8, 0, 0)
    mov #0x8, r4
    mov #0x0, r6
    mov r6, r5
    jsr @r14                                ! display_channel_b(0x4, 0, 0)
    mov #0x4, r4
    mov.l   .L_fn_channel_nibble, r14       ! r14 = channel_nibble_config (reused)
    mov.w   .L_chan_id_0x100, r4
    jsr @r14                                ! channel_nibble(0x100, 0)
    mov #0x0, r5
    mov #0x4, r5
    jsr @r14                                ! channel_nibble(4, 4) — delay slot sets r4=r5
    mov r5, r4
    mov #0x5, r5
    jsr @r14                                ! channel_nibble(0x8, 5)
    mov #0x8, r4
    mov #0x6, r5
    bra     .L_channel_setup_cont           ! channel_nibble(0x10, 6) — continues after pool
    mov #0x10, r4
.L_off_struct_0x558:
    .2byte  0x0558                          /* struct offset: display list A ptr */
.L_off_struct_0x560:
    .2byte  0x0560                          /* struct offset: display list B ptr */
.L_copy_len_0x294:
    .2byte  0x0294                          /* copy length for list B */
.L_off_struct_0x550:
    .2byte  0x0550                          /* struct offset: display list C ptr */
.L_fp_adj_0x6000:
    .2byte  0x6000                          /* size adjustment for list C */
.L_copy_len_0x82:
    .2byte  0x0082                          /* copy length for list C */
.L_chan_id_0x100:
    .2byte  0x0100                          /* channel ID for nibble config */
.L_display_timer:
    .4byte  sym_06087804                    /* display timer (16-bit word) */
.L_fn_render_state_commit:
    .4byte  sym_06028560                    /* render state commit / clear */
.L_fn_gameover_channel:
    .4byte  gameover_channel_setup          /* game-over channel setup */
.L_fn_display_layer_cfg:
    .4byte  sym_0602853E                    /* display layer fill config */
.L_fn_memcpy_word:
    .4byte  memcpy_word_idx                 /* word-indexed memcpy */
.L_pal_src_cram6E0:
    .4byte  sym_0604898C                    /* palette source for CRAM +0x6E0 */
.L_vdp2_cram_0x6E0:
    .4byte  0x25F006E0                      /* VDP2 color RAM +0x6E0 */
.L_pal_src_cram300:
    .4byte  sym_060489AC                    /* palette source for CRAM +0x300 */
.L_vdp2_cram_0x300:
    .4byte  0x25F00300                      /* VDP2 color RAM +0x300 */
.L_pal_src_cram400:
    .4byte  sym_060489CC                    /* palette source for CRAM +0x400 */
.L_vdp2_cram_0x400:
    .4byte  0x25F00400                      /* VDP2 color RAM +0x400 */
.L_vdp2_cram_0x060:
    .4byte  0x25F00060                      /* VDP2 color RAM +0x060 */
.L_obj_struct_base:
    .4byte  sym_06063750                    /* obj/replay struct base ptr */
.L_fn_display_list_copy:
    .4byte  sym_06028400                    /* display list copy function */
.L_fp_half:
    .4byte  0x00008000                      /* 0.5 (16.16 fixed-point) */
.L_fn_display_channel_b:
    .4byte  display_channel_b               /* display channel enable */
.L_fn_channel_nibble:
    .4byte  channel_nibble_config           /* channel nibble configuration */
.L_channel_setup_cont:                      ! --- Phase 4 continued (after pool) ---
    jsr @r14                                ! channel_nibble(0x10, 6) — r4/r5 set before bra
    nop
    mov #0x7, r5
    jsr @r14                                ! channel_nibble(0x20, 7)
    mov #0x20, r4
    mov #0x1, r2
    mov.l   .L_obj_mode_flag, r3
    mov.b r2, @r3                           ! obj_mode_flag = 1 (visibility enabled)
    mov.b @(4, r15), r0                     ! r0 = saved obj index from stack
    mov r0, r4
    .byte   0xB3, 0xC9    /* bsr 0x06020DEE (external) — clear obj anim fields */
    extu.b r4, r4
    mov.l   .L_obj_scale_z, r14            ! --- Phase 5: viewport draw coord calc ---
    mov.l   .L_fp_four, r2                 ! r14 = &obj_scale_z
    mov.l r2, @r14                          ! scale_z = 4.0
    mov r2, r3
    mov.l   .L_obj_scale_x, r2
    mov.l r3, @r2                           ! scale_x = 4.0
    mov.l @r14, r3
    mov.l   .L_obj_scale_y, r2
    mov.l r3, @r2                           ! scale_y = 4.0 (all axes uniform)
    mov.l   .L_fp_three, r5                ! r5 = 3.0 (near plane)
    mov.l   .L_fp_176, r4                  ! r4 = 176.0 (half screen width)
    mov.l   .L_fn_fpmul, r3
    jsr @r3                                 ! r0 = fpmul(176.0, 3.0) = 528.0
    nop
    mov r0, r4                              ! r4 = 528.0
    mov.l   .L_fn_fpdiv, r3
    jsr @r3                                 ! r0 = fpdiv(528.0, scale_z)
    mov.l @r14, r5                          ! r5 = scale_z (4.0)
    mov.l   .L_obj_draw_x, r3
    mov.l r0, @r3                           ! draw_x = 528.0 / 4.0 = 132.0
    mov.l @r14, r5
    mov.l   .L_fp_neg_one, r2
    mov.l   .L_fp_112, r4                  ! r4 = 112.0 (half screen height)
    mov.l   .L_fn_fpmul, r3
    jsr @r3                                 ! r0 = fpmul(112.0, scale_z - 1.0)
    add r2, r5                              ! r5 = scale_z - 1.0 = 3.0
    mov r0, r4                              ! r4 = 336.0
    mov.l   .L_fn_fpdiv, r3
    jsr @r3                                 ! r0 = fpdiv(336.0, scale_z)
    mov.l @r14, r5                          ! r5 = scale_z (4.0)
    mov.l   .L_obj_draw_y, r3
    mov.l r0, @r3                           ! draw_y = 336.0 / 4.0 = 84.0
    mov.l   .L_fn_cmd_queue_init, r3        ! --- Phase 6: scene finalize ---
    jsr @r3                                 ! cmd_queue_init(0x8)
    mov #0x8, r4
    mov.l   .L_obj_scale_y, r5
    mov.l   .L_obj_scale_x, r4
    mov.l   .L_fn_color_intensity, r3
    mov.l @r5, r5                           ! r5 = scale_y
    jsr @r3                                 ! scene_color_intensity(scale_x, scale_y)
    mov.l @r4, r4                           ! r4 = scale_x
    mov #0x0, r6
    mov.l   .L_obj_draw_y, r5
    mov.l   .L_obj_draw_x, r4
    mov.l   .L_fn_scene_write_add, r3
    mov.l @r5, r5                           ! r5 = draw_y
    jsr @r3                                 ! scene_data_write_add(draw_x, draw_y, 0)
    mov.l @r4, r4                           ! r4 = draw_x
    add #0x8, r15                           ! free stack frame
    lds.l @r15+, pr
    mov.l @r15+, r13
    mov.l   .L_fn_cmd_queue_commit, r3
    jmp @r3                                 ! tailcall: cmd_queue_commit()
    mov.l @r15+, r14
.L_obj_mode_flag:
    .4byte  sym_06059F6F                    /* obj visibility mode flag (byte) */
.L_obj_scale_z:
    .4byte  sym_06087820                    /* obj scale Z (16.16 fp) */
.L_fp_four:
    .4byte  0x00040000                      /* 4.0 (16.16 fixed-point) */
.L_obj_scale_x:
    .4byte  sym_06087818                    /* obj scale X (16.16 fp) */
.L_obj_scale_y:
    .4byte  sym_0608781C                    /* obj scale Y (16.16 fp) */
.L_fp_three:
    .4byte  0x00030000                      /* 3.0 (16.16 fixed-point) */
.L_fp_176:
    .4byte  0x00B00000                      /* 176.0 (16.16 fp) — half screen width */
.L_fn_fpmul:
    .4byte  fpmul                           /* fixed-point multiply */
.L_fn_fpdiv:
    .4byte  fpdiv_setup                     /* fixed-point divide */
.L_obj_draw_x:
    .4byte  sym_06087810                    /* obj draw X coordinate (16.16 fp) */
.L_fp_neg_one:
    .4byte  0xFFFF0000                      /* -1.0 (16.16 fixed-point) */
.L_fp_112:
    .4byte  0x00700000                      /* 112.0 (16.16 fp) — half screen height */
.L_obj_draw_y:
    .4byte  sym_06087814                    /* obj draw Y coordinate (16.16 fp) */
.L_fn_cmd_queue_init:
    .4byte  sym_0603850C                    /* display cmd queue: init */
.L_fn_color_intensity:
    .4byte  scene_color_intensity           /* scene color intensity */
.L_fn_scene_write_add:
    .4byte  scene_data_write_add            /* scene data write (additive) */
.L_fn_cmd_queue_commit:
    .4byte  sym_06038520                    /* display cmd queue: commit */
