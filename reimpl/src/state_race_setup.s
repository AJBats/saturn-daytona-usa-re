/* state_race_setup -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008EBC - 0x06009098
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Race setup state handler — initializes all subsystems for a new race.
 * Called when transitioning into the race-preparing state (game_state=0xF).
 *
 * Initialization sequence:
 *   1. race_resource_init() — load course/car resources
 *   2. Clear race result, set active flag, physics frame count = 8
 *   3. Auto-select course from status register (if game_mode == 0x8000
 *      and no special mode or overlay active)
 *   4. vdp2_config_extended() + geom_output_finalize()
 *   5. Set sound mode (3 or 4 based on mode register)
 *   6. race_init_master() — initialize race state machine
 *   7. hud_post_update(hud_variant) + hud_subsystem_init() + disp_init_setup()
 *   8. Set countdown timer = 150 frames (0x96)
 *   9. Dispatch race variant setup via jump table[race_end_state]
 *  10. race_start_init() + bg_layer_init() + geom_matrix_setup()
 *  11. If overlay active: menu_overlay_render(1)
 *  12. Set game_state = 0xF, render_flags |= 0x40000000
 *  13. Clear camera follow flag, set state_word = 3, course_loaded = 0
 *
 * Persistent registers:
 *   r13 = 3 (sound mode / state_word constant)
 *   r14 = 0 (zero constant, used for clearing state)
 */

    .section .text.FUN_06008EBC


    .global state_race_setup
    .type state_race_setup, @function
state_race_setup:
    mov.l r14, @-r15                  /* save r14 */
    mov.l r13, @-r15                  /* save r13 */
    sts.l pr, @-r15                   /* save return address */
    mov #0x3, r13                     /* r13 = 3 (sound mode / state word) */
    mov.l   .L_fn_race_resource_init, r3 /* r3 = &race_resource_init */
    jsr @r3                            /* race_resource_init() */
    mov #0x0, r14                     /* r14 = 0 (clear constant) */
    extu.b r14, r2                    /* r2 = 0 (zero-extended byte) */
    mov.l   .L_race_result_byte, r3   /* r3 = &race_result */
    mov #0x1, r6                      /* r6 = 1 (active flag value) */
    mov #0x8, r0                      /* r0 = 8 (physics warmup frames) */
    mov.b r2, @r3                     /* race_result = 0 */
    extu.b r6, r1                     /* r1 = 1 (zero-extended byte) */
    mov.l   .L_race_active_flag, r3   /* r3 = &race_active */
    mov.b r1, @r3                     /* race_active = 1 */
    mov.l   .L_physics_frame_count, r3 /* r3 = &physics_frame_count */
    mov.l r0, @r3                     /* physics_frame_count = 8 */
    mov.l   .L_game_mode_word, r0     /* --- auto-select course check --- */
    mov.l   .L_fp_half, r3           /* 0x8000 = specific game mode */
    mov.w @r0, r0                     /* r0 = game_mode (16-bit) */
    extu.w r0, r0                     /* zero-extend to 32-bit */
    cmp/eq r3, r0                     /* game_mode == 0x8000? */
    bf      .L_subsys_init           /* no → skip course auto-select */
    mov.l   .L_special_mode_flag, r0  /* r0 = &special_mode_flag */
    mov.l @r0, r0                     /* r0 = special_mode_flag */
    tst r0, r0                        /* special_mode == 0? */
    bf      .L_subsys_init              /* special mode active → skip */
    mov.l   .L_overlay_active, r0    /* r0 = &overlay_active */
    mov.b @r0, r0                     /* r0 = overlay_active (byte) */
    tst r0, r0                        /* overlay == 0? */
    bf      .L_subsys_init              /* overlay active → skip */
    mov.l   .L_status_word, r4       /* r4 = &status_word --- course selection from status bits --- */
    mov.l   .L_course_index, r5      /* r5 = &course_index (persists through mask checks) */
    mov.l   .L_course_mask_a, r2     /* r2 = &course_mask_a */
    mov.w @r4, r4                    /* r4 = status word (16-bit) */
    mov.w @r2, r2                    /* r2 = course mask A */
    exts.w r4, r3                     /* r3 = status (sign-extended) */
    extu.w r2, r2                     /* r2 = mask_a (zero-extended) */
    and r2, r3                        /* r3 = status & mask_a */
    tst r3, r3                        /* result == 0? */
    bt      .L_check_mask_b              /* mask A clear → check mask B */
    bra     .L_subsys_init              /* mask A set → course 0 (default) */
    mov.b r14, @r5                   /* course_index = 0 */
.L_check_mask_b:                             /* --- check course mask B --- */
    exts.w r4, r2                     /* r2 = status (sign-extended) */
    mov.l   .L_course_mask_b, r3     /* r3 = &course_mask_b */
    mov.w @r3, r3                    /* r3 = course mask B */
    extu.w r3, r3                     /* r3 = mask_b (zero-extended) */
    and r3, r2                        /* r2 = status & mask_b */
    tst r2, r2                        /* result == 0? */
    bt      .L_check_mask_c              /* mask B clear → check mask C */
    exts.b r6, r6                     /* r6 = 1 (sign-extended byte) */
    bra     .L_subsys_init
    mov.b r6, @r5                    /* course_index = 1 */
.L_check_mask_c:                             /* --- check course mask C --- */
    exts.w r4, r2                     /* r2 = status (sign-extended) */
    mov.l   .L_course_mask_c, r3     /* r3 = &course_mask_c */
    mov.w @r3, r3                    /* r3 = course mask C */
    extu.w r3, r3                     /* r3 = mask_c (zero-extended) */
    and r3, r2                        /* r2 = status & mask_c */
    tst r2, r2                        /* result == 0? */
    bt      .L_check_mask_d              /* mask C clear → check mask D */
    mov #0x2, r3                      /* r3 = 2 (course index for mask C) */
    mov.b r3, @r5                    /* course_index = 2 */
    bra     .L_subsys_init            /* → subsystem init */
    nop                               /* (delay slot) */
.L_fn_race_resource_init:
    .4byte  race_resource_init         /* course/car resource loader */
.L_race_result_byte:
    .4byte  sym_06078635               /* race result (0=in progress) */
.L_race_active_flag:
    .4byte  sym_06078634               /* race active flag (1=active) */
.L_physics_frame_count:
    .4byte  sym_0607ED88               /* physics warmup frame counter */
.L_game_mode_word:
    .4byte  sym_0607865E               /* game mode selector (16-bit) */
.L_fp_half:
    .4byte  0x00008000                  /* 0.5 (16.16 fixed-point) */
.L_special_mode_flag:
    .4byte  sym_0605AD08               /* special game mode flag */
.L_overlay_active:
    .4byte  sym_0605AB18               /* menu overlay active flag (byte) */
.L_status_word:
    .4byte  g_pad_state               /* input/status register (16-bit) */
.L_course_index:
    .4byte  sym_06078648               /* current course index (byte) */
.L_course_mask_a:
    .4byte  sym_06078656               /* course 0 selection bit mask */
.L_course_mask_b:
    .4byte  sym_06078658               /* course 1 selection bit mask */
.L_course_mask_c:
    .4byte  sym_0607865A               /* course 2 selection bit mask */
.L_check_mask_d:                              /* --- check course mask D --- */
    exts.w r4, r4                     /* r4 = status (sign-extended) */
    mov.l   .L_course_mask_d, r2     /* r2 = &course_mask_d */
    mov.w @r2, r2                    /* r2 = course mask D */
    extu.w r2, r2                     /* r2 = mask_d (zero-extended) */
    and r2, r4                        /* r4 = status & mask_d */
    tst r4, r4                        /* result == 0? */
    bt      .L_subsys_init              /* mask D clear → no auto-select */
    exts.b r13, r3                    /* r3 = 3 (course index for mask D) */
    mov.b r3, @r5                    /* course_index = 3 */
.L_subsys_init:                              /* === Subsystem initialization === */
    mov.l   .L_fn_vdp2_config, r3    /* r3 = &vdp2_config_extended */
    jsr @r3                            /* vdp2_config_extended() */
    nop                               /* (delay slot) */
    mov.l   .L_fn_geom_finalize, r3  /* r3 = &geom_output_finalize */
    jsr @r3                            /* geom_output_finalize() */
    nop                               /* (delay slot) */
    exts.b r13, r2                    /* r2 = 3 (default sound mode) */
    mov.l   .L_sound_mode, r4         /* r4 = &sound_mode */
    mov.b r2, @r4                     /* sound_mode = 3 */
    mov.l   .L_race_result_ref, r0   /* r0 = &race_result */
    mov.b @r0, r0                     /* check race result */
    extu.b r0, r0                     /* zero-extend to 32-bit */
    tst r0, r0                        /* race_result == 0? */
    bf      .L_race_master_init              /* result != 0 → keep mode 3 */
    mov.l   .L_mode_register, r0     /* r0 = &mode_register */
    mov.w @r0, r0                     /* r0 = mode_register (16-bit) */
    extu.w r0, r0                     /* zero-extend to 32-bit */
    tst r0, r0                        /* mode_register == 0? */
    bt      .L_race_master_init              /* mode register == 0 → keep mode 3 */
    mov #0x4, r3                      /* r3 = 4 (enhanced sound mode) */
    mov.b r3, @r4                     /* sound_mode = 4 (enhanced) */
.L_race_master_init:                              /* --- race master init --- */
    mov.l   .L_fn_race_init, r3      /* r3 = &race_init_master */
    jsr @r3                            /* race_init_master() */
    nop                               /* (delay slot) */
    mov.l   .L_hud_variant, r4       /* r4 = &hud_variant */
    mov.l   .L_fn_hud_post_update, r3 /* r3 = &hud_post_update */
    mov.b @r4, r4                     /* r4 = hud_variant (byte) */
    jsr @r3                            /* hud_post_update(hud_variant) */
    extu.b r4, r4                     /* (delay slot) zero-extend arg r4 */
    mov.l   .L_fn_hud_init, r3       /* r3 = &hud_subsystem_init */
    jsr @r3                            /* hud_subsystem_init() */
    nop                               /* (delay slot) */
    mov.l   .L_fn_disp_init, r3      /* r3 = &disp_init_setup */
    jsr @r3                            /* disp_init_setup() */
    nop                               /* (delay slot) */
    mov.w   .L_countdown_initial, r2  /* 0x96 = 150 frames */
    mov.l   .L_countdown_timer, r3   /* r3 = &countdown_timer */
    mov.l r2, @r3                     /* countdown_timer = 150 */
    mov.l   .L_race_end_state, r4    /* r4 = &race_end_state --- variant setup dispatch --- */
    mov.l   .L_variant_table, r3     /* r3 = variant_table base */
    mov.l   .L_fn_variant_dispatch, r2 /* r2 = &variant_dispatch */
    mov.l @r4, r4                    /* r4 = race_end_state index */
    shll2 r4                          /* index * 4 */
    add r3, r4                        /* &variant_table[state] */
    jsr @r2                            /* variant_dispatch(table[state]) */
    mov.l @r4, r4                     /* (delay slot) r4 = table[state] fn ptr */
    mov.l   .L_fn_race_start_init, r3 /* r3 = &race_start_init */
    jsr @r3                            /* race_start_init() */
    nop                               /* (delay slot) */
    mov.l   .L_fn_bg_layer_init, r3  /* r3 = &bg_layer_init */
    jsr @r3                            /* bg_layer_init() */
    nop                               /* (delay slot) */
    mov.l   .L_fn_geom_matrix, r3   /* r3 = &geom_matrix_setup */
    jsr @r3                            /* geom_matrix_setup() */
    nop                               /* (delay slot) */
    mov.l   .L_overlay_active_2, r0  /* r0 = &overlay_active */
    mov.b @r0, r0                     /* r0 = overlay_active (byte) */
    tst r0, r0                        /* overlay == 0? */
    bt      .L_final_state_setup              /* overlay not active → skip */
    mov.l   .L_fn_menu_overlay, r3   /* r3 = &menu_overlay_render */
    jsr @r3                            /* menu_overlay_render(1) */
    mov #0x1, r4                      /* (delay slot) arg r4 = 1 */
.L_final_state_setup:                              /* --- final state setup --- */
    mov #0xF, r2                      /* 0xF = race-preparing state */
    mov.l   .L_game_state, r3         /* r3 = &game_state */
    mov.l r2, @r3                     /* game_state = 0xF */
    mov.l   .L_render_flags, r4      /* r4 = &render_flags */
    mov.l   .L_render_flag_bit, r2   /* 0x40000000 = bit 30 */
    mov.l @r4, r3                     /* r3 = current render_flags */
    or r2, r3                         /* set bit 30 */
    mov.l r3, @r4                     /* render_flags |= 0x40000000 */
    mov.l   .L_fn_init_finalize, r3   /* r3 = &init_finalize */
    jsr @r3                            /* init_finalize() */
    nop                               /* (delay slot) */
    mov.l   .L_camera_follow_flag, r3 /* r3 = &camera_follow_flag */
    mov.l r14, @r3                    /* camera_follow_flag = 0 */
    mov.l   .L_state_word, r3         /* r3 = &state_word */
    mov.w r13, @r3                    /* state_word = 3 */
    mov.l   .L_course_loaded, r3     /* r3 = &course_loaded */
    mov.b r14, @r3                    /* course_loaded = 0 */
    lds.l @r15+, pr                   /* restore return address */
    mov.l @r15+, r13                  /* restore r13 */
    rts                               /* return */
    mov.l @r15+, r14                  /* (delay slot) restore r14 */
.L_countdown_initial:
    .2byte  0x0096                        /* 150 frames countdown */
    .2byte  0xFFFF                        /* padding for 4-byte alignment */
.L_course_mask_d:
    .4byte  sym_0607865C               /* course 3 selection bit mask */
.L_fn_vdp2_config:
    .4byte  vdp2_config_extended       /* VDP2 extended configuration */
.L_fn_geom_finalize:
    .4byte  geom_output_finalize       /* geometry output finalization */
.L_sound_mode:
    .4byte  sym_06078662               /* sound mode (3=normal, 4=enhanced) */
.L_race_result_ref:
    .4byte  sym_06078635               /* race result byte (dup for reach) */
.L_mode_register:
    .4byte  sym_0607ED8C               /* mode register (16-bit) */
.L_fn_race_init:
    .4byte  race_init_master           /* race state machine initialization */
.L_hud_variant:
    .4byte  sym_0607ED91               /* HUD variant index (byte) */
.L_fn_hud_post_update:
    .4byte  hud_post_update            /* HUD post-update handler */
.L_fn_hud_init:
    .4byte  hud_subsystem_init         /* HUD subsystem initialization */
.L_fn_disp_init:
    .4byte  disp_init_setup            /* display initialization */
.L_countdown_timer:
    .4byte  sym_0607EBCC               /* race countdown timer */
.L_race_end_state:
    .4byte  sym_0607EAD8               /* race end state (dispatch index) */
.L_variant_table:
    .4byte  sym_0605E158               /* race variant function table */
.L_fn_variant_dispatch:
    .4byte  sym_060054EA               /* variant setup dispatch function */
.L_fn_race_start_init:
    .4byte  race_start_init            /* race start sequence initialization */
.L_fn_bg_layer_init:
    .4byte  bg_layer_init              /* background layer initialization */
.L_fn_geom_matrix:
    .4byte  geom_matrix_setup          /* geometry matrix initialization */
.L_overlay_active_2:
    .4byte  sym_0605AB18               /* overlay active flag (dup for reach) */
.L_fn_menu_overlay:
    .4byte  menu_overlay_render        /* menu overlay renderer */
.L_game_state:
    .4byte  g_game_state               /* game phase state */
.L_render_flags:
    .4byte  sym_0605B6D8               /* global render flags */
.L_render_flag_bit:
    .4byte  0x40000000                  /* bit 30: race render enable */
.L_fn_init_finalize:
    .4byte  sym_06026CE0               /* initialization finalization */
.L_camera_follow_flag:
    .4byte  sym_06059F44               /* camera follow mode flag */
.L_state_word:
    .4byte  sym_0605A016               /* game state word (16-bit) */
.L_course_loaded:
    .4byte  sym_0607864A               /* course loaded flag (byte) */
