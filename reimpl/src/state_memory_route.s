/* state_memory_route -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008C76 - 0x06008CCC
 * Auto-generated by tools/generate_l3_tu.py
 *
 * State machine routing after geometry output completes.
 *
 * state_memory_route (0x06008C76):
 *   Called during a state transition to check whether the geometry
 *   output pipeline has finished processing (via geom_output_dispatch).
 *   If not ready, returns immediately without changing state.
 *
 *   When ready, reads the preview_camera_flag (sym_0605E0A2, byte):
 *     - If flag == 0 (normal path):
 *         Set game_state = 4 (loading complete),
 *         call disable_display (clear bit 15 of VDP2 display reg),
 *         call camera_finalize (render/display update).
 *     - If flag != 0 (preview/alternate path):
 *         Set game_state = 6 (preview active).
 *
 *   In both cases, clears the preview flag to 0 before returning.
 *
 * Data references:
 *   sym_0605E0A2 = preview_camera_flag (byte, set by preview_camera_path)
 *   sym_0605A016 = display_mode (16-bit, fb resolution mode selector)
 *   sym_0605AD10 = game_state_dispatch (32-bit, controls game flow)
 *   sym_060149E0 = disable_display() -- clears bit 15 of display reg
 *   sym_06026CE0 = camera_finalize() -- render/display update
 */

    .section .text.FUN_06008C76


    .global state_memory_route
    .type state_memory_route, @function
state_memory_route:
    sts.l pr, @-r15                       ! save return address to stack
    .byte   0xD3, 0x10    /* mov.l .L_pool_06008CBC, r3 */  ! r3 = &geom_output_dispatch
    jsr @r3                               ! call geom_output_dispatch — check if VDP2/geometry is ready
    nop                                   ! delay slot
    tst r0, r0                            ! test return value: 0 = not ready
    bt      .L_return                     ! if not ready, skip to return
    .byte   0xD4, 0x0F    /* mov.l .L_pool_06008CC0, r4 */  ! r4 = &game_state_dispatch (sym_0605AD10)
    .byte   0xD0, 0x0B    /* mov.l .L_pool_06008CB4, r0 */  ! r0 = &preview_camera_flag (sym_0605E0A2)
    mov.b @r0, r0                         ! r0 = preview_camera_flag value (byte)
    extu.b r0, r0                         ! zero-extend byte to 32-bit
    tst r0, r0                            ! test if preview flag == 0
    bf      .L_preview_active             ! if flag != 0, take preview path (state 6)
    mov #0x4, r3                          ! r3 = 4 (normal completion state)
    mov.l r3, @r4                         ! game_state_dispatch = 4
    .byte   0xD3, 0x0C    /* mov.l .L_pool_06008CC4, r3 */  ! r3 = &disable_display (sym_060149E0)
    jsr @r3                               ! call disable_display — clear bit 15 of VDP2 display reg
    nop                                   ! delay slot
    .byte   0xD3, 0x0B    /* mov.l .L_pool_06008CC8, r3 */  ! r3 = &camera_finalize (sym_06026CE0)
    jsr @r3                               ! call camera_finalize — render/display update
    nop                                   ! delay slot
    bra     .L_clear_flag                 ! skip preview path, go to flag clear
    nop                                   ! delay slot
.L_preview_active:
    mov #0x6, r2                          ! r2 = 6 (preview active state)
    mov.l r2, @r4                         ! game_state_dispatch = 6
.L_clear_flag:
    mov #0x0, r3                          ! r3 = 0 (clear value)
    .byte   0xD2, 0x02    /* mov.l .L_pool_06008CB4, r2 */  ! r2 = &preview_camera_flag (sym_0605E0A2)
    mov.b r3, @r2                         ! preview_camera_flag = 0
.L_return:
    lds.l @r15+, pr                       ! restore return address from stack
    rts                                   ! return to caller
    nop                                   ! delay slot
    .2byte  0xFFFF
.L_pool_preview_flag:
    .4byte  sym_0605E0A2                  /* preview_camera_flag (byte) */
    .4byte  sym_0605A016                  /* display_mode (16-bit, fb resolution selector) */
.L_pool_fn_geom_dispatch:
    .4byte  geom_output_dispatch          /* VDP2 status check / geometry dispatch */
.L_pool_game_state:
    .4byte  sym_0605AD10                  /* game_state_dispatch (32-bit) */
.L_pool_fn_disable_display:
    .4byte  sym_060149E0                  /* disable_display -- clear bit 15 */
.L_pool_fn_camera_finalize:
    .4byte  sym_06026CE0                  /* camera_finalize -- render/display update */
