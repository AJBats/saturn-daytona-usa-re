/* sound_channel_dispatch -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601D5F4 - 0x0601DBB8
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Sound command dispatch system. Routes sound commands to per-channel
 * handlers that write command words into the Sound RAM mailbox at
 * 0x25A02C20. Each channel (A-D) has a last-command cache to suppress
 * duplicate writes.
 *
 * Functions:
 *   sound_cmd_dispatch     — main dispatcher: r4=cmd byte, r5=param
 *   sound_write_direct     — unconditional write to Sound RAM mailbox
 *   sound_channel_a/b/c/d  — per-channel handlers (deduplicate + write)
 *   sound_channel_c2       — alternate channel C write (no dedup)
 *   sound_pass_direct      — direct pass-through handler (channel 4)
 *   sound_notify_handler   — race event sound notifications
 *   snd_race_update        — per-frame race sound state machine
 *   snd_busy_wait          — spin on Sound RAM busy flag with timeout
 */

    .section .text.FUN_0601D5F4


    .global sound_cmd_dispatch
    .type sound_cmd_dispatch, @function
sound_cmd_dispatch:                         ! r4=cmd byte, r5=param
    mov.l r14, @-r15
    sts.l pr, @-r15
    mov.l   .L_snd_busy_flag, r0
    mov.l @r0, r0
    tst r0, r0                              ! busy? skip all commands
    bf/s    .L_dispatch_exit
    mov r5, r14                             ! r14 = param (delay slot)
    mov.l   .L_snd_cmd_mask, r5             ! r5 = 0xA0000000 validation mask
    bra     .L_cmd_dispatch_table
    mov r4, r0                              ! r0 = cmd byte for dispatch
.L_cmd_store_handler:                       ! cmd 0: direct store
    mov r14, r2
    and r5, r2
    cmp/eq r5, r2                           ! validate top nibble = 0xA0
    bf      .L_dispatch_exit
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_sound_ram_0x02C20, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store, r3
    mov.l r14, @r3
    bra     .L_dispatch_exit
    nop
.L_cmd_chan_a:                               ! cmd 1: channel A
    shll8 r14                               ! param << 8
    mov.l   .L_snd_chan_a_cmd, r4           ! r4 = 0xA07000FF
    add r14, r4                             ! r4 = 0xA070xxFF (xx=param)
    lds.l @r15+, pr
    bra     sound_channel_a
    mov.l @r15+, r14
.L_cmd_chan_b:                               ! cmd 2: channel B
    shll8 r14
    mov.l   .L_snd_chan_b_cmd, r4
    add r14, r4
    lds.l @r15+, pr
    bra     sound_channel_b
    mov.l @r15+, r14
.L_cmd_chan_c:                               ! cmd 3: channel C
    shll8 r14
    mov.l   .L_snd_chan_c_cmd, r4
    add r14, r4
    lds.l @r15+, pr
    bra     sound_channel_c
    mov.l @r15+, r14
.L_cmd_pass_direct:                         ! cmd 4: direct pass-through
    mov r14, r4
    lds.l @r15+, pr
    bra     sound_pass_direct
    mov.l @r15+, r14
.L_cmd_chan_d:                               ! cmd 5: channel D
    shll8 r14
    mov.l   .L_snd_chan_d_cmd, r4
    add r14, r4
    lds.l @r15+, pr
    bra     sound_channel_d
    mov.l @r15+, r14
.L_cmd_store_handler_f:                     ! cmd 0xF: same as cmd 0
    mov r14, r2
    and r5, r2
    cmp/eq r5, r2
    bf      .L_dispatch_exit
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_sound_ram_0x02C20, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store, r3
    mov.l r14, @r3
    bra     .L_dispatch_exit
    nop
.L_snd_busy_flag:
    .4byte  sym_06086050                    /* busy flag: nonzero = sound driver busy */
.L_snd_cmd_mask:
    .4byte  0xA0000000                      /* top-nibble validation mask */
.L_sound_ram_0x02C20:
    .4byte  0x25A02C20                  /* Sound RAM +0x02C20 */
.L_snd_cmd_store:
    .4byte  sym_0608604C                    /* last-command mirror */
.L_snd_chan_a_cmd:
    .4byte  0xA07000FF                      /* chan A base: A0=chanA, 70=cmd, 00FF=param */
.L_snd_chan_b_cmd:
    .4byte  0xA17000FF                      /* chan B base */
.L_snd_chan_c_cmd:
    .4byte  0xA27000FF                      /* chan C base */
.L_snd_chan_d_cmd:
    .4byte  0xA37000FF                      /* chan D base */
.L_cmd_dispatch_table:
    cmp/eq #0x0, r0
    bt      .L_cmd_store_handler
    cmp/eq #0x1, r0
    bt      .L_cmd_chan_a
    cmp/eq #0x2, r0
    bt      .L_cmd_chan_b
    cmp/eq #0x3, r0
    bt      .L_cmd_chan_c
    cmp/eq #0x4, r0
    bt      .L_cmd_pass_direct
    cmp/eq #0x5, r0
    bt      .L_cmd_chan_d
    cmp/eq #0xF, r0
    bt      .L_cmd_store_handler_f
.L_dispatch_exit:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global sound_write_direct
    .type sound_write_direct, @function
sound_write_direct:                         ! r4=cmd word, no dedup check
    sts.l pr, @-r15
    add #-0x4, r15
    bsr     .L_snd_busy_wait
    mov.l r4, @r15                          ! save r4 across busy-wait
    mov.l @r15, r2
    mov.l   .L_snd_mailbox_wd, r3
    mov.l r2, @r3
    mov.l @r15, r2
    mov.l   .L_snd_cmd_store_wd, r3
    add #0x4, r15
    lds.l @r15+, pr
    rts
    mov.l r2, @r3
.L_snd_mailbox_wd:
    .4byte  0x25A02C20                  /* Sound RAM +0x02C20 */
.L_snd_cmd_store_wd:
    .4byte  sym_0608604C

    .global sound_channel_a
    .type sound_channel_a, @function
sound_channel_a:
    mov.l r14, @-r15
    mov r4, r14

    .global snd_channel_a_body
    .type snd_channel_a_body, @function
snd_channel_a_body:
    sts.l pr, @-r15
    mov.l   .L_chan_a_last_cmd, r3
    mov.l @r3, r3
    cmp/eq r14, r3                          ! skip if same as last cmd
    bt      .L_chan_a_skip
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_chan_a_last_cmd, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store_ab, r3
    mov.l r14, @r3
    mov.l   .L_snd_mailbox_ab, r3
    mov.l r14, @r3
.L_chan_a_skip:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global sound_channel_b
    .type sound_channel_b, @function
sound_channel_b:
    mov.l r14, @-r15
    mov r4, r14

    .global snd_channel_b_body
    .type snd_channel_b_body, @function
snd_channel_b_body:
    sts.l pr, @-r15
    mov.l   .L_chan_b_last_cmd, r3
    mov.l @r3, r3
    cmp/eq r14, r3
    bt      .L_chan_b_skip
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_chan_b_last_cmd, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store_ab, r3
    mov.l r14, @r3
    mov.l   .L_snd_mailbox_ab, r3
    mov.l r14, @r3
.L_chan_b_skip:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14
.L_chan_a_last_cmd:
    .4byte  sym_0605DF94                    /* chan A last-command cache */
.L_snd_cmd_store_ab:
    .4byte  sym_0608604C                    /* cmd mirror (shared A/B) */
.L_snd_mailbox_ab:
    .4byte  0x25A02C20                      /* Sound RAM mailbox (shared A/B) */
.L_chan_b_last_cmd:
    .4byte  sym_0605DF98                    /* chan B last-command cache */

    .global sound_channel_c
    .type sound_channel_c, @function
sound_channel_c:
    mov.l r14, @-r15
    mov r4, r14

    .global snd_channel_c_handler
    .type snd_channel_c_handler, @function
snd_channel_c_handler:
    sts.l pr, @-r15
    mov.l   .L_chan_c_last_cmd, r3
    mov.l @r3, r3
    cmp/eq r14, r3
    bt      .L_chan_c_skip
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_chan_c_last_cmd, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store_c, r3
    mov.l r14, @r3
    mov.l   .L_snd_mailbox_c, r3
    mov.l r14, @r3
.L_chan_c_skip:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global sound_channel_c2
    .type sound_channel_c2, @function
sound_channel_c2:
    sts.l pr, @-r15
    add #-0x4, r15
    bsr     .L_snd_busy_wait
    mov.l r4, @r15
    mov.l @r15, r2
    mov.l   .L_snd_mailbox_c, r3
    mov.l r2, @r3
    mov.l @r15, r2
    mov.l   .L_snd_cmd_store_c, r3
    add #0x4, r15
    lds.l @r15+, pr
    rts
    mov.l r2, @r3
    .2byte  0xFFFF
.L_chan_c_last_cmd:
    .4byte  sym_0605DF9C                    /* chan C last-command cache */
.L_snd_cmd_store_c:
    .4byte  sym_0608604C                    /* cmd mirror (chan C) */
.L_snd_mailbox_c:
    .4byte  0x25A02C20                      /* Sound RAM mailbox (chan C) */

    .global sound_pass_direct
    .type sound_pass_direct, @function
sound_pass_direct:
    mov.l r14, @-r15
    mov r4, r14

    .global snd_direct_pass
    .type snd_direct_pass, @function
snd_direct_pass:
    sts.l pr, @-r15
    mov.l   .L_direct_last_cmd, r3
    mov.l @r3, r3
    cmp/eq r14, r3
    bt      .L_direct_skip
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_direct_last_cmd, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store_dd, r3
    mov.l r14, @r3
    mov.l   .L_snd_mailbox_dd, r3
    mov.l r14, @r3
.L_direct_skip:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global sound_channel_d
    .type sound_channel_d, @function
sound_channel_d:
    mov.l r14, @-r15
    mov r4, r14

    .global snd_channel_d_handler
    .type snd_channel_d_handler, @function
snd_channel_d_handler:
    sts.l pr, @-r15
    mov.l   .L_chan_d_last_cmd, r3
    mov.l @r3, r3
    cmp/eq r14, r3
    bt      .L_chan_d_skip
    bsr     .L_snd_busy_wait
    nop
    mov.l   .L_chan_d_last_cmd, r3
    mov.l r14, @r3
    mov.l   .L_snd_cmd_store_dd, r3
    mov.l r14, @r3
    mov.l   .L_snd_mailbox_dd, r3
    mov.l r14, @r3
.L_chan_d_skip:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14
.L_direct_last_cmd:
    .4byte  sym_0605DFA4                    /* direct pass last-command cache */
.L_snd_cmd_store_dd:
    .4byte  sym_0608604C                    /* cmd mirror (direct/chan D) */
.L_snd_mailbox_dd:
    .4byte  0x25A02C20                      /* Sound RAM mailbox (direct/chan D) */
.L_chan_d_last_cmd:
    .4byte  sym_0605DFA8                    /* chan D last-command cache */

    .global sound_notify_handler
    .type sound_notify_handler, @function
sound_notify_handler:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov #0x1, r12
    mov.l r11, @-r15
    mov.l r10, @-r15
    mov.l r9, @-r15
    mov.l r8, @-r15
    sts.l pr, @-r15
    mov #0x50, r8
    mov.l   .L_notify_timer_ptr, r10
    mov.l   .L_notify_mode_ptr, r11
    mov.l   .L_notify_pending_flag, r13
    mov.l   .L_notify_retry_ctr, r14
    mov.l   .L_notify_race_data, r4
    mov.l @r11, r0
    exts.b r0, r0
    mov r0, r3
    shll2 r0
    shll2 r3
    shll r3
    add r3, r0
    exts.b r0, r0
    mov.l   .L_notify_lookup_base, r2
    add r2, r0
    mov.l   .L_notify_car_count, r5
    mov.l @r5, r5
    shll2 r5
    mov.l @(r0, r5), r5
    mov.l   .L_notify_sound_off, r0
    mov.b @r0, r0
    tst r0, r0
    bt/s    .L_notify_check_mode
    mov.l @r4, r4
    mov.l   .L_notify_total_laps, r3
    mov.w   .L_notify_lap_offset, r0
    mov.l @r3, r3
    mov.l @(r0, r4), r2
    add #-0x1, r3
    cmp/eq r3, r2
    bf      .L_notify_lap_complete
    mov.l   .L_notify_final_sent, r0
    mov.l @r0, r0
    tst r0, r0
    bf      .L_notify_lap_complete
    mov.l   .L_snd_final_lap_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    extu.w r8, r2
    mov.w r2, @r10
    mov.l   .L_notify_final_sent, r3
    mov.l r12, @r3
    bra     .L_notify_exit
    nop
.L_notify_lap_complete:
    mov.l   .L_snd_lap_complete_cmd, r5
    mov #0x0, r4
    lds.l @r15+, pr
    mov.l @r15+, r8
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    bra     sound_cmd_dispatch
    mov.l @r15+, r14
.L_notify_check_mode:
    mov.l @r11, r0
    tst r0, r0
    bf      .L_notify_check_mode1
    mov r5, r2
    mov.w   .L_notify_lap_offset, r0
    mov.l @(r0, r4), r3
    sub r3, r2
    mov #0x8, r3
    cmp/gt r3, r2
    bt      .L_notify_check_mode1
    mov.b @r13, r3
    extu.b r3, r3
    tst r3, r3
    bf      .L_notify_mode0_inc_retry
    mov.l   .L_notify_car_count, r3
    mov #0x0, r2
    mov.l @r3, r3
    cmp/hi r2, r3
    bf      .L_notify_mode0_inc_retry
    extu.b r12, r2
    mov.b r2, @r13
    mov #0x0, r3
    mov.w r3, @r14
    bra     .L_notify_check_mode1
    nop
.L_notify_lap_offset:
    .2byte  0x021C                          /* offset 0x21C into race data = lap count */
    .2byte  0xFFFF
.L_notify_timer_ptr:
    .4byte  sym_06086054
.L_notify_mode_ptr:
    .4byte  sym_0607EAD8
.L_notify_pending_flag:
    .4byte  sym_06087060
.L_notify_retry_ctr:
    .4byte  sym_06086058
.L_notify_race_data:
    .4byte  sym_0607E944
.L_notify_lookup_base:
    .4byte  sym_0604A50C
.L_notify_car_count:
    .4byte  sym_0605AD00
.L_notify_sound_off:
    .4byte  sym_06085FF4
.L_notify_total_laps:
    .4byte  sym_06063F28
.L_notify_final_sent:
    .4byte  sym_06086034
.L_snd_final_lap_cmd:
    .4byte  0xAE1121FF                      /* "final lap" jingle */
.L_snd_lap_complete_cmd:
    .4byte  0xAE1146FF                      /* "lap complete" jingle */
.L_notify_mode0_inc_retry:
    mov.w @r14, r2
    add #0x1, r2
    mov.w r2, @r14
.L_notify_check_mode1:
    mov.l @r11, r0
    cmp/eq #0x1, r0
    bf      .L_notify_check_mode2
    mov r5, r3
    mov.w   DAT_0601d974, r0
    mov.l @(r0, r4), r2
    sub r2, r3
    mov #0x4, r2
    cmp/gt r2, r3
    bt      .L_notify_check_mode2
    mov.b @r13, r2
    extu.b r2, r2
    tst r2, r2
    bf      .L_notify_mode1_inc_retry
    mov.l   .L_notify_car_count_2, r3
    mov #0x0, r2
    mov.l @r3, r3
    cmp/hi r2, r3
    bf      .L_notify_mode1_inc_retry
    extu.b r12, r2
    bra     .L_notify_check_mode2
    mov.b r2, @r13
.L_notify_mode1_inc_retry:
    mov.w @r14, r2
    add #0x1, r2
    mov.w r2, @r14
.L_notify_check_mode2:
    mov.l @r11, r0
    cmp/eq #0x2, r0
    bf      .L_notify_halfway_check
    mov.w   DAT_0601d974, r0
    mov r5, r3
    mov.l @(r0, r4), r2
    sub r2, r3
    mov #0x2, r2
    cmp/gt r2, r3
    bt      .L_notify_halfway_check
    mov.b @r13, r2
    extu.b r2, r2
    tst r2, r2
    bf      .L_notify_mode2_inc_retry
    mov #0x0, r2
    mov.l   .L_notify_car_count_2, r3
    mov.l @r3, r3
    cmp/hi r2, r3
    bf      .L_notify_mode2_inc_retry
    extu.b r12, r2
    bra     .L_notify_halfway_check
    mov.b r2, @r13
.L_notify_mode2_inc_retry:
    mov.w @r14, r2
    add #0x1, r2
    mov.w r2, @r14
.L_notify_halfway_check:
    mov #0x0, r2
    mov.l   .L_notify_countdown_ptr, r9
    mov.w   DAT_0601d974, r0
    cmp/gt r5, r2
    mov.l @(r0, r4), r3
    addc r2, r5
    add #0x1, r3
    shar r5
    cmp/gt r5, r3
    bt      .L_notify_final_check
    mov.l   .L_snd_halfway_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    mov.w   DAT_0601d976, r2
    mov.w r2, @r10
    mov #0x14, r3
    mov.w r3, @r9
    bra     .L_notify_exit
    nop
.L_notify_final_check:
    mov.l   .L_notify_total_laps_2, r2
    mov.w   DAT_0601d974, r0
    mov.l @r2, r2
    mov.l @(r0, r4), r3
    add #-0x1, r2
    cmp/eq r2, r3
    bf      .L_notify_default_cmd
    mov.l   .L_notify_final_sent_2, r0
    mov.l @r0, r0
    tst r0, r0
    bf      .L_notify_default_cmd
    mov.l   .L_snd_final_lap_cmd_2, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    extu.w r8, r2
    mov.w r2, @r9
    extu.w r8, r3
    mov.w r3, @r10
    mov.l   .L_notify_final_sent_2, r3
    mov.l r12, @r3
    bra     .L_notify_exit
    nop

    .global DAT_0601d974
DAT_0601d974:
    .2byte  0x021C

    .global DAT_0601d976
DAT_0601d976:
    .2byte  0x04B0
.L_notify_car_count_2:
    .4byte  sym_0605AD00
.L_notify_countdown_ptr:
    .4byte  sym_06086056
.L_snd_halfway_cmd:
    .4byte  0xAE1126FF                      /* halfway through race */
.L_notify_total_laps_2:
    .4byte  sym_06063F28
.L_notify_final_sent_2:
    .4byte  sym_06086034
.L_snd_final_lap_cmd_2:
    .4byte  0xAE1121FF                      /* "final lap" jingle (pool dup) */
.L_notify_default_cmd:
    mov.l   .L_snd_notify_default_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    mov.w   .L_notify_timer_1200, r2
    mov.w r2, @r10
    mov #0x14, r3
    mov.w r3, @r9
.L_notify_exit:
    lds.l @r15+, pr
    mov.l @r15+, r8
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14

    .global snd_race_update
    .type snd_race_update, @function
snd_race_update:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov #0x28, r12
    mov.l r11, @-r15
    sts.l pr, @-r15
    mov.l   .L_race_timer_ptr, r14
    mov.l   .L_race_sound_off, r0
    mov.b @r0, r0
    tst r0, r0
    bt/s    .L_race_sound_active
    mov #0x0, r13
    bra     .L_race_update_exit
    nop
.L_race_sound_active:
    mov.l   .L_race_countdown_ptr, r2
    mov.w @r2, r2
    extu.w r2, r2
    tst r2, r2
    bf      .L_race_check_inhibit
    bra     .L_race_check_fade
    nop
.L_race_check_inhibit:
    mov.l   .L_race_inhibit_flag, r0
    mov.b @r0, r0
    extu.b r0, r0
    cmp/eq #0x1, r0
    bf      .L_race_dec_countdown
    bra     .L_race_check_fade
    nop
.L_race_dec_countdown:
    mov.l   .L_race_countdown_ptr, r0
    mov.l   .L_race_countdown_ptr, r3
    mov.w @r0, r0
    add #-0x1, r0
    mov.w r0, @r3
    add #0x1, r0
    extu.w r0, r0
    cmp/eq #0x1, r0
    bt      .L_race_countdown_expired
    bra     .L_race_check_fade
    nop
.L_race_countdown_expired:
    mov.l   .L_race_mode_ptr, r5
    mov.l   .L_race_state_ptr, r4
    mov.l   .L_snd_race_loop_cmd, r11
    mov.l @r5, r0
    tst r0, r0
    bf/s    .L_race_mode_nonzero
    mov #0x64, r6
    mov.w @r4, r0
    bra     .L_race_state_dispatch
    extu.w r0, r0
.L_race_state1_handler:
    mov.l   .L_race_countdown_ptr, r3
    mov.w r13, @r3
    mov.l   .L_snd_race_state1_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    bra     .L_race_set_timer_short
    nop
.L_race_state2_handler:
    mov.l   .L_race_countdown_ptr, r3
    mov r11, r5
    mov.w r13, @r3
    bsr     sound_cmd_dispatch
    mov #0x0, r4
.L_race_set_timer_short:
    bra     .L_race_set_timer_long
    nop
.L_race_state3_handler:
    mov.l   .L_race_countdown_ptr, r3
    mov.w r13, @r3
    mov.l   .L_snd_race_state3_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    bra     .L_race_write_timer
    mov #0x14, r2
.L_notify_timer_1200:
    .2byte  0x04B0
    .2byte  0xFFFF
.L_snd_notify_default_cmd:
    .4byte  0xAE1127FF                      /* default race notify sound */
.L_race_timer_ptr:
    .4byte  sym_06086054
.L_race_sound_off:
    .4byte  sym_06085FF4
.L_race_countdown_ptr:
    .4byte  sym_06086056
.L_race_inhibit_flag:
    .4byte  sym_0608605A
.L_race_mode_ptr:
    .4byte  sym_0607EAD8
.L_race_state_ptr:
    .4byte  sym_06086058
.L_snd_race_loop_cmd:
    .4byte  0xAE112BFF                      /* race loop/repeat music */
.L_snd_race_state1_cmd:
    .4byte  0xAE1129FF                      /* race state 1 sound */
.L_snd_race_state3_cmd:
    .4byte  0xAE112AFF                      /* race state 3 sound */
.L_race_state4_handler:
    mov.l   .L_race_countdown_ptr_2, r3
    mov r11, r5
    mov.w r13, @r3
    bsr     sound_cmd_dispatch
    mov #0x0, r4
.L_race_set_timer_long:
    bra     .L_race_write_timer
    extu.w r12, r2
.L_race_state5_handler:
    mov.l   .L_race_countdown_ptr_2, r3
    mov.w r13, @r3
    mov.l   .L_snd_race_state5_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    bra     .L_race_write_timer
    mov #0x14, r2
.L_race_state6_handler:
    mov.l   .L_race_countdown_ptr_2, r3
    mov r11, r5
    mov.w r13, @r3
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    extu.w r12, r2
.L_race_write_timer:
    bra     .L_race_check_fade
    mov.w r2, @r14
.L_race_state_default:
    extu.w r6, r6
    bra     .L_race_check_fade
    mov.w r6, @r14
.L_race_state_dispatch:
    cmp/eq #0x1, r0
    bt      .L_race_state1_handler
    cmp/eq #0x2, r0
    bt      .L_race_state2_handler
    cmp/eq #0x3, r0
    bt      .L_race_state3_handler
    cmp/eq #0x4, r0
    bt      .L_race_state4_handler
    cmp/eq #0x5, r0
    bt      .L_race_state5_handler
    cmp/eq #0x6, r0
    bt      .L_race_state6_handler
    bra     .L_race_state_default
    nop
.L_race_mode_nonzero:
    mov.l @r5, r0
    cmp/eq #0x1, r0
    bf      .L_race_check_mode2
    mov.w @r4, r0
    bra     .L_race_m1_dispatch
    extu.w r0, r0
.L_race_m1_state1:
    mov r11, r5
    mov.l   .L_race_countdown_ptr_2, r3
    mov.w r13, @r3
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    bra     .L_race_m1_set_timer
    nop
.L_race_m1_state3:
    mov.l   .L_race_countdown_ptr_2, r3
    mov r11, r5
    mov.w r13, @r3
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    bra     .L_race_m1_set_timer
    nop
.L_race_m1_state6:
    mov.l   .L_race_countdown_ptr_2, r3
    mov.w r13, @r3
    mov.l   .L_snd_race_m1s6_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
.L_race_m1_set_timer:
    extu.w r12, r2
    bra     .L_race_check_fade
    mov.w r2, @r14
.L_race_m1_default:
    extu.w r6, r6
    bra     .L_race_check_fade
    mov.w r6, @r14
.L_race_m1_dispatch:
    cmp/eq #0x1, r0
    bt      .L_race_m1_state1
    cmp/eq #0x3, r0
    bt      .L_race_m1_state3
    cmp/eq #0x6, r0
    bt      .L_race_m1_state6
    bra     .L_race_m1_default
    nop
.L_race_check_mode2:
    mov.l @r5, r0
    cmp/eq #0x2, r0
    bf      .L_race_check_fade
    mov.w @r4, r0
    extu.w r0, r0
    cmp/eq #0x8, r0
    bf      .L_race_check_fade
    mov.l   .L_race_countdown_ptr_2, r3
    mov.w r13, @r3
    mov.l   .L_snd_race_m2s8_cmd, r5
    bsr     sound_cmd_dispatch
    mov #0x0, r4
    extu.w r12, r2
    mov.w r2, @r14
.L_race_check_fade:
    mov.l   .L_race_fade_flag, r4
    mov.b @r4, r0
    extu.b r0, r0
    cmp/eq #0x1, r0
    bf      .L_race_update_exit
    mov.l   .L_race_countdown_ptr_2, r0
    mov.l   .L_race_countdown_ptr_2, r3
    mov.w @r0, r0
    add #-0x1, r0
    mov.w r0, @r3
    add #0x1, r0
    extu.w r0, r0
    cmp/eq #0x1, r0
    bf      .L_race_update_exit
    extu.b r13, r3
    mov.b r3, @r4
    mov.l   .L_race_countdown_ptr_2, r3
    mov.w r13, @r3
    mov.w r12, @r14
    mov.l   .L_snd_fade_complete_cmd, r5
    mov #0x0, r4
    lds.l @r15+, pr
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    bra     sound_cmd_dispatch
    mov.l @r15+, r14
.L_race_update_exit:
    lds.l @r15+, pr
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14
    .2byte  0xFFFF
.L_race_countdown_ptr_2:
    .4byte  sym_06086056
.L_snd_race_state5_cmd:
    .4byte  0xAE112CFF                      /* race state 5 sound */
.L_snd_race_m1s6_cmd:
    .4byte  0xAE112DFF                      /* mode 1, state 6 sound */
.L_snd_race_m2s8_cmd:
    .4byte  0xAE112FFF                      /* mode 2, state 8 sound */
.L_race_fade_flag:
    .4byte  sym_0608605A
.L_snd_fade_complete_cmd:
    .4byte  0xAE1120FF                      /* fade-out complete sound */
    .4byte  0x000B0009
    .4byte  0x000B0009
.L_snd_busy_wait:                           ! spin until Sound RAM mailbox clear
    mov.l   .L_busy_flag_ptr, r7           ! r7 = &busy_flag
    mov.l   .L_snd_mailbox_busy, r6        ! r6 = 0x25A02C20 (Sound RAM mailbox)
    mov #0x1, r5
    mov.l   .L_busy_timeout, r4            ! r4 = 100,000 iterations max
.L_busy_spin_loop:
    dt r4                                   ! decrement timeout counter
    bf      .L_busy_poll
    bra     .L_busy_done                    ! timeout: set busy flag and bail
    mov.l r5, @r7                           ! busy_flag = 1 (delay slot)
.L_busy_poll:
    mov.l @r6, r0                           ! read Sound RAM mailbox
    tst r0, r0                              ! zero = sound driver consumed cmd
    bf      .L_busy_spin_loop
.L_busy_done:
    rts
    nop
    .2byte  0xFFFF
.L_busy_flag_ptr:
    .4byte  sym_06086050                    /* &busy_flag */
.L_snd_mailbox_busy:
    .4byte  0x25A02C20                      /* Sound RAM mailbox */
.L_busy_timeout:
    .4byte  0x000186A0                      /* 100,000 = max spin iterations */
    .4byte  0xE300D201
    .4byte  0x000B2230
    .4byte  0x25A02D97
