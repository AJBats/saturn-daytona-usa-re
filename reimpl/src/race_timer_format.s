/* race_timer_format -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060138BE - 0x06013948
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Post-race rendering dispatch -- called as a state handler from the
 * results/post-race function pointer table (sym_0605B6B8). Sets up
 * fixed-point parameters (0.5 and 150.0) and delegates to
 * rigid_body_transform for 3D scene processing, then tail-calls
 * frame_end_commit to finalize the display frame.
 *
 * The constant pool contains a table of pointers to race state
 * variables in WRAM high (0x06084Axx-0x06084Bxx), display config,
 * and references to the sound and geometry subsystems.
 *
 * loc_06013930 is a separate entry point (first slot in the
 * post-race dispatch table) that initializes the animation state
 * flag and frame timer before falling through to score_calculator.
 *
 * Stack convention: this function does NOT save PR itself -- the
 * dispatch caller is responsible for saving PR and r14 on the stack.
 * After work, this function restores the caller's PR and r14 and
 * tail-jumps to frame_end_commit.
 *
 * Arguments:
 *   r2 -- context pointer (passed through as r4 to rigid_body_transform)
 *
 * Returns: does not return directly; tail-calls frame_end_commit
 */

    .section .text.FUN_060138BE


    .global race_timer_format
    .type race_timer_format, @function
race_timer_format:
    mov.l r14, @-r15                        ! save r14 on stack
    .byte   0xD3, 0x17    /* mov.l .L_fp_half, r3 */  ! r3 = 0x00008000 (0.5 in 16.16 fixed-point)
    mov.l r3, @-r15                         ! push fp_half as stack parameter
    .byte   0xD5, 0x17    /* mov.l .L_pool_param_150, r5 */  ! r5 = 0x00960000 (150.0 in 16.16 fixed-point)
    .byte   0xD3, 0x18    /* mov.l .L_pool_rigid_body_transform, r3 */  ! r3 = rigid_body_transform address
    jsr @r3                                 ! call rigid_body_transform(r4=context, r5=150.0, stack=0.5)
    mov r2, r4                              ! (delay slot) r4 = context pointer from caller
    add #0xC, r15                           ! clean up stack: fp_half(4) + r14(4) + caller frame(4)
    lds.l @r15+, pr                         ! restore caller's PR from stack
    .byte   0xD3, 0x16    /* mov.l .L_pool_frame_end_commit, r3 */  ! r3 = frame_end_commit address
    jmp @r3                                 ! tail-call frame_end_commit (finalize display frame)
    mov.l @r15+, r14                        ! (delay slot) restore caller's r14

    .global DAT_060138d6
DAT_060138d6:
    .word 0x04B0 /* 1200 -- frame count or time constant */

    .global DAT_060138d8
DAT_060138d8:
    mov.b @(r0, r13), r5                    ! data word 0x05DC (1500) -- encoded as instruction bytes

    .global DAT_060138da
DAT_060138da:
    mov.b @(r0, r0), r2                     ! data word 0x020C (524) -- encoded as instruction bytes
    .4byte  sym_06084B0C                    ! race state: lap count or position data
    .4byte  sym_06084B18                    ! race state: timing data
    .4byte  sym_06084B20                    ! race state: result flag or score
    .4byte  sym_06084AF0                    ! race state: status byte
    .4byte  sym_0607EBCC                    ! display/geometry data reference
    .4byte  sym_06084AF2                    ! race state: animation state flag
    .4byte  sym_06084B14                    ! race state: display parameter
    .4byte  sym_0605AD5C                    ! game state or callback address
    .4byte  sym_06084AF8                    ! race state: counter or index
    .4byte  sym_06084AFC                    ! race state: counter or index
    .4byte  sym_0605AAA0                    ! game state or callback address
    .4byte  0xAB1100FF                      ! packed constants (color or bitmask)
    .4byte  sound_cmd_dispatch              ! sound subsystem entry point
    .4byte  sym_060149CC                    ! display or render callback
    .4byte  sym_06026CE0                    ! geometry setup function
    .4byte  sym_0605B6B8                    ! post-race dispatch function pointer table
    .4byte  0x00010000                      ! 1.0 in 16.16 fixed-point
.L_fp_half:
    .4byte  0x00008000                      ! 0.5 in 16.16 fixed-point
.L_pool_param_150:
    .4byte  0x00960000                      ! 150.0 in 16.16 fixed-point (0x96 = 150)
.L_pool_rigid_body_transform:
    .4byte  rigid_body_transform            ! 3D transform processing function
.L_pool_frame_end_commit:
    .4byte  frame_end_commit                ! display frame finalization function

/* loc_06013930 -- post-race animation initializer
 *
 * First entry in the post-race dispatch table (sym_0605B6B8).
 * Sets the animation state flag to 1 (active) and the frame timer
 * to 0x20 (32 frames), then falls through to score_calculator
 * to begin the post-race animation sequence.
 *
 * Arguments: none (uses constant pool addresses directly)
 * Returns: falls through to score_calculator via BRA
 */
    .global loc_06013930
loc_06013930:
    mov #0x1, r3                            ! r3 = 1 (animation active state)
    .byte   0xD2, 0x03    /* mov.l .L_pool_anim_state_flag, r2 */  ! r2 = &sym_06084AF2 (animation state flag)
    mov.b r3, @r2                           ! set animation state flag = 1 (active)
    mov #0x20, r3                           ! r3 = 0x20 (32 frames for animation timer)
    .byte   0xD2, 0x02    /* mov.l .L_pool_anim_timer, r2 */  ! r2 = &sym_06084AF4 (animation frame timer)
    mov.w r3, @r2                           ! set animation frame timer = 32
    .byte   0xA0, 0x04    /* bra 0x06013948 (external) */  ! branch to score_calculator (next handler)
    nop                                     ! (delay slot) no-op
.L_pool_anim_state_flag:
    .4byte  sym_06084AF2                    ! animation state flag address
.L_pool_anim_timer:
    .4byte  sym_06084AF4                    ! animation frame timer address
