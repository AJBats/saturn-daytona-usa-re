/* obj_collision_box -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06020B58 - 0x06020BCE
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Object collision box display initialization.
 * Sets up render state and display timers for collision-box visualization:
 *
 *   1. Sets bit 0 of race_event_bitfield, calls display_list_copy_inline
 *   2. Calls display_layer_fill_cfg(0xC)
 *   3. First display pass: ORs bit 26 into render_mode_flags,
 *      sets display_timer = 2, clears input_skip_flag = 0,
 *      calls camera_state_finalize
 *   4. Second display pass: ORs bit 26 into render_mode_flags again,
 *      sets display_timer = 4, calls camera_state_finalize
 *   5. Sets obj_visibility_mode = 3, display_enable_flag = 1,
 *      clears attract_countdown = 0
 *   6. Calls obj_anim_advance to clear all 16 animation slots
 *   7. Clears car_struct_base[0]+0x10 byte to 0
 *   8. Calls camera_state_finalize twice more
 *
 * Pool entries are shared with obj_state_pack (next section).
 *
 * Key symbols:
 *   sym_0607EBF4 -- race_event_bitfield (32-bit, bit 0 set here)
 *   sym_0602853E -- display_layer_fill_cfg(r4=mode)
 *   sym_0605B6D8 -- render_mode_flags (32-bit bitmask)
 *   sym_0605A00C -- input_skip_flag (0 = process input)
 *   sym_06026CE0 -- camera_state_finalize
 *   sym_0608780C -- display_timer (16-bit word; 2 and 4 written here)
 *   sym_06059F6F -- obj_visibility_mode (byte; 3 = collision box mode)
 *   sym_06085F8A -- display_enable_flag (byte; 1 = enabled)
 *   sym_0607EBCC -- attract_countdown (32-bit; cleared to 0)
 *   sym_06063F5C -- car_struct_array_base (pointer to pointer)
 */

    .section .text.FUN_06020B58


    .global obj_collision_box
    .type obj_collision_box, @function
obj_collision_box:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov.l r11, @-r15
    sts.l pr, @-r15
    .byte   0xD4, 0x27    /* mov.l .L_ptr_race_event_bits, r4 -- &race_event_bitfield (sym_0607EBF4) */
    mov.l @r4, r0                            ! r0 = race_event_bitfield value
    or #0x1, r0                              ! set bit 0 (collision box event)
    .byte   0xBF, 0xDA    /* bsr display_list_copy_inline (0x06020B20) */
    mov.l r0, @r4                            ! (delay) store updated bitfield
    .byte   0xD3, 0x25    /* mov.l .L_fn_display_layer_fill_cfg, r3 -- sym_0602853E */
    jsr @r3                                  ! call display_layer_fill_cfg(0xC)
    mov #0xC, r4                             ! (delay) r4 = 0xC (layer config mode)
    mov #0x0, r14                            ! r14 = 0 (reused as zero constant)
    .byte   0xDB, 0x24    /* mov.l .L_ptr_render_mode_flags, r11 -- &render_mode_flags (sym_0605B6D8) */
    .byte   0xD2, 0x25    /* mov.l .L_const_bit26, r2 -- 0x04000000 */
    mov.l @r11, r3                           ! r3 = render_mode_flags
    or r2, r3                                ! r3 |= 0x04000000 (set bit 26: collision update trigger)
    mov.l r3, @r11                           ! store updated render_mode_flags
    mov #0x2, r2
    .byte   0xD3, 0x23    /* mov.l .L_ptr_display_timer, r3 -- &display_timer (sym_0608780C) */
    mov.w r2, @r3                            ! display_timer = 2 (first pass)
    .byte   0xDD, 0x23    /* mov.l .L_ptr_input_skip_flag, r13 -- &input_skip_flag (sym_0605A00C) */
    .byte   0xDC, 0x24    /* mov.l .L_fn_camera_state_finalize, r12 -- sym_06026CE0 */
    jsr @r12                                 ! call camera_state_finalize
    mov.l r14, @r13                          ! (delay) input_skip_flag = 0
    .byte   0xD2, 0x1F    /* mov.l .L_const_bit26, r2 -- 0x04000000 */
    mov.l @r11, r3                           ! r3 = render_mode_flags (reload)
    or r2, r3                                ! r3 |= 0x04000000 (set bit 26 again)
    mov #0x4, r2
    mov.l r3, @r11                           ! store updated render_mode_flags
    .byte   0xD3, 0x1E    /* mov.l .L_ptr_display_timer, r3 -- &display_timer (sym_0608780C) */
    mov.w r2, @r3                            ! display_timer = 4 (second pass)
    jsr @r12                                 ! call camera_state_finalize
    mov.l r14, @r13                          ! (delay) input_skip_flag = 0
    mov #0x3, r3
    .byte   0xD2, 0x1E    /* mov.l .L_ptr_obj_visibility_mode, r2 -- &obj_visibility_mode (sym_06059F6F) */
    mov.b r3, @r2                            ! obj_visibility_mode = 3 (collision box mode)
    mov #0x1, r2
    .byte   0xD3, 0x1E    /* mov.l .L_ptr_display_enable_flag, r3 -- &display_enable_flag (sym_06085F8A) */
    mov.b r2, @r3                            ! display_enable_flag = 1 (enable)
    .byte   0xD3, 0x1E    /* mov.l .L_ptr_attract_countdown, r3 -- &attract_countdown (sym_0607EBCC) */
    mov.l r14, @r3                           ! attract_countdown = 0 (clear)
    .byte   0xB1, 0x0F    /* bsr obj_anim_advance (0x06020DD0) */
    nop                                      ! (delay) clear all 16 animation slots
    .byte   0xD2, 0x1D    /* mov.l .L_ptr_car_struct_base, r2 -- &car_struct_array_base (sym_06063F5C) */
    mov.l @r2, r2                            ! r2 = *car_struct_array_base (first car struct)
    add #0x10, r2                            ! r2 += 0x10 (offset to target byte field)
    mov.b r14, @r2                           ! car_struct[0]+0x10 = 0 (clear byte field)
    jsr @r12                                 ! call camera_state_finalize
    mov.l r14, @r13                          ! (delay) input_skip_flag = 0
    jsr @r12                                 ! call camera_state_finalize (final pass)
    mov.l r14, @r13                          ! (delay) input_skip_flag = 0
    lds.l @r15+, pr
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14
