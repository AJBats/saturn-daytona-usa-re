/* force_table_apply -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008418 - 0x060088CC
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Force/steering physics — applies force vectors to cars from lookup
 * tables during collisions and braking. Contains 5 functions:
 *
 * force_steer_calc (0x06008418):
 *   If car[+0x1BC] (collision timer) == 0: check race_flags & 0x20000,
 *   optionally play collision sound, set car flags, write 0xCC to
 *   car[+0x214], tail-call race_config_physics with force_config_a.
 *
 * force_steer_impact (0x0600845E):
 *   Same as force_steer_calc but uses force_config_b.
 *
 * race_config_physics (0x060084C8):
 *   Increment car[+0x1D4] (force counter), clear car[+0x1AC],
 *   call force_table_apply. If current car == player (sym_06078900):
 *   special end-of-race setup: display_mode=3, lap_count=7,
 *   camera_mode=2, view params (z_near=0xF300, z_far=0x6E0000, scale=16.0).
 *
 * brake_force_apply (0x060085C8):
 *   If car[+0x1BC] != 0: set brake timeout, copy position/velocity
 *   data between car slots, call force application. Check lap threshold.
 *
 * sym_06008640:
 *   Dispatch force_table_apply based on car flags and frame counter parity.
 *
 * force_table_apply (0x060086C4):
 *   Core: reads frame_counter parity + force state from car[+0x1C0],
 *   calls channel_commit twice, writes force pointer and vectors from
 *   the force table entry to the car struct.
 *
 * Anonymous (0x06008730):
 *   Decrements car timers [+0x1BC] and [+0x00BC], reads force table
 *   entry (12 bytes: ptr + 5 words), applies force vectors to car
 *   based on direction flags at car[+0x1C0]. Checks lap completion.
 *
 * Car struct offsets used:
 *   +0x001 = flags byte       +0x00BC = timer
 *   +0x028/0x030 = position   +0x1AC = cleared
 *   +0x1B4/0x1B8 = force ptr  +0x1BC = collision timer
 *   +0x1C0 = direction flags  +0x1C4 = force counter
 *   +0x1C8 = force X          +0x1CC = force Y
 *   +0x1D0 = force Z          +0x1D4 = collision count
 *   +0x208 = alt force ptr    +0x214 = flags word
 */

    .section .text.FUN_06008418


    .global force_steer_calc
    .type force_steer_calc, @function
force_steer_calc:
    mov.l r14, @-r15
    sts.l pr, @-r15
    mov.l   .L_car_state_ptr, r14
    mov.w   DAT_060084a2, r0            /* 0x01BC = collision timer offset */
    mov.l @r14, r3
    mov.l @(r0, r3), r0                 /* car[+0x1BC] = collision timer */
    tst r0, r0
    bf      .L_0600845A                  /* timer active → return */
    mov.l   .L_race_flags, r3           /* --- Check race flags --- */
    mov.l   .L_fp_two, r2               /* 0x20000 */
    mov.l @r3, r3
    and r2, r3
    tst r3, r3
    bt      .L_0600843C                  /* flag not set → skip sound */
    mov.l   .L_snd_cmd_collision, r5    /* 0xAE1102FF = collision sound */
    mov.l   .L_fn_sound_dispatch, r3
    jsr @r3                              /* sound_cmd_dispatch(0, collision_snd) */
    mov #0x0, r4
.L_0600843C:                              /* --- Set car flags + force config --- */
    mov.l @r14, r3
    add #0x1, r3
    mov.b @r3, r0                        /* car[+0x01] flags byte */
    and #0xFE, r0                        /* clear bit 0 */
    or #0x1, r0                          /* set bit 0 */
    mov.b r0, @r3
    mov.l @r14, r2
    mov.w   DAT_060084a4, r3            /* 0x00CC */
    mov.w   DAT_060084a6, r0            /* 0x0214 = flags word offset */
    mov.l r3, @(r0, r2)                 /* car[+0x214] = 0xCC */
    mov.l   .L_force_config_a, r4
    mov.l @r4, r4                        /* force config table A entry */
    lds.l @r15+, pr
    bra     race_config_physics          /* → tail-call */
    mov.l @r15+, r14
.L_0600845A:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global force_steer_impact
    .type force_steer_impact, @function
force_steer_impact:
    mov.l r14, @-r15
    sts.l pr, @-r15
    mov.l   .L_car_state_ptr, r14
    mov.w   DAT_060084a2, r0            /* 0x01BC collision timer */
    mov.l @r14, r3
    mov.l @(r0, r3), r0
    tst r0, r0
    bf      .L_060084C4                  /* timer active → return */
    mov.l   .L_race_flags, r3
    mov.l   .L_fp_two, r2
    mov.l @r3, r3
    and r2, r3
    tst r3, r3
    bt      .L_06008484
    mov.l   .L_snd_cmd_collision, r5
    mov.l   .L_fn_sound_dispatch, r3
    jsr @r3                              /* sound_cmd_dispatch(0, collision_snd) */
    mov #0x0, r4
.L_06008484:
    mov.l @r14, r3
    add #0x1, r3
    mov.b @r3, r0
    and #0xFE, r0
    or #0x1, r0
    mov.b r0, @r3
    mov.l @r14, r2
    mov.w   DAT_060084a4, r3
    mov.w   DAT_060084a6, r0
    mov.l r3, @(r0, r2)                 /* car[+0x214] = 0xCC */
    mov.l   .L_force_config_b, r4
    mov.l @r4, r4                        /* force config table B entry */
    lds.l @r15+, pr
    bra     race_config_physics
    mov.l @r15+, r14

    .global DAT_060084a2
DAT_060084a2:
    .2byte  0x01BC                        /* car struct: collision timer offset */

    .global DAT_060084a4
DAT_060084a4:
    .2byte  0x00CC                        /* constant 0xCC (written to flags) */

    .global DAT_060084a6
DAT_060084a6:
    .2byte  0x0214                        /* car struct: flags word offset */
.L_car_state_ptr:
    .4byte  sym_0607E944               /* player car state pointer */
.L_race_flags:
    .4byte  sym_0607EBC4               /* race flags (32-bit) */
.L_fp_two:
    .4byte  0x00020000                  /* 2.0 (16.16 fixed-point) */
.L_snd_cmd_collision:
    .4byte  0xAE1102FF                  /* sound command: collision */
.L_fn_sound_dispatch:
    .4byte  sound_cmd_dispatch         /* sound command dispatcher */
.L_force_config_a:
    .4byte  sym_060453B4               /* force config table A */
.L_force_config_b:
    .4byte  sym_060453BC               /* force config table B */
.L_060084C4:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global race_config_physics
    .type race_config_physics, @function
race_config_physics:
    mov.l r14, @-r15
    sts.l pr, @-r15
    mov.l   .L_car_state_ptr_b, r14
    mov.w   DAT_0600855e, r0            /* 0x01D4 = collision count offset */
    mov.l @r14, r3
    mov.l @(r0, r3), r2
    add #0x1, r2
    mov.l r2, @(r0, r3)                 /* car[+0x1D4]++ */
    mov #0x0, r2
    add #-0x10, r0                       /* 0x01C4 → cleared offset is 0x1AC... wait, 0x1D4 - 0x10 = 0x1C4 */
    mov.l @r14, r3
    mov.l r2, @(r0, r3)                 /* car[+0x1C4] = 0 (force counter) */
    bsr     force_table_apply            /* apply force table entry */
    nop
    mov.l @r14, r2                       /* --- Check if player car --- */
    mov.l   .L_player_car_base, r3
    cmp/eq r3, r2
    bf      .L_06008558                  /* not player → return */
    mov.l   .L_race_flags_b, r3         /* --- Player: check end conditions --- */
    mov.l   .L_fp_two_b, r2
    mov.l @r3, r3
    and r2, r3
    tst r3, r3
    bt      .L_06008558
    mov.l   .L_demo_flag, r0
    mov.b @r0, r0
    extu.b r0, r0
    tst r0, r0
    bf      .L_0600850E                  /* demo active → skip render check */
    mov.l   .L_special_render_flag, r0
    mov.w @r0, r0
    extu.w r0, r0
    tst r0, r0
    bf      .L_06008558                  /* special render → return */
.L_0600850E:                              /* --- End-of-race display setup --- */
    mov #0x3, r3
    mov.l   .L_display_mode_word, r2
    mov #0x0, r5
    mov.w r3, @r2                        /* display_mode = 3 */
    mov #0x7, r3
    mov.l   .L_lap_count, r2
    mov.b r3, @r2                        /* lap_count = 7 */
    mov #0x2, r3
    mov.l   .L_camera_mode, r2
    mov.l r3, @r2                        /* camera_mode = 2 */
    mov #0x1, r3
    mov.l   .L_camera_follow, r2
    mov.l r3, @r2                        /* camera_follow = 1 */
    mov.l   .L_fn_channel_config, r3
    jsr @r3                              /* channel_nibble_config(8, 0) */
    mov #0x8, r4
    mov.l   .L_z_near_start, r2         /* === View frustum params === */
    mov.l   .L_camera_yaw_ptr, r3
    mov.l r2, @r3                        /* camera_yaw = 0x58000 */
    mov.l   .L_z_near_clip, r2
    mov.l   .L_camera_near_store, r3
    mov.l r2, @r3                        /* near_clip = 0xF300 */
    mov.l   .L_z_far_clip, r2
    mov.l   .L_camera_far_store, r3
    mov.l r2, @r3                        /* far_clip = 0x6E0000 */
    mov.l   .L_fp_sixteen, r2
    mov.l   .L_camera_scale_store, r3
    mov.l r2, @r3                        /* z_scale = 16.0 */
    mov #0x0, r2
    mov.l   .L_camera_clear, r3
    mov.l r2, @r3                        /* camera_clear = 0 */
    mov.l @r14, r2
    mov.w   .L_wpool_06008560, r0        /* 0x01BC = collision timer offset */
    mov.l @(r0, r2), r3
    exts.b r3, r3
    mov.l   .L_course_section_byte, r2
    mov.b r3, @r2                        /* course_section = car[+0x1BC] low byte */
.L_06008558:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global DAT_0600855e
DAT_0600855e:
    .2byte  0x01D4                        /* car struct: collision count offset */
.L_wpool_06008560:
    .2byte  0x01BC                        /* car struct: collision timer offset */
    .2byte  0xFFFF
.L_car_state_ptr_b:
    .4byte  sym_0607E944               /* player car state pointer */
.L_player_car_base:
    .4byte  sym_06078900               /* player car array base */
.L_race_flags_b:
    .4byte  sym_0607EBC4               /* race flags (32-bit) */
.L_fp_two_b:
    .4byte  0x00020000                  /* 2.0 (16.16 fixed-point) */
.L_demo_flag:
    .4byte  sym_06078635               /* demo mode flag (byte) */
.L_special_render_flag:
    .4byte  sym_0607ED8C               /* special render enable (16-bit) */
.L_display_mode_word:
    .4byte  sym_0605A016               /* display mode (16-bit) */
.L_lap_count:
    .4byte  sym_06078654               /* lap count (byte) */
.L_camera_mode:
    .4byte  sym_06063E1C               /* camera mode (32-bit) */
.L_camera_follow:
    .4byte  sym_06059F30               /* camera follow flag (32-bit) */
.L_fn_channel_config:
    .4byte  channel_nibble_config      /* channel configuration function */
.L_z_near_start:
    .4byte  0x00058000                  /* view z near start (5.5 in 16.16) */
.L_camera_yaw_ptr:
    .4byte  sym_06063E24               /* camera yaw parameter */
.L_z_near_clip:
    .4byte  0x0000F300                  /* near clip distance */
.L_camera_near_store:
    .4byte  sym_06063E34               /* camera near clip store */
.L_z_far_clip:
    .4byte  0x006E0000                  /* far clip distance */
.L_camera_far_store:
    .4byte  sym_06063E28               /* camera far clip store */
.L_fp_sixteen:
    .4byte  0x00100000                  /* 16.0 (16.16 fixed-point) */
.L_camera_scale_store:
    .4byte  sym_06063E2C               /* camera z-scale store */
.L_camera_clear:
    .4byte  sym_06063E30               /* camera clear register */
.L_course_section_byte:
    .4byte  sym_0607866C               /* course section byte */

    .global brake_force_apply
    .type brake_force_apply, @function
brake_force_apply:
    mov.l r14, @-r15
    sts.l pr, @-r15
    mov.l   .L_active_car_ptr, r14
    mov.w   DAT_06008624, r0            /* 0x01BC = collision timer */
    mov.l @r14, r3
    mov.l @(r0, r3), r0
    tst r0, r0
    bt      .L_0600861E                  /* no collision → return */
    mov #0x46, r3                        /* --- Set brake timeout --- */
    mov.l   .L_brake_timeout, r2
    mov.l r3, @r2                        /* brake_timeout = 70 frames */
    mov.l @r14, r0                       /* --- Check car timer value --- */
    mov.w   DAT_06008626, r1            /* 0x00BC = timer offset */
    mov.l @(r0, r1), r0
    cmp/eq #0x1, r0                      /* timer == 1? */
    bf      .L_060085F6                  /* no → skip position copy */
    mov.l @r14, r2                       /* --- Copy position/velocity data --- */
    mov.w   .L_off_car_flags_160, r0    /* 0x0160 */
    mov.b @(r0, r2), r0
    tst #0x80, r0                        /* bit 7 set? */
    bt      .L_060085F6                  /* no → skip copy */
    mov.l @r14, r3
    mov r3, r2
    mov.l @(48, r2), r1                  /* car[+0x30] = velocity */
    mov.l r1, @(40, r3)                  /* car[+0x28] = car[+0x30] */
    mov.l @r14, r3
    mov r3, r2
    mov.w   DAT_0600862a, r0            /* 0x01EC */
    mov.l @(r0, r2), r1                  /* car[+0x1EC] */
    add #-0x8, r0                        /* 0x01E4 */
    mov.l r1, @(r0, r3)                  /* car[+0x1E4] = car[+0x1EC] */
.L_060085F6:                              /* --- Apply force + check lap --- */
    bsr     .L_06008730                  /* call force timer handler */
    nop
    mov #0x1, r4
    mov.l @r14, r2
    mov.w   DAT_06008624, r0            /* 0x01BC */
    mov.l @(r0, r2), r3
    cmp/gt r4, r3                        /* collision timer > 1? */
    bt      .L_0600861E                  /* still counting → return */
    mov.l   .L_lap_count_b, r5          /* --- Lap count check --- */
    mov.l   .L_race_flags_c, r2
    mov.l   .L_wram_low, r3             /* 0x200000 */
    mov.l @r2, r2
    cmp/eq r3, r2                        /* race_flags == WRAM_Low? (sentinel) */
    bf      .L_0600861A
    mov #0x4, r3
    mov.b r3, @r5                        /* lap_count = 4 */
    bra     .L_0600861E
    nop
.L_0600861A:
    extu.b r4, r4
    mov.b r4, @r5                        /* lap_count = 1 */
.L_0600861E:
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global DAT_06008624
DAT_06008624:
    .2byte  0x01BC                        /* car struct: collision timer offset */

    .global DAT_06008626
DAT_06008626:
    .2byte  0x00BC                        /* car struct: timer offset */
.L_off_car_flags_160:
    .2byte  0x0160                        /* car struct: flags at +0x160 */

    .global DAT_0600862a
DAT_0600862a:
    .2byte  0x01EC                        /* car struct: velocity B offset */
.L_active_car_ptr:
    .4byte  sym_0607E940               /* active car state pointer */
.L_brake_timeout:
    .4byte  sym_0607EBD4               /* brake timeout counter (32-bit) */
.L_lap_count_b:
    .4byte  sym_06078654               /* lap count (byte) */
.L_race_flags_c:
    .4byte  sym_0607EBC4               /* race flags (32-bit) */
.L_wram_low:
    .4byte  0x00200000                  /* Work RAM Low base */

    .global sym_06008640
sym_06008640:                             /* === Force dispatch === */
    mov.l   .L_active_car_ptr_b, r4
    mov.l @r4, r2
    mov r2, r0
    mov.b @r0, r0                        /* car[+0x00] flags byte */
    tst #0x8, r0                         /* bit 3 set? */
    bf      .L_0600865A                  /* yes → clear bit + check timer */
    mov.l @r4, r3                        /* --- Bit 3 clear path --- */
    mov.w   .L_off_collision_timer, r0   /* 0x01BC */
    mov.l @(r0, r3), r0
    tst r0, r0
    bt      .L_060086A0                  /* timer == 0 → return */
    bra     .L_06008730                  /* timer active → apply force */
    nop
.L_0600865A:                              /* --- Bit 3 set: clear it --- */
    mov.l @r4, r3
    mov.b @r3, r0
    and #0xF7, r0                        /* clear bit 3 */
    or #0x0, r0
    mov.b r0, @r3
    mov.l @r4, r2
    mov.w   .L_off_collision_timer, r0
    mov.l @(r0, r2), r0
    tst r0, r0
    bt      .L_06008672                  /* timer == 0 → setup display timer */
    bra     .L_06008730
    nop
.L_06008672:                              /* --- Setup display timer + force --- */
    mov #0x14, r3                        /* display timeout = 20 */
    mov.w   .L_off_display_timer, r0    /* 0x00D4 */
    mov.l @r4, r2
    mov.w r3, @(r0, r2)                 /* car[+0xD4] = 20 */
    mov.l   .L_race_flags_d, r3
    mov.l   .L_race_flag_bit, r2        /* 0x800000 = bit 23 */
    mov.l @r3, r3
    and r2, r3
    tst r3, r3
    bt      .L_0600868C                  /* bit 23 clear → use frame parity */
    mov.l   .L_force_config_c, r4
    bra     force_table_apply
    mov.l @r4, r4                        /* use fixed config C */
.L_0600868C:                              /* --- Frame parity force select --- */
    mov.l   .L_frame_counter, r0
    mov.l @r0, r0
    and #0x1, r0                         /* frame & 1 */
    mov r0, r4
    shll2 r4
    shll r4                              /* parity * 8 */
    mov.l   .L_force_config_table, r3
    add r3, r4
    bra     force_table_apply
    mov.l @r4, r4                        /* use table[parity * 8] */
.L_060086A0:
    rts
    nop
.L_off_collision_timer:
    .2byte  0x01BC                        /* car struct: collision timer offset */
.L_off_display_timer:
    .2byte  0x00D4                        /* car struct: display timer offset */
.L_active_car_ptr_b:
    .4byte  sym_0607E940               /* active car state pointer */
.L_race_flags_d:
    .4byte  sym_0607EBC4               /* race flags (32-bit) */
.L_race_flag_bit:
    .4byte  0x00800000                  /* race flag bit 23 */
.L_force_config_c:
    .4byte  sym_060453C4               /* force config table C */
.L_frame_counter:
    .4byte  sym_0607EBD0               /* frame counter (32-bit) */
.L_force_config_table:
    .4byte  sym_060453B4               /* force config table base */

    .global force_table_apply
    .type force_table_apply, @function
force_table_apply:
    sts.l pr, @-r15
    mov #0x1, r6
    mov.l   .L_frame_counter_b, r7
    mov.l   .L_active_car_ptr_c, r5
    mov.w   .L_off_force_state, r3      /* 0x01C0 = force state offset */
    mov.l @r7, r0                        /* frame_counter */
    mov.l @r5, r2                        /* car_state */
    and r6, r0                           /* frame & 1 (parity) */
    add r3, r2                           /* &car[+0x1C0] */
    mov.l   .L_fn_channel_commit, r3
    jsr @r3                              /* channel_commit(car+0x1C0, parity, 1) */
    mov r6, r1                           /* channel ID = 0x0001 */
    mov.l @r5, r2                        /* --- Second channel commit --- */
    mov.l @r7, r0
    mov.w   .L_off_force_state, r3
    mov.w   .L_channel_id_b, r1         /* 0x0101 */
    shar r0                              /* frame_counter >> 1 (quarter parity) */
    add r3, r2
    mov.l   .L_fn_channel_commit, r3
    jsr @r3                              /* channel_commit(car+0x1C0, parity>>1, 0x0101) */
    and r6, r0
    mov.l @r5, r2                        /* --- Write force pointer --- */
    mov.l @r4, r3                        /* config[+0] = force data ptr */
    mov.w   .L_off_force_ptr, r0        /* 0x01B8 */
    mov.l r3, @(r0, r2)                 /* car[+0x1B8] = force_ptr */
    mov.l @(4, r4), r4                  /* config[+4] = timer value */
    mov.l @r5, r3
    mov.w   DAT_0600871a, r0            /* 0x01BC */
    mov.l r4, @(r0, r3)                 /* car[+0x1BC] = timer */
    add #-0x28, r4                       /* timer - 0x28 */
    mov.l @r5, r3
    mov.w   DAT_0600871c, r0            /* 0x00BC */
    mov.l r4, @(r0, r3)                 /* car[+0x00BC] = timer - 0x28 */
    mov.l @r5, r3
    mov.w   .L_off_alt_force_ptr, r0    /* 0x0208 */
    mov.l r4, @(r0, r3)                 /* car[+0x208] = timer - 0x28 */
    mov.l   .L_force_apply_count, r4
    mov.b @r4, r3
    add r6, r3                           /* force_apply_count++ */
    mov.b r3, @r4
    bra     .L_06008730                  /* → apply force vectors */
    lds.l @r15+, pr
.L_off_force_state:
    .2byte  0x01C0                        /* car struct: force state offset */
.L_channel_id_b:
    .2byte  0x0101                        /* channel ID 0x0101 */
.L_off_force_ptr:
    .2byte  0x01B8                        /* car struct: force pointer offset */

    .global DAT_0600871a
DAT_0600871a:
    .2byte  0x01BC                        /* car struct: collision timer offset */

    .global DAT_0600871c
DAT_0600871c:
    .2byte  0x00BC                        /* car struct: timer offset */
.L_off_alt_force_ptr:
    .2byte  0x0208                        /* car struct: alt force pointer offset */
.L_frame_counter_b:
    .4byte  sym_0607EBD0               /* frame counter (32-bit) */
.L_active_car_ptr_c:
    .4byte  sym_0607E940               /* active car state pointer */
.L_fn_channel_commit:
    .4byte  sym_06034F78               /* channel data commit */
.L_force_apply_count:
    .4byte  sym_0607EBEC               /* force apply count (byte) */
.L_06008730:                              /* === Force timer + vector application === */
    mov.l   .L_active_car_ptr_d, r4
    mov.w   DAT_060087e8, r0            /* 0x01BC = collision timer */
    mov.l @r4, r3
    mov.l @(r0, r3), r2                 /* car[+0x1BC] */
    cmp/pl r2                            /* > 0? */
    bf/s    .L_06008748
    mov #0x0, r6                         /* r6 = 0 (delay slot) */
    mov.l @r4, r2                        /* --- Decrement collision timer --- */
    mov.w   DAT_060087e8, r0
    mov.l @(r0, r2), r3
    add #-0x1, r3
    mov.l r3, @(r0, r2)                 /* car[+0x1BC]-- */
.L_06008748:                              /* --- Check secondary timer --- */
    mov.l @r4, r3
    mov.w   DAT_060087ea, r0            /* 0x00BC = timer */
    mov.l @(r0, r3), r2
    cmp/pl r2
    bf      .L_0600875C
    mov.l @r4, r2
    mov.w   DAT_060087ea, r0
    mov.l @(r0, r2), r3
    add #-0x1, r3
    mov.l r3, @(r0, r2)                 /* car[+0xBC]-- */
.L_0600875C:                              /* --- Check timer == 10 → set display --- */
    mov.l @r4, r0
    mov.w   DAT_060087ea, r1
    mov.l @(r0, r1), r0
    cmp/eq #0xA, r0                      /* timer == 10? */
    bf      .L_0600876E
    mov.l @r4, r2
    mov #0xA, r3
    mov.w   DAT_060087ec, r0            /* 0x00D4 = display timer */
    mov.w r3, @(r0, r2)                 /* car[+0xD4] = 10 */
.L_0600876E:                              /* === Read force table entry === */
    mov.l @r4, r5
    mov.w   .L_off_force_ptr_b, r0      /* 0x01B8 */
    mov.l @(r0, r5), r3                 /* force_ptr = car[+0x1B8] */
    add #0xC, r3                         /* advance by 12 bytes */
    mov.l r3, @(r0, r5)                 /* car[+0x1B8] = force_ptr + 12 */
    add #-0xC, r3                        /* back to original entry */
    add #-0x4, r0                        /* 0x01B4 */
    mov r3, r5                           /* r5 → force table entry (12 bytes) */
    mov.l @r4, r3
    mov.l @r5, r2                        /* entry[+0] = force data pointer */
    mov.l r2, @(r0, r3)                 /* car[+0x1B4] = force_data_ptr */
    mov.w @(4, r5), r0                  /* entry[+4] = direction/magnitude word */
    mov.l @r4, r2
    mov r0, r7                           /* save direction word */
    mov.w   .L_off_direction_flags, r0   /* 0x01C0 */
    mov.b @(r0, r2), r0                 /* car[+0x1C0] direction flags byte */
    tst #0x40, r0                        /* bit 6 = negate X? */
    bt      .L_060087B8                  /* bit clear → check bit 7 */
    mov.l @r4, r3                        /* --- Bit 6 set: negate X vectors --- */
    mov.w @(6, r5), r0                  /* entry[+6] = force X component */
    mov r0, r2
    mov.w   .L_off_force_x, r0          /* 0x01C8 */
    mov.l r2, @(r0, r3)                 /* car[+0x1C8] = force_X (positive) */
    mov.l @r4, r3
    mov.w @(8, r5), r0                  /* entry[+8] = force Y component */
    mov r0, r2
    neg r2, r2                           /* negate */
    mov.w   DAT_060087f4, r0            /* 0x01CC */
    mov.l r2, @(r0, r3)                 /* car[+0x1CC] = -force_Y */
    mov.l @r4, r3
    mov.w @(10, r5), r0                 /* entry[+10] = force Z component */
    mov r0, r2
    neg r2, r2
    mov.w   .L_off_force_z, r0          /* 0x01D0 */
    mov.l r2, @(r0, r3)                 /* car[+0x1D0] = -force_Z */
    bra     .L_0600881A
    nop
.L_060087B8:                              /* --- Check bit 7 --- */
    mov.l @r4, r2
    mov.w   .L_off_direction_flags, r0
    mov.b @(r0, r2), r0
    tst #0x80, r0                        /* bit 7 = negate XY? */
    bt      .L_060087FC                  /* bit clear → default path */
    mov.l @r4, r3                        /* --- Bit 7 set: negate XY --- */
    mov.w @(6, r5), r0
    mov r0, r2
    neg r2, r2
    mov.w   .L_off_force_x, r0
    mov.l r2, @(r0, r3)                 /* car[+0x1C8] = -force_X */
    mov.l @r4, r3
    mov.w @(8, r5), r0
    mov r0, r2
    neg r2, r2
    mov.w   DAT_060087f4, r0
    mov.l r2, @(r0, r3)                 /* car[+0x1CC] = -force_Y */
    mov.l @r4, r3
    mov.w @(10, r5), r0
    mov r0, r2
    mov.w   .L_off_force_z, r0
    mov.l r2, @(r0, r3)                 /* car[+0x1D0] = force_Z (positive) */
    bra     .L_0600881A
    nop

    .global DAT_060087e8
DAT_060087e8:
    .2byte  0x01BC                        /* car struct: collision timer */

    .global DAT_060087ea
DAT_060087ea:
    .2byte  0x00BC                        /* car struct: timer */

    .global DAT_060087ec
DAT_060087ec:
    .2byte  0x00D4                        /* car struct: display timer */
.L_off_force_ptr_b:
    .2byte  0x01B8                        /* car struct: force pointer */
.L_off_direction_flags:
    .2byte  0x01C0                        /* car struct: direction flags */
.L_off_force_x:
    .2byte  0x01C8                        /* car struct: force X vector */

    .global DAT_060087f4
DAT_060087f4:
    .2byte  0x01CC                        /* car struct: force Y vector */
.L_off_force_z:
    .2byte  0x01D0                        /* car struct: force Z vector */
.L_active_car_ptr_d:
    .4byte  sym_0607E940               /* active car state pointer */
.L_060087FC:                              /* --- Default: vectors unchanged --- */
    mov.l @r4, r2
    mov.w @(6, r5), r0
    mov r0, r3
    mov.w   .L_off_force_x_b, r0        /* 0x01C8 */
    mov.l r3, @(r0, r2)                 /* car[+0x1C8] = force_X */
    mov.l @r4, r3
    mov.w @(8, r5), r0
    mov r0, r2
    mov.w   DAT_060088ac, r0            /* 0x01CC */
    mov.l r2, @(r0, r3)                 /* car[+0x1CC] = force_Y */
    mov.l @r4, r3
    mov.w @(10, r5), r0
    mov r0, r2
    mov.w   .L_off_force_z_b, r0        /* 0x01D0 */
    mov.l r2, @(r0, r3)                 /* car[+0x1D0] = force_Z */
.L_0600881A:                              /* === Check force direction match === */
    mov.l @r4, r3
    mov.l   .L_force_direction_byte, r2
    mov.l @(4, r3), r3                  /* car[+0x04] = car ID byte */
    mov.b @r2, r2
    extu.b r2, r2
    cmp/eq r2, r3                        /* car_id == force_direction? */
    bf      .L_06008884                  /* no match → skip counter logic */
    exts.w r7, r7                        /* sign-extend direction word */
    mov.l @r4, r3
    mov.w   DAT_060088b0, r0            /* 0x01C4 = force counter */
    mov.l @(r0, r3), r2
    add #0x1, r2
    mov.l r2, @(r0, r3)                 /* car[+0x1C4]++ */
    mov.w   DAT_060088b2, r3            /* 0x0100 = threshold */
    cmp/gt r3, r7                        /* direction > 256? */
    bf      .L_0600885A
    mov.l @r4, r3                        /* --- Strong force: check 80/40 --- */
    mov.w   DAT_060088b0, r0
    mov.l @(r0, r3), r2
    mov #0x50, r3                        /* 80 */
    cmp/ge r3, r2                        /* counter >= 80? */
    bf      .L_0600884A
    bra     .L_06008854                  /* yes → clear counter */
    nop
.L_0600884A:
    mov.l @r4, r2
    mov.w   DAT_060088b0, r0
    mov.l @(r0, r2), r3
    mov #0x28, r2                        /* 40 */
    cmp/ge r2, r3                        /* counter >= 40? T bit set */
.L_06008854:                              /* --- Clear force counter --- */
    mov.l @r4, r2
    mov.w   DAT_060088b0, r0
    mov.l r6, @(r0, r2)                 /* car[+0x1C4] = 0 */
.L_0600885A:                              /* --- Check collision timer for lap --- */
    mov.l @r4, r3
    mov.w   DAT_060088b4, r0            /* 0x01BC */
    mov.l @(r0, r3), r0
    tst r0, r0
    bf      .L_06008884                  /* still counting → skip lap check */
    exts.b r6, r3                        /* --- Timer expired: check lap --- */
    mov.l   .L_course_section, r2
    mov.b r3, @r2                        /* course_section = 0 */
    mov.l   .L_demo_flag_b, r0
    mov.b @r0, r0
    extu.b r0, r0
    tst r0, r0
    bf      .L_0600887E                  /* demo → set display mode */
    mov.l   .L_special_render_flag_b, r0
    mov.w @r0, r0
    extu.w r0, r0
    tst r0, r0
    bf      .L_06008884                  /* special render → skip */
.L_0600887E:
    mov #0x4, r3
    mov.l   .L_display_mode_word_b, r2
    mov.w r3, @r2                        /* display_mode = 4 */
.L_06008884:                              /* --- Clear force state on timer 0 --- */
    mov.l @r4, r3
    mov.w   DAT_060088b4, r0            /* 0x01BC */
    mov.l @(r0, r3), r0
    tst r0, r0
    bf      .L_060088A6                  /* still counting → return */
    mov.l @r4, r3                        /* --- Timer == 0: clear 4 fields --- */
    mov.w   DAT_060088b6, r0            /* 0x01B4 */
    mov.l r6, @(r0, r3)                 /* car[+0x1B4] = 0 */
    mov.l @r4, r3
    add #0x14, r0                        /* 0x01C8 */
    mov.l r6, @(r0, r3)                 /* car[+0x1C8] = 0 (force X) */
    mov.l @r4, r3
    add #0x4, r0                         /* 0x01CC */
    mov.l r6, @(r0, r3)                 /* car[+0x1CC] = 0 (force Y) */
    mov.l @r4, r3
    add #0x4, r0                         /* 0x01D0 */
    mov.l r6, @(r0, r3)                 /* car[+0x1D0] = 0 (force Z) */
.L_060088A6:
    rts
    nop
.L_off_force_x_b:
    .2byte  0x01C8                        /* car struct: force X vector */

    .global DAT_060088ac
DAT_060088ac:
    .2byte  0x01CC                        /* car struct: force Y vector */
.L_off_force_z_b:
    .2byte  0x01D0                        /* car struct: force Z vector */

    .global DAT_060088b0
DAT_060088b0:
    .2byte  0x01C4                        /* car struct: force counter */

    .global DAT_060088b2
DAT_060088b2:
    .2byte  0x0100                        /* force threshold (256) */

    .global DAT_060088b4
DAT_060088b4:
    .2byte  0x01BC                        /* car struct: collision timer */

    .global DAT_060088b6
DAT_060088b6:
    .2byte  0x01B4                        /* car struct: force data pointer */
.L_force_direction_byte:
    .4byte  sym_0607EBBC               /* force direction byte */
.L_course_section:
    .4byte  sym_0607866C               /* course section byte */
.L_demo_flag_b:
    .4byte  sym_06078635               /* demo mode flag (byte) */
.L_special_render_flag_b:
    .4byte  sym_0607ED8C               /* special render enable (16-bit) */
.L_display_mode_word_b:
    .4byte  sym_0605A016               /* display mode (16-bit) */
