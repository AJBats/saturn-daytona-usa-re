/* display_mode_init -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06014A74 - 0x06014D2C
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Display mode initialization — sets up display channels, color palettes,
 * VDP1 sprite data, VDP2 tile maps, and HUD element table for the race
 * display mode.
 *
 * Initialization sequence:
 *   1. Configure 6 display channels via channel_nibble_config:
 *      (0x100,0), (4,1), (8,1), (16,2), (32,7), (1,0)
 *   2. Conditional path:
 *      - If sym_06085F8A == 0: layer_config(4), display_channel_b(8,0,0),
 *        channel_nibble(16,6), render_commit, gameover_channel_setup
 *      - If nonzero: obj_data_compact, frame_end_commit
 *   3. channel_nibble(0x100,4), layer_config(0xC)
 *   4. display_channel_b(16,0,0), display_channel_b(32,0,0)
 *   5. Copy 4 color palettes (32 bytes each) to VDP2 CRAM:
 *      +0x660, +0x680, +0x6A0, +0x6C0
 *   6. Copy 4 sprite pattern sets (32 bytes each) to VDP1 VRAM:
 *      at base + index*8 + offset (0x260, 0x280, 0x220, 0x240)
 *   7. Copy 4 tile maps (8 tiles each) to VDP2 VRAM:
 *      +0x73B98, +0x74158, +0x74AFC, +0x75730
 *   8. Initialize HUD element table (44 entries × 0x36-byte stride):
 *      Set priority, entry count, and element slots
 *   9. vdp2_loop_ctrl, geom_pipeline_coord
 *  10. Set display flags, optional car demo parameter setup
 *
 * Persistent registers:
 *   r8  = VDP1 VRAM base (0x25C00000)
 *   r9  = HUD element table base (sym_06085640)
 *   r10 = 1 (constant)
 *   r11 = 0 (constant)
 *   r12 = channel_nibble_config function
 *   r13 = memcpy function (word or tile)
 *   r14 = HUD entry count (25)
 */

    .section .text.FUN_06014A74


    .global display_mode_init
    .type display_mode_init, @function
display_mode_init:
    mov.l r14, @-r15
    mov #0x19, r14                       /* r14 = 25 (HUD entry count) */
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov #0x0, r11                        /* r11 = 0 (constant zero) */
    mov.l r10, @-r15
    mov #0x1, r10                        /* r10 = 1 (constant one) */
    mov.l r9, @-r15
    mov.l r8, @-r15
    sts.l pr, @-r15
    sts.l macl, @-r15
    mov.l   .L_hud_table_base, r9       /* r9 = HUD element table base */
    mov.l   .L_fn_channel_config, r12   /* r12 = channel_nibble_config */
    mov.w   .L_channel_id_0x100, r4     /* === Channel configuration === */
    jsr @r12                             /* channel_nibble_config(0x100, 0) */
    mov r11, r5
    mov r10, r5
    jsr @r12                             /* channel_nibble_config(4, 1) */
    mov #0x4, r4
    mov r10, r5
    jsr @r12                             /* channel_nibble_config(8, 1) */
    mov #0x8, r4
    mov #0x2, r5
    jsr @r12                             /* channel_nibble_config(16, 2) */
    mov #0x10, r4
    mov #0x7, r5
    jsr @r12                             /* channel_nibble_config(32, 7) */
    mov #0x20, r4
    mov r11, r5
    jsr @r12                             /* channel_nibble_config(1, 0) */
    mov r10, r4
    mov.l   .L_display_skip_flag, r3    /* === Conditional display path === */
    mov.b @r3, r3
    tst r3, r3
    bf      .L_06014B00                  /* nonzero → compact+commit path */
    mov.l   .L_fn_layer_config, r3      /* --- Standard init path --- */
    jsr @r3                              /* layer_config(4) */
    mov #0x4, r4
    mov #0x0, r6
    mov.l   .L_fn_display_channel, r3
    mov r6, r5
    jsr @r3                              /* display_channel_b(8, 0, 0) */
    mov #0x8, r4
    mov #0x6, r5
    jsr @r12                             /* channel_nibble_config(16, 6) */
    mov #0x10, r4
    mov.l   .L_fn_render_commit, r3
    jsr @r3                              /* render_commit() */
    nop
    mov.l   .L_fn_gameover_setup, r3
    jsr @r3                              /* gameover_channel_setup() */
    nop
    bra     .L_06014B0C
    nop
.L_channel_id_0x100:
    .2byte  0x0100                        /* channel ID 0x100 */
.L_hud_table_base:
    .4byte  sym_06085640               /* HUD element table base */
.L_fn_channel_config:
    .4byte  channel_nibble_config      /* channel configuration function */
.L_display_skip_flag:
    .4byte  sym_06085F8A               /* display skip flag (byte) */
.L_fn_layer_config:
    .4byte  sym_0602853E               /* display layer configuration */
.L_fn_display_channel:
    .4byte  display_channel_b          /* display channel B enable */
.L_fn_render_commit:
    .4byte  sym_06028560               /* render state commit */
.L_fn_gameover_setup:
    .4byte  gameover_channel_setup     /* game over channel setup */
.L_06014B00:                              /* --- Compact+commit path --- */
    mov.l   .L_fn_obj_compact, r3
    jsr @r3                              /* obj_data_compact() */
    nop
    mov.l   .L_fn_frame_commit, r3
    jsr @r3                              /* frame_end_commit() */
    nop
.L_06014B0C:                              /* === Common initialization === */
    mov.w   .L_channel_id_0x100_b, r4
    jsr @r12                             /* channel_nibble_config(0x100, 4) */
    mov #0x4, r5
    mov.l   .L_fn_layer_config_b, r3
    jsr @r3                              /* layer_config(0xC) */
    mov #0xC, r4
    mov #0x0, r6
    mov.l   .L_fn_display_channel_b, r3
    mov r6, r5
    jsr @r3                              /* display_channel_b(16, 0, 0) */
    mov #0x10, r4
    mov #0x0, r6
    mov.l   .L_fn_display_channel_b, r3
    mov r6, r5
    jsr @r3                              /* display_channel_b(32, 0, 0) */
    mov #0x20, r4
    mov.l   .L_fn_memcpy_word, r13      /* r13 = memcpy_word_idx */
    mov.l   .L_palette_src_0, r5        /* === Color palette copies === */
    mov.l   .L_vdp2_cram_0x660, r4
    jsr @r13                             /* memcpy(CRAM+0x660, palette_0, 32) */
    mov #0x20, r6
    mov.l   .L_palette_src_1, r5
    mov.l   .L_vdp2_cram_0x680, r4
    jsr @r13                             /* memcpy(CRAM+0x680, palette_1, 32) */
    mov #0x20, r6
    mov.l   .L_palette_src_2, r5
    mov.l   .L_vdp2_cram_0x6A0, r4
    jsr @r13                             /* memcpy(CRAM+0x6A0, palette_2, 32) */
    mov #0x20, r6
    mov.l   .L_palette_src_3, r5
    mov.l   .L_vdp2_cram_0x6C0, r4
    jsr @r13                             /* memcpy(CRAM+0x6C0, palette_3, 32) */
    mov #0x20, r6
    mov #0x20, r6                        /* === VDP1 sprite pattern copies === */
    mov.l   .L_sprite_src_0, r5
    mov.l   .L_vdp1_vram_base, r8       /* r8 = 0x25C00000 */
    mov.l   .L_tile_index_ptr, r4
    mov.w   .L_sprite_offset_0, r3      /* 0x0260 */
    mov.l @r4, r4                        /* tile_index */
    shll2 r4
    shll r4                              /* index * 8 */
    add r8, r4
    jsr @r13                             /* memcpy(VRAM + idx*8 + 0x260, src_0, 32) */
    add r3, r4
    mov #0x20, r6
    mov.l   .L_sprite_src_1, r5
    mov.l   .L_tile_index_ptr, r4
    mov.w   .L_sprite_offset_1, r3      /* 0x0280 */
    mov.l @r4, r4
    shll2 r4
    shll r4
    add r8, r4
    jsr @r13                             /* memcpy(VRAM + idx*8 + 0x280, src_1, 32) */
    add r3, r4
    mov #0x20, r6
    mov.l   .L_sprite_src_2, r5
    mov.l   .L_tile_index_ptr, r4
    mov.w   .L_sprite_offset_2, r3      /* 0x0220 */
    mov.l @r4, r4
    shll2 r4
    shll r4
    add r8, r4
    jsr @r13                             /* memcpy(VRAM + idx*8 + 0x220, src_2, 32) */
    add r3, r4
    mov #0x20, r6
    mov.l   .L_sprite_src_3, r5
    mov.l   .L_tile_index_ptr, r4
    mov.w   .L_sprite_offset_3, r3      /* 0x0240 */
    mov.l @r4, r4
    shll2 r4
    shll r4
    add r8, r4
    jsr @r13                             /* memcpy(VRAM + idx*8 + 0x240, src_3, 32) */
    add r3, r4
    mov.l   .L_fn_vram_tile_copy, r13   /* === VDP2 tile map copies === */
    mov #0x8, r7                         /* 8 tiles per map */
    mov.l   .L_tilemap_src_0, r5
    mov.l   .L_vdp2_vram_0x73B98, r4
    jsr @r13                             /* vram_tile_copy(+0x73B98, tilemap_0, 0, 8) */
    mov #0x0, r6
    mov #0x8, r7
    mov.l   .L_tilemap_src_1, r5
    mov.l   .L_vdp2_vram_0x74158, r4
    jsr @r13                             /* vram_tile_copy(+0x74158, tilemap_1, 0, 8) */
    mov #0x0, r6
    mov #0x8, r7
    mov.l   .L_tilemap_src_2, r5
    mov.l   .L_vdp2_vram_0x74AFC, r4
    jsr @r13                             /* vram_tile_copy(+0x74AFC, tilemap_2, 0, 8) */
    mov #0x0, r6
    mov #0x8, r7
    mov.l   .L_tilemap_src_3, r5
    mov.l   .L_vdp2_vram_0x75730, r4
    jsr @r13                             /* vram_tile_copy(+0x75730, tilemap_3, 0, 8) */
    mov #0x0, r6
    bra     .L_06014C7C                  /* → HUD table init */
    extu.b r11, r5                       /* r5 = 0 (first element) */
.L_channel_id_0x100_b:
    .2byte  0x0100                        /* channel ID 0x100 (second ref) */
.L_sprite_offset_0:
    .2byte  0x0260                        /* VDP1 sprite offset 0 */
.L_sprite_offset_1:
    .2byte  0x0280                        /* VDP1 sprite offset 1 */
.L_sprite_offset_2:
    .2byte  0x0220                        /* VDP1 sprite offset 2 */
.L_sprite_offset_3:
    .2byte  0x0240                        /* VDP1 sprite offset 3 */
.L_fn_obj_compact:
    .4byte  obj_data_compact           /* object data compaction */
.L_fn_frame_commit:
    .4byte  frame_end_commit           /* frame end commit */
.L_fn_layer_config_b:
    .4byte  sym_0602853E               /* display layer configuration */
.L_fn_display_channel_b:
    .4byte  display_channel_b          /* display channel B enable */
.L_fn_memcpy_word:
    .4byte  memcpy_word_idx            /* word-indexed memory copy */
.L_palette_src_0:
    .4byte  sym_06044A64               /* color palette source 0 */
.L_vdp2_cram_0x660:
    .4byte  0x25F00660                  /* VDP2 color RAM +0x660 */
.L_palette_src_1:
    .4byte  sym_06044A84               /* color palette source 1 */
.L_vdp2_cram_0x680:
    .4byte  0x25F00680                  /* VDP2 color RAM +0x680 */
.L_palette_src_2:
    .4byte  sym_06044AA4               /* color palette source 2 */
.L_vdp2_cram_0x6A0:
    .4byte  0x25F006A0                  /* VDP2 color RAM +0x6A0 */
.L_palette_src_3:
    .4byte  sym_06044AC4               /* color palette source 3 */
.L_vdp2_cram_0x6C0:
    .4byte  0x25F006C0                  /* VDP2 color RAM +0x6C0 */
.L_vdp1_vram_base:
    .4byte  0x25C00000                  /* VDP1 VRAM base */
.L_sprite_src_0:
    .4byte  sym_06044AE4               /* sprite pattern source 0 */
.L_tile_index_ptr:
    .4byte  sym_06059FFC               /* tile index value (ptr, *8 for offset) */
.L_sprite_src_1:
    .4byte  sym_06044B24               /* sprite pattern source 1 */
.L_sprite_src_2:
    .4byte  sym_06044B04               /* sprite pattern source 2 */
.L_sprite_src_3:
    .4byte  sym_06044B44               /* sprite pattern source 3 */
.L_fn_vram_tile_copy:
    .4byte  sym_0600511E               /* VRAM tile data copy */
.L_tilemap_src_0:
    .4byte  0x00017700                  /* tile map source 0 address */
.L_vdp2_vram_0x73B98:
    .4byte  0x25E73B98                  /* VDP2 VRAM +0x73B98 */
.L_tilemap_src_1:
    .4byte  0x000189E0                  /* tile map source 1 address */
.L_vdp2_vram_0x74158:
    .4byte  0x25E74158                  /* VDP2 VRAM +0x74158 */
.L_tilemap_src_2:
    .4byte  0x0001AFA0                  /* tile map source 2 address */
.L_vdp2_vram_0x74AFC:
    .4byte  0x25E74AFC                  /* VDP2 VRAM +0x74AFC */
.L_tilemap_src_3:
    .4byte  0x0001C980                  /* tile map source 3 address */
.L_vdp2_vram_0x75730:
    .4byte  0x25E75730                  /* VDP2 VRAM +0x75730 */
.L_06014C48:                              /* === Per-element HUD init === */
    extu.b r5, r4
    mov #0x36, r3                        /* element stride = 54 bytes */
    muls.w r3, r4
    sts macl, r4
    exts.w r4, r4
    add r9, r4                           /* &hud_table[element * 0x36] */
    extu.w r10, r2                       /* = 1 */
    mov.w r2, @r4                        /* elem[+0x00] = 1 (priority) */
    extu.w r14, r0                       /* = 25 */
    mov.w r0, @(2, r4)                   /* elem[+0x02] = 25 (entry count) */
    extu.b r11, r4                       /* slot = 0 */
    extu.b r5, r6
    muls.w r3, r6
    sts macl, r6
    exts.w r6, r6
    add r9, r6                           /* &hud_table[element * 0x36] */
.L_06014C68:                              /* --- Slot fill loop --- */
    extu.b r4, r2                        /* slot index */
    mov #0x20, r0                        /* slot value = 32 */
    shll r2                              /* slot * 2 (word offset) */
    add #0x1, r4                         /* slot++ */
    add r6, r2                           /* &elem[slot * 2] */
    extu.b r4, r3
    mov.w r0, @(4, r2)                   /* elem[+4 + slot*2] = 32 */
    cmp/ge r14, r3                        /* slot >= 25? */
    bf      .L_06014C68
    add #0x1, r5                         /* element++ */
.L_06014C7C:                              /* --- Element loop condition --- */
    extu.b r5, r3
    mov #0x2C, r2                        /* 44 elements total */
    cmp/ge r2, r3
    bf      .L_06014C48                  /* → next element */
    mov.l   .L_fn_vdp2_loop, r3         /* === Post-init finalization === */
    jsr @r3                              /* vdp2_loop_ctrl() */
    nop
    mov.l   .L_fn_geom_pipeline, r3
    jsr @r3                              /* geom_pipeline_coord() */
    nop
    exts.w r10, r0                       /* r0 = 1 */
    mov.l   .L_display_flag_a, r3
    mov.b r11, @r3                       /* display_flag_a = 0 */
    mov.l   .L_display_flag_b, r3
    mov.w r11, @r3                       /* display_flag_b = 0 */
    mov.l   .L_display_flag_c, r3
    mov.w r0, @r3                        /* display_flag_c = 1 */
    mov.l   .L_fn_pre_display, r3
    jsr @r3                              /* pre_display() */
    nop
    mov.l   .L_special_render_check, r0 /* === Optional car demo params === */
    mov.w @r0, r0
    extu.w r0, r0
    cmp/eq #0x2, r0
    .word 0x0029 /* UNKNOWN */
    mov.l   .L_race_event_flags, r3
    mov.l @r3, r3
    and r3, r0
    and r10, r0
    tst r0, r0
    bt      .L_06014CDE                  /* not active → return */
    mov #0x27, r3                        /* --- Set demo parameters --- */
    mov.l   .L_display_flag_b, r2
    mov.w r3, @r2                        /* display_flag_b = 0x27 */
    mov.l   .L_car_state_ptr, r4
    mov.l @r4, r3                        /* car_state base */
    mov.l   .L_demo_src_byte, r2
    mov.b @r2, r2                        /* demo source byte */
    mov.w   DAT_06014cf2, r0             /* 0x0224 offset */
    mov.l r2, @(r0, r3)                 /* car[+0x224] = demo_src_byte */
    mov.l @r4, r3
    mov.l   .L_demo_src_word, r2
    mov.l @r2, r2                        /* demo source word */
    mov.w   .L_car_demo_offset_b, r0    /* 0x0240 offset */
    mov.l r2, @(r0, r3)                 /* car[+0x240] = demo_src_word */
    mov.l   .L_demo_params, r3
    mov.l @r3, r3
    mov.l   .L_demo_dest, r2
    mov.l r3, @r2                        /* demo_dest = demo_params */
.L_06014CDE:                              /* === Return === */
    lds.l @r15+, macl
    lds.l @r15+, pr
    mov.l @r15+, r8
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14

    .global DAT_06014cf2
DAT_06014cf2:
    .2byte  0x0224                        /* car struct: demo param A offset */
.L_car_demo_offset_b:
    .2byte  0x0240                        /* car struct: demo param B offset */
    .2byte  0xFFFF
.L_fn_vdp2_loop:
    .4byte  vdp2_loop_ctrl             /* VDP2 loop control */
.L_fn_geom_pipeline:
    .4byte  geom_pipeline_coord        /* geometry pipeline coordinates */
.L_display_flag_a:
    .4byte  sym_06085F89               /* display flag A (byte) */
.L_display_flag_b:
    .4byte  sym_06085F90               /* display flag B (16-bit) */
.L_display_flag_c:
    .4byte  sym_06085F94               /* display flag C (16-bit) */
.L_fn_pre_display:
    .4byte  sym_060149CC               /* pre-display setup */
.L_special_render_check:
    .4byte  sym_0607ED8C               /* special render enable (16-bit) */
.L_race_event_flags:
    .4byte  sym_0607EBF4               /* race event bitfield (32-bit) */
.L_car_state_ptr:
    .4byte  sym_0607E944               /* car state base pointer */
.L_demo_src_byte:
    .4byte  sym_06078637               /* demo source byte */
.L_demo_src_word:
    .4byte  sym_06078638               /* demo source word (32-bit) */
.L_demo_params:
    .4byte  sym_0607863C               /* demo parameters source */
.L_demo_dest:
    .4byte  sym_060786A4               /* demo parameters destination */
