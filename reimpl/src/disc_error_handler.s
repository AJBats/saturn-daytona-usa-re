/* disc_error_handler -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601B4D6 - 0x0601B584
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Disc error handler — checks CD status flags and triggers recovery.
 *
 * Two functions:
 *   disc_error_handler: Main handler — checks two error flag sets:
 *     1. bit 8 of CD status → fatal: set error flag, jump to handler_init_reset
 *     2. bits 11:9 of CD status → recoverable: check disc type, set error code
 *   loc_0601B566: Sets error code to 3 (disc removed/unreadable)
 *
 * Data block (0x0601B4F6-0x0601B523): Embedded palette/display data for the
 * error screen overlay, reused from disc_error_handler's parent TU. This is
 * NOT code — it's a constant pool shared with adjacent functions.
 */

    .section .text.FUN_0601B4D6


    .global disc_error_handler
    .type disc_error_handler, @function
disc_error_handler:
    sts.l pr, @-r15
    .byte   0xD3, 0x12    /* mov.l .L_cd_status, r3 */
    mov.w @r3, r2                     /* r2 = CD status word */
    mov.w   .L_err_mask_fatal, r3     /* 0x0100 = bit 8 (fatal error) */
    extu.w r2, r2
    and r3, r2
    tst r2, r2
    bt      .L_0601B530              /* no fatal error → check recoverable */
    mov #0x1, r3                      /* fatal error path */
    .byte   0xD2, 0x0F    /* mov.l .L_error_flag, r2 */
    mov.b r3, @r2                     /* set error flag = 1 */
    .byte   0xD3, 0x0F    /* mov.l .L_fn_init_reset, r3 */
    jmp @r3                           /* jump to handler_init_reset (no return) */
    lds.l @r15+, pr
    .2byte  0x0080                      /* padding */
.L_err_mask_fatal:
    .2byte  0x0100                      /* CD status bit 8: fatal disc error */
    .2byte  0xFFFF
    .4byte  sym_060485EC
    .4byte  0x25F00020
    .4byte  memcpy_word_idx
    .4byte  sym_060485CC
    .4byte  0x25F00180
    .4byte  sym_06028560
    .4byte  sym_0602853E
    .4byte  sym_060638C8
    .4byte  0x0000C000
    .4byte  sym_06028400
    .4byte  sym_0608600D
.L_cd_status:
    .4byte  sym_06063D9A               /* CD block status word (16-bit) */
.L_error_flag:
    .4byte  sym_0608600C               /* disc error flag (byte) */
.L_fn_init_reset:
    .4byte  handler_init_reset         /* system reset handler */
.L_0601B530:
    .byte   0xB1, 0x60    /* bsr 0x0601B7F4 (external) — palette setup for error screen */
    nop
    .byte   0xB0, 0xD2    /* bsr 0x0601B6DC (external) — display setup for error screen */
    nop
    .byte   0xD2, 0x0D    /* mov.l .L_cd_status_2, r2 */
    mov.w @r2, r3                     /* re-read CD status */
    mov.w   .L_err_mask_recov, r2     /* 0x0E00 = bits 11:9 (recoverable errors) */
    extu.w r3, r3
    and r2, r3
    tst r3, r3
    bt      .L_0601B560              /* no recoverable error → return */
    .byte   0xD0, 0x0B    /* mov.l .L_disc_type, r0 */
    mov.b @r0, r0                     /* check disc type */
    cmp/eq #0x2, r0                   /* type 2 = game disc */
    bf      .L_0601B55A              /* not game disc → set error code 2 */
    mov #0x1, r2                      /* game disc removed → fatal reset */
    .byte   0xD3, 0x09    /* mov.l .L_error_flag_2, r3 */
    mov.b r2, @r3                     /* set error flag = 1 */
    .byte   0xD3, 0x09    /* mov.l .L_fn_init_reset_2, r3 */
    jmp @r3                           /* jump to handler_init_reset */
    lds.l @r15+, pr
.L_0601B55A:
    mov #0x2, r2                      /* set error code = 2 (wrong disc) */
    .byte   0xD3, 0x08    /* mov.l .L_error_code, r3 */
    mov.b r2, @r3
.L_0601B560:
    lds.l @r15+, pr
    rts
    nop

    .global loc_0601B566
loc_0601B566:                             /* disc removed/unreadable — set error code 3 */
    mov #0x3, r3
    .byte   0xD2, 0x05    /* mov.l .L_error_code, r2 */
    rts
    mov.b r3, @r2                     /* error code = 3 */
.L_err_mask_recov:
    .2byte  0x0E00                      /* CD status bits 11:9: recoverable errors */
.L_cd_status_2:
    .4byte  sym_06063D9A               /* CD block status word (16-bit) */
.L_disc_type:
    .4byte  sym_0608600E               /* disc type: 2 = game disc */
.L_error_flag_2:
    .4byte  sym_0608600C               /* disc error flag (byte) */
.L_fn_init_reset_2:
    .4byte  handler_init_reset         /* system reset handler */
.L_error_code:
    .4byte  sym_0608600D               /* error code: 0=none, 1=fatal, 2=wrong, 3=removed */
