/* post_race_transition -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0600F650 - 0x0600F794
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Post-race visual transition setup — initializes audio, loads palette/tile
 * data for the results screen, and configures the display layers for the
 * post-race overlay (rankings, times, continue prompt).
 *
 * Initialization sequence:
 *   1. audio_display_init() — reset audio display state
 *   2. sound_cmd_dispatch(0, 0xAE0003FF) — trigger results music
 *   3. sound_init_race() — initialize race sound state
 *   4. Clear 4 display slots (sym_06078870, 16-bit each)
 *   5. memcpy_word_idx(palette_src, VDP2_CRAM+0x460, 0xC0) — load palette
 *   6. dma_memory_transfer(tile_src, VDP2_VRAM+0x75DDC) — transfer tiles
 *   7. Display layer setup via sym_06028400(layer_params...) ×3
 *   8. sound_cmd_dispatch(0, 0xAB1103FF) — secondary sound command
 *   9. sym_06011494(0) + anim_ui_transition(0) + hud_course_render()
 *  10. Read display mode from status word[+6]:
 *      If nonzero: tile offsets = 0x29/0x26 (extended layout)
 *      Else: tile offsets = 0x24/0x22 (standard layout)
 *  11. Configure 3 display layers via sym_06028400 calls
 *  12. Clear transition state, set countdown = 0x78 (120 frames),
 *      set transition_active = 1
 *
 * Persistent registers:
 *   r10/r12 = tile table indices (mode-dependent)
 *   r11 = tile table base (sym_06059F5C, loaded cross-TU)
 *   r13 = display layer setup function (sym_06028400)
 *   r14 = 0 (zero constant)
 */

    .section .text.FUN_0600F650


    .global post_race_transition
    .type post_race_transition, @function
post_race_transition:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov.l r10, @-r15
    sts.l pr, @-r15
    add #-0x4, r15
    mov.l   .L_fn_layer_setup, r13    /* r13 = display layer setup fn */
    mov.l   .L_fn_audio_init, r3
    jsr @r3                            /* audio_display_init() */
    mov #0x0, r14                     /* r14 = 0 */
    mov.l   .L_snd_cmd_results, r5   /* 0xAE0003FF = results music command */
    mov.l   .L_fn_sound_dispatch, r3
    jsr @r3                            /* sound_cmd_dispatch(0, results_cmd) */
    mov r14, r4
    mov.l   .L_fn_sound_init_race, r3
    jsr @r3                            /* sound_init_race() */
    nop
    mov.l   .L_display_slots, r4     /* --- clear 4 display slots --- */
    extu.w r14, r0
    mov.w r0, @(6, r4)              /* slot[3] = 0 */
    mov.w r0, @(4, r4)              /* slot[2] = 0 */
    mov.w r0, @(2, r4)              /* slot[1] = 0 */
    mov.w r0, @r4                    /* slot[0] = 0 */
    mov.w   .L_palette_size, r6     /* 0xC0 = 192 bytes (96 colors) */
    mov.l   .L_palette_src, r5
    mov.l   .L_vdp2_cram_0x460, r4  /* VDP2 CRAM + 0x460 */
    mov.l   .L_fn_memcpy_word, r3
    jsr @r3                            /* memcpy_word_idx(src, CRAM, 192) */
    nop
    mov.l   .L_tile_src, r2          /* --- DMA tile data --- */
    mov.l r2, @r15                    /* save tile src on stack */
    mov.l   .L_vdp2_vram_0x75DDC, r4 /* VDP2 VRAM + 0x75DDC */
    mov.l   .L_fn_dma_transfer, r3
    jsr @r3                            /* dma_memory_transfer(src, VRAM) */
    mov r2, r5
    mov.l   .L_layer_mask, r7       /* 0xE000 = bits 15:13 */
    mov r14, r6                       /* r6 = 0 */
    mov.l @r15, r5                   /* tile src */
    jsr @r13                          /* layer_setup(12, tile_src, 0, 0xE000) */
    mov #0xC, r4
    mov.l   .L_fn_scroll_config, r3
    jsr @r3                            /* scroll_config() */
    nop
    mov.l   .L_snd_cmd_secondary, r5 /* 0xAB1103FF */
    mov.l   .L_fn_sound_dispatch, r3
    jsr @r3                            /* sound_cmd_dispatch(0, secondary_cmd) */
    mov r14, r4
    mov.l   .L_fn_ui_setup, r3
    jsr @r3                            /* ui_setup(0) */
    extu.w r14, r4
    mov.l   .L_fn_anim_transition, r3
    jsr @r3                            /* anim_ui_transition(0) */
    extu.w r14, r4
    mov.l   .L_fn_hud_course, r3
    jsr @r3                            /* hud_course_render() */
    nop
    mov.l   .L_status_word, r2       /* --- display mode selection --- */
    mov.w @(6, r2), r0               /* status[+6] = display mode */
    mov r0, r3
    extu.w r3, r3
    tst r3, r3
    bf      .L_0600F724              /* nonzero → extended layout */
    mov #0x24, r10                    /* standard: tile index A = 0x24 */
    bra     .L_0600F728
    mov #0x22, r12                    /* standard: tile index B = 0x22 */
.L_palette_size:
    .2byte  0x00C0                        /* palette copy size (192 bytes) */
    .2byte  0xFFFF
.L_fn_layer_setup:
    .4byte  sym_06028400               /* display layer setup function */
.L_fn_audio_init:
    .4byte  audio_display_init         /* audio display initialization */
.L_snd_cmd_results:
    .4byte  0xAE0003FF                  /* sound command: results music */
.L_fn_sound_dispatch:
    .4byte  sound_cmd_dispatch         /* sound command dispatcher */
.L_fn_sound_init_race:
    .4byte  sound_init_race            /* race sound state initialization */
.L_display_slots:
    .4byte  sym_06078870               /* display slot array (4×16-bit) */
.L_palette_src:
    .4byte  sym_060484EC               /* results palette source data */
.L_vdp2_cram_0x460:
    .4byte  0x25F00460                  /* VDP2 color RAM +0x460 */
.L_fn_memcpy_word:
    .4byte  memcpy_word_idx            /* word-indexed memory copy */
.L_tile_src:
    .4byte  sym_06094FA8               /* results tile source data */
.L_vdp2_vram_0x75DDC:
    .4byte  0x25E75DDC                  /* VDP2 VRAM +0x75DDC */
.L_fn_dma_transfer:
    .4byte  dma_memory_transfer        /* DMA memory transfer */
.L_layer_mask:
    .4byte  0x0000E000                  /* display layer priority mask */
.L_fn_scroll_config:
    .4byte  sym_0601143E               /* scroll layer configuration */
.L_snd_cmd_secondary:
    .4byte  0xAB1103FF                  /* sound command: secondary trigger */
.L_fn_ui_setup:
    .4byte  sym_06011494               /* UI element setup */
.L_fn_anim_transition:
    .4byte  anim_ui_transition         /* animated UI transition */
.L_fn_hud_course:
    .4byte  hud_course_render          /* course HUD element renderer */
.L_status_word:
    .4byte  g_pad_state               /* game status word (16-bit array) */
.L_0600F724:                              /* --- extended layout --- */
    mov #0x29, r10                    /* extended: tile index A = 0x29 */
    mov #0x26, r12                    /* extended: tile index B = 0x26 */
.L_0600F728:                              /* === Display layer configuration === */
    .byte   0xDB, 0x28    /* mov.l .L_tile_table, r11 — tile table base */
    mov r10, r7                       /* --- layer A setup --- */
    shll2 r7
    shll r7                          /* index * 8 */
    add r11, r7                       /* &tile_table[index_A] */
    mov.l r7, @r15
    mov.l @(4, r7), r7              /* tile_table[A][+4] = layer data */
    .byte   0xD3, 0x26    /* mov.l .L_tile_offset_a, r3 — tile offset A */
    .byte   0x96, 0x43    /* mov.w .L_tile_size_a, r6 — tile size A */
    mov.l @r15, r5
    add r3, r7                        /* apply offset */
    mov.l @r5, r5
    jsr @r13                          /* layer_setup(8, tile_data, tile_size) */
    mov #0x8, r4
    mov r12, r7                       /* --- layer B setup --- */
    shll2 r7
    shll r7
    add r11, r7
    mov.l r7, @r15
    mov.l @(4, r7), r7
    .byte   0xD3, 0x1F    /* mov.l .L_tile_offset_a, r3 */
    .byte   0x96, 0x37    /* mov.w .L_tile_size_b, r6 — tile size B */
    mov.l @r15, r5
    add r3, r7
    mov.l @r5, r5
    jsr @r13                          /* layer_setup(8, tile_data_B, tile_size_B) */
    mov #0x8, r4
    .byte   0x97, 0x32    /* mov.w .L_tile_index_c, r7 — tile index C */
    add r11, r7                       /* --- layer C setup --- */
    mov.l r7, @r15
    mov.l @(4, r7), r7
    .byte   0xD3, 0x1B    /* mov.l .L_tile_offset_c, r3 — tile offset C */
    .byte   0x96, 0x2E    /* mov.w .L_tile_size_c, r6 — tile size C */
    mov.l @r15, r5
    add r3, r7
    mov.l @r5, r5
    jsr @r13                          /* layer_setup(8, tile_data_C, tile_size_C) */
    mov #0x8, r4
    .byte   0xD3, 0x18    /* mov.l .L_transition_state, r3 — transition state */
    mov.l r14, @r3                    /* transition_state = 0 (clear) */
    .byte   0x92, 0x27    /* mov.w .L_countdown_value, r2 — 0x78 = 120 frames */
    .byte   0xD3, 0x18    /* mov.l .L_countdown_timer, r3 — countdown timer */
    mov.l r2, @r3                     /* countdown = 120 frames */
    mov #0x1, r2
    .byte   0xD3, 0x17    /* mov.l .L_transition_active, r3 — transition flag */
    mov.b r2, @r3                     /* transition_active = 1 */
    add #0x4, r15
    lds.l @r15+, pr
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14
