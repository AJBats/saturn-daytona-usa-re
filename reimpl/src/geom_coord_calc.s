/* geom_coord_calc -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601EAA0 - 0x0601EB1C
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Geometry coordinate calculator -- queries the HUD state machine for the
 * current player's element priority and updates the player's status flag
 * and element state accordingly.
 *
 * Flow:
 *   1. Read current player index from sym_060877D8.
 *   2. Compute pointer into the course string table (sym_0604A57C,
 *      12 bytes per entry) for that player.
 *   3. Call hud_state_machine to get a priority code (0..8).
 *   4. If priority >= 7 (idle): clear the player's status flag
 *      in sym_060877DD, return 0 (no work needed).
 *   5. If priority < 7: set status flag to 1.
 *      - If priority >= 3: store (priority - 3) as element state
 *        in sym_060877D9, return 0 (deferred update).
 *      - If priority < 3: store priority as element state,
 *        return 1 (immediate update needed).
 *
 * Key symbols:
 *   sym_060877D8 = current player/car index (byte)
 *   sym_0604A57C = course name string table (12 bytes per entry)
 *   sym_060877DD = player status flags array (indexed by player)
 *   sym_060877D9 = player element state array (indexed by player)
 *
 * Called functions:
 *   hud_state_machine (0x0601E4D4) -- scan HUD element priorities
 *
 * Arguments: none
 * Returns: r0 = 1 if immediate update needed, 0 otherwise
 */

    .section .text.FUN_0601EAA0


    .global geom_coord_calc
    .type geom_coord_calc, @function
geom_coord_calc:
    mov.l r14, @-r15                   ! save r14
    mov.l r13, @-r15                   ! save r13
    sts.l pr, @-r15                    ! save return address
    mov #0x0, r13                      ! r13 = 0 (default return value: no update)
    mov.l   .L_pool_player_index, r14  ! r14 -> sym_060877D8 (current player index byte)
    mov.l   .L_pool_string_table, r2   ! r2 -> sym_0604A57C (course string table base)
    mov.b @r14, r4                     ! r4 = player index (signed byte)
    extu.b r4, r4                      ! r4 = player index (unsigned)
    mov r4, r3                         ! r3 = player index (copy for stride calc)
    shll2 r4                           ! r4 = index * 4
    shll2 r3                           ! r3 = index * 4
    shll r3                            ! r3 = index * 8
    add r3, r4                         ! r4 = index * 12 (entry stride)
    .byte   0xBD, 0x0B    /* bsr 0x0601E4D4 (hud_state_machine) */
    add r2, r4                         ! r4 -> string table entry for this player (delay slot)
    extu.b r0, r4                      ! r4 = priority code from hud_state_machine (0..8)
    mov.l   .L_pool_status_flags, r6   ! r6 -> sym_060877DD (player status flags array)
    mov #0x7, r2                       ! r2 = 7 (idle threshold)
    cmp/ge r2, r4                      ! T = (priority >= 7)?
    bf      .L_priority_active         ! branch if priority < 7 (element needs attention)
    mov.b @r14, r0                     ! r0 = player index
    extu.b r0, r0                      ! r0 = player index (unsigned)
    mov #0x0, r3                       ! r3 = 0 (clear status flag)
    mov.b r3, @(r0, r6)               ! status_flags[player] = 0 (idle)
    bra     .L_epilogue                ! jump to return (r13 = 0, no update)
    nop                                ! delay slot
    .4byte  sym_060877D9               ! pool: player element state array (unreferenced in this TU)
.L_pool_string_table:
    .4byte  sym_0604A57C               ! pool: course name string table base
    .4byte  sym_06087080               ! pool: geom busy flag (unreferenced in this TU)
    .4byte  sym_0604A5AC               ! pool: (unreferenced in this TU)
.L_pool_player_index:
    .4byte  sym_060877D8               ! pool: current player/car index byte
.L_pool_status_flags:
    .4byte  sym_060877DD               ! pool: player status flags array
.L_priority_active:
    mov #0x1, r5                       ! r5 = 1 (status flag: active)
    mov #0x3, r2                       ! r2 = 3 (update threshold)
    mov.b @r14, r0                     ! r0 = player index
    extu.b r0, r0                      ! r0 = player index (unsigned)
    mov.b r5, @(r0, r6)               ! status_flags[player] = 1 (active)
    .byte   0xD6, 0x19    /* mov.l .L_pool_0601EB5C, r6 -- loads sym_060877D9 (element state array, in geom_rotation_apply pool) */
    cmp/ge r2, r4                      ! T = (priority >= 3)?
    bf      .L_low_priority            ! branch if priority < 3 (immediate update)
    mov.b @r14, r0                     ! r0 = player index
    extu.b r0, r0                      ! r0 = player index (unsigned)
    add #-0x3, r4                      ! r4 = priority - 3 (normalize to 0-based state)
    extu.b r4, r4                      ! r4 = element state (unsigned byte)
    bra     .L_epilogue                ! jump to return (r13 = 0, deferred update)
    mov.b r4, @(r0, r6)               ! element_state[player] = priority - 3 (delay slot)
.L_low_priority:
    mov.b @r14, r0                     ! r0 = player index
    extu.b r0, r0                      ! r0 = player index (unsigned)
    extu.b r4, r4                      ! r4 = priority (0..2, unsigned byte)
    mov.b r4, @(r0, r6)               ! element_state[player] = priority (raw)
    extu.b r5, r13                     ! r13 = 1 (return: immediate update needed)
.L_epilogue:
    mov r13, r0                        ! r0 = return value (0 or 1)
    lds.l @r15+, pr                    ! restore return address
    mov.l @r15+, r13                   ! restore r13
    rts                                ! return to caller
    mov.l @r15+, r14                   ! restore r14 (delay slot)
