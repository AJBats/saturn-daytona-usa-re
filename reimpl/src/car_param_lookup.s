/* car_param_lookup -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06012AFA - 0x06012B58
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Car parameter table lookup and display list submission.
 *
 * Reads a param_load_state counter from sym_060788FC:
 *   - If bit 2 is CLEAR: calls course_table_lookup (BSR to 0x06012AC4)
 *     to load course-specific parameter tables.
 *   - If bit 2 is SET: loads car data from sym_06063800, computes a
 *     display list source offset using struct field +0x061C and a
 *     texture data pointer from field +4 with 0x4000 bias, then calls
 *     display_list_loader (sym_06028400) with mode 0x8 to transfer
 *     car model display data.
 *
 * After either path, increments the param_load_state counter and returns.
 *
 * Key symbols:
 *   sym_060788FC  = param_load_state counter (32-bit word)
 *   sym_06063800  = car data struct base pointer
 *   sym_06028400  = display_list_loader(r4=mode, r5=dlist_base, r6=src_offset, r7=tex_data)
 *   sym_0605ACDD  = static rendering data (in pool but not directly used by this function)
 *   sym_060283E0  = geom_render_dispatch (in pool but not directly used by this function)
 */

    .section .text.FUN_06012AFA


    .global car_param_lookup
    .type car_param_lookup, @function
car_param_lookup:
    mov.l r14, @-r15                            ! save r14 on stack
    sts.l pr, @-r15                             ! save return address on stack
    add #-0x4, r15                              ! allocate 4 bytes of stack space for local
    .byte   0xDE, 0x12    /* mov.l .L_pool_param_load_state, r14 */  ! r14 = &param_load_state (sym_060788FC)
    mov.l @r14, r0                              ! r0 = param_load_state value
    tst #0x4, r0                                ! test bit 2 of param_load_state
    bt      .L_call_course_lookup               ! if bit 2 clear: branch to course table path
    .byte   0xD3, 0x11    /* mov.l .L_pool_car_data_struct, r3 */  ! r3 = &car_data_struct (sym_06063800)
    mov.l r3, @r15                              ! store car_data_ptr in stack local [sp+0]
    mov r3, r7                                  ! r7 = car_data_struct base (for tex_data calc)
    mov.w   .L_wpool_dlist_src_offset, r6        ! r6 = 0x061C (display list source offset in struct)
    mov.l @r15, r5                              ! r5 = car_data_struct base (reload from stack)
    mov.l @(4, r7), r7                          ! r7 = car_data_struct[+4] (texture base pointer)
    mov.w   .L_wpool_tex_data_bias, r3           ! r3 = 0x4000 (texture data bias)
    mov.l @r5, r5                               ! r5 = car_data_struct[+0] (display list base)
    add r3, r7                                  ! r7 = texture base + 0x4000 (biased tex_data ptr)
    .byte   0xD3, 0x0E    /* mov.l .L_pool_dlist_loader, r3 */  ! r3 = &display_list_loader (sym_06028400)
    jsr @r3                                     ! call display_list_loader
    mov #0x8, r4                                ! r4 = 0x8 (mode = car param load) [delay slot]
    bra     .L_increment_and_return             ! skip course_table_lookup path
    nop                                         ! delay slot (nop)
.L_call_course_lookup:
    .byte   0xBF, 0xCE    /* bsr 0x06012AC4 (external) */  ! call course_table_lookup
    nop                                         ! delay slot (nop)
.L_increment_and_return:
    mov.l @r14, r2                              ! r2 = param_load_state value
    add #0x1, r2                                ! r2++ (advance to next state)
    mov.l r2, @r14                              ! store incremented param_load_state
    add #0x4, r15                               ! free 4 bytes of stack space
    lds.l @r15+, pr                             ! restore return address
    rts                                         ! return to caller
    mov.l @r15+, r14                            ! restore r14 [delay slot]
.L_wpool_dlist_src_offset:
    .2byte  0x061C
    .4byte  0x069C071C
.L_wpool_tex_data_bias:
    .2byte  0x4000
    .2byte  0xFFFF
    .4byte  sym_0605ACDD
    .4byte  sym_060283E0
    .4byte  0x0000F000
.L_pool_param_load_state:
    .4byte  sym_060788FC
.L_pool_car_data_struct:
    .4byte  sym_06063800
.L_pool_dlist_loader:
    .4byte  sym_06028400
