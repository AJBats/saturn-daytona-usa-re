/* transition_small_d -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0600FDFE - 0x0600FE38
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Small screen transition tick handler. Called each frame during a
 * transition countdown sequence:
 *
 *   1. Decrement state countdown timer (dword at sym_0607EBCC)
 *   2. If timer still >= 0, return (transition still in progress)
 *   3. When timer expires (goes negative):
 *      a. sound_cmd_dispatch(0, 0xAB110DFF) â€” play transition-end sound
 *      b. Reset countdown timer to 0x00B4 (180 frames = 3 sec)
 *      c. Set game state byte to 0x0F (advance to next state)
 *
 * Args: none
 * Returns: void
 * Calls: sound_cmd_dispatch
 */

    .section .text.FUN_0600FDFE


    .global transition_small_d
    .type transition_small_d, @function
transition_small_d:
    mov.l r14, @-r15                         ! save r14 (used as timer pointer)
    sts.l pr, @-r15                          ! save return address
    .byte   0xDE, 0x09    /* mov.l .L_pool_countdown_ptr, r14 */
    mov.l @r14, r3                           ! r3 = current countdown value
    add #-0x1, r3                            ! r3-- (decrement timer)
    cmp/pz r3                                ! is r3 >= 0? (timer still active?)
    bt/s    .L_epilogue                      ! if still positive, skip to return
    mov.l r3, @r14                           ! store decremented timer (delay slot)
    .byte   0xD5, 0x07    /* mov.l .L_pool_sound_id, r5 */
    .byte   0xD3, 0x07    /* mov.l .L_pool_fn_sound_cmd, r3 */
    jsr @r3                                  ! sound_cmd_dispatch(0, 0xAB110DFF)
    mov #0x0, r4                             ! r4 = 0 (channel arg, delay slot)
    mov.w   .L_wpool_countdown_reset, r2            ! r2 = 0x00B4 (180 frames = 3 sec)
    mov.l r2, @r14                           ! reset countdown timer to 180
    mov #0xF, r3                             ! r3 = 0x0F (next game state)
    .byte   0xD2, 0x05    /* mov.l .L_pool_game_state, r2 */
    mov.b r3, @r2                            ! game_state_byte = 0x0F
.L_epilogue:
    lds.l @r15+, pr                          ! restore return address
    rts                                      ! return
    mov.l @r15+, r14                         ! restore r14 (delay slot)
.L_wpool_countdown_reset:
    .2byte  0x00B4                           /* [HIGH] countdown reset value: 180 frames */
.L_pool_countdown_ptr:
    .4byte  sym_0607EBCC                     /* [HIGH] &state countdown timer (dword) */
.L_pool_sound_id:
    .4byte  0xAB110DFF                       /* [MEDIUM] sound ID: transition-end sound */
.L_pool_fn_sound_cmd:
    .4byte  sound_cmd_dispatch               /* [HIGH] sound command dispatcher function */
.L_pool_game_state:
    .4byte  sym_0607887F                     /* [HIGH] &game state byte */
