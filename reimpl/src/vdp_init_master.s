/* vdp_init_master -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06036F0C - 0x060370E4
 * Auto-generated by tools/generate_l3_tu.py
 *
 * ============================================================
 * vdp_init_master(r4=interlace, r5=vlines, r6=resolution)
 * ============================================================
 * Configures the VDP display mode by setting screen width, height,
 * and display state flags based on three parameters:
 *
 *   r4 = interlace mode:
 *     0 = non-interlace (progressive)
 *     2 = interlace single-density (display state |= 0x80)
 *     3 = interlace double-density (height doubled, display state |= 0xC0)
 *
 *   r5 = vertical lines mode (color/scan mode):
 *     0 = 224 lines (0x00E0)
 *     1 = 240 lines (0x00F0), display state bits[5:4] = 0x10
 *     2 = 256 lines (0x0100), display state bits[5:4] = 0x20
 *
 *   r6 = resolution mode (0-7):
 *     0 = 320px  normal      (width=0x0140)
 *     1 = 352px  normal      (width=0x0160, state |= 0x01)
 *     2 = 640px  hi-res      (width=0x0280, state |= 0x02)
 *     3 = 704px  hi-res      (width=0x02C0, state |= 0x03)
 *     4 = 320px  480-line    (width=0x0140, height=480, state |= 0x04)
 *     5 = 352px  480-line    (width=0x0160, height=480, state |= 0x05)
 *     6 = 640px  480-line    (width=0x0280, height=480, state |= 0x06)
 *     7 = 704px  480-line    (width=0x02C0, height=480, state |= 0x07)
 *
 * Data structures:
 *   sym_060635AE = screen width (16-bit, init=320)
 *   sym_060635B0 = screen height (16-bit, init=224)
 *   sym_060A3D88 = display state word (bitfield: [7:6]=interlace,
 *                  [5:4]=vlines, [3:0]=resolution)
 *   sym_060635AC = command-ready flag (0=idle, 1=pending)
 *   sym_06000324 = BIOS indirect: current TV mode flag
 *   sym_06000320 = BIOS indirect: set TV mode function ptr
 *
 * Called during system init: vdp_init_master(0, 0, 1) sets 352x224 progressive.
 *
 * ============================================================
 * sym_060370C0 -- vdp_config_struct_clear(r4=struct_ptr)
 * ============================================================
 * Zeroes a 15-byte VDP config struct at the address in r4.
 * Fields: [0..3]=dword0, [4..7]=dword1, [8..14]=7 individual bytes.
 * Called from engine_init_global to prepare a VDP init parameter block.
 */

    .section .text.FUN_06036F0C


    .global vdp_init_master
    .type vdp_init_master, @function
vdp_init_master:
    mov.l r14, @-r15                        ! save r14
    mov.l r13, @-r15                        ! save r13
    mov.l r12, @-r15                        ! save r12
    mov.l r11, @-r15                        ! save r11
    mov.l r10, @-r15                        ! save r10
    sts.l pr, @-r15                         ! save return address
    mov.w   DAT_06036fba, r10               ! r10 = 0x01E0 (480 = hi-res height)
    mov.l   _pool_screen_width, r12         ! r12 = &screen_width (sym_060635AE)
    mov.l   _pool_screen_height, r13        ! r13 = &screen_height (sym_060635B0)
    mov.l   _pool_display_state, r14        ! r14 = &display_state (sym_060A3D88)
    mov.l   _pool_bios_tv_flag_ptr, r7     ! r7 = &BIOS_tv_mode_flag_ptr (sym_06000324)
    mov.l @r7, r7                           ! r7 = current TV mode flag value
    mov.l   _pool_mask_clear_vlines, r3    ! r3 = 0xFFCF (mask to clear bits[5:4])
    mov.w @r14, r2                          ! r2 = display_state
    and r3, r2                              ! clear vertical-lines bits
    mov.w r2, @r14                          ! write back masked display_state
    bra     .L_switch_vlines                ! jump to vlines dispatch
    extu.b r5, r0                           ! (delay) r0 = vlines mode (0-2)

    /* ---- Vertical lines mode 0: 224 lines ---- */
.L_vlines_224:
    mov.w   DAT_06036fbc, r2               ! r2 = 0x00E0 (224)
    bra     .L_vlines_done                  ! skip to end of vlines switch
    mov.w r2, @r13                          ! (delay) screen_height = 224

    /* ---- Vertical lines mode 1: 240 lines ---- */
.L_vlines_240:
    mov.w   DAT_06036fbe, r2               ! r2 = 0x00F0 (240)
    mov.w r2, @r13                          ! screen_height = 240
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_vlines_state           ! go store modified state
    or #0x10, r0                            ! (delay) set bit 4 (vlines=1)

    /* ---- Vertical lines mode 2: 256 lines ---- */
.L_vlines_256:
    mov.w   DAT_06036fc0, r2               ! r2 = 0x0100 (256)
    mov.w r2, @r13                          ! screen_height = 256
    mov.w @r14, r0                          ! r0 = display_state
    or #0x20, r0                            ! set bit 5 (vlines=2)
.L_store_vlines_state:
    bra     .L_vlines_done                  ! jump to vlines done
    mov.w r0, @r14                          ! (delay) write display_state

    /* ---- Vertical lines dispatch ---- */
.L_switch_vlines:
    cmp/eq #0x0, r0                         ! vlines == 0?
    bt      .L_vlines_224                   ! -> 224 lines
    cmp/eq #0x1, r0                         ! vlines == 1?
    bt      .L_vlines_240                   ! -> 240 lines
    cmp/eq #0x2, r0                         ! vlines == 2?
    bt      .L_vlines_256                   ! -> 256 lines

    /* ---- Begin interlace configuration ---- */
.L_vlines_done:
    mov.l   _pool_mask_clear_interlace, r2 ! r2 = 0xFF3F (mask to clear bits[7:6])
    mov.w @r14, r3                          ! r3 = display_state
    and r2, r3                              ! clear interlace bits
    mov.w r3, @r14                          ! write back
    bra     .L_switch_interlace             ! jump to interlace dispatch
    extu.b r4, r0                           ! (delay) r0 = interlace mode

    /* ---- Interlace mode 2: single-density ---- */
.L_interlace_single:
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_interlace_state        ! go store
    or #0x80, r0                            ! (delay) set bit 7 (interlace single)

    /* ---- Interlace mode 3: double-density ---- */
.L_interlace_double:
    mov.w @r13, r2                          ! r2 = screen_height
    mov.w @r13, r3                          ! r3 = screen_height (again)
    add r2, r3                              ! r3 = height * 2 (double for interlace)
    mov.w r3, @r13                          ! screen_height = doubled height
    mov.w @r14, r0                          ! r0 = display_state
    or #0xC0, r0                            ! set bits[7:6] (interlace double)
.L_store_interlace_state:
    bra     .L_interlace_done               ! jump to interlace done
    mov.w r0, @r14                          ! (delay) write display_state

    /* ---- Interlace dispatch ---- */
.L_switch_interlace:
    cmp/eq #0x0, r0                         ! interlace == 0? (non-interlace)
    bt      .L_interlace_done               ! -> skip, no change
    cmp/eq #0x2, r0                         ! interlace == 2? (single)
    bt      .L_interlace_single             ! -> single-density
    cmp/eq #0x3, r0                         ! interlace == 3? (double)
    bt      .L_interlace_double             ! -> double-density

    /* ---- Begin resolution configuration ---- */
.L_interlace_done:
    mov.l   _pool_mask_clear_res, r2       ! r2 = 0xFFF0 (mask to clear bits[3:0])
    mov.w @r14, r3                          ! r3 = display_state
    and r2, r3                              ! clear resolution bits
    mov.w r3, @r14                          ! write back
    mov.l   _pool_bios_tvmode_fn, r11     ! r11 = &BIOS_set_tv_mode (sym_06000320)
    bra     .L_switch_resolution            ! jump to resolution dispatch
    extu.b r6, r0                           ! (delay) r0 = resolution mode (0-7)

    /* ---- Resolution mode 0: 320px normal ---- */
.L_res_320_normal:
    tst r7, r7                              ! TV mode flag == 0?
    bt      .L_res_320_normal_skip          ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(0)
    mov #0x0, r4                            ! (delay) r4 = 0 (normal mode)
.L_res_320_normal_skip:
    mov.w   DAT_06036fc2, r2               ! r2 = 0x0140 (320)
    bra     .L_resolution_done              ! skip to end
    mov.w r2, @r12                          ! (delay) screen_width = 320

    /* ---- Resolution mode 1: 352px normal ---- */
.L_res_352_normal:
    mov r7, r0                              ! r0 = TV mode flag
    cmp/eq #0x1, r0                         ! already in mode 1?
    bt      .L_res_352_normal_skip          ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(1)
    mov #0x1, r4                            ! (delay) r4 = 1 (wide mode)
.L_res_352_normal_skip:
    mov.w   _wpool_width_352, r2           ! r2 = 0x0160 (352)
    mov.w r2, @r12                          ! screen_width = 352
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_res_state              ! go store resolution bits
    or #0x1, r0                             ! (delay) set resolution = 1

    .global DAT_06036fba
DAT_06036fba:
    .2byte  0x01E0                          ! 480 (hi-res height constant)

    .global DAT_06036fbc
DAT_06036fbc:
    .2byte  0x00E0                          ! 224 (standard vertical lines)

    .global DAT_06036fbe
DAT_06036fbe:
    .2byte  0x00F0                          ! 240 (extended vertical lines)

    .global DAT_06036fc0
DAT_06036fc0:
    .2byte  0x0100                          ! 256 (full vertical lines)

    .global DAT_06036fc2
DAT_06036fc2:
    .2byte  0x0140                          ! 320 (normal screen width)
_wpool_width_352:
    .2byte  0x0160                          ! 352 (wide screen width)
    .2byte  0xFFFF                          ! padding / alignment
_pool_screen_width:
    .4byte  sym_060635AE                    ! &screen_width
_pool_screen_height:
    .4byte  sym_060635B0                    ! &screen_height
_pool_display_state:
    .4byte  sym_060A3D88                    ! &display_state word
_pool_bios_tv_flag_ptr:
    .4byte  sym_06000324                    ! &BIOS TV mode flag (indirect)
_pool_mask_clear_vlines:
    .4byte  0x0000FFCF                      ! mask: clear bits[5:4] (vlines field)
_pool_mask_clear_interlace:
    .4byte  0x0000FF3F                      ! mask: clear bits[7:6] (interlace field)
_pool_mask_clear_res:
    .4byte  0x0000FFF0                      ! mask: clear bits[3:0] (resolution field)
_pool_bios_tvmode_fn:
    .4byte  sym_06000320                    ! &BIOS set_tv_mode function ptr

    /* ---- Resolution mode 2: 640px hi-res ---- */
.L_res_640_normal:
    tst r7, r7                              ! TV mode flag == 0?
    bt      .L_res_640_normal_skip          ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(0)
    mov #0x0, r4                            ! (delay) r4 = 0 (normal mode)
.L_res_640_normal_skip:
    mov.w   DAT_06037078, r2               ! r2 = 0x0280 (640)
    mov.w r2, @r12                          ! screen_width = 640
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_res_state              ! go store resolution bits
    or #0x2, r0                             ! (delay) set resolution = 2

    /* ---- Resolution mode 3: 704px hi-res ---- */
.L_res_704_normal:
    mov r7, r0                              ! r0 = TV mode flag
    cmp/eq #0x1, r0                         ! already in mode 1?
    bt      .L_res_704_normal_skip          ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(1)
    mov #0x1, r4                            ! (delay) r4 = 1 (wide mode)
.L_res_704_normal_skip:
    mov.w   DAT_0603707a, r2               ! r2 = 0x02C0 (704)
    mov.w r2, @r12                          ! screen_width = 704
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_res_state              ! go store resolution bits
    or #0x3, r0                             ! (delay) set resolution = 3

    /* ---- Resolution mode 4: 320px 480-line ---- */
.L_res_320_480:
    tst r7, r7                              ! TV mode flag == 0?
    bt      .L_res_320_480_skip             ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(0)
    mov #0x0, r4                            ! (delay) r4 = 0 (normal mode)
.L_res_320_480_skip:
    mov.w   DAT_0603707c, r2               ! r2 = 0x0140 (320)
    mov.w r2, @r12                          ! screen_width = 320
    extu.w r10, r3                          ! r3 = 480 (hi-res height)
    mov.w r3, @r13                          ! screen_height = 480
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_res_state              ! go store resolution bits
    or #0x4, r0                             ! (delay) set resolution = 4

    /* ---- Resolution mode 5: 352px 480-line ---- */
.L_res_352_480:
    mov r7, r0                              ! r0 = TV mode flag
    cmp/eq #0x1, r0                         ! already in mode 1?
    bt      .L_res_352_480_skip             ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(1)
    mov #0x1, r4                            ! (delay) r4 = 1 (wide mode)
.L_res_352_480_skip:
    mov.w   DAT_0603707e, r2               ! r2 = 0x0160 (352)
    mov.w r2, @r12                          ! screen_width = 352
    extu.w r10, r3                          ! r3 = 480 (hi-res height)
    mov.w r3, @r13                          ! screen_height = 480
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_res_state              ! go store resolution bits
    or #0x5, r0                             ! (delay) set resolution = 5

    /* ---- Resolution mode 6: 640px 480-line ---- */
.L_res_640_480:
    tst r7, r7                              ! TV mode flag == 0?
    bt      .L_res_640_480_skip             ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(0)
    mov #0x0, r4                            ! (delay) r4 = 0 (normal mode)
.L_res_640_480_skip:
    mov.w   DAT_06037078, r2               ! r2 = 0x0280 (640)
    mov.w r2, @r12                          ! screen_width = 640
    extu.w r10, r3                          ! r3 = 480 (hi-res height)
    mov.w r3, @r13                          ! screen_height = 480
    mov.w @r14, r0                          ! r0 = display_state
    bra     .L_store_res_state              ! go store resolution bits
    or #0x6, r0                             ! (delay) set resolution = 6

    /* ---- Resolution mode 7: 704px 480-line ---- */
.L_res_704_480:
    mov r7, r0                              ! r0 = TV mode flag
    cmp/eq #0x1, r0                         ! already in mode 1?
    bt      .L_res_704_480_skip             ! -> skip BIOS call
    mov.l @r11, r3                          ! r3 = BIOS set_tv_mode function
    jsr @r3                                 ! call BIOS set_tv_mode(1)
    mov #0x1, r4                            ! (delay) r4 = 1 (wide mode)
.L_res_704_480_skip:
    mov.w   DAT_0603707a, r2               ! r2 = 0x02C0 (704)
    mov.w r2, @r12                          ! screen_width = 704
    extu.w r10, r3                          ! r3 = 480 (hi-res height)
    mov.w r3, @r13                          ! screen_height = 480
    mov.w @r14, r0                          ! r0 = display_state
    or #0x7, r0                             ! set resolution = 7
.L_store_res_state:
    bra     .L_resolution_done              ! jump to resolution done
    mov.w r0, @r14                          ! (delay) write display_state

    .global DAT_06037078
DAT_06037078:
    .2byte  0x0280                          ! 640 (hi-res screen width)

    .global DAT_0603707a
DAT_0603707a:
    .2byte  0x02C0                          ! 704 (wide hi-res screen width)

    .global DAT_0603707c
DAT_0603707c:
    .2byte  0x0140                          ! 320 (normal width, 480-line variant)

    .global DAT_0603707e
DAT_0603707e:
    .2byte  0x0160                          ! 352 (wide width, 480-line variant)

    /* ---- Resolution dispatch ---- */
.L_switch_resolution:
    cmp/eq #0x0, r0                         ! resolution == 0?
    bt      .L_res_320_normal               ! -> 320px normal
    cmp/eq #0x1, r0                         ! resolution == 1?
    bt      .L_res_352_normal               ! -> 352px normal
    cmp/eq #0x2, r0                         ! resolution == 2?
    bt      .L_res_640_normal               ! -> 640px hi-res
    cmp/eq #0x3, r0                         ! resolution == 3?
    bt      .L_res_704_normal               ! -> 704px hi-res
    cmp/eq #0x4, r0                         ! resolution == 4?
    bt      .L_res_320_480                  ! -> 320px 480-line
    cmp/eq #0x5, r0                         ! resolution == 5?
    bt      .L_res_352_480                  ! -> 352px 480-line
    cmp/eq #0x6, r0                         ! resolution == 6?
    bt      .L_res_640_480                  ! -> 640px 480-line
    cmp/eq #0x7, r0                         ! resolution == 7?
    bt      .L_res_704_480                  ! -> 704px 480-line

    /* ---- Finalize: set command-ready flag ---- */
.L_resolution_done:
    mov.l   _pool_cmd_ready_flag, r4       ! r4 = &command_ready (sym_060635AC)
    mov.w @r4, r2                           ! r2 = command_ready
    extu.w r2, r2                           ! zero-extend to 32-bit
    tst r2, r2                              ! command_ready == 0?
    bf      .L_epilogue                     ! -> already set, skip
    mov #0x1, r3                            ! r3 = 1
    mov.w r3, @r4                           ! command_ready = 1 (signal pending)
.L_epilogue:
    lds.l @r15+, pr                         ! restore return address
    mov.l @r15+, r10                        ! restore r10
    mov.l @r15+, r11                        ! restore r11
    mov.l @r15+, r12                        ! restore r12
    mov.l @r15+, r13                        ! restore r13
    rts                                     ! return
    mov.l @r15+, r14                        ! (delay) restore r14
_pool_cmd_ready_flag:
    .4byte  sym_060635AC                    ! &command_ready flag

    .global sym_060370C0
    .type sym_060370C0, @function
sym_060370C0:
    mov #0x0, r5                            ! r5 = 0 (clear value)
    extu.b r5, r0                           ! r0 = 0 (byte)
    mov.l r5, @r4                           ! struct[0..3] = 0
    mov.l r5, @(4, r4)                      ! struct[4..7] = 0
    mov.b r0, @(8, r4)                      ! struct[8] = 0
    extu.b r5, r0                           ! r0 = 0
    mov.b r0, @(9, r4)                      ! struct[9] = 0
    extu.b r5, r0                           ! r0 = 0
    mov.b r0, @(10, r4)                     ! struct[10] = 0
    extu.b r5, r0                           ! r0 = 0
    mov.b r0, @(11, r4)                     ! struct[11] = 0
    extu.b r5, r0                           ! r0 = 0
    mov.b r0, @(12, r4)                     ! struct[12] = 0
    extu.b r5, r0                           ! r0 = 0
    mov.b r0, @(13, r4)                     ! struct[13] = 0
    extu.b r5, r0                           ! r0 = 0
    rts                                     ! return
    mov.b r0, @(14, r4)                     ! (delay) struct[14] = 0
