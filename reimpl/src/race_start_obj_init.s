/* race_start_obj_init -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060200A4 - 0x060201B8
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Race start object initialization — sets up VDP2 patterns, palettes,
 * and display objects for the race start sequence (grid, lights, banners).
 *
 * Steps:
 *   1. Copy 2 palette banks to CRAM 0x6C0 and 0x060 (32 bytes each)
 *   2. Upload 4 pattern blocks to VDP2 VRAM (starting lights, grid, etc.)
 *   3. Load display list from course descriptor with 0x6000 offset
 *   4. Clear display channels 0x20 and 0x08
 *   5. Call race start object setup (BSR external)
 *   6. Reset 4 race state counters/flags to zero
 *   7. Send sound command (race start fanfare)
 *   8. Reset 3 animation state bytes (incl. lap counter = 0xF)
 */

    .section .text.FUN_060200A4


    .global race_start_obj_init
    .type race_start_obj_init, @function
race_start_obj_init:
    mov.l r14, @-r15
    sts.l pr, @-r15
    add #-0x4, r15
    mov.l   .L_pal_start_objs, r5     /* copy 1: start objects palette → CRAM 0x6C0 */
    mov.l   .L_vdp2_cram_0x6C0, r4
    mov.l   .L_fn_memcpy_word, r3
    jsr @r3
    mov #0x20, r6                     /* 32 bytes = 16 colors */
    mov.l   .L_pal_grid_overlay, r5   /* copy 2: grid overlay palette → CRAM 0x060 */
    mov.l   .L_vdp2_cram_0x060, r4
    mov.l   .L_fn_memcpy_word, r3
    jsr @r3
    mov #0x20, r6
    mov #0x8, r7                      /* pattern block 1 → VDP2 VRAM +0x33AD8 */
    mov.l   .L_rom_pattern_a, r5
    mov.l   .L_fn_pattern_upload, r14
    mov.l   .L_vdp2_vram_0x33AD8, r4
    jsr @r14
    mov #0x0, r6
    mov #0x8, r7                      /* pattern block 2 → VDP2 VRAM +0x33764 */
    mov.l   .L_rom_pattern_b, r5
    mov.l   .L_vdp2_vram_0x33764, r4
    jsr @r14
    mov #0x0, r6
    mov #0x8, r7                      /* pattern block 3 → Work RAM staging area */
    mov.l   .L_rom_pattern_c, r5
    mov.l   .L_vram_staging, r4
    jsr @r14
    mov #0x0, r6
    mov #0x8, r7                      /* pattern block 4 → VDP2 VRAM +0x3398C */
    mov.l   .L_rom_pattern_d, r5
    mov.l   .L_vdp2_vram_0x3398C, r4
    jsr @r14
    mov #0x0, r6
    mov.l   .L_course_descriptor, r2  /* load display list from course descriptor */
    mov.l r2, @r15
    mov r2, r7
    mov r2, r5
    mov.w   DAT_0602014a, r3         /* +0x6000 offset into descriptor */
    mov.w   DAT_0602014c, r6         /* 0x0A02 display config flags */
    mov.l @(4, r7), r7
    mov.l @r5, r5
    add r3, r7
    mov.l   .L_fn_disp_loader, r3    /* load display list (channel 0xC) */
    jsr @r3
    mov #0xC, r4
    mov #0x0, r6                      /* clear display channel 0x20 */
    mov.l   .L_fn_disp_chan_b, r3
    mov r6, r5
    jsr @r3
    mov #0x20, r4
    mov #0x0, r6                      /* clear display channel 0x08 */
    mov.l   .L_fn_disp_chan_b, r3
    mov r6, r5
    jsr @r3
    mov #0x8, r4
    .byte   0xB6, 0x5C    /* bsr 0x06020DD0 (external) — race start object setup */
    nop
    mov #0x0, r2                      /* reset race state counters */
    mov.l   .L_start_timer_a, r3
    mov.w r2, @r3                     /* timer A = 0 */
    mov.l   .L_start_timer_b, r3
    mov.w r2, @r3                     /* timer B = 0 */
    mov.l   .L_start_state, r3
    mov.l r2, @r3                     /* state = 0 (32-bit clear) */
    mov.l   .L_start_phase, r3
    mov.w r2, @r3                     /* phase = 0 */
    mov.l   .L_snd_start_fanfare, r5 /* send race start sound command */
    mov.l   .L_fn_sound_cmd, r3
    jsr @r3
    mov r2, r4                        /* r4 = 0 (sound param) */
    mov #0x0, r2                      /* reset animation state */
    mov.l   .L_anim_state_a, r3
    mov.b r2, @r3                     /* anim state A = 0 */
    mov.l   .L_anim_state_b, r3
    mov.b r2, @r3                     /* anim state B = 0 */
    mov #0xF, r2
    mov.l   .L_lap_init_counter, r3
    mov.b r2, @r3                     /* lap counter = 0xF (initial) */
    add #0x4, r15
    lds.l @r15+, pr
    rts
    mov.l @r15+, r14

    .global DAT_0602014a
DAT_0602014a:
    .2byte  0x6000                      /* display list offset into course descriptor */

    .global DAT_0602014c
DAT_0602014c:
    .2byte  0x0A02                      /* display config flags */
    .2byte  0xFFFF
.L_pal_start_objs:
    .4byte  sym_0604896C               /* source: start objects palette */
.L_vdp2_cram_0x6C0:
    .4byte  0x25F006C0                  /* VDP2 color RAM +0x6C0 — course palette bank */
.L_fn_memcpy_word:
    .4byte  memcpy_word_idx            /* word-indexed memcpy */
.L_pal_grid_overlay:
    .4byte  sym_0604BC14               /* source: grid overlay palette */
.L_vdp2_cram_0x060:
    .4byte  0x25F00060                  /* VDP2 color RAM +0x060 — NBG0 ext */
.L_fn_pattern_upload:
    .4byte  sym_0600511E               /* pattern data upload function */
.L_rom_pattern_a:
    .4byte  0x00017700                  /* ROM offset: pattern block A */
.L_vdp2_vram_0x33AD8:
    .4byte  0x25E33AD8                  /* VDP2 VRAM +0x33AD8 — pattern A dest */
.L_rom_pattern_b:
    .4byte  0x00018B40                  /* ROM offset: pattern block B */
.L_vdp2_vram_0x33764:
    .4byte  0x25E33764                  /* VDP2 VRAM +0x33764 — pattern B dest */
.L_rom_pattern_c:
    .4byte  0x0001D2A0                  /* ROM offset: pattern block C */
.L_vram_staging:
    .4byte  sym_0605E164               /* Work RAM staging buffer for pattern C */
.L_rom_pattern_d:
    .4byte  0x00018F20                  /* ROM offset: pattern block D */
.L_vdp2_vram_0x3398C:
    .4byte  0x25E3398C                  /* VDP2 VRAM +0x3398C — pattern D dest */
.L_course_descriptor:
    .4byte  sym_06063CA0               /* course display list descriptor */
.L_fn_disp_loader:
    .4byte  sym_06028400               /* display list loader */
.L_fn_disp_chan_b:
    .4byte  display_channel_b          /* display channel clear/set */
.L_start_timer_a:
    .4byte  sym_0608780A               /* race start timer A (16-bit) */
.L_start_timer_b:
    .4byte  sym_06087808               /* race start timer B (16-bit) */
.L_start_state:
    .4byte  sym_06087814               /* race start state (32-bit) */
.L_start_phase:
    .4byte  sym_06087806               /* race start phase (16-bit) */
.L_snd_start_fanfare:
    .4byte  0xAB1128FF                  /* sound cmd: race start fanfare */
.L_fn_sound_cmd:
    .4byte  sound_cmd_dispatch         /* sound command dispatch */
.L_anim_state_a:
    .4byte  sym_06087826               /* animation state A (byte) */
.L_anim_state_b:
    .4byte  sym_06087824               /* animation state B (byte) */
.L_lap_init_counter:
    .4byte  sym_06087825               /* lap init counter (byte, initial = 0xF) */
