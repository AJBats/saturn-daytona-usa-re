/* update_mode_dispatch -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0600DF66 - 0x0600DFD0
 *
 * Update mode dispatcher — selects per-car update path based on a mode byte.
 * Called each frame during post-race cleanup and other non-racing states.
 *
 * Steps:
 *   1. Read total car count, halve it (arithmetic shift), store as half count
 *   2. Read update mode byte from sym_06083261
 *   3. Dispatch:
 *      - Mode 0 → simplified per-car update (FUN_0600E410, countdown/pre-race)
 *      - Mode 1 → alternative per-car update (FUN_0600E47C, replay)
 *      - Mode 2 → alternative per-car update (FUN_0600E47C, same as mode 1)
 *      - Default → skip directly to per-car loop
 *   4. All paths tail-branch to per-car update loop (FUN_0600E0C0)
 *
 * Auto-generated by tools/generate_l3_tu.py
 */

    .section .text.FUN_0600DF66


    .global update_mode_dispatch
    .type update_mode_dispatch, @function
update_mode_dispatch:
    sts.l pr, @-r15                             ! save return address
    .byte   0xD3, 0x12    /* mov.l .L_pool_total_car_count, r3 */  ! r3 = &total_car_count (sym_0607EA98)
    mov.l @r3, r3                               ! r3 = total car count
    shar r3                                     ! r3 = car_count >> 1 (arithmetic shift right)
    exts.w r3, r3                               ! sign-extend halfword result
    .byte   0xD2, 0x11    /* mov.l .L_pool_half_count_store, r2 */ ! r2 = &half_count_store (sym_060786CA)
    mov.w r3, @r2                               ! store half car count
    .byte   0xD0, 0x11    /* mov.l .L_pool_update_mode_byte, r0 */ ! r0 = &update_mode_byte (sym_06083261)
    bra     .L_dispatch                         ! jump to mode dispatch
    mov.b @r0, r0                               ! r0 = update mode (delay slot)

! --- Mode 0: simplified per-car update (countdown / pre-race) ---
.L_mode_0:
    .byte   0xB2, 0x49    /* bsr 0x0600E410 (external) */  ! call simplified per-car update
    nop                                         ! (delay slot)
    bra     .L_tail_exit                        ! branch to per-car loop exit
    nop                                         ! (delay slot)

! --- Mode 1: alternative per-car update (replay) ---
.L_mode_1:
    .byte   0xB2, 0x7B    /* bsr 0x0600E47C (external) */  ! call alternative per-car update
    nop                                         ! (delay slot)
    bra     .L_tail_exit                        ! branch to per-car loop exit
    nop                                         ! (delay slot)

! --- Mode 2: alternative per-car update (same as mode 1) ---
.L_mode_2:
    .byte   0xB2, 0x77    /* bsr 0x0600E47C (external) */  ! call alternative per-car update
    nop                                         ! (delay slot)
    bra     .L_tail_exit                        ! branch to per-car loop exit
    nop                                         ! (delay slot)

! --- Adjacent pool data (referenced by surrounding TU functions) ---
    .2byte  0xFFFF
    .4byte  sym_06078635
    .4byte  sym_06063EF0
    .4byte  sym_06078634
    .4byte  sym_0600A8BC
    .4byte  sym_06083255
    .4byte  terrain_data_lookup
    .4byte  sprite_transform
    .4byte  sprite_batch_render

! --- Constant pool ---
.L_pool_total_car_count:
    .4byte  sym_0607EA98                        ! &total_car_count (long)
.L_pool_half_count_store:
    .4byte  sym_060786CA                        ! &half_count (word, written each frame)
.L_pool_update_mode_byte:
    .4byte  sym_06083261                        ! &update_mode_byte (0=simplified, 1/2=alternative)

! --- Mode dispatch ---
.L_dispatch:
    cmp/eq #0x0, r0                             ! mode == 0?
    bt      .L_mode_0                           ! → simplified per-car update
    cmp/eq #0x1, r0                             ! mode == 1?
    bt      .L_mode_1                           ! → alternative per-car update (replay)
    cmp/eq #0x2, r0                             ! mode == 2?
    bt      .L_mode_2                           ! → alternative per-car update (replay)

! --- Tail exit: branch to per-car update loop (FUN_0600E0C0), restore PR ---
.L_tail_exit:
    .byte   0xA0, 0x78    /* bra 0x0600E0C0 (external) */  ! tail-branch to per-car update loop
    lds.l @r15+, pr                             ! restore return address (delay slot)
