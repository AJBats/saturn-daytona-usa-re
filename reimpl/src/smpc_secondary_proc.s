/* smpc_secondary_proc -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06035CBC - 0x06035D22
 * Auto-generated by tools/generate_l3_tu.py
 *
 * smpc_secondary_proc -- CD Data Transfer FIFO reader
 *   Reads word-sized data from the CD block's Data Transfer FIFO
 *   (0x25898000) into a caller-supplied buffer.
 *
 *   Input:
 *     r4 = word_count  -- number of 16-bit words to transfer
 *     r5 = dest_buf    -- pointer to destination buffer (word-aligned)
 *
 *   Flow:
 *     1. Calls ai_brake_zone_adjust(0) to issue the CD transfer command
 *     2. If that returns non-zero, returns the error code immediately
 *     3. Copies word_count words from FIFO into dest_buf
 *     4. Calls ai_brake_zone_main(stack_buf) for post-transfer validation
 *     5. If validation returns zero AND stack result != word_count,
 *        returns -7 (0xFFFFFFF9) as a length-mismatch error
 *     6. Otherwise returns the validation result
 *
 *   Return:  r0 = 0 on success, negative on error
 */

    .section .text.FUN_06035CBC


    .global smpc_secondary_proc
    .type smpc_secondary_proc, @function
smpc_secondary_proc:
    mov.l r14, @-r15                    ! save r14 (callee-saved) on stack
    mov r4, r14                         ! r14 = word_count (number of words to read)
    mov.l r13, @-r15                    ! save r13 (callee-saved) on stack
    mov.l r12, @-r15                    ! save r12 (callee-saved) on stack
    sts.l pr, @-r15                     ! save return address on stack
    mov r5, r12                         ! r12 = dest_buf (destination buffer pointer)
    add #-0x4, r15                      ! allocate 4 bytes of stack for local variable
    mov.l   .L_pool_cd_fifo_addr, r13   ! r13 = 0x25898000 (CD Data Transfer FIFO)
    mov.l   .L_pool_fn_setup, r3        ! r3 = &ai_brake_zone_adjust
    jsr @r3                             ! call ai_brake_zone_adjust(0) -- issue CD transfer command
    mov #0x0, r4                        ! r4 = 0 (command argument, in delay slot)
    mov r0, r4                          ! r4 = return value from setup call
    tst r4, r4                          ! test if setup returned zero (success)
    bt      .L_setup_ok                 ! if zero -> proceed with data transfer
    bra     .L_epilogue                 ! setup failed -> skip to epilogue
    mov r4, r0                          ! r0 = error code (in delay slot, returned to caller)
    .4byte  0x2589000C                  ! pool: CD_HIRQMSK register (not referenced by this function)
    .4byte  0x25818028                  ! pool: A-bus CS1 address (not referenced by this function)
.L_pool_cd_fifo_addr:
    .4byte  0x25898000                  ! pool: CD Data Transfer FIFO address
.L_pool_fn_setup:
    .4byte  ai_brake_zone_adjust        ! pool: CD transfer setup function
.L_setup_ok:
    mov r12, r4                         ! r4 = dest_buf (write pointer, starts at buffer base)
    cmp/pl r14                          ! T = (word_count > 0)
    bf/s    .L_copy_done                ! if word_count <= 0 -> skip copy loop
    mov #0x0, r5                        ! r5 = 0 (loop counter, in delay slot)
.L_copy_loop:
    mov.w @r13, r2                      ! r2 = read one 16-bit word from CD FIFO
    add #0x1, r5                        ! r5++ (increment loop counter)
    mov.w r2, @r4                       ! store word to dest_buf[i]
    cmp/ge r14, r5                      ! T = (counter >= word_count)
    bf/s    .L_copy_loop                ! if counter < word_count -> continue loop
    add #0x2, r4                        ! r4 += 2 (advance write pointer, in delay slot)
.L_copy_done:
    .byte   0xD3, 0x22    /* mov.l .L_pool_06035D8C, r3 */  ! r3 = &ai_brake_zone_main (cross-TU pool)
    jsr @r3                             ! call ai_brake_zone_main(stack_buf) -- validate transfer
    mov r15, r4                         ! r4 = stack pointer (local buffer, in delay slot)
    mov r0, r4                          ! r4 = validation result
    tst r4, r4                          ! test if validation returned non-zero (error)
    bf      .L_return_result            ! if non-zero -> return the error code as-is
    mov.l @r15, r3                      ! r3 = value stored on stack by ai_brake_zone_main
    cmp/eq r3, r14                      ! T = (stack value == word_count)
    bt      .L_return_result            ! if they match -> return success (r4=0)
    mov #-0x7, r4                       ! r4 = -7 (0xFFFFFFF9) -- length mismatch error
.L_return_result:
    mov r4, r0                          ! r0 = final return value
.L_epilogue:
    add #0x4, r15                       ! deallocate 4 bytes of stack locals
    lds.l @r15+, pr                     ! restore return address from stack
    mov.l @r15+, r12                    ! restore r12 from stack
    mov.l @r15+, r13                    ! restore r13 from stack
    rts                                 ! return to caller
    mov.l @r15+, r14                    ! restore r14 from stack (in delay slot)
