/* obj_render_cleanup -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06021128 - 0x06021178
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Resets the scene rendering pipeline after a frame or mode transition.
 *
 * This is the teardown counterpart to obj_render_setup. It:
 *   1. Calls cmd_slot_write(8) to flush command channel 8.
 *   2. Sets channel_flag_D (config byte +3) to 1, re-enabling scene B
 *      coordinate copies for the next scene_buffer_init call.
 *   3. Calls scene_buffer_init with the scene config base to reinitialize
 *      the scene rendering buffers in their default state.
 *   4. Tail-calls cmd_queue_commit to signal the command queue is ready,
 *      while also zeroing:
 *        - render_timer (countdown byte at sym_06089594)
 *        - render_trigger (flag byte at sym_06089595)
 *        - car_state_store (longword at sym_06089598, read by secondary SH-2)
 *
 * Called from: post-race cleanup, mode transitions, attract mode reset.
 * Related: obj_render_setup (sets up the same state), obj_render_update.
 */

    .section .text.FUN_06021128


    .global obj_render_cleanup
    .type obj_render_cleanup, @function
obj_render_cleanup:
    sts.l pr, @-r15                        ! save return address to stack
    mov.l   .L_fn_cmd_slot_write, r3       ! r3 = &cmd_slot_write
    jsr @r3                                ! cmd_slot_write(8) — flush command channel 8
    mov #0x8, r4                           ! (delay) r4 = channel 8
    mov #0x1, r2                           ! r2 = 1 (enable flag)
    mov.l   .L_channel_flag_d, r3          ! r3 = &channel_flag_D (config byte +3)
    mov.b r2, @r3                          ! channel_flag_D = 1 (re-enable scene B coord copies)
    mov.l   .L_scene_config_base, r4       ! r4 = scene config struct base (arg for scene_buffer_init)
    mov.l   .L_fn_scene_buffer_init, r3    ! r3 = &scene_buffer_init
    jsr @r3                                ! scene_buffer_init(config_base) — reinit scene buffers
    nop
    mov.l   .L_fn_cmd_queue_commit, r3     ! r3 = &cmd_queue_commit
    jsr @r3                                ! cmd_queue_commit() — signal command queue ready
    nop
    mov #0x0, r4                           ! r4 = 0 (clear value for remaining fields)
    mov.l   .L_render_timer, r3            ! r3 = &render_timer (countdown byte)
    mov.b r4, @r3                          ! render_timer = 0 (reset countdown)
    mov.l   .L_render_trigger, r3          ! r3 = &render_trigger (flag byte)
    mov.b r4, @r3                          ! render_trigger = 0 (clear trigger)
    mov.l   .L_car_state_store, r3         ! r3 = &car_state_store (longword for secondary SH-2)
    lds.l @r15+, pr                        ! restore return address from stack
    rts                                    ! return to caller
    mov.l r4, @r3                          ! (delay) car_state_store = 0 (clear car state)
    .2byte  0xFFFF                         /* padding to align constant pool */
.L_fn_cmd_slot_write:
    .4byte  sym_0603850C
.L_channel_flag_d:
    .4byte  sym_06087C87
.L_scene_config_base:
    .4byte  sym_06087C84
.L_fn_scene_buffer_init:
    .4byte  scene_buffer_init
.L_fn_cmd_queue_commit:
    .4byte  sym_06038520
.L_render_timer:
    .4byte  sym_06089594
.L_render_trigger:
    .4byte  sym_06089595
.L_car_state_store:
    .4byte  sym_06089598
