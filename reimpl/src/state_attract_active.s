/* state_attract_active -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008A18 - 0x06008B04
 * Auto-generated by tools/generate_l3_tu.py
 *
 * State 3 — Attract Demo Active Loop
 * -----------------------------------
 * Runs the attract-mode demo with full gameplay simulation each frame.
 * Called once per frame while the attract demo is playing.
 *
 * Algorithm:
 *   1. Decrement the attract countdown timer (initialized to 920 in state 2)
 *   2. Call per_frame_game_tick() for general per-frame housekeeping
 *   3. If timer >= 0 AND Start button not pressed:
 *        Run full attract gameplay frame:
 *        - On 3rd attract cycle, init special camera angle
 *        - Update geometry display, race countdown, car proximity, projection
 *        - Dispatch display list slot with timer + slot 0x15 (21)
 *        - Call scene_master for scene rendering
 *        - If timer > 580 (first ~5.7s), run attract_phase_dispatch
 *        - Tail-call frame_end_commit to finalize the frame
 *   4. If timer expired (< 0):
 *        Increment attract cycle counter (mod 3), transition to state 4
 *   5. If Start pressed while timer active:
 *        Call handler_init_reset, transition to state 4 (mode select)
 *
 * State 4 transition: sets game_state = 4, handler_mode = 3, then returns.
 */

    .section .text.FUN_06008A18


    .global state_attract_active
    .type state_attract_active, @function
state_attract_active:
    mov.l r14, @-r15                            ! push r14 (callee-saved)
    sts.l pr, @-r15                             ! push PR (return address)
    mov.l   .L_attract_countdown_ptr, r14       ! r14 = &attract_countdown_timer (kept across calls)
    mov.l @r14, r3                              ! r3 = countdown timer value
    add #-0x1, r3                               ! r3-- (decrement timer by 1 frame)
    mov.l r3, @r14                              ! store decremented timer back
    mov.l   .L_fn_per_frame_tick, r3            ! r3 = &per_frame_game_tick
    jsr @r3                                     ! call per_frame_game_tick() — general per-frame update
    nop                                         ! delay slot
    mov.l   .L_attract_cycle_counter_ptr, r4    ! r4 = &attract_cycle_counter (how many attract loops done)
    mov.l @r14, r2                              ! r2 = countdown timer (post-decrement)
    cmp/pz r2                                   ! timer >= 0? (still counting down)
    bf      .L_timer_expired_or_start           ! if timer < 0 -> expired, transition out
    mov.l   .L_button_state_ptr, r2             ! r2 = &button_state register
    mov.w @r2, r3                               ! r3 = current button state (16-bit)
    mov.w   .L_start_button_mask, r2            ! r2 = 0x0800 (Start button bitmask)
    extu.w r3, r3                               ! zero-extend button state to 32 bits
    and r2, r3                                  ! r3 = button_state & START_MASK
    tst r3, r3                                  ! is Start button pressed?
    bt      .L_attract_gameplay_loop            ! if Start NOT pressed -> run attract frame
.L_timer_expired_or_start:
    mov.l @r14, r3                              ! r3 = countdown timer
    cmp/pz r3                                   ! timer >= 0? (Start was pressed, not expired)
    bf      .L_timer_expired_inc_cycle          ! if timer < 0 -> actually expired, increment cycle
    mov.l   .L_fn_handler_init_reset, r3        ! r3 = &handler_init_reset
    jsr @r3                                     ! call handler_init_reset() — prepare for mode select
    nop                                         ! delay slot
    bra     .L_transition_to_state4             ! jump to state 4 transition
    nop                                         ! delay slot
.L_timer_expired_inc_cycle:
    mov.l @r4, r2                               ! r2 = attract_cycle_counter (0, 1, or 2)
    mov #0x3, r3                                ! r3 = 3 (cycle wrap threshold)
    add #0x1, r2                                ! r2++ (completed one more attract cycle)
    mov.l r2, @r4                               ! store incremented cycle counter
    cmp/hs r3, r2                               ! r2 >= 3? (wrapped past maximum)
    bf      .L_transition_to_state4             ! if < 3, keep count and transition
    mov #0x0, r3                                ! r3 = 0
    mov.l r3, @r4                               ! attract_cycle_counter = 0 (wrap around after 3 cycles)
.L_transition_to_state4:
    mov #0x4, r2                                ! r2 = 4 (state 4 = mode select)
    mov.l   .L_game_state_ptr, r3               ! r3 = &game_state
    mov.l r2, @r3                               ! game_state = 4 (transition to mode select)
    mov #0x3, r2                                ! r2 = 3 (handler mode value)
    mov.l   .L_handler_mode_ptr, r3             ! r3 = &handler_mode (16-bit)
    mov.w r2, @r3                               ! handler_mode = 3
    lds.l @r15+, pr                             ! pop PR (return address)
    rts                                         ! return to caller
    mov.l @r15+, r14                            ! (delay) pop r14
.L_attract_gameplay_loop:
    mov.l @r4, r0                               ! r0 = attract_cycle_counter
    cmp/eq #0x2, r0                             ! is this the 3rd attract cycle (index 2)?
    bf      .L_skip_special_camera              ! if not cycle 2, skip special camera init
    mov.l   .L_fn_camera_attract_init, r3       ! r3 = &camera_attract_init
    jsr @r3                                     ! call camera_attract_init() — set special camera angle
    nop                                         ! delay slot
.L_skip_special_camera:
    mov.l   .L_fn_geom_display_ctrl, r3        ! r3 = &geom_display_ctrl_b
    jsr @r3                                     ! call geom_display_ctrl_b() — geometry display update
    nop                                         ! delay slot
    mov.l   .L_fn_race_countdown, r3            ! r3 = &race_countdown_update
    jsr @r3                                     ! call race_countdown_update() — update race countdown state
    nop                                         ! delay slot
    mov.l   .L_fn_car_proximity, r3             ! r3 = &car_proximity_check
    jsr @r3                                     ! call car_proximity_check() — check car-to-car proximity
    nop                                         ! delay slot
    mov.l   .L_fn_perspective_project, r3       ! r3 = &perspective_project
    jsr @r3                                     ! call perspective_project() — 3D projection / object rendering
    nop                                         ! delay slot
    mov #0x15, r5                               ! r5 = 0x15 (21: display list slot index for attract)
    mov.l   .L_fn_dlist_slot_select, r3         ! r3 = &dlist_slot_select
    jsr @r3                                     ! call dlist_slot_select(timer, 21) — dispatch display list
    mov.l @r14, r4                              ! (delay) r4 = countdown timer value (arg 1)
    mov.l   .L_fn_scene_master, r3              ! r3 = &scene_master
    jsr @r3                                     ! call scene_master() — master scene rendering orchestrator
    nop                                         ! delay slot
    mov.l @r14, r2                              ! r2 = countdown timer
    mov.w   .L_early_attract_threshold, r3      ! r3 = 0x0244 (580: early attract time threshold)
    cmp/gt r3, r2                               ! timer > 580? (first ~5.7 seconds of attract)
    bt      .L_frame_commit                     ! if timer <= 580, skip early-attract dispatch
    mov.l   .L_fn_attract_phase_dispatch, r3    ! r3 = &attract_phase_dispatch
    jsr @r3                                     ! call attract_phase_dispatch() — early attract phase logic
    nop                                         ! delay slot
.L_frame_commit:
    lds.l @r15+, pr                             ! pop PR (return address)
    mov.l   .L_fn_frame_end_commit, r3          ! r3 = &frame_end_commit
    jmp @r3                                     ! tail-call frame_end_commit() — finalize and commit frame
    mov.l @r15+, r14                            ! (delay) pop r14
    .2byte  0x4F26                              /* dead code: unreachable lds.l @r15+, pr */
    .4byte  0x000B6EF6                          /* dead code: unreachable rts + mov.l @r15+, r14 */
.L_start_button_mask:
    .2byte  0x0800                              /* Start button bitmask */
.L_early_attract_threshold:
    .2byte  0x0244                              /* 580 frames (~9.7s remaining = first ~5.7s of attract) */
.L_attract_countdown_ptr:
    .4byte  sym_0607EBCC                        /* attract mode countdown timer (32-bit, init 920) */
.L_fn_per_frame_tick:
    .4byte  sym_0600A1F6                        /* per_frame_game_tick — general per-frame update */
.L_attract_cycle_counter_ptr:
    .4byte  sym_0607EAD8                        /* attract cycle counter (0-2, wraps mod 3) */
.L_button_state_ptr:
    .4byte  sym_06063D9A                        /* button state register (16-bit) */
.L_fn_handler_init_reset:
    .4byte  handler_init_reset                  /* handler_init_reset — prepare for mode select */
.L_game_state_ptr:
    .4byte  g_game_state                        /* game state variable (32-bit) */
.L_handler_mode_ptr:
    .4byte  sym_06087804                        /* handler mode (16-bit) */
.L_fn_camera_attract_init:
    .4byte  camera_attract_init                 /* camera_attract_init — special camera for 3rd cycle */
.L_fn_geom_display_ctrl:
    .4byte  geom_display_ctrl_b                 /* geom_display_ctrl_b — geometry display update */
.L_fn_race_countdown:
    .4byte  race_countdown_update               /* race_countdown_update — countdown state update */
.L_fn_car_proximity:
    .4byte  car_proximity_check                 /* car_proximity_check — car-to-car proximity */
.L_fn_perspective_project:
    .4byte  perspective_project                 /* perspective_project — 3D projection / rendering */
.L_fn_dlist_slot_select:
    .4byte  sym_0600338C                        /* dlist_slot_select — display list slot dispatch */
.L_fn_scene_master:
    .4byte  scene_master                        /* scene_master — master scene rendering orchestrator */
.L_fn_attract_phase_dispatch:
    .4byte  sym_0601AEB6                        /* attract_phase_dispatch — early attract phase logic */
.L_fn_frame_end_commit:
    .4byte  frame_end_commit                    /* frame_end_commit — finalize and commit frame */
