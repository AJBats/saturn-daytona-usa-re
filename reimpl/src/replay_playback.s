/* replay_playback -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x0601BE64 - 0x0601C3E4
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Replay-mode display element dispatch controller. Parallel structure to
 * master_ctrl_dispatch but used during replay playback. Manages 4 timed
 * display channels (A/B/C/D) with command IDs 0x1901, 0x1801, 0x1701, 0x1601.
 *
 * When game state flags are both zero, issues all 4 display commands and exits.
 * Otherwise, checks control state bit flags (0x40, 0x80, 0x01, 0x02) to arm
 * per-channel countdown timers. Each active timer drives a render cycle:
 *   - set 3D position/scale via sym_06026E2E (replay position_set)
 *   - apply Y-axis rotation via mat_rot_y
 *   - set render parameters from indexed tables (z, x, y, w)
 *   - decrement cmd_buf_base by 0x30 per frame
 *   - cycle through 3 animation frames per channel
 *
 * Channels A and B check game flags to choose between two scale/position
 * presets. Channels C and D always use mat_scale_columns for uniform scaling.
 *
 * After timer processing, checks sym_06059F30 active display flag and
 * optionally dispatches an animated render using camera state from sym_06044670
 * with element lookup from sym_0605DF46.
 *
 * Register allocation:
 *   r8  = 0.5 fixed-point constant (0x00008000)
 *   r9  = command buffer base ptr (sym_06089EDC)
 *   r10 = uniform scale constant (0x6666), later camera state ptr
 *   r11 = index byte B (sym_0605DF57) -- used by channels B, D
 *   r12 = index byte A (sym_0605DF56) -- used by channels A, C
 *   r13 = 0 (zero constant)
 *   r14 = control state block (loaded from sym_0607E944)
 */

    .section .text.FUN_0601BE64


    .global replay_playback
    .type replay_playback, @function
replay_playback:
    mov.l r14, @-r15
    mov.l r13, @-r15
    mov.l r12, @-r15
    mov #0x0, r13                       ! r13 = 0 constant (used throughout)
    mov.l r11, @-r15
    mov.l r10, @-r15
    mov.l r9, @-r15
    mov.l r8, @-r15
    sts.l pr, @-r15
    add #-0x4, r15                      ! allocate 4 bytes stack local
    mov.l   .L_fp_half, r8             ! r8 = 0.5 (16.16 fixed-point)
    mov.l   .L_cmd_buf_base, r9        ! r9 = &cmd_buffer
    mov.l   .L_idx_byte_b, r11         ! r11 = &frame_index_b
    mov.l   .L_idx_byte_a, r12         ! r12 = &frame_index_a
    mov.l   .L_ctrl_state_ptr, r14     ! r14 = &ctrl_state_ptr
    mov.l   .L_game_flag_a, r0
    mov.l @r0, r0                       ! r0 = game_flag_a
    tst r0, r0
    bt/s    .L_issue_all_cmds           ! if flag_a == 0, issue all cmds
    mov.l @r14, r14                     ! r14 = ctrl_state (delay slot)
    mov.l   .L_game_flag_b, r0
    mov.l @r0, r0                       ! r0 = game_flag_b
    tst r0, r0
    bf      .L_check_bit_flags          ! if flag_b != 0, check bits
.L_issue_all_cmds:                      ! -- inactive: issue all 4 display cmds --
    mov r13, r0                         ! r0 = 0 (param)
    mov.w   .L_cmd_id_1901_a, r1        ! r1 = cmd 0x1901
    mov.l   .L_fn_disp_cmd_issue, r3
    jsr @r3                             ! disp_cmd_issue(0, 0x1901, ctrl_state)
    mov r14, r2
    mov r13, r0
    mov.w   .L_cmd_id_1801_a, r1        ! r1 = cmd 0x1801
    mov.l   .L_fn_disp_cmd_issue, r3
    jsr @r3                             ! disp_cmd_issue(0, 0x1801, ctrl_state)
    mov r14, r2
    mov r13, r0
    mov.w   .L_cmd_id_1701_a, r1        ! r1 = cmd 0x1701
    mov.l   .L_fn_disp_cmd_issue, r3
    jsr @r3                             ! disp_cmd_issue(0, 0x1701, ctrl_state)
    mov r14, r2
    mov r13, r0
    mov.w   .L_cmd_id_1601_a, r1        ! r1 = cmd 0x1601
    mov.l   .L_fn_disp_cmd_issue, r3
    jsr @r3                             ! disp_cmd_issue(0, 0x1601, ctrl_state)
    mov r14, r2
    bra     .L_epilogue                 ! done -- return
    nop
.L_cmd_id_1901_a:
    .2byte  0x1901
.L_cmd_id_1801_a:
    .2byte  0x1801
.L_cmd_id_1701_a:
    .2byte  0x1701
.L_cmd_id_1601_a:
    .2byte  0x1601
.L_fp_half:
    .4byte  0x00008000                  /* 0.5 (16.16 fixed-point) */
.L_cmd_buf_base:
    .4byte  sym_06089EDC
.L_idx_byte_b:
    .4byte  sym_0605DF57
.L_idx_byte_a:
    .4byte  sym_0605DF56
.L_ctrl_state_ptr:
    .4byte  sym_0607E944
.L_game_flag_a:
    .4byte  sym_06063E1C
.L_game_flag_b:
    .4byte  sym_06063E20
.L_fn_disp_cmd_issue:
    .4byte  sym_06034F78
.L_check_bit_flags:                     ! -- active: check state bits to arm timers --
    mov r14, r0
    mov.b @(3, r0), r0                  ! r0 = ctrl_state[3] (bit flags byte)
    tst #0x40, r0                       ! test bit 6
    bt      .L_check_bit_80             ! skip if bit 6 clear
    mov #0x8, r3                        ! timer = 8 frames
    mov.l   .L_timer_ch_a, r2
    mov r13, r0
    mov.w r3, @r2                       ! timer_ch_a = 8
    mov.w   .L_cmd_id_1901_b, r1        ! issue cmd 0x1901 for channel A
    mov.l   .L_fn_disp_cmd_issue_b, r3
    jsr @r3
    mov r14, r2
.L_check_bit_80:
    mov r14, r0
    mov.b @(3, r0), r0                  ! r0 = ctrl_state[3]
    tst #0x80, r0                       ! test bit 7
    bt      .L_check_bit_01             ! skip if bit 7 clear
    mov #0x8, r3
    mov.l   .L_timer_ch_b, r2
    mov r13, r0
    mov.w r3, @r2                       ! timer_ch_b = 8
    mov.w   .L_cmd_id_1801_b, r1        ! issue cmd 0x1801 for channel B
    mov.l   .L_fn_disp_cmd_issue_b, r3
    jsr @r3
    mov r14, r2
.L_check_bit_01:
    mov r14, r0
    mov.b @(2, r0), r0                  ! r0 = ctrl_state[2] (second flag byte)
    tst #0x1, r0                        ! test bit 0
    bt      .L_check_bit_02             ! skip if bit 0 clear
    mov #0x8, r3
    mov.l   .L_timer_ch_c, r2
    mov r13, r0
    mov.w r3, @r2                       ! timer_ch_c = 8
    mov.w   .L_cmd_id_1701_b, r1        ! issue cmd 0x1701 for channel C
    mov.l   .L_fn_disp_cmd_issue_b, r3
    jsr @r3
    mov r14, r2
.L_check_bit_02:
    mov r14, r0
    mov.b @(2, r0), r0                  ! r0 = ctrl_state[2]
    tst #0x2, r0                        ! test bit 1
    bt      .L_check_timer_ch_a         ! skip if bit 1 clear
    mov #0x8, r3
    mov.l   .L_timer_ch_d, r2
    mov r13, r0
    mov.w r3, @r2                       ! timer_ch_d = 8
    mov.w   .L_cmd_id_1601_b, r1        ! issue cmd 0x1601 for channel D
    mov.l   .L_fn_disp_cmd_issue_b, r3
    jsr @r3
    mov r14, r2
.L_check_timer_ch_a:                    ! -- channel A timer processing --
    mov.w   .L_uniform_scale, r10       ! r10 = 0x6666 (uniform scale)
    mov.l   .L_timer_ch_a, r2
    mov.w @r2, r2
    extu.w r2, r2
    cmp/pl r2                           ! timer_ch_a > 0?
    bf      .L_check_timer_ch_b         ! no -- skip to channel B
    mov.l   .L_fn_render_setup, r3
    jsr @r3                             ! render_setup()
    nop
    mov.l   .L_game_flag_a_2, r0
    mov.l @r0, r0
    cmp/eq #0x1, r0                     ! flag_a == 1?
    bf      .L_ch_a_alt_position
    mov.l   .L_game_flag_b_2, r0
    mov.l @r0, r0
    cmp/eq #0x1, r0                     ! flag_b == 1?
    bf      .L_ch_a_alt_position        ! if either != 1, use alt position
    mov.l   .L_scale_neg_ch_a, r6       ! r6 = -0x1C000 (16.16 scale)
    mov.l   .L_pos_param_ch_a, r4       ! r4 = 0x14872 (16.16 position)
    mov.l   .L_fn_position_set, r3
    jsr @r3                             ! position_set(pos, 0.5, scale)
    mov r8, r5                          ! r5 = 0.5 (delay slot)
    mov r10, r6                         ! r6 = 0x6666 (uniform scale)
    mov r10, r5
    mov.l   .L_fn_mat_scale, r3
    jsr @r3                             ! mat_scale(0x6666, 0x6666, 0x6666)
    mov r10, r4
    bra     .L_ch_a_render_common
    nop
.L_cmd_id_1901_b:
    .2byte  0x1901
.L_cmd_id_1801_b:
    .2byte  0x1801
.L_cmd_id_1701_b:
    .2byte  0x1701
.L_cmd_id_1601_b:
    .2byte  0x1601
.L_uniform_scale:
    .2byte  0x6666                      /* 0.4 (16.16 scale factor) */
.L_timer_ch_a:
    .4byte  sym_0605DF4E
.L_fn_disp_cmd_issue_b:
    .4byte  sym_06034F78
.L_timer_ch_b:
    .4byte  sym_0605DF50
.L_timer_ch_c:
    .4byte  sym_0605DF52
.L_timer_ch_d:
    .4byte  sym_0605DF54
.L_fn_render_setup:
    .4byte  sym_06026DBC
.L_game_flag_a_2:
    .4byte  sym_06063E1C
.L_game_flag_b_2:
    .4byte  sym_06063E20
.L_scale_neg_ch_a:
    .4byte  0xFFFE4000                  /* -1.75 (16.16 fixed-point) */
.L_pos_param_ch_a:
    .4byte  0x00014872                  /* 1.28 (16.16 fixed-point) */
.L_fn_position_set:
    .4byte  sym_06026E2E
.L_fn_mat_scale:
    .4byte  mat_scale_columns
.L_ch_a_alt_position:                   ! -- ch A: flags != 1, use alt position --
    mov.w   .L_alt_scale_ch_a, r6       ! r6 = 0x228F (alt scale)
    mov.l   .L_pos_param_ch_a_alt, r4   ! r4 = 0x14872 (same position)
    mov.l   .L_fn_position_set_2, r3
    jsr @r3                             ! position_set(pos, 0.5, alt_scale)
    mov r8, r5
.L_ch_a_render_common:                  ! -- ch A: common render path --
    mov.w   .L_rot_angle_ch_a, r4       ! r4 = 0x1000 (rotation angle)
    mov.l   .L_fn_mat_rot_y, r3
    jsr @r3                             ! mat_rot_y(0x1000)
    nop
    mov.b @r12, r5                      ! r5 = frame_index_a
    extu.b r5, r5
    add #0x12, r5                       ! r5 = index + 0x12 (table offset)
    shll2 r5                            ! r5 *= 4 (word-aligned)
    mov.l r5, @r15                      ! save offset to stack
    mov.l   .L_render_z_tbl, r3         ! r3 = z_params table base
    mov.l @r15, r4
    mov.l   .L_render_x_tbl, r2         ! r2 = x_params table base
    mov.l   .L_fn_render_params_a, r1
    add r3, r5                          ! r5 = &z_params[index]
    add r2, r4                          ! r4 = &x_params[index]
    mov.l @r5, r5                       ! r5 = z_param value
    jsr @r1                             ! render_params_a(x, z)
    mov.l @r4, r4                       ! r4 = x_param value (delay slot)
    mov.b @r12, r6                      ! r6 = frame_index_a (re-read)
    extu.b r6, r6
    add #0x12, r6
    shll2 r6
    mov.l r6, @r15
    mov.l   .L_render_y_tbl, r3         ! r3 = y_params table base
    mov.l   .L_scale_factor_tbl, r5     ! r5 = &scale_factor
    mov.l @r15, r4
    mov.l   .L_render_w_tbl, r2         ! r2 = w_params table base
    mov.l   .L_fn_render_params_b, r1
    add r3, r6                          ! r6 = &y_params[index]
    mov.w @r5, r5                       ! r5 = scale_factor (16-bit)
    add r2, r4                          ! r4 = &w_params[index]
    mov.l @r6, r6                       ! r6 = y_param value
    jsr @r1                             ! render_params_b(w, scale, y)
    mov.l @r4, r4                       ! r4 = w_param value (delay slot)
    mov.l @r9, r3                       ! r3 = cmd_buf ptr
    add #-0x30, r3                      ! advance cmd buffer by -0x30
    mov.l r3, @r9
    mov.b @r12, r2                      ! frame_index_a++
    add #0x1, r2
    mov.b r2, @r12
    mov #0x3, r2
    mov.b @r12, r3
    extu.b r3, r3
    cmp/ge r2, r3                       ! index >= 3?
    bf      .L_ch_a_dec_timer           ! no -- skip wrap
    extu.b r13, r2
    mov.b r2, @r12                      ! wrap index to 0
.L_ch_a_dec_timer:                      ! decrement channel A timer
    mov.l   .L_timer_ch_a_dec, r3
    mov.w @r3, r3
    add #-0x1, r3                       ! timer_ch_a--
    mov.l   .L_timer_ch_a_dec, r2
    mov.w r3, @r2
    bra     .L_check_active_display     ! skip to post-timer check
    nop
.L_check_timer_ch_b:                    ! -- channel B timer check --
    mov.l   .L_timer_ch_b_chk, r3
    mov.w @r3, r3
    extu.w r3, r3
    cmp/pl r3                           ! timer_ch_b > 0?
    bt      .L_process_ch_b
    bra     .L_check_timer_ch_c         ! no -- try channel C
    nop
.L_process_ch_b:                        ! -- channel B timer processing --
    mov.l   .L_fn_render_setup_2, r3
    jsr @r3                             ! render_setup()
    nop
    mov.l   .L_game_flag_a_3, r0
    mov.l @r0, r0
    cmp/eq #0x1, r0                     ! flag_a == 1?
    bf      .L_ch_b_alt_position
    mov.l   .L_game_flag_b_3, r0
    mov.l @r0, r0
    cmp/eq #0x1, r0                     ! flag_b == 1?
    bf      .L_ch_b_alt_position        ! if either != 1, use alt position
    mov.l   .L_scale_neg_ch_b, r6       ! r6 = -0x1C000 (16.16 scale)
    mov.l   .L_pos_param_ch_b, r4       ! r4 = -0x14872 (16.16 position)
    mov.l   .L_fn_position_set_2, r3
    jsr @r3                             ! position_set(pos, 0.5, scale)
    mov r8, r5                          ! r5 = 0.5 (delay slot)
    mov r10, r6                         ! r6 = 0x6666 (uniform scale)
    mov r10, r5
    mov.l   .L_fn_mat_scale_2, r3
    jsr @r3                             ! mat_scale(0x6666, 0x6666, 0x6666)
    mov r10, r4
    bra     .L_ch_b_render_common
    nop
.L_alt_scale_ch_a:
    .2byte  0x228F
.L_rot_angle_ch_a:
    .2byte  0x1000
    .2byte  0xFFFF
.L_pos_param_ch_a_alt:
    .4byte  0x00014872                  /* 1.28 (16.16 fixed-point) */
.L_fn_position_set_2:
    .4byte  sym_06026E2E
.L_fn_mat_rot_y:
    .4byte  mat_rot_y
.L_render_z_tbl:
    .4byte  sym_060621D8
.L_render_x_tbl:
    .4byte  sym_0606212C
.L_fn_render_params_a:
    .4byte  sym_06031D8C
.L_render_y_tbl:
    .4byte  sym_06062180
.L_scale_factor_tbl:
    .4byte  sym_06089E9C
.L_render_w_tbl:
    .4byte  sym_060620D8
.L_fn_render_params_b:
    .4byte  sym_06031A28
.L_timer_ch_a_dec:
    .4byte  sym_0605DF4E
.L_timer_ch_b_chk:
    .4byte  sym_0605DF50
.L_fn_render_setup_2:
    .4byte  sym_06026DBC
.L_game_flag_a_3:
    .4byte  sym_06063E1C
.L_game_flag_b_3:
    .4byte  sym_06063E20
.L_scale_neg_ch_b:
    .4byte  0xFFFE4000                  /* -1.75 (16.16 fixed-point) */
.L_pos_param_ch_b:
    .4byte  0xFFFEB78E                  /* -1.28 (16.16 fixed-point) */
.L_fn_mat_scale_2:
    .4byte  mat_scale_columns
.L_ch_b_alt_position:                   ! -- ch B: flags != 1, use alt position --
    mov.w   .L_alt_scale_ch_b, r6       ! r6 = 0x228F (alt scale)
    mov.l   .L_pos_param_ch_b_alt, r4   ! r4 = -0x14872 (same position)
    mov.l   .L_fn_position_set_3, r3
    jsr @r3                             ! position_set(pos, 0.5, alt_scale)
    mov r8, r5
.L_ch_b_render_common:                  ! -- ch B: common render path --
    mov.w   .L_rot_angle_ch_b, r4       ! r4 = 0x7000 (rotation angle)
    mov.l   .L_fn_mat_rot_y_2, r3
    jsr @r3                             ! mat_rot_y(0x7000)
    nop
    mov.b @r11, r5                      ! r5 = frame_index_b
    extu.b r5, r5
    add #0x12, r5                       ! r5 = index + 0x12
    shll2 r5                            ! r5 *= 4
    mov.l r5, @r15
    mov.l   .L_render_z_tbl_2, r3
    mov.l @r15, r4
    mov.l   .L_render_x_tbl_2, r2
    mov.l   .L_fn_render_params_a_2, r1
    add r3, r5
    add r2, r4
    mov.l @r5, r5
    jsr @r1                             ! render_params_a(x, z)
    mov.l @r4, r4
    mov.b @r11, r6                      ! r6 = frame_index_b (re-read)
    extu.b r6, r6
    add #0x12, r6
    shll2 r6
    mov.l r6, @r15
    mov.l   .L_render_y_tbl_2, r3
    mov.l   .L_scale_factor_tbl_2, r5
    mov.l @r15, r4
    mov.l   .L_render_w_tbl_2, r2
    mov.l   .L_fn_render_params_b_2, r1
    add r3, r6
    mov.w @r5, r5
    add r2, r4
    mov.l @r6, r6
    jsr @r1                             ! render_params_b(w, scale, y)
    mov.l @r4, r4
    mov.l @r9, r3                       ! r3 = cmd_buf ptr
    add #-0x30, r3                      ! advance cmd buffer by -0x30
    mov.l r3, @r9
    mov.b @r11, r2                      ! frame_index_b++
    add #0x1, r2
    mov.b r2, @r11
    mov #0x3, r2
    mov.b @r11, r3
    extu.b r3, r3
    cmp/ge r2, r3                       ! index >= 3?
    bf      .L_ch_b_dec_timer           ! no -- skip wrap
    extu.b r13, r2
    mov.b r2, @r11                      ! wrap index to 0
.L_ch_b_dec_timer:                      ! decrement channel B timer
    mov.l   .L_timer_ch_b_dec, r3
    mov.w @r3, r3
    add #-0x1, r3                       ! timer_ch_b--
    mov.l   .L_timer_ch_b_dec, r2
    mov.w r3, @r2
    bra     .L_check_active_display     ! skip to post-timer check
    nop
.L_alt_scale_ch_b:
    .2byte  0x228F
.L_rot_angle_ch_b:
    .2byte  0x7000
    .2byte  0xFFFF
.L_pos_param_ch_b_alt:
    .4byte  0xFFFEB78E                  /* -1.28 (16.16 fixed-point) */
.L_fn_position_set_3:
    .4byte  sym_06026E2E
.L_fn_mat_rot_y_2:
    .4byte  mat_rot_y
.L_render_z_tbl_2:
    .4byte  sym_060621D8
.L_render_x_tbl_2:
    .4byte  sym_0606212C
.L_fn_render_params_a_2:
    .4byte  sym_06031D8C
.L_render_y_tbl_2:
    .4byte  sym_06062180
.L_scale_factor_tbl_2:
    .4byte  sym_06089E9C
.L_render_w_tbl_2:
    .4byte  sym_060620D8
.L_fn_render_params_b_2:
    .4byte  sym_06031A28
.L_timer_ch_b_dec:
    .4byte  sym_0605DF50
.L_check_timer_ch_c:                    ! -- channel C timer processing --
    mov.l   .L_timer_ch_c_val, r3
    mov.w @r3, r3
    extu.w r3, r3
    cmp/pl r3                           ! timer_ch_c > 0?
    bf      .L_check_timer_ch_d         ! no -- try channel D
    mov r10, r6                         ! r6 = 0x6666 (uniform scale)
    mov r10, r5
    mov.l   .L_fn_mat_scale_3, r3
    jsr @r3                             ! mat_scale(0x6666, 0x6666, 0x6666)
    mov r10, r4
    mov.w   .L_alt_scale_ch_c, r6       ! r6 = 0xDD71 (scale factor)
    mov.l   .L_pos_param_ch_c, r4       ! r4 = 0x14872 (position)
    mov.l   .L_fn_position_set_4, r3
    jsr @r3                             ! position_set(pos, 0.5, scale)
    mov r8, r5
    mov.w   .L_rot_angle_ch_c, r4       ! r4 = 0x1000 (rotation angle)
    mov.l   .L_fn_mat_rot_y_3, r3
    jsr @r3                             ! mat_rot_y(0x1000)
    nop
    mov.b @r12, r5                      ! r5 = frame_index_a
    extu.b r5, r5
    add #0x12, r5
    shll2 r5
    mov.l r5, @r15
    mov.l   .L_render_z_tbl_3, r3
    mov.l @r15, r4
    mov.l   .L_render_x_tbl_3, r2
    mov.l   .L_fn_render_params_a_3, r1
    add r3, r5
    add r2, r4
    mov.l @r5, r5
    jsr @r1                             ! render_params_a(x, z)
    mov.l @r4, r4
    mov.b @r12, r6
    extu.b r6, r6
    add #0x12, r6
    shll2 r6
    mov.l r6, @r15
    mov.l   .L_render_y_tbl_3, r3
    mov.l   .L_scale_factor_tbl_3, r5
    mov.l @r15, r4
    mov.l   .L_render_w_tbl_3, r2
    mov.l   .L_fn_render_params_b_3, r1
    add r3, r6
    mov.w @r5, r5
    add r2, r4
    mov.l @r6, r6
    jsr @r1                             ! render_params_b(w, scale, y)
    mov.l @r4, r4
    mov.l @r9, r3                       ! r3 = cmd_buf ptr
    add #-0x30, r3                      ! advance cmd buffer by -0x30
    mov.l r3, @r9
    mov.b @r12, r2                      ! frame_index_a++
    add #0x1, r2
    mov.b r2, @r12
    mov.b @r12, r3
    mov #0x3, r2
    extu.b r3, r3
    cmp/ge r2, r3                       ! index >= 3?
    bf      .L_ch_c_dec_timer           ! no -- skip wrap
    extu.b r13, r2
    mov.b r2, @r12                      ! wrap index to 0
.L_ch_c_dec_timer:                      ! decrement channel C timer
    mov.l   .L_timer_ch_c_val, r3
    mov.w @r3, r3
    add #-0x1, r3                       ! timer_ch_c--
    mov.l   .L_timer_ch_c_val, r2
    mov.w r3, @r2
    bra     .L_check_active_display     ! skip to post-timer check
    nop
.L_alt_scale_ch_c:
    .2byte  0xDD71
.L_rot_angle_ch_c:
    .2byte  0x1000
    .2byte  0xFFFF
.L_timer_ch_c_val:
    .4byte  sym_0605DF52
.L_fn_mat_scale_3:
    .4byte  mat_scale_columns
.L_pos_param_ch_c:
    .4byte  0x00014872                  /* 1.28 (16.16 fixed-point) */
.L_fn_position_set_4:
    .4byte  sym_06026E2E
.L_fn_mat_rot_y_3:
    .4byte  mat_rot_y
.L_render_z_tbl_3:
    .4byte  sym_060621D8
.L_render_x_tbl_3:
    .4byte  sym_0606212C
.L_fn_render_params_a_3:
    .4byte  sym_06031D8C
.L_render_y_tbl_3:
    .4byte  sym_06062180
.L_scale_factor_tbl_3:
    .4byte  sym_06089E9C
.L_render_w_tbl_3:
    .4byte  sym_060620D8
.L_fn_render_params_b_3:
    .4byte  sym_06031A28
.L_check_timer_ch_d:                    ! -- channel D timer processing --
    mov.l   .L_timer_ch_d_val, r3
    mov.w @r3, r3
    extu.w r3, r3
    cmp/pl r3                           ! timer_ch_d > 0?
    bf      .L_check_active_display     ! no -- skip to active display check
    mov.l   .L_fn_render_setup_3, r3
    jsr @r3                             ! render_setup()
    nop
    mov r10, r6                         ! r6 = 0x6666 (uniform scale)
    mov r10, r5
    mov.l   .L_fn_mat_scale_4, r3
    jsr @r3                             ! mat_scale(0x6666, 0x6666, 0x6666)
    mov r10, r4
    mov.w   .L_alt_scale_ch_d, r6       ! r6 = 0xDD71 (scale factor)
    mov.l   .L_pos_param_ch_d, r4       ! r4 = -0x14872 (position)
    mov.l   .L_fn_position_set_5, r3
    jsr @r3                             ! position_set(pos, 0.5, scale)
    mov r8, r5
    mov.w   .L_rot_angle_ch_d, r4       ! r4 = 0x7000 (rotation angle)
    mov.l   .L_fn_mat_rot_y_4, r3
    jsr @r3                             ! mat_rot_y(0x7000)
    nop
    mov.b @r11, r5                      ! r5 = frame_index_b
    extu.b r5, r5
    add #0x12, r5
    shll2 r5
    mov.l r5, @r15
    mov.l   .L_render_z_tbl_4, r3
    mov.l @r15, r4
    mov.l   .L_render_x_tbl_4, r2
    mov.l   .L_fn_render_params_a_4, r1
    add r3, r5
    add r2, r4
    mov.l @r5, r5
    jsr @r1                             ! render_params_a(x, z)
    mov.l @r4, r4
    mov.b @r11, r6
    extu.b r6, r6
    add #0x12, r6
    shll2 r6
    mov.l r6, @r15
    mov.l   .L_render_y_tbl_4, r3
    mov.l   .L_scale_factor_tbl_4, r5
    mov.l @r15, r4
    mov.l   .L_render_w_tbl_4, r2
    mov.l   .L_fn_render_params_b_4, r1
    add r3, r6
    mov.w @r5, r5
    add r2, r4
    mov.l @r6, r6
    jsr @r1                             ! render_params_b(w, scale, y)
    mov.l @r4, r4
    mov.l @r9, r3                       ! r3 = cmd_buf ptr
    add #-0x30, r3                      ! advance cmd buffer by -0x30
    mov.l r3, @r9
    mov.b @r11, r2                      ! frame_index_b++
    add #0x1, r2
    mov.b r2, @r11
    mov #0x3, r2
    mov.b @r11, r3
    extu.b r3, r3
    cmp/ge r2, r3                       ! index >= 3?
    bf      .L_ch_d_dec_timer           ! no -- skip wrap
    extu.b r13, r2
    mov.b r2, @r11                      ! wrap index to 0
.L_ch_d_dec_timer:                      ! decrement channel D timer
    mov.l   .L_timer_ch_d_val, r3
    mov.w @r3, r3
    add #-0x1, r3                       ! timer_ch_d--
    mov.l   .L_timer_ch_d_val, r2
    mov.w r3, @r2
.L_check_active_display:                ! -- post-timer: check active display --
    mov.l   .L_active_display_flag, r0
    mov.l @r0, r0
    tst r0, r0                          ! active_display != 0?
    bf      .L_check_anim_state         ! yes -- check anim state
    bra     .L_epilogue                 ! no -- return
    nop
.L_alt_scale_ch_d:
    .2byte  0xDD71
.L_rot_angle_ch_d:
    .2byte  0x7000
.L_timer_ch_d_val:
    .4byte  sym_0605DF54
.L_fn_render_setup_3:
    .4byte  sym_06026DBC
.L_fn_mat_scale_4:
    .4byte  mat_scale_columns
.L_pos_param_ch_d:
    .4byte  0xFFFEB78E                  /* -1.28 (16.16 fixed-point) */
.L_fn_position_set_5:
    .4byte  sym_06026E2E
.L_fn_mat_rot_y_4:
    .4byte  mat_rot_y
.L_render_z_tbl_4:
    .4byte  sym_060621D8
.L_render_x_tbl_4:
    .4byte  sym_0606212C
.L_fn_render_params_a_4:
    .4byte  sym_06031D8C
.L_render_y_tbl_4:
    .4byte  sym_06062180
.L_scale_factor_tbl_4:
    .4byte  sym_06089E9C
.L_render_w_tbl_4:
    .4byte  sym_060620D8
.L_fn_render_params_b_4:
    .4byte  sym_06031A28
.L_active_display_flag:
    .4byte  sym_06059F30
.L_check_anim_state:                    ! -- animation state check --
    mov.w   .L_field_166_off, r0        ! r0 = offset 0x166
    mov.w @(r0, r14), r3               ! r3 = ctrl_state[0x166]
    tst r3, r3
    bf      .L_recheck_anim_fields      ! if field_166 != 0, skip reset
    mov.w   .L_field_152_off, r0        ! r0 = offset 0x152
    mov.w @(r0, r14), r3               ! r3 = ctrl_state[0x152]
    tst r3, r3
    bf      .L_recheck_anim_fields      ! if field_152 != 0, skip reset
    exts.w r13, r3                      ! both fields zero: reset elem index
    mov.l   .L_disp_elem_index, r2
    mov.w r3, @r2                       ! display_elem_index = 0
.L_recheck_anim_fields:                 ! re-check: need at least one field nonzero
    mov.w   .L_field_166_off, r0
    mov.w @(r0, r14), r0
    tst r0, r0
    bf      .L_anim_render_dispatch     ! field_166 != 0 -- do anim
    mov.w   .L_field_152_off, r0
    mov.w @(r0, r14), r0
    tst r0, r0
    bt      .L_epilogue                 ! both zero -- return
.L_anim_render_dispatch:                ! -- animated display element render --
    mov.l   .L_fn_render_setup_4, r3
    jsr @r3                             ! render_setup()
    nop
    mov.l   .L_camera_state_ptr, r10    ! r10 = camera_state struct
    mov.l   .L_z_offset_neg, r3         ! r3 = -0xA000 (z offset)
    mov.w   .L_y_offset_neg, r2         ! r2 = 0xCCCD (y offset, signed neg)
    mov.l @(8, r10), r6                 ! r6 = camera_state.z
    mov.l @(4, r10), r5                 ! r5 = camera_state.y
    neg r6, r6                          ! r6 = -z
    add r2, r5                          ! r5 = y + y_offset
    add r3, r6                          ! r6 = -z + z_offset
    mov.l   .L_fn_position_set_6, r3
    jsr @r3                             ! position_set(x, y+off, -z+off)
    mov.l @r10, r4                      ! r4 = camera_state.x (delay slot)
    mov.l   .L_fn_mat_rot_y_5, r3
    jsr @r3                             ! mat_rot_y(0.5)
    mov r8, r4                          ! r4 = 0.5 (delay slot)
    mov.w   .L_field_166_off, r0        ! r0 = offset 0x166
    mov.l   .L_elem_lookup_tbl, r3      ! r3 = elem_lookup table
    mov.w @(r0, r14), r5               ! r5 = ctrl_state[0x166] (element index)
    shll r5                             ! r5 *= 2 (halfword index)
    add r3, r5                          ! r5 = &lookup[index]
    mov.w @r5, r5                       ! r5 = lookup value
    add #0xE, r5                        ! r5 += 0xE (render slot offset)
    shll2 r5                            ! r5 *= 4
    mov.l r5, @r15                      ! save offset
    mov.l   .L_render_z_tbl_5, r2
    mov.l @r15, r4
    mov.l   .L_render_x_tbl_5, r1
    mov.l   .L_fn_render_params_a_5, r3
    add r2, r5
    add r1, r4
    mov.l @r5, r5
    jsr @r3                             ! render_params_a(x, z)
    mov.l @r4, r4
    mov.w   .L_field_166_off, r0
    mov.l   .L_elem_lookup_tbl, r3
    mov.w @(r0, r14), r6               ! r6 = ctrl_state[0x166] (re-read)
    shll r6
    add r3, r6
    mov.w @r6, r6
    add #0xE, r6
    shll2 r6
    mov.l r6, @r15
    mov.l   .L_render_y_tbl_5, r2
    mov.l   .L_scale_factor_tbl_5, r5
    mov.l @r15, r4
    mov.l   .L_render_w_tbl_5, r1
    mov.l   .L_fn_render_params_b_5, r3
    add r2, r6
    mov.w @r5, r5
    add r1, r4
    mov.l @r6, r6
    jsr @r3                             ! render_params_b(w, scale, y)
    mov.l @r4, r4
    mov.l @r9, r2                       ! r2 = cmd_buf ptr
    add #-0x30, r2                      ! advance cmd buffer by -0x30
    mov.l r2, @r9
.L_epilogue:                            ! -- function epilogue --
    add #0x4, r15                       ! free stack local
    lds.l @r15+, pr
    mov.l @r15+, r8
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14                    ! restore r14 (delay slot)
.L_field_166_off:
    .2byte  0x0166
.L_field_152_off:
    .2byte  0x0152
.L_y_offset_neg:
    .2byte  0xCCCD                      /* -0x3333 signed = -13107 */
.L_disp_elem_index:
    .4byte  sym_0605DF44
.L_fn_render_setup_4:
    .4byte  sym_06026DBC
.L_camera_state_ptr:
    .4byte  sym_06044670
.L_z_offset_neg:
    .4byte  0xFFFF6000                  /* -0.625 (16.16 fixed-point) */
.L_fn_position_set_6:
    .4byte  sym_06026E2E
.L_fn_mat_rot_y_5:
    .4byte  mat_rot_y
.L_elem_lookup_tbl:
    .4byte  sym_0605DF46
.L_render_z_tbl_5:
    .4byte  sym_060621D8
.L_render_x_tbl_5:
    .4byte  sym_0606212C
.L_fn_render_params_a_5:
    .4byte  sym_06031D8C
.L_render_y_tbl_5:
    .4byte  sym_06062180
.L_scale_factor_tbl_5:
    .4byte  sym_06089E9C
.L_render_w_tbl_5:
    .4byte  sym_060620D8
.L_fn_render_params_b_5:
    .4byte  sym_06031A28
