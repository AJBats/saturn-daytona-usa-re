/* track_elev_map -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060146D4 - 0x0601476C
 * Auto-generated by tools/generate_l3_tu.py
 *
 * File ID Search Dispatch and Variant Buffer Copy
 * ------------------------------------------------
 * Part of the results screen state machine. Stores a caller-provided
 * countdown value into the countdown timer (sym_0607EBCC), then calls
 * perspective_proj_3d (a file ID search routine) with the car count
 * pointer as output parameter.
 *
 * Based on the search result:
 *   - Non-zero (0xFF = key replaced during search): set phase byte = 6
 *   - Zero (match found or sentinel): set phase byte = 4
 *
 * Then checks the status flags word (sym_06084B10). If bit 0 is clear,
 * copies 4 bytes from the variant char buffer (sym_06084B14) into two
 * destination pointers:
 *   - sym_06085FFC = active camera cut-point entry pointer
 *   - sym_06086000 = camera override pointer
 * Each destination is dereferenced (pointer-to-pointer) before the copy.
 * If either destination pointer is NULL, the copy for that target is skipped.
 *
 * INPUT:
 *   r3 = countdown timer value to store
 *
 * STATE VARIABLES:
 *   sym_0607EBCC = countdown timer (32-bit, in frames)
 *   sym_06084FB4 = car count (32-bit output parameter for file ID search)
 *   sym_06084AF2 = phase byte (written: 4 or 6)
 *   sym_06084B10 = status flags (bit 0: skip variant copy)
 *   sym_06084B14 = variant char buffer (4 bytes source)
 *   sym_06085FFC = active camera entry pointer (indirect dest A)
 *   sym_06086000 = camera override pointer (indirect dest B)
 */

    .section .text.FUN_060146D4


    .global track_elev_map
    .type track_elev_map, @function
track_elev_map:
    sts.l pr, @-r15                     ! save return address
    mov.l   .L_ptr_countdown_timer, r2  ! r2 = &countdown_timer (sym_0607EBCC)
    mov.l r3, @r2                       ! countdown_timer = r3 (caller-provided value)
    mov.l   .L_ptr_car_count, r4        ! r4 = &car_count (sym_06084FB4, output param)
    .byte   0xB0, 0x46    /* bsr perspective_proj_3d (file ID search) */
    nop                                 ! delay slot
    exts.b r0, r0                       ! sign-extend search result to 32-bit
    tst r0, r0                          ! test if result == 0
    bt      .L_search_terminated        ! if zero (match/sentinel) → phase = 4
    mov #0x6, r3                        ! r3 = 6 (key-replaced phase)
    mov.l   .L_ptr_phase_byte_a, r2     ! r2 = &phase_byte (sym_06084AF2)
    mov.b r3, @r2                       ! phase_byte = 6
    bra     .L_check_status_flags       ! skip alternate path
    nop                                 ! delay slot
    .4byte  sym_06084B18                /* active car count (32-bit) — prev TU pool */
    .4byte  sym_06084AF0                /* frame timer base (16-bit) — prev TU pool */
.L_ptr_countdown_timer:
    .4byte  sym_0607EBCC                /* countdown timer (32-bit, in frames) */
.L_ptr_car_count:
    .4byte  sym_06084FB4                /* car count output parameter */
.L_ptr_phase_byte_a:
    .4byte  sym_06084AF2                /* phase byte (results state machine) */
.L_search_terminated:
    mov #0x4, r2                        ! r2 = 4 (terminated phase)
    mov.l   .L_ptr_phase_byte_b, r3     ! r3 = &phase_byte (sym_06084AF2)
    mov.b r2, @r3                       ! phase_byte = 4
.L_check_status_flags:
    mov.l   .L_ptr_status_flags, r0     ! r0 = &status_flags (sym_06084B10)
    mov.l @r0, r0                       ! r0 = status_flags value
    tst #0x1, r0                        ! test bit 0 of status flags
    bf      .L_done                     ! if bit 0 set → skip variant copy
    mov.l   .L_ptr_cam_entry, r4        ! r4 = &active_cam_entry_ptr (sym_06085FFC)
    mov.l @r4, r4                       ! r4 = active_cam_entry_ptr (deref)
    tst r4, r4                          ! test if pointer is NULL
    bt      .L_try_override_ptr         ! if NULL → skip first copy
    mov.l   .L_ptr_variant_buf, r5      ! r5 = &variant_char_buffer (sym_06084B14)
    mov.b @r5+, r1                      ! r1 = variant_buf[0]; r5++
    mov.b r1, @r4                       ! dest_a[0] = variant_buf[0]
    add #0x1, r4                        ! r4++ (advance dest pointer)
    mov.b @r5+, r1                      ! r1 = variant_buf[1]; r5++
    mov.b r1, @r4                       ! dest_a[1] = variant_buf[1]
    add #0x1, r4                        ! r4++ (advance dest pointer)
    mov.b @r5+, r1                      ! r1 = variant_buf[2]; r5++
    mov.b r1, @r4                       ! dest_a[2] = variant_buf[2]
    add #0x1, r4                        ! r4++ (advance dest pointer)
    mov.b @r5, r3                       ! r3 = variant_buf[3]
    mov.b r3, @r4                       ! dest_a[3] = variant_buf[3]
.L_try_override_ptr:
    mov.l   .L_ptr_cam_override, r4     ! r4 = &cam_override_ptr (sym_06086000)
    mov.l @r4, r4                       ! r4 = cam_override_ptr (deref)
    tst r4, r4                          ! test if pointer is NULL
    bt      .L_done                     ! if NULL → skip second copy
    mov.l   .L_ptr_variant_buf, r5      ! r5 = &variant_char_buffer (sym_06084B14)
    mov.b @r5+, r1                      ! r1 = variant_buf[0]; r5++
    mov.b r1, @r4                       ! dest_b[0] = variant_buf[0]
    add #0x1, r4                        ! r4++ (advance dest pointer)
    mov.b @r5+, r1                      ! r1 = variant_buf[1]; r5++
    mov.b r1, @r4                       ! dest_b[1] = variant_buf[1]
    add #0x1, r4                        ! r4++ (advance dest pointer)
    mov.b @r5+, r1                      ! r1 = variant_buf[2]; r5++
    mov.b r1, @r4                       ! dest_b[2] = variant_buf[2]
    add #0x1, r4                        ! r4++ (advance dest pointer)
    mov.b @r5, r3                       ! r3 = variant_buf[3]
    mov.b r3, @r4                       ! dest_b[3] = variant_buf[3]
.L_done:
    lds.l @r15+, pr                     ! restore return address
    rts                                 ! return to caller
    nop                                 ! delay slot
.L_ptr_phase_byte_b:
    .4byte  sym_06084AF2                /* phase byte (results state machine) */
.L_ptr_status_flags:
    .4byte  sym_06084B10                /* status flags (bit 0 = skip variant copy) */
.L_ptr_cam_entry:
    .4byte  sym_06085FFC                /* active camera cut-point entry pointer */
.L_ptr_variant_buf:
    .4byte  sym_06084B14                /* variant char buffer (4 bytes) */
.L_ptr_cam_override:
    .4byte  sym_06086000                /* camera override pointer */
