/* lap_counter_update -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060158DE - 0x06015954
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Lap counter update — handles lap completion logic for a given car.
 *
 * Takes r4 = car index.
 *
 * If race_end_flag is set:
 *   - Write 1 to final_lap_flag → tail-call display update
 *
 * Otherwise:
 *   - Compute car slot address: base + (idx*4 + idx*16) = base + idx*20
 *   - Write 1 at slot+1 (lap completion marker)
 *   - Look up sound effect from car struct → sound table
 *   - Play lap completion sound via sound_cmd_dispatch
 *   - Tail-call lap display handler with car index
 */

    .section .text.FUN_060158DE


    .global lap_counter_update
    .type lap_counter_update, @function
lap_counter_update:
    sts.l pr, @-r15
    add #-0x4, r15
    mov.b r4, @r15                    /* save car index on stack */
    .byte   0xD0, 0x15    /* mov.l .L_race_end_flag, r0 */
    mov.l @r0, r0                     /* check race end flag */
    tst r0, r0
    bt/s    .L_060158F8              /* not ended → normal lap update */
    mov #0x1, r4
    exts.w r4, r4                     /* race ended: set final_lap_flag = 1 */
    .byte   0xD3, 0x13    /* mov.l .L_final_lap_flag, r3 */
    mov.w r4, @r3
    bra     .L_06015926              /* → tail-call display update */
    nop
.L_060158F8:
    mov.b @r15, r2                    /* r2 = car index */
    extu.b r4, r0                     /* r0 = 1 (lap marker) */
    .byte   0xD1, 0x0D    /* mov.l .L_lap_slot_base, r1 */
    extu.b r2, r2
    mov r2, r3                        /* compute slot: idx*4 + idx*16 = idx*20 */
    shll2 r2                          /* r2 = idx * 4 */
    shll2 r3                          /* r3 = idx * 4 */
    shll2 r3                          /* r3 = idx * 16 */
    shll2 r3
    add r3, r2                        /* r2 = idx * 20 */
    exts.w r2, r2
    add r1, r2                        /* r2 = &lap_slot[idx] */
    mov.b r0, @(1, r2)               /* slot[1] = 1 (lap completed) */
    .byte   0xD5, 0x0C    /* mov.l .L_car_struct_base, r5 */
    mov.w   .L_off_car_id, r0        /* offset +0x224 = car sound ID */
    .byte   0xD3, 0x0C    /* mov.l .L_sound_table, r3 */
    .byte   0xD2, 0x0C    /* mov.l .L_fn_sound_cmd, r2 */
    mov.l @(r0, r5), r5              /* r5 = car.sound_id */
    shll2 r5                          /* index * 4 into sound table */
    add r3, r5
    mov.l @r5, r5                     /* r5 = sound_table[car.sound_id] */
    jsr @r2                           /* play lap completion sound */
    mov #0x0, r4
.L_06015926:
    mov.b @r15, r4                    /* restore car index */
    extu.b r4, r4
    add #0x4, r15
    .byte   0xD3, 0x08    /* mov.l .L_fn_lap_display, r3 */
    jmp @r3                           /* tail-call: lap display handler(car_index) */
    lds.l @r15+, pr
.L_off_car_id:
    .2byte  0x0224                      /* car struct offset: sound ID for this car */
.L_lap_slot_base:
    .4byte  sym_06084FC8               /* base of lap slot array (20 bytes per car) */
    .4byte  sym_0605B8A4               /* (adjacent data) */
.L_race_end_flag:
    .4byte  sym_0607EAE0               /* race end flag (32-bit, nonzero = ended) */
.L_final_lap_flag:
    .4byte  sym_06085F94               /* final lap completion flag (16-bit) */
.L_car_struct_base:
    .4byte  sym_06078900               /* car struct array base */
.L_sound_table:
    .4byte  sym_06044BD8               /* lap completion sound table (4 bytes per entry) */
.L_fn_sound_cmd:
    .4byte  sound_cmd_dispatch         /* sound command dispatch */
.L_fn_lap_display:
    .4byte  sym_060172E4               /* lap display handler */
