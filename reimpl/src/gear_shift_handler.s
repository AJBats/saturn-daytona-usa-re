/* gear_shift_handler -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008318 - 0x06008418
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Gear shift handler — processes manual transmission gear changes.
 *
 * If a shift is in progress (shift_timer > 0):
 *   - Decrement shift_timer
 *   - Look up gear ratio from table (indexed by remaining timer)
 *   - Apply positive or negative ratio based on shift direction (+0x1DC field)
 *   - Store interpolated gear value at +0x1D8 in car struct
 *
 * If no shift in progress and RPM > 600 (0x258):
 *   - Check button bits: 0x10 = shift down, 0x20 = shift up
 *   - Set shift_timer = 0x20 (32 frames), direction = -1 or +1
 *   - Store car pointer for shift tracking
 *   - Set shift duration = 0x28 (40) at +0xD4 offset
 *
 * Exit: call helper twice with mode bytes 0x0301 and 0x0201
 *       (likely gear indicator display update)
 */

    .section .text.FUN_06008318


    .global gear_shift_handler
    .type gear_shift_handler, @function
gear_shift_handler:
    sts.l pr, @-r15
    mov.l   .L_car_struct_ptr, r4     /* r4 = &car_struct_ptr (indirect) */
    mov.w   .L_off_shift_timer, r0    /* offset +0xB8 = shift_timer in car struct */
    mov.l @r4, r3
    mov.l @(r0, r3), r0               /* r0 = car.shift_timer */
    tst r0, r0
    bt      .L_06008378              /* shift_timer == 0 → check for new shift */
    mov.l @r4, r3                     /* --- shift in progress path --- */
    mov.w   .L_off_shift_timer, r0
    mov.l @(r0, r3), r2
    add #-0x1, r2                     /* decrement shift_timer */
    mov.l r2, @(r0, r3)
    mov.l @r4, r5
    mov.l   .L_gear_ratio_table, r3   /* look up interpolated gear ratio */
    mov.l @r4, r2
    mov.l @(r0, r5), r5               /* r5 = remaining timer */
    mov r2, r1
    shll r5                            /* index × 2 (16-bit table entries) */
    mov.w   DAT_0600835a, r0         /* offset +0x1DC = shift_direction */
    add r3, r5
    mov.l @(r0, r1), r3               /* r3 = car.shift_direction */
    cmp/pl r3                          /* positive direction? */
    bf/s    .L_0600834C
    mov.w @r5, r5                     /* r5 = gear_ratio_table[timer] */
    bra     .L_06008350
    exts.w r5, r3                     /* positive shift: use ratio directly */
.L_0600834C:
    exts.w r5, r1                     /* negative shift: negate ratio */
    neg r1, r3
.L_06008350:
    mov.w   .L_off_gear_interp, r0   /* offset +0x1D8 = interpolated gear value */
    mov.l r3, @(r0, r2)              /* store gear interpolation value */
    bra     .L_060083DE              /* → exit path */
    nop
.L_off_shift_timer:
    .2byte  0x00B8                      /* car struct offset: shift timer (32-bit) */

    .global DAT_0600835a
DAT_0600835a:
    .2byte  0x01DC                      /* car struct offset: shift direction */
    .4byte  0x03010201                  /* embedded data: shift sound params */
.L_off_gear_interp:
    .2byte  0x01D8                      /* car struct offset: interpolated gear value */
    .2byte  0xFFFF
    .4byte  0xAE111BFF                  /* embedded data: gear change sound cmd */
    .4byte  sound_cmd_dispatch         /* (used by adjacent inline code) */
    .4byte  sym_06034F78               /* gear display helper */
.L_car_struct_ptr:
    .4byte  sym_0607E940               /* pointer to current car struct */
.L_gear_ratio_table:
    .4byte  sym_060453CC               /* gear ratio interpolation table (16-bit entries) */
.L_06008378:                              /* --- no shift in progress → check for new shift --- */
    mov.l   .L_rpm_value, r2
    mov.w   .L_rpm_threshold, r3      /* 0x258 = 600 RPM minimum for shifting */
    mov.l @r2, r2
    cmp/gt r3, r2
    bf      .L_060083DE              /* RPM too low → skip */
    mov.l   .L_car_struct_ptr_2, r3
    mov.w   DAT_060083fc, r0         /* offset +0xBC = gear lock flag */
    mov.l @r3, r3
    mov.l @(r0, r3), r0
    tst r0, r0
    bf      .L_060083DE              /* gear locked → skip */
    mov #0x28, r6                     /* shift duration = 40 frames */
    mov.l @r4, r2
    mov.l   .L_shift_car_ptr, r7     /* store car pointer for shift tracking */
    mov r2, r0
    mov.b @r0, r0                     /* read button state byte */
    tst #0x10, r0                     /* bit 4 = shift DOWN button */
    bt/s    .L_060083BA              /* not pressed → check shift up */
    mov #0x20, r5                     /* shift_timer = 32 frames */
    mov.l @r4, r3                     /* --- SHIFT DOWN path --- */
    mov.w   .L_off_shift_timer_2, r0
    mov.l r5, @(r0, r3)              /* set shift_timer = 32 */
    mov.l @r4, r3
    mov #-0x1, r2                     /* direction = -1 (downshift) */
    mov.w   DAT_06008400, r0
    mov.l r2, @(r0, r3)              /* set shift_direction = -1 */
    mov.l @r4, r3
    mov.l r3, @r7                     /* store car ptr for tracking */
    mov.l @r4, r2
    exts.w r6, r6
    mov.w   DAT_06008402, r0         /* offset +0xD4 = shift duration display */
    bra     .L_060083DE
    mov.w r6, @(r0, r2)              /* set display duration = 40 */
.L_060083BA:
    mov.l @r4, r2                     /* --- check SHIFT UP --- */
    mov r2, r0
    mov.b @r0, r0                     /* read button state byte */
    tst #0x20, r0                     /* bit 5 = shift UP button */
    bt      .L_060083DE              /* not pressed → skip */
    mov.l @r4, r3                     /* --- SHIFT UP path --- */
    mov.w   .L_off_shift_timer_2, r0
    mov.l r5, @(r0, r3)              /* set shift_timer = 32 */
    mov.l @r4, r3
    mov #0x1, r2                      /* direction = +1 (upshift) */
    mov.w   DAT_06008400, r0
    mov.l r2, @(r0, r3)              /* set shift_direction = +1 */
    mov.l @r4, r3
    mov.l r3, @r7                     /* store car ptr for tracking */
    mov.l @r4, r2
    exts.w r6, r6
    mov.w   DAT_06008402, r0
    mov.w r6, @(r0, r2)              /* set display duration = 40 */
.L_060083DE:                              /* --- exit: update gear indicator --- */
    mov #0x0, r5
    mov.l @r4, r2
    mov.w   .L_gear_mode_a, r1       /* mode 0x0301 = gear display A */
    mov.l   .L_fn_gear_helper, r3
    jsr @r3
    mov r5, r0
    mov.l @r4, r2
    mov.w   .L_gear_mode_b, r1       /* mode 0x0201 = gear display B */
    mov.l   .L_fn_gear_helper, r3
    jsr @r3
    mov r5, r0
    lds.l @r15+, pr
    rts
    nop
.L_rpm_threshold:
    .2byte  0x0258                      /* 600 RPM — minimum for gear shift */

    .global DAT_060083fc
DAT_060083fc:
    .2byte  0x00BC                      /* car struct offset: gear lock flag */
.L_off_shift_timer_2:
    .2byte  0x00B8                      /* car struct offset: shift timer */

    .global DAT_06008400
DAT_06008400:
    .2byte  0x01DC                      /* car struct offset: shift direction */

    .global DAT_06008402
DAT_06008402:
    .2byte  0x00D4                      /* car struct offset: shift duration display */
.L_gear_mode_a:
    .2byte  0x0301                      /* gear indicator mode A */
.L_gear_mode_b:
    .2byte  0x0201                      /* gear indicator mode B */
.L_rpm_value:
    .4byte  sym_0607EBD0               /* current RPM value (32-bit) */
.L_car_struct_ptr_2:
    .4byte  sym_0607E940               /* pointer to current car struct */
.L_shift_car_ptr:
    .4byte  sym_0607EBE0               /* car pointer saved during shift */
.L_fn_gear_helper:
    .4byte  sym_06034F78               /* gear display update helper */
