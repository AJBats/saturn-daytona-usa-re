/* adv_collision_resp -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x060145BC - 0x060146D2
 * Auto-generated by tools/generate_l3_tu.py
 *
 * Active Car Variant Manager
 * --------------------------
 * Processes input flags to add or remove car variants from the active set.
 * Checks button state bits 8-10 (0x0700 mask) for car management commands.
 *
 * Two removal paths (bit 8 set OR current variant == 0x7D):
 *   - If car count is zero: clear the 4-byte variant buffer to zero
 *   - If car count > 0: play removal sound (0xAB1101FF), decrement count,
 *     clear the last variant char slot
 *
 * Addition path (neither removal condition met):
 *   - If current variant == 0x7B: tail-call track_wall_collision (0x060146D2)
 *   - Otherwise: increment car count, store variant code in buffer,
 *     look up per-character sound from table (chars >= 0x41 use indexed table
 *     at sym_0605B0FC, chars < 0x41 use default sound 0xAB1102FF),
 *     play the sound. When count reaches 3, set car slot index to 0x1C
 *     and play completion sound (0xAB111EFF).
 *
 * Key state variables:
 *   sym_06084B18 = active car count (32-bit, max 3)
 *   sym_06084B14 = variant char buffer (3 bytes, one per active car)
 *   sym_06084B20 = current variant code (read from lookup table)
 *   g_pad_state = input/button state struct (+2 = button flags word)
 *   sym_06084B08 = car slot index
 *   sym_0605B0FC = per-character sound lookup table (indexed by char - 0x41)
 *
 * Sound commands:
 *   0xAB1101FF = car removal sound
 *   0xAB1102FF = default character sound (for codes < 0x41)
 *   0xAB111EFF = all 3 cars active / completion sound
 */

    .section .text.FUN_060145BC


    .global adv_collision_resp
    .type adv_collision_resp, @function
adv_collision_resp:
    mov.l r14, @-r15                    ! save r14 (callee-saved)
    mov.l r13, @-r15                    ! save r13 (callee-saved)
    mov.l r12, @-r15                    ! save r12 (callee-saved)
    mov.l r11, @-r15                    ! save r11 (callee-saved)
    sts.l pr, @-r15                     ! save return address
    mov.l   .L_pool_sound_dispatch, r12 ! r12 = sound_cmd_dispatch function ptr
    mov.l   .L_pool_car_count_ptr, r14  ! r14 = &active_car_count (sym_06084B18)
    mov.l   .L_pool_input_state_ptr, r4 ! r4 = &input_state struct (g_pad_state)
    mov.w   DAT_06014682, r2            ! r2 = 0x0700 (button mask: bits 8-10)
    mov.w @(2, r4), r0                  ! r0 = input_state[+2] (button flags word)
    mov r0, r3                          ! r3 = button flags (copy)
    extu.w r3, r3                       ! r3 = zero-extend to 32-bit
    and r2, r3                          ! r3 &= 0x0700 (isolate bits 8-10)
    tst r3, r3                          ! test if any car-management buttons pressed
    bt      .L_exit                     ! if no relevant buttons → exit early
    mov.l   .L_pool_variant_buf_ptr, r11 ! r11 = &variant_char_buffer (sym_06084B14)
    mov.l   .L_pool_variant_code_ptr, r13 ! r13 = &current_variant_code (sym_06084B20)
    mov.w @(2, r4), r0                  ! r0 = re-read button flags word
    mov.w   .L_wpool_bit8_mask, r2      ! r2 = 0x0100 (bit 8 mask)
    mov r0, r3                          ! r3 = button flags (copy)
    extu.w r3, r3                       ! r3 = zero-extend to 32-bit
    mov.l @r13, r0                      ! r0 = current variant code (*sym_06084B20)
    and r2, r3                          ! r3 &= 0x0100 (isolate bit 8: removal flag)
    cmp/eq #0x7D, r0                    ! T = (variant_code == 0x7D)?
    .word 0x0029 /* movt r0 */          ! r0 = T bit (1 if variant==0x7D, else 0)
    or r0, r3                           ! r3 |= movt result (removal if bit8 OR code==0x7D)
    tst r3, r3                          ! test combined removal condition
    bt      .L_check_add                ! if neither removal condition → try addition
    mov.l @r14, r0                      ! r0 = active_car_count
    tst r0, r0                          ! test if car count == 0
    bf/s    .L_remove_car               ! if count > 0 → remove a car
    mov #0x0, r13                       ! (delay) r13 = 0 (clear byte value)
    mov r11, r4                         ! r4 = &variant_char_buffer[0]
    mov.b r13, @r4                      ! variant_buf[0] = 0
    add #0x1, r4                        ! r4 = &variant_buf[1]
    mov.b r13, @r4                      ! variant_buf[1] = 0
    add #0x1, r4                        ! r4 = &variant_buf[2]
    extu.b r13, r2                      ! r2 = 0 (zero-extended byte)
    mov.b r2, @r4                       ! variant_buf[2] = 0
    add #0x1, r4                        ! r4 = &variant_buf[3]
    extu.b r13, r13                     ! r13 = 0 (zero-extended byte)
    bra     .L_exit                     ! jump to exit
    mov.b r13, @r4                      ! (delay) variant_buf[3] = 0
.L_remove_car:
    mov.l   .L_pool_snd_remove, r5      ! r5 = 0xAB1101FF (car removal sound ID)
    jsr @r12                            ! sound_cmd_dispatch(0, 0xAB1101FF)
    mov #0x0, r4                        ! (delay) r4 = 0 (sound channel)
    mov.l @r14, r2                      ! r2 = active_car_count
    add #-0x1, r2                       ! r2 = count - 1
    mov.l r2, @r14                      ! active_car_count = count - 1
    mov r2, r3                          ! r3 = new count (= index of last slot)
    add r3, r11                         ! r11 = &variant_buf[new_count] (last active slot)
    extu.b r13, r13                     ! r13 = 0 (zero-extended)
    bra     .L_exit                     ! jump to exit
    mov.b r13, @r11                     ! (delay) variant_buf[new_count] = 0 (clear removed slot)
.L_check_add:
    mov.l @r13, r0                      ! r0 = current variant code (*sym_06084B20)
    cmp/eq #0x7B, r0                    ! test if variant code == 0x7B (confirm/done sentinel)
    bf      .L_add_variant              ! if not sentinel → add variant to buffer
    lds.l @r15+, pr                     ! restore return address (epilogue start)
    mov.l @r15+, r11                    ! restore r11
    mov.l @r15+, r12                    ! restore r12
    mov.l @r15+, r13                    ! restore r13
    .byte   0xA0, 0x4C    /* bra 0x060146D2 (external) */  ! tail-call track_wall_collision
    mov.l @r15+, r14                    ! (delay) restore r14
.L_add_variant:
    mov.l @r14, r0                      ! r0 = active_car_count
    add #0x1, r0                        ! r0 = count + 1
    mov.l r0, @r14                      ! active_car_count = count + 1
    add #-0x1, r0                       ! r0 = old count (= index for new entry)
    mov.l @r13, r3                      ! r3 = current variant code
    mov.b r3, @(r0, r11)               ! variant_buf[old_count] = variant_code (store new char)
    mov.l @r13, r2                      ! r2 = current variant code (re-read)
    add #-0x41, r2                      ! r2 = variant_code - 0x41 (char-to-index conversion)
    cmp/pz r2                           ! test if index >= 0 (i.e. code >= 0x41)
    bt      .L_lookup_sound             ! if code >= 0x41 → use indexed sound table
    mov.l   .L_pool_snd_default, r5     ! r5 = 0xAB1102FF (default sound for codes < 0x41)
    bra     .L_play_sound               ! jump to play the sound
    nop                                 ! (delay) nop
.L_lookup_sound:
    mov.l @r13, r5                      ! r5 = current variant code
    add #-0x41, r5                      ! r5 = variant_code - 0x41 (table index)
    shll2 r5                            ! r5 = index * 4 (32-bit table entry stride)
    mov.l   .L_pool_sound_table, r3     ! r3 = &sound_table (sym_0605B0FC)
    add r3, r5                          ! r5 = &sound_table[index]
    mov.l @r5, r5                       ! r5 = sound_table[index] (sound ID for this char)
.L_play_sound:
    jsr @r12                            ! sound_cmd_dispatch(0, sound_id)
    mov #0x0, r4                        ! (delay) r4 = 0 (sound channel)
    mov.l @r14, r0                      ! r0 = active_car_count (after increment)
    cmp/eq #0x3, r0                     ! test if count == 3 (all slots full)
    bf      .L_exit                     ! if not full → exit
    mov #0x1C, r3                       ! r3 = 0x1C (car slot index for full set)
    mov.l   .L_pool_car_slot_ptr, r2    ! r2 = &car_slot_index (sym_06084B08)
    mov.l r3, @r2                       ! car_slot_index = 0x1C
    mov.l   .L_pool_snd_complete, r5    ! r5 = 0xAB111EFF (completion sound ID)
    jsr @r12                            ! sound_cmd_dispatch(0, 0xAB111EFF)
    mov #0x0, r4                        ! (delay) r4 = 0 (sound channel)
.L_exit:
    lds.l @r15+, pr                     ! restore return address
    mov.l @r15+, r11                    ! restore r11
    mov.l @r15+, r12                    ! restore r12
    mov.l @r15+, r13                    ! restore r13
    rts                                 ! return
    mov.l @r15+, r14                    ! (delay) restore r14

    .global DAT_06014682
DAT_06014682:
    .2byte  0x0700                      /* button mask: bits 8-10 (car management inputs) */
.L_wpool_bit8_mask:
    .2byte  0x0100                      /* bit 8 mask (removal/backspace button) */
    .2byte  0xFFFF                      /* padding / alignment */
.L_pool_sound_dispatch:
    .4byte  sound_cmd_dispatch          /* sound command dispatch function */
.L_pool_car_count_ptr:
    .4byte  sym_06084B18                /* &active_car_count (32-bit int) */
.L_pool_input_state_ptr:
    .4byte  g_pad_state                /* &input_state struct (+2 = button flags) */
.L_pool_variant_buf_ptr:
    .4byte  sym_06084B14                /* &variant_char_buffer (3 bytes) */
.L_pool_variant_code_ptr:
    .4byte  sym_06084B20                /* &current_variant_code (32-bit) */
.L_pool_snd_remove:
    .4byte  0xAB1101FF                  /* sound: car variant removed */
.L_pool_snd_default:
    .4byte  0xAB1102FF                  /* sound: default char (code < 0x41) */
.L_pool_sound_table:
    .4byte  sym_0605B0FC                /* per-character sound lookup table */
.L_pool_car_slot_ptr:
    .4byte  sym_06084B08                /* &car_slot_index (32-bit) */
.L_pool_snd_complete:
    .4byte  0xAB111EFF                  /* sound: all 3 slots filled / completion */
    .4byte  0xD30FE204                  /* trailing data (next TU preamble) */
    .4byte  0x63323322
    .4byte  0x8907D20E
    .4byte  0xD30D6221
    .4byte  0x72FF2321
    .4byte  0x622F4215
    .4byte  0x8901A002
    .4byte  0x0009000B
    .2byte  0x0009
