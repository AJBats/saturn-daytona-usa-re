/* engine_init_global -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06004A98 - 0x06004F14
 * Auto-generated by tools/generate_l3_tu.py
 *
 * One-time global engine initialization. Called at startup to configure
 * the entire display pipeline, VDP2 pattern tables, and subsystems:
 *
 *   1. Clear all VDP2 VRAM (128KB of zeros)
 *   2. Init display hardware, VDP master, tilemap DMA
 *   3. Spin-wait for SCU VBlank-OUT interrupt
 *   4. Register callbacks: button_input_read (vec 0x40), vblank_out (vec 0x41)
 *   5. Set up scene state processor
 *   6. Configure 4 display channels (4, 8, 16, 32) in sequence:
 *      - Each gets VRAM base address, pattern table config, VDP1 polygon build
 *      - Control values: ch4=0xC024, ch8=0xC044, ch16=0xC000, ch32=0xC060
 *   7. Zero-fill pattern config buffer (256 bytes at r12+0x1810)
 *   8. Init scene buffers, color intensity, texture banks
 *   9. VDP1 polygon commit, display channels clear, render update
 *  10. Sound init, VDP2 register init, master_init_dispatch
 *  11. obj_template_init, audio_display_init
 *  12. Set display ready flags and final interrupt config
 *
 * Register conventions:
 *   r8  = interrupt controller function pointer
 *   r9  = vdp1_polygon_build function
 *   r10 = SCU IST register (0x25FE00A4)
 *   r11 = 2 (SCU IST bit 1 = VBlank-OUT)
 *   r12 = pattern config base address (sym_06087C84)
 *   r13 = 1 (const), r14 = 0 (const)
 */

    .section .text.FUN_06004A98


    .global engine_init_global
    .type engine_init_global, @function
engine_init_global:
    mov.l r14, @-r15
    mov #0x0, r14                           ! r14 = const 0 (used throughout)
    mov.l r13, @-r15
    mov #0x1, r13                           ! r13 = const 1
    mov.l r12, @-r15
    mov.l r11, @-r15
    mov.l r10, @-r15
    mov #0x2, r11                           ! r11 = 2 (VBlank-OUT bit)
    mov.l r9, @-r15
    mov.l r8, @-r15
    sts.l pr, @-r15
    add #-0x5C, r15                         ! 92-byte stack frame
    mov.l   .L_interrupt_ctrl_ptr, r8       ! r8 → interrupt controller fn ptr
    mov.l   .L_fn_vdp1_poly_build, r9      ! r9 = vdp1_polygon_build
    mov.l   .L_scu_ist, r10                 ! r10 = SCU IST (0x25FE00A4)
    mov.l   .L_pattern_config_base, r12     ! r12 = pattern table config base
    mov.w   .L_irq_mask_init, r5            ! r5 = 0x0083 (interrupt mask)
    mov.l @r8, r3
    jsr @r3                                 ! interrupt_ctrl(-1, 0x0083)
    mov #-0x1, r4                           !   enable standard interrupts

    /* ---- Clear VDP2 VRAM (128KB = 0x20000 bytes) ---- */
    mov.l   .L_vdp2_vram_0x00000, r5       ! r5 = 0x25E00000 (VDP2 VRAM start)
    mov.l   .L_fp_two, r4                   ! r4 = 0x20000 (128K, loop counter)
    bra     .L_06004AF2
    nop
.L_irq_mask_init:
    .2byte  0x0083                          /* interrupt config: enable vblank */
    .2byte  0xFFFF
.L_interrupt_ctrl_ptr:
    .4byte  sym_06000344                    /* → interrupt controller function */
.L_fn_vdp1_poly_build:
    .4byte  vdp1_polygon_build              /* VDP1 polygon/pattern builder */
.L_scu_ist:
    .4byte  0x25FE00A4                      /* SCU IST — interrupt status */
.L_pattern_config_base:
    .4byte  sym_06087C84                    /* pattern table config structure */
.L_vdp2_vram_0x00000:
    .4byte  0x25E00000                      /* VDP2 VRAM +0x00000 */
.L_fp_two:
    .4byte  0x00020000                      /* 2.0 (16.16 fixed-point) / 128K count */
.L_06004AE4:
    mov r5, r2
    add #0x4, r5                            ! advance 4 bytes
    mov.l r14, @r2                          ! write 0
    mov r5, r3
    add #0x4, r5                            ! advance 4 more
    mov.l r14, @r3                          ! write 0 (8 bytes per iteration)
    add #-0x2, r4                           ! decrement by 2
.L_06004AF2:
    tst r4, r4
    bf      .L_06004AE4                     ! loop until all VRAM cleared

    /* ---- Display hardware initialization ---- */
    mov.l   .L_fn_display_hw_init, r3
    jsr @r3                                 ! display_hw_init()
    nop
    mov #0x1, r6                            ! r6 = 1
    mov #0x0, r5                            ! r5 = 0
    mov.l   .L_fn_vdp_init_master, r3
    jsr @r3                                 ! vdp_init_master(0, 0, 1)
    mov r5, r4                              !   r4 = 0
    mov.l   .L_fn_display_extra, r3
    jsr @r3                                 ! display_extra_config(1)
    mov #0x1, r4

    /* ---- Palette intensity + tilemap DMA ---- */
    mov.l   .L_fp_half, r2                  ! 0x8000 = 0.5 fixed-point
    mov.l   .L_palette_intensity, r3
    mov.w r2, @r3                           ! palette_intensity = 0.5
    mov r3, r6                              ! r6 = &palette_intensity
    mov.l   .L_vdp2_cram_0xFFE, r4         ! VDP2 color RAM last entry
    mov.l   .L_fn_tilemap_dma, r3
    jsr @r3                                 ! tilemap_dma_update(CRAM+0xFFE, 1, &palette)
    mov #0x1, r5

    /* ---- Wait for VBlank-OUT interrupt ---- */
    mov.l r11, @r10                         ! write 2 to SCU IST (clear VB-OUT flag)
.L_06004B1E:
    mov.l @r10, r2                          ! read SCU IST
    and r11, r2                             ! isolate bit 1
    cmp/eq r11, r2                          ! VBlank-OUT fired?
    bt      .L_06004B2A                     !   yes → continue
    bra     .L_06004CBA                     !   no → keep spinning
    nop

    /* ---- Register interrupt callbacks ---- */
.L_06004B2A:
    mov.l   .L_vector_table_ptr, r3
    mov.l   .L_fn_button_input, r5          ! callback = button_input_read
    mov.l @r3, r3
    jsr @r3                                 ! register_callback(0x40, button_input_read)
    mov #0x40, r4                           !   vector 0x40 = VBlank-IN handler
    mov.l   .L_vector_table_ptr, r2
    mov.l   .L_fn_vblank_out, r5            ! callback = vblank_out_handler
    mov.l @r2, r2
    jsr @r2                                 ! register_callback(0x41, vblank_out_handler)
    mov #0x41, r4                           !   vector 0x41 = VBlank-OUT handler

    /* ---- Scene state processor init ---- */
    extu.b r14, r3                          ! r3 = 0
    mov #0x5, r7                            ! r7 = 5
    mov #0x10, r6                           ! r6 = 16
    mov #0x2, r5                            ! r5 = 2
    mov.l r3, @-r15                         ! push 0
    mov.l   .L_scene_state_param, r2
    mov.l r2, @-r15                         ! push scene_state_param
    mov.l   .L_fn_scene_state, r3
    jsr @r3                                 ! scene_state_process(2, 16, 5, param, 0)
    mov r5, r4
    add #0x8, r15                           ! pop stack args

    /* ---- Display parameter + initial VRAM dest ---- */
    mov.l   .L_fn_display_param, r3
    jsr @r3                                 ! display_param_set(1)
    mov #0x1, r4
    mov.l   .L_vdp2_vram_0x58000, r4       ! 0x25E58000
    mov.l   .L_vram_dest_ch4, r3
    mov.l r4, @r3                           ! vram_dest_ch4 = 0x25E58000
    mov.l   .L_vram_cfg_ch4, r3
    mov.l r4, @r3                           ! vram_cfg_ch4 = 0x25E58000

    /* ==== Channel 4: pattern table setup ==== */
    mov.l   .L_fn_pattern_tbl_init, r3
    jsr @r3                                 ! pattern_tbl_init(sp)
    mov r15, r4
    /* Build pattern config struct on stack */
    extu.b r13, r2
    mov.b r2, @r15                          ! sp[0] = 1 (enabled)
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(1, r15)                     ! sp[1] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(2, r15)                     ! sp[2] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(3, r15)                     ! sp[3] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(5, r15)                     ! sp[5] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(6, r15)                     ! sp[6] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(8, r15)                     ! sp[8] = 1
    mov.l   .L_vram_cfg_ch4, r3
    mov.l @r3, r3
    mov.l r3, @(12, r15)                    ! sp[12] = vram_cfg_ch4 base
    mov.w   .L_vram_page_size, r4           ! 0x2000 = 8KB page
    mov.l   .L_vram_cfg_ch4, r3
    mov.l @r3, r3
    add r4, r3
    mov.l r3, @(16, r15)                    ! sp[16] = vram_cfg + 0x2000
    mov.l   .L_vram_cfg_ch4, r3
    mov.l @r3, r3
    mov.l r3, @(20, r15)                    ! sp[20] = vram_cfg base
    mov.l   .L_vram_cfg_ch4, r3
    mov.l @r3, r3
    mov r15, r5
    add r3, r4
    mov.l r4, @(24, r15)                    ! sp[24] = vram_cfg + 0x2000
    jsr @r9                                 ! vdp1_polygon_build(4, sp)
    mov #0x4, r4                            !   channel 4
    mov.l   .L_vdp2_ctrl_ch4, r3
    mov.l   .L_vdp2_ctrl_val_ch4, r2
    mov.w r2, @r3                           ! vdp2_ctrl_ch4 = 0xC024
    bra     .L_06004C10
    mov #0x4, r4
.L_vram_page_size:
    .2byte  0x2000                          /* 8KB VRAM page size */
    .2byte  0xFFFF
.L_fn_display_hw_init:
    .4byte  display_hw_init                 /* display hardware init */
.L_fn_vdp_init_master:
    .4byte  vdp_init_master                 /* VDP master init */
.L_fn_display_extra:
    .4byte  display_extra_config            /* extra display configuration */
.L_fp_half:
    .4byte  0x00008000                      /* 0.5 (16.16 fixed-point) */
.L_palette_intensity:
    .4byte  sym_06086028                    /* palette intensity (word) */
.L_vdp2_cram_0xFFE:
    .4byte  0x25F00FFE                      /* VDP2 color RAM +0xFFE */
.L_fn_tilemap_dma:
    .4byte  tilemap_dma_update              /* tilemap DMA transfer */
.L_vector_table_ptr:
    .4byte  sym_06000300                    /* → callback registration fn */
.L_fn_button_input:
    .4byte  button_input_read               /* button input handler */
.L_fn_vblank_out:
    .4byte  vblank_out_handler              /* VBlank-OUT handler */
.L_scene_state_param:
    .4byte  sym_06063DA8                    /* scene state config data */
.L_fn_scene_state:
    .4byte  scene_state_process             /* scene state processor */
.L_fn_display_param:
    .4byte  display_param_set               /* display parameter config */
.L_vdp2_vram_0x58000:
    .4byte  0x25E58000                      /* VDP2 VRAM +0x58000 */
.L_vram_dest_ch4:
    .4byte  sym_06061294                    /* VRAM dest for channel 4 */
.L_vram_cfg_ch4:
    .4byte  sym_060612AC                    /* VRAM config for channel 4 */
.L_fn_pattern_tbl_init:
    .4byte  sym_06037618                    /* pattern table init */
.L_vdp2_ctrl_ch4:
    .4byte  sym_060A3DB8                    /* VDP2 control register ch4 */
.L_vdp2_ctrl_val_ch4:
    .4byte  0x0000C024                      /* ch4 control value */

    /* ==== Channel 8: pattern table setup ==== */
.L_06004C10:
    mov.l   .L_fn_cmd_queue_write, r3
    jsr @r3                                 ! cmd_queue_write(4) — select channel 4
    nop
    mov.l   .L_fp_one, r5                   ! 1.0 fixed-point
    mov.l   .L_fn_color_intensity, r3
    jsr @r3                                 ! scene_color_intensity(1.0, 1.0)
    mov r5, r4
    mov.l   .L_fn_cmd_queue_commit, r3
    jsr @r3                                 ! cmd_queue_commit()
    nop
    mov.l   .L_vdp2_vram_0x5C000, r4       ! 0x25E5C000
    mov.l   .L_vram_dest_ch8, r3
    mov.l r4, @r3                           ! vram_dest_ch8 = 0x25E5C000
    mov.l   .L_vram_cfg_ch8, r3
    mov.l r4, @r3                           ! vram_cfg_ch8 = 0x25E5C000
    mov.l   .L_fn_pattern_tbl_init_ch8, r3
    jsr @r3                                 ! pattern_tbl_init(sp)
    mov r15, r4
    /* Build ch8 pattern config (same byte layout as ch4) */
    extu.b r13, r2
    mov.b r2, @r15                          ! sp[0] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(1, r15)                     ! sp[1] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(2, r15)                     ! sp[2] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(3, r15)                     ! sp[3] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(5, r15)                     ! sp[5] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(6, r15)                     ! sp[6] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(8, r15)                     ! sp[8] = 1
    mov.l   .L_vram_cfg_ch8, r3
    mov.l @r3, r3
    mov.l r3, @(12, r15)                    ! sp[12] = vram_cfg_ch8
    mov.l   .L_vram_cfg_ch8, r3
    mov.l @r3, r3
    mov.l r3, @(16, r15)                    ! sp[16] = vram_cfg_ch8
    mov.l   .L_vram_cfg_ch8, r3
    mov.l @r3, r3
    mov.l r3, @(20, r15)                    ! sp[20] = vram_cfg_ch8
    mov.l   .L_vram_cfg_ch8, r3
    mov.l @r3, r3
    mov.l r3, @(24, r15)                    ! sp[24] = vram_cfg_ch8
    mov r15, r5
    jsr @r9                                 ! vdp1_polygon_build(8, sp)
    mov #0x8, r4                            !   channel 8
    mov.l   .L_vdp2_ctrl_ch8, r3
    mov.l   .L_vdp2_ctrl_val_ch8, r2
    mov.w r2, @r3                           ! vdp2_ctrl_ch8 = 0xC044
    mov.l   .L_fn_cmd_queue_write, r3
    jsr @r3                                 ! cmd_queue_write(8) — select channel 8
    mov #0x8, r4

    /* ---- Display enable + pattern config base setup ---- */
    mov.l   .L_display_enable_arg, r4
    mov.l   .L_fn_display_enable, r3
    jsr @r3                                 ! display_enable_ctrl(pattern_config_base)
    nop
    mov.l   .L_fn_cmd_queue_commit, r3
    jsr @r3                                 ! cmd_queue_commit()
    nop
    mov.l   .L_fn_cmd_queue_write, r3
    jsr @r3                                 ! cmd_queue_write(8) — channel 8 again
    mov #0x8, r4

    /* ---- Initialize pattern config buffer ---- */
    extu.b r14, r2
    mov.b r2, @r12                          ! config[0] = 0
    extu.b r14, r0
    mov.b r0, @(1, r12)                     ! config[1] = 0
    extu.b r14, r0
    mov.b r0, @(2, r12)                     ! config[2] = 0
    extu.b r13, r0
    mov.b r0, @(3, r12)                     ! config[3] = 1
    extu.b r14, r0
    mov.b r0, @(4, r12)                     ! config[4] = 0
    mov.l   .L_vdp2_vram_0x5FE80, r3
    mov.l r3, @(8, r12)                     ! config[8] = 0x25E5FE80
    mov.l   .L_vdp2_vram_0x5FF00, r2
    mov.l r2, @(12, r12)                    ! config[12] = 0x25E5FF00
    bra     .L_06004D0C
    mov #0x0, r4                            ! loop counter = 0

    /* ---- Spin-wait re-entry (VBlank-OUT not yet) ---- */
.L_06004CBA:
    bra     .L_06004B1E                     ! loop back to check SCU IST
    nop
    .2byte  0xFFFF
.L_fn_cmd_queue_write:
    .4byte  sym_0603850C                    /* display cmd queue: select channel */
.L_fp_one:
    .4byte  0x00010000                      /* 1.0 (16.16 fixed-point) */
.L_fn_color_intensity:
    .4byte  scene_color_intensity           /* scene color intensity */
.L_fn_cmd_queue_commit:
    .4byte  sym_06038520                    /* display cmd queue: commit */
.L_vdp2_vram_0x5C000:
    .4byte  0x25E5C000                      /* VDP2 VRAM +0x5C000 */
.L_vram_dest_ch8:
    .4byte  sym_06061298                    /* VRAM dest for channel 8 */
.L_vram_cfg_ch8:
    .4byte  sym_060612B0                    /* VRAM config for channel 8 */
.L_fn_pattern_tbl_init_ch8:
    .4byte  sym_06037618                    /* pattern table init (ch8) */
.L_vdp2_ctrl_ch8:
    .4byte  sym_060A3DBA                    /* VDP2 control register ch8 */
.L_vdp2_ctrl_val_ch8:
    .4byte  0x0000C044                      /* ch8 control value */
.L_display_enable_arg:
    .4byte  sym_06087C84                    /* pattern config base (for enable) */
.L_fn_display_enable:
    .4byte  display_enable_ctrl             /* display enable control */
.L_vdp2_vram_0x5FE80:
    .4byte  0x25E5FE80                      /* VDP2 VRAM +0x5FE80 */
.L_vdp2_vram_0x5FF00:
    .4byte  0x25E5FF00                      /* VDP2 VRAM +0x5FF00 */

    /* ---- Zero-fill pattern config buffer (256 bytes at config+0x1810) ---- */
.L_06004CF8:
    mov.w   .L_pattern_buf_offset, r2      ! offset 0x1810
    add r12, r2
    add r4, r2
    mov.l r14, @r2                          ! config[0x1810 + i] = 0
    add #0x4, r4
    mov.w   .L_pattern_buf_offset, r3
    add r12, r3
    add r4, r3
    mov.l r14, @r3                          ! config[0x1810 + i+4] = 0
    add #0x4, r4                            ! advance 8 bytes per iteration
.L_06004D0C:
    mov.w   .L_pattern_buf_size, r2        ! 0x0100 = 256
    cmp/hs r2, r4
    bf      .L_06004CF8                     ! loop until 256 bytes cleared

    /* ==== Channel 16: scene buffer + pattern setup ==== */
    mov.l   .L_scene_buf_init_arg, r4
    mov.l   .L_fn_scene_buf_init, r3
    jsr @r3                                 ! scene_buffer_init(pattern_config_base)
    nop
    mov.l   .L_fp_one_ch16, r5             ! 1.0 fixed-point
    mov.l   .L_fn_color_intensity_ch16, r3
    jsr @r3                                 ! scene_color_intensity(1.0, 1.0)
    mov r5, r4
    mov.l   .L_fn_cmd_commit_ch16, r3
    jsr @r3                                 ! cmd_queue_commit()
    nop
    mov.l   .L_vram_link_src, r2            ! source VRAM config ref
    mov.l   .L_vram_link_dst, r3
    mov.l r2, @r3                           ! link_dst = link_src
    mov.l   .L_vdp2_vram_0x5E000, r2       ! 0x25E5E000
    mov.l   .L_vram_cfg_ch16, r3
    mov.l r2, @r3                           ! vram_cfg_ch16 = 0x25E5E000
    mov.l   .L_fn_pattern_tbl_init_ch16, r3
    jsr @r3                                 ! pattern_tbl_init(sp)
    mov r15, r4
    /* Build ch16 pattern config (all VRAM entries = same base) */
    extu.b r13, r2
    mov.b r2, @r15                          ! sp[0] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(1, r15)                     ! sp[1] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(2, r15)                     ! sp[2] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(3, r15)                     ! sp[3] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(5, r15)                     ! sp[5] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(6, r15)                     ! sp[6] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(8, r15)                     ! sp[8] = 1
    mov.l   .L_vram_cfg_ch16, r3
    mov.l @r3, r3
    mov.l r3, @(12, r15)                    ! sp[12] = 0x25E5E000
    mov.l   .L_vram_cfg_ch16, r3
    mov.l @r3, r3
    mov.l r3, @(16, r15)                    ! sp[16] = 0x25E5E000
    mov.l   .L_vram_cfg_ch16, r3
    mov.l @r3, r3
    mov.l r3, @(20, r15)                    ! sp[20] = 0x25E5E000
    mov.l   .L_vram_cfg_ch16, r3
    mov.l @r3, r3
    mov.l r3, @(24, r15)                    ! sp[24] = 0x25E5E000
    mov r15, r5
    jsr @r9                                 ! vdp1_polygon_build(16, sp)
    mov #0x10, r4                           !   channel 16
    mov.l   .L_vdp2_ctrl_ch16, r3
    mov.l   .L_vdp2_ctrl_val_ch16, r2
    mov.w r2, @r3                           ! vdp2_ctrl_ch16 = 0xC000

    /* ---- Channel 32 VRAM setup ---- */
    mov.l   .L_vdp2_vram_0x7E000, r4       ! 0x25E7E000
    mov.l   .L_vram_dest_ch32, r3
    mov.l r4, @r3                           ! vram_dest_ch32 = 0x25E7E000
    mov.l   .L_vram_cfg_ch32, r3
    mov.l r4, @r3                           ! vram_cfg_ch32 = 0x25E7E000
    mov.l   .L_fn_pattern_tbl_init_ch16, r3
    jsr @r3                                 ! pattern_tbl_init(sp) — reuse ch16 fn ref
    mov r15, r4
    /* Build ch32 pattern config (all entries = 0x25E7E000) */
    extu.b r13, r2
    mov.b r2, @r15                          ! sp[0] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(1, r15)                     ! sp[1] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(2, r15)                     ! sp[2] = 1
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(3, r15)                     ! sp[3] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(5, r15)                     ! sp[5] = 0
    extu.b r14, r3
    mov r3, r0
    mov.b r0, @(6, r15)                     ! sp[6] = 0
    extu.b r13, r3
    mov r3, r0
    mov.b r0, @(8, r15)                     ! sp[8] = 1
    mov.l   .L_vram_cfg_ch32, r3
    mov.l @r3, r3
    mov.l r3, @(12, r15)                    ! sp[12] = 0x25E7E000
    mov.l   .L_vram_cfg_ch32, r3
    mov.l @r3, r3
    mov.l r3, @(16, r15)                    ! sp[16] = 0x25E7E000
    mov.l   .L_vram_cfg_ch32, r3
    mov.l @r3, r3
    mov.l r3, @(20, r15)                    ! sp[20] = 0x25E7E000
    mov.l   .L_vram_cfg_ch32, r3
    mov.l @r3, r3
    mov.l r3, @(24, r15)                    ! sp[24] = 0x25E7E000
    bra     .L_06004E1C
    nop
.L_pattern_buf_offset:
    .2byte  0x1810                          /* offset into pattern config buffer */
.L_pattern_buf_size:
    .2byte  0x0100                          /* 256 bytes to clear */
    .2byte  0xFFFF
.L_scene_buf_init_arg:
    .4byte  sym_06087C84                    /* pattern config base (for scene init) */
.L_fn_scene_buf_init:
    .4byte  scene_buffer_init               /* scene buffer initialization */
.L_fp_one_ch16:
    .4byte  0x00010000                      /* 1.0 (16.16 fixed-point) */
.L_fn_color_intensity_ch16:
    .4byte  scene_color_intensity           /* scene color intensity (ch16) */
.L_fn_cmd_commit_ch16:
    .4byte  sym_06038520                    /* cmd queue commit (ch16) */
.L_vram_link_src:
    .4byte  sym_060612C4                    /* VRAM config link source */
.L_vram_link_dst:
    .4byte  sym_0606129C                    /* VRAM config link destination */
.L_vdp2_vram_0x5E000:
    .4byte  0x25E5E000                      /* VDP2 VRAM +0x5E000 */
.L_vram_cfg_ch16:
    .4byte  sym_060612B4                    /* VRAM config for channel 16 */
.L_fn_pattern_tbl_init_ch16:
    .4byte  sym_06037618                    /* pattern table init (ch16/32) */
.L_vdp2_ctrl_ch16:
    .4byte  sym_060A3DBC                    /* VDP2 control register ch16 */
.L_vdp2_ctrl_val_ch16:
    .4byte  0x0000C000                      /* ch16 control value */
.L_vdp2_vram_0x7E000:
    .4byte  0x25E7E000                      /* VDP2 VRAM +0x7E000 */
.L_vram_dest_ch32:
    .4byte  sym_060612A0                    /* VRAM dest for channel 32 */
.L_vram_cfg_ch32:
    .4byte  sym_060612B8                    /* VRAM config for channel 32 */

    /* ==== Channel 32: polygon build + final subsystem init ==== */
.L_06004E1C:
    mov r15, r5
    jsr @r9                                 ! vdp1_polygon_build(32, sp)
    mov #0x20, r4                           !   channel 32
    mov r15, r4
    mov.l   .L_vdp2_ctrl_ch32, r3
    mov.l   .L_vdp2_ctrl_val_ch32, r2
    mov.w r2, @r3                           ! vdp2_ctrl_ch32 = 0xC060

    /* ---- VDP init dispatch + texture bank setup ---- */
    mov.l   .L_fn_vdp_init_dispatch, r3
    jsr @r3                                 ! vdp_init_dispatch(sp + 0x4C)
    add #0x4C, r4
    /* Build texture bank config (6 bytes at sp+0x54) */
    extu.b r13, r2
    mov #0x54, r0
    extu.b r13, r3
    mov r15, r4
    mov.b r2, @(r0, r15)                    ! sp[0x54] = 1
    mov #0x55, r0
    mov.b r3, @(r0, r15)                    ! sp[0x55] = 1
    extu.b r14, r3
    mov #0x56, r0
    mov.b r3, @(r0, r15)                    ! sp[0x56] = 0
    extu.b r14, r3
    mov #0x57, r0
    mov.b r3, @(r0, r15)                    ! sp[0x57] = 0
    extu.b r14, r3
    mov #0x58, r0
    mov.b r3, @(r0, r15)                    ! sp[0x58] = 0
    extu.b r14, r3
    mov #0x59, r0
    mov.b r3, @(r0, r15)                    ! sp[0x59] = 0
    mov.l   .L_fn_texture_bank_setup, r3
    jsr @r3                                 ! texture_bank_setup(sp + 0x4C)
    add #0x4C, r4

    /* ---- VDP1 polygon commit + display/audio init ---- */
    mov.l   .L_vdp1_init_param, r4
    mov.l   .L_fn_vdp1_poly_commit, r3
    jsr @r3                                 ! vdp1_polygon_commit(init_params)
    nop
    mov.l   .L_fn_channels_clear, r3
    jsr @r3                                 ! display_channels_clear()
    nop
    mov.l   .L_fn_display_init, r3
    jsr @r3                                 ! display hardware init (final)
    nop

    /* ---- Interrupt config: mask for subsystem init ---- */
    mov.l @r8, r2
    mov.w   .L_irq_mask_subsys, r4         ! 0xFF7C (mask most interrupts)
    jsr @r2                                 ! interrupt_ctrl(0xFF7C, 0)
    mov #0x0, r5
    mov.l   .L_fn_render_update, r3
    jsr @r3                                 ! render/display update
    nop

    /* ---- Restore interrupts for subsystem init ---- */
    mov.l @r8, r2
    mov.w   .L_irq_mask_restore, r5        ! 0x0083
    jsr @r2                                 ! interrupt_ctrl(-1, 0x0083)
    mov #-0x1, r4

    /* ---- Major subsystem initialization ---- */
    mov.l   .L_fn_sound_init, r3
    jsr @r3                                 ! sound init
    nop
    mov.l   .L_fn_vdp2_reg_init, r3
    jsr @r3                                 ! vdp2_register_init()
    nop
    mov.l   .L_fn_master_init, r3
    jsr @r3                                 ! master_init_dispatch()
    nop
    mov.l   .L_fn_obj_template, r3
    jsr @r3                                 ! obj_template_init()
    nop
    mov.l   .L_fn_audio_init, r3
    jsr @r3                                 ! audio_display_init()
    nop

    /* ---- Set display ready flags ---- */
    mov #0xF, r2
    mov.l   .L_display_state_flags, r3
    mov.w r2, @r3                           ! display_state = 0xF (all ready)
    mov.l   .L_cmd_queue_ready, r3
    mov.w r13, @r3                          ! cmd_queue_ready = 1

    /* ---- Final interrupt config + render update ---- */
    mov.l @r8, r1
    mov.w   .L_irq_mask_subsys, r4         ! 0xFF7C
    jsr @r1                                 ! interrupt_ctrl(0xFF7C, 0)
    mov #0x0, r5
    mov.l   .L_fn_render_update, r3
    jsr @r3                                 ! final render/display update
    nop

    add #0x5C, r15
    lds.l @r15+, pr
    mov.l @r15+, r8
    mov.l @r15+, r9
    mov.l @r15+, r10
    mov.l @r15+, r11
    mov.l @r15+, r12
    mov.l @r15+, r13
    rts
    mov.l @r15+, r14
.L_irq_mask_subsys:
    .2byte  0xFF7C                          /* mask: disable most interrupts */
.L_irq_mask_restore:
    .2byte  0x0083                          /* restore: enable standard interrupts */
.L_vdp2_ctrl_ch32:
    .4byte  sym_060A3DBE                    /* VDP2 control register ch32 */
.L_vdp2_ctrl_val_ch32:
    .4byte  0x0000C060                      /* ch32 control value */
.L_fn_vdp_init_dispatch:
    .4byte  sym_060370C0                    /* VDP init dispatcher */
.L_fn_texture_bank_setup:
    .4byte  texture_bank_setup              /* texture bank configuration */
.L_vdp1_init_param:
    .4byte  sym_06059F20                    /* VDP1 init parameter block */
.L_fn_vdp1_poly_commit:
    .4byte  sym_06038044                    /* VDP1 polygon list commit */
.L_fn_channels_clear:
    .4byte  display_channels_clear          /* clear display channels */
.L_fn_display_init:
    .4byte  sym_060149E0                    /* display hardware init (final) */
.L_fn_render_update:
    .4byte  sym_06026CE0                    /* render/display update */
.L_fn_sound_init:
    .4byte  sym_06012E62                    /* sound subsystem init */
.L_fn_vdp2_reg_init:
    .4byte  vdp2_register_init              /* VDP2 register initialization */
.L_fn_master_init:
    .4byte  master_init_dispatch            /* master init dispatch */
.L_fn_obj_template:
    .4byte  obj_template_init               /* object template init */
.L_fn_audio_init:
    .4byte  audio_display_init              /* audio display init */
.L_display_state_flags:
    .4byte  sym_060A3DA8                    /* display state flags (0xF = ready) */
.L_cmd_queue_ready:
    .4byte  sym_060635AC                    /* cmd queue ready flag */
