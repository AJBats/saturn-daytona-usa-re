/* state_race_prepare -- L3 assembly (SH-2 mnemonics)
 * Translation unit: 0x06008E00 - 0x06008E48
 * Auto-generated by tools/generate_l3_tu.py
 *
 * State 12 — Race Preparation (Final Pre-Race Setup)
 * Called from: main state dispatch (game_state == 12)
 *
 * Final initialization before the race loop begins. Validates resources,
 * initializes car physics and rendering subsystems, sets the "race ready"
 * flag (bit 30 in display_flags), clears the results flag, resets the
 * phase flag, then tail-calls handler_dispatch(5, 5, 15) to start the
 * race countdown sequence (transitions to state 15).
 *
 * Pool entries are cross-TU references into state_pre_race's literal pool.
 *
 * Pool map (all confirmed DEFINITE in pre_race_states.s annotation):
 *   0x06008E84 = race_resource_init    (FUN_0600A0C0)  [HIGH]
 *   0x06008E88 = race_prep_init        (FUN_06018FA4)  [HIGH]
 *   0x06008E8C = &game_state           (g_game_state)  [HIGH]
 *   0x06008E90 = car_physics_init      (FUN_0600EC78)  [HIGH]
 *   0x06008E94 = obj_render_update     (FUN_060210F6)  [HIGH]
 *   0x06008E98 = &display_flags        (sym_0605B6D8)  [HIGH]
 *   0x06008E9C = 0x40000000            (bit 30 mask)   [MEDIUM — "race ready" per annotation, single source]
 *   0x06008EA0 = display_commit        (sym_06026CE0)  [MEDIUM — frame_timing says "display/palette commit"]
 *   0x06008EA4 = &results_flag         (sym_06059F44)  [HIGH]
 *   0x06008EA8 = &phase_flag           (sym_0605A016)  [HIGH]
 *   0x06008EAC = handler_dispatch      (FUN_06018DDC)  [HIGH]
 */

    .section .text.FUN_06008E00


    .global state_race_prepare
    .type state_race_prepare, @function
state_race_prepare:
    sts.l pr, @-r15                     ! save return address
    .byte   0xD3, 0x20    /* mov.l .L_fn_race_resource_init, r3 — validate loaded resources [HIGH] */
    jsr @r3                             ! race_resource_init()
    nop
    .byte   0xD3, 0x1F    /* mov.l .L_fn_race_prep_init, r3 — race subsystem initialization [HIGH] */
    jsr @r3                             ! race_prep_init()
    nop
    mov #0xD, r2                        ! r2 = 13 (state 13 = race readiness check)
    .byte   0xD3, 0x1E    /* mov.l .L_game_state, r3 — &game_state (g_game_state) [HIGH] */
    mov.l r2, @r3                       ! game_state = 13
    .byte   0xD3, 0x1E    /* mov.l .L_fn_car_physics_init, r3 — car/physics initialization [HIGH] */
    jsr @r3                             ! car_physics_init()
    nop
    .byte   0xD3, 0x1E    /* mov.l .L_fn_obj_render_update, r3 — object render update [HIGH] */
    jsr @r3                             ! obj_render_update()
    nop
    .byte   0xD4, 0x1D    /* mov.l .L_display_flags, r4 — &display_flags (sym_0605B6D8) [HIGH] */
    .byte   0xD2, 0x1E    /* mov.l .L_race_ready_bit, r2 — 0x40000000 (bit 30) [MEDIUM] */
    mov.l @r4, r3                       ! r3 = current display_flags
    or r2, r3                           ! r3 |= 0x40000000 (set "race ready" bit 30)
    mov.l r3, @r4                       ! display_flags |= 0x40000000
    .byte   0xD3, 0x1D    /* mov.l .L_fn_display_commit, r3 — display/palette commit (sym_06026CE0) [MEDIUM] */
    jsr @r3                             ! display_commit()
    nop
    mov #0x0, r2                        ! r2 = 0 (clear value)
    .byte   0xD3, 0x1C    /* mov.l .L_results_flag, r3 — &results_flag (sym_06059F44) [HIGH] */
    mov.l r2, @r3                       ! results_flag = 0 (clear)
    mov #0x3, r2                        ! r2 = 3
    .byte   0xD3, 0x1B    /* mov.l .L_phase_flag, r3 — &phase_flag (sym_0605A016) [HIGH] */
    mov.w r2, @r3                       ! phase_flag = 3 (word write)
    mov #0xF, r6                        ! r6 = 15 (target state = state 15, main race loop)
    mov #0x5, r5                        ! r5 = 5 (sub-handler index)
    mov r5, r4                          ! r4 = 5 (handler index)
    .byte   0xD3, 0x1A    /* mov.l .L_fn_handler_dispatch, r3 — handler dispatcher (FUN_06018DDC) [HIGH] */
    jmp @r3                             ! tail-call handler_dispatch(5, 5, 15)
    lds.l @r15+, pr                     ! restore PR in delay slot
